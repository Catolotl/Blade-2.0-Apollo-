<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Indy â€” Language Coach</title>
  <style>
    :root {
      --bg:        #000000;
      --text:      #ffffff;
      --text-dim:  #cccccc;
      --border:    #333333;
      --accent:    #ffffff;
      --accent-dim:#888888;
      --modal-bg:  rgba(0,0,0,0.75);
    }

    * { margin:0; padding:0; box-sizing:border-box; }

    body {
      font-family: system-ui, -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      padding: 1.5rem;
      line-height: 1.5;
    }

    .container { max-width: 920px; margin: 0 auto; }

    header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }

    h1 { font-size: 2.1rem; font-weight: 500; letter-spacing: -0.02em; }

    .btn-small {
      padding: 0.5rem 1rem;
      background: #111;
      color: white;
      border: 1px solid #444;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.18s ease;
    }
    .btn-small:hover { background: #222; border-color: #666; }

    #chat {
      background: #0a0a0a;
      border: 1px solid #222;
      border-radius: 8px;
      height: 520px;
      overflow-y: auto;
      padding: 1.4rem;
      margin-bottom: 1rem;
    }

    .message {
      margin: 1rem 0;
      padding: 0.9rem 1.3rem;
      border-radius: 8px;
      max-width: 80%;
      line-height: 1.45;
      font-size: 1.05rem;
    }

    .user { background: #1a1a1a; margin-left: auto; border: 1px solid #333; }

    .ai { background: transparent; border-left: 3px solid #888; padding-left: 1.1rem; }

    .input-area { display: flex; gap: 0.8rem; }

    #userInput {
      flex: 1;
      padding: 0.9rem 1.3rem;
      background: #111;
      color: white;
      border: 1px solid #333;
      border-radius: 8px;
      font-size: 1.05rem;
    }

    #userInput:focus { outline: none; border-color: #777; }

    .mic-btn {
      width: 52px; height: 52px;
      border-radius: 50%;
      background: #111;
      color: white;
      border: 1px solid #444;
      font-size: 1.4rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .mic-btn:hover { background: #1a1a1a; }

    .mic-btn.listening {
      background: #300000;
      border-color: #800000;
      animation: softPulse 2s infinite ease-in-out;
    }

    @keyframes softPulse {
      0%,100% { box-shadow: 0 0 0 0 rgba(255,0,0,0.12); }
      50%     { box-shadow: 0 0 0 14px rgba(255,0,0,0.08); }
    }

    .status { margin-top: 0.7rem; color: #888; font-size: 0.9rem; }

    .modal {
      position: fixed; inset: 0;
      background: var(--modal-bg);
      display: none;
      place-items: center;
      z-index: 1000;
      backdrop-filter: blur(6px);
    }

    .modal.active { display: grid; }

    .modal-content {
      background: #111;
      border: 1px solid #333;
      border-radius: 10px;
      width: 90%;
      max-width: 460px;
      padding: 1.8rem;
    }

    .modal h2 { margin-bottom: 1.4rem; font-weight: 500; }

    .form-group { margin-bottom: 1.2rem; }

    label { display: block; margin-bottom: 0.4rem; color: #aaa; font-size: 0.9rem; }

    input[type="text"], select {
      width: 100%;
      padding: 0.8rem 1rem;
      background: #0a0a0a;
      color: white;
      border: 1px solid #333;
      border-radius: 6px;
      font-size: 1rem;
    }

    .modal-buttons { margin-top: 1.6rem; text-align: right; }

    .btn-primary {
      padding: 0.8rem 1.4rem;
      background: #222;
      color: white;
      border: 1px solid #555;
      border-radius: 6px;
      cursor: pointer;
    }

    .btn-primary:hover { background: #333; }
  </style>
</head>
<body>

<div class="container">
  <header>
    <h1>Indy</h1>
    <button class="btn-small" id="editProfileBtn" style="display:none;">Change Profile</button>
  </header>

  <div id="chat"></div>

  <div class="input-area" id="inputArea" style="display:none;">
    <input type="text" id="userInput" placeholder="Type here..." autocomplete="off"/>
    <button class="mic-btn" id="micBtn" title="Voice â€¢ Say Hey Indy">ðŸŽ¤</button>
  </div>

  <div class="status" id="status">Loading...</div>
</div>

<!-- Profile Modal -->
<div class="modal" id="profileModal">
  <div class="modal-content">
    <h2 id="modalTitle">Welcome â€” Let's begin</h2>

    <div class="form-group">
      <label>Your Name</label>
      <input type="text" id="name" placeholder="e.g. Alex" autocomplete="off"/>
    </div>

    <div class="form-group">
      <label>Language to learn</label>
      <select id="language">
        <option value="">â€” select â€”</option>
        <option value="French">French</option>
        <option value="German">German</option>
        <option value="Italian">Italian</option>
        <option value="Portuguese">Portuguese</option>
        <option value="Japanese">Japanese</option>
        <option value="Korean">Korean</option>
        <option value="Mandarin Chinese">Mandarin Chinese</option>
        <option value="Arabic">Arabic</option>
        <option value="Russian">Russian</option>
      </select>
    </div>

    <div class="form-group">
      <label>Your level</label>
      <select id="level">
        <option value="">â€” select â€”</option>
        <option value="Beginner">Beginner</option>
        <option value="Intermediate">Intermediate</option>
        <option value="Advanced">Advanced</option>
      </select>
    </div>

    <div class="modal-buttons">
      <button class="btn-primary" id="saveProfileBtn">Save & Start</button>
    </div>
  </div>
</div>

<script>
// CONFIG
const POLLINATIONS_API = "https://text.pollinations.ai/";
const STORAGE_KEY = "indyCoach_v2026";

const SYSTEM_PROMPT_TEMPLATE = `
You are Indy, a calm, patient, encouraging language tutor on Sunshine 1.0.

Your only purpose is to actively teach {language} at {level} level.
Use the student's name ({name}) naturally sometimes.

Rules:
- Use mostly {language}, but explain grammar/vocabulary/pronunciation in clear simple English.
- Actively teach: examples, explanations, questions, small exercises, gentle corrections.
- Show corrections: wrong â†’ correct â†’ short reason.
- Give phonetic help when useful (e.g. "konnichiwa" â†’ "kon-nee-chee-wah")
- Replies 4â€“10 sentences max, focused and clear.
- Never teach or use Spanish.
- Warm, structured, motivating tutor style.
`;

// STATE
let profile = null;
let recognition = null;
let isListening = false;

const chat = document.getElementById("chat");
const statusEl = document.getElementById("status");
const inputArea = document.getElementById("inputArea");
const editBtn = document.getElementById("editProfileBtn");
const modal = document.getElementById("profileModal");
const modalTitle = document.getElementById("modalTitle");
const nameInput = document.getElementById("name");
const langSelect = document.getElementById("language");
const levelSelect = document.getElementById("level");

// PROFILE STORAGE
function loadProfile() {
  try {
    const data = localStorage.getItem(STORAGE_KEY);
    return data ? JSON.parse(data) : null;
  } catch { return null; }
}

function saveProfile() {
  const name = nameInput.value.trim();
  const language = langSelect.value;
  const level = levelSelect.value;

  if (!name || !language || !level) {
    alert("Please fill all fields.");
    return false;
  }

  profile = { name, language, level };
  localStorage.setItem(STORAGE_KEY, JSON.stringify(profile));
  return true;
}

// UI
function addMessage(sender, text) {
  const div = document.createElement("div");
  div.className = `message ${sender}`;
  div.textContent = text;
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
}

function showModal(isEdit = false) {
  if (isEdit && profile) {
    modalTitle.textContent = "Edit Profile";
    nameInput.value = profile.name;
    langSelect.value = profile.language;
    levelSelect.value = profile.level;
  } else {
    modalTitle.textContent = "Welcome â€” Let's begin";
    nameInput.value = "";
    langSelect.value = "";
    levelSelect.value = "";
  }
  modal.classList.add("active");
}

function hideModal() { modal.classList.remove("active"); }

// BROWSER TTS (keyless, multilingual fallback)
function speak(text) {
  if (!window.speechSynthesis) return;

  const utterance = new SpeechSynthesisUtterance(text);

  const voices = speechSynthesis.getVoices();
  let selectedVoice;

  // Try to match language being learned
  if (profile?.language.includes("Japanese")) {
    selectedVoice = voices.find(v => v.lang === 'ja-JP') || voices.find(v => v.lang.startsWith('ja'));
  } else if (profile?.language.includes("Korean")) {
    selectedVoice = voices.find(v => v.lang === 'ko-KR') || voices.find(v => v.lang.startsWith('ko'));
  } else if (profile?.language.includes("Chinese")) {
    selectedVoice = voices.find(v => v.lang === 'zh-CN' || v.lang === 'zh-TW') || voices.find(v => v.lang.startsWith('zh'));
  } else {
    // English fallback â†’ prefer male/en-AU if possible
    selectedVoice = voices.find(v =>
      v.lang.includes('en-AU') &&
      /male|daniel|james|liam|jack|ethan|owen/i.test(v.name.toLowerCase())
    ) || voices.find(v => v.lang.includes('en-AU')) ||
      voices.find(v => v.lang.startsWith('en'));
  }

  if (selectedVoice) {
    utterance.voice = selectedVoice;
    utterance.lang = selectedVoice.lang;
  }

  utterance.rate = 0.94;
  utterance.pitch = 1.0;
  utterance.volume = 1.0;

  speechSynthesis.speak(utterance);
}

// VOICE RECOGNITION (continuous hotword)
function initRecognition() {
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SR) {
    statusEl.textContent = "Voice not supported";
    return;
  }

  recognition = new SR();
  recognition.continuous = true;
  recognition.interimResults = false;
  recognition.lang = "en-US";

  recognition.onresult = (event) => {
    let transcript = "";
    for (let i = event.resultIndex; i < event.results.length; i++) {
      transcript += event.results[i][0].transcript;
    }
    transcript = transcript.trim().toLowerCase();

    const triggers = ["hey indy", "hi indy", "hello indy", "indy"];

    for (const t of triggers) {
      if (transcript.startsWith(t)) {
        const msg = transcript.slice(t.length).trim();
        if (msg) {
          addMessage("user", msg);
          processUserMessage(msg);
        } else {
          statusEl.textContent = "Listening...";
        }
        return;
      }
    }

    if (isListening && transcript) {
      addMessage("user", transcript);
      processUserMessage(transcript);
    }
  };

  recognition.onerror = () => {
    document.getElementById("micBtn").classList.remove("listening");
    isListening = false;
    statusEl.textContent = "Voice error";
  };

  recognition.onend = () => {
    if (isListening) recognition.start();
    else document.getElementById("micBtn").classList.remove("listening");
  };
}

document.getElementById("micBtn").onclick = () => {
  if (!recognition) initRecognition();
  if (!recognition) return;

  if (isListening) {
    recognition.stop();
    isListening = false;
    document.getElementById("micBtn").classList.remove("listening");
    statusEl.textContent = "Voice off";
  } else {
    recognition.start();
    isListening = true;
    document.getElementById("micBtn").classList.add("listening");
    statusEl.textContent = "Listeningâ€¦ say 'Hey Indy' + your message";
  }
};

// TEXT INPUT
document.getElementById("userInput").addEventListener("keypress", e => {
  if (e.key === "Enter") {
    e.preventDefault();
    const msg = e.target.value.trim();
    if (msg) {
      addMessage("user", msg);
      processUserMessage(msg);
      e.target.value = "";
    }
  }
});

// AI CALL
async function processUserMessage(message) {
  if (!profile) {
    addMessage("ai", "Please set up your profile first.");
    return;
  }

  const system = SYSTEM_PROMPT_TEMPLATE
    .replace("{name}", profile.name)
    .replace("{language}", profile.language)
    .replace("{level}", profile.level);

  const fullPrompt = system + "\n\nUser: " + message + "\n\nIndy:";

  statusEl.textContent = "Indy is thinking...";

  try {
    const res = await fetch(POLLINATIONS_API + encodeURIComponent(fullPrompt));
    let reply = (await res.text()).trim();
    reply = reply.replace(/\*\*|\*/g, '');

    addMessage("ai", reply);
    speak(reply);
    statusEl.textContent = "Ready for your next message.";
  } catch (err) {
    addMessage("ai", "Sorryâ€¦ something went wrong.");
    statusEl.textContent = "Connection issue.";
  }
}

// INIT
function initializeApp() {
  profile = loadProfile();

  if (profile) {
    editBtn.style.display = "block";
    inputArea.style.display = "flex";
    addMessage("ai", `Welcome back ${profile.name}. Ready to continue ${profile.language}?`);
    speak(`Welcome back ${profile.name}. Ready to continue ${profile.language}?`);
    statusEl.textContent = "Ready when you are.";
  } else {
    showModal(false);
    statusEl.textContent = "Please set up your profile.";
  }
}

document.getElementById("saveProfileBtn").onclick = () => {
  if (saveProfile()) {
    hideModal();
    editBtn.style.display = "block";
    inputArea.style.display = "flex";
    addMessage("ai", `Hi ${profile.name} â€” let's start ${profile.language}! What would you like to practice?`);
    speak(`Hi ${profile.name}. Let's start ${profile.language}!`);
    statusEl.textContent = "Ready when you are.";
  }
};

editBtn.onclick = () => showModal(true);

initializeApp();

</script>
</body>
</html>
