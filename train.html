<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Indy â€” Language Coach</title>
  <style>
    :root {
      --bg: #ffffff;
      --text: #111111;
      --subtext: #444444;
      --accent: #0066cc;
      --light: #f8f9fa;
      --border: #e0e0e0;
      --modal-bg: rgba(0,0,0,0.55);
    }

    * { margin:0; padding:0; box-sizing:border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen-Sans, Ubuntu, Cantarell, 'Helvetica Neue', Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      padding: 24px;
      line-height: 1.5;
    }

    .container { max-width: 900px; margin: 0 auto; }

    header { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      margin-bottom: 1.5rem; 
    }

    h1 { 
      font-size: 2.2rem; 
      color: var(--accent); 
      font-weight: 600; 
    }

    .btn-small {
      padding: 8px 16px;
      background: #6c757d;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
    }
    .btn-small:hover { background: #5a6268; }

    #chat {
      border: 1px solid var(--border);
      border-radius: 10px;
      height: 480px;
      overflow-y: auto;
      padding: 1.5rem;
      background: white;
      margin-bottom: 1rem;
      box-shadow: 0 2px 10px rgba(0,0,0,0.04);
    }

    .message {
      margin: 1rem 0;
      padding: 12px 16px;
      border-radius: 10px;
      max-width: 82%;
      line-height: 1.45;
    }
    .user   { background: #e3f2fd; margin-left: auto; }
    .ai     { background: #f5f5f5; border-left: 4px solid var(--accent); }

    .input-area { display: flex; gap: 12px; }

    #userInput {
      flex: 1;
      padding: 14px 18px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 1.05rem;
    }

    #userInput:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(0,102,204,0.15);
    }

    .mic-btn {
      width: 54px;
      height: 54px;
      border-radius: 50%;
      background: var(--accent);
      color: white;
      border: none;
      font-size: 1.3rem;
      cursor: pointer;
    }
    .mic-btn.listening {
      background: #dc3545;
      animation: pulse 1.5s infinite;
    }
    @keyframes pulse { 0%,100% { transform: scale(1); } 50% { transform: scale(1.08); } }

    .status { margin-top: 0.8rem; color: var(--subtext); font-size: 0.9rem; }

    .modal {
      position: fixed;
      inset: 0;
      background: var(--modal-bg);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      backdrop-filter: blur(4px);
    }
    .modal.active { display: flex; }

    .modal-content {
      background: white;
      border-radius: 12px;
      width: 90%;
      max-width: 480px;
      padding: 2rem;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }

    .modal h2 { margin-bottom: 1.5rem; color: var(--accent); }

    .form-group { margin-bottom: 1.3rem; }
    label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--subtext); }
    input[type="text"], select {
      width: 100%;
      padding: 10px 14px;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 1rem;
    }
    select:focus, input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(0,102,204,0.15);
    }

    .modal-buttons { margin-top: 1.8rem; text-align: right; }
    .btn-primary {
      padding: 10px 20px;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1rem;
    }
    .btn-primary:hover { background: #0055aa; }
  </style>
</head>
<body>

<div class="container">
  <header>
    <h1>Indy â€” Language Coach</h1>
    <button class="btn-small" id="editProfileBtn" style="display:none;">Change Profile</button>
  </header>

  <div id="chat"></div>

  <div class="input-area" id="inputArea" style="display:none;">
    <input type="text" id="userInput" placeholder="Type your message..." autocomplete="off"/>
    <button class="mic-btn" id="micBtn" title="Click or say 'Hey Indy'">ðŸŽ¤</button>
  </div>

  <div class="status" id="status">Loading...</div>
</div>

<!-- Profile Modal (no cancel button) -->
<div class="modal" id="profileModal">
  <div class="modal-content">
    <h2 id="modalTitle">Welcome! Let's get started</h2>
    <div class="form-group">
      <label>Your Name</label>
      <input type="text" id="name" placeholder="e.g. Alex" autocomplete="off"/>
    </div>
    <div class="form-group">
      <label>Language you want to learn</label>
      <select id="language">
        <option value="">â€” select â€”</option>
        <option value="French">French</option>
        <option value="German">German</option>
        <option value="Italian">Italian</option>
        <option value="Portuguese">Portuguese</option>
        <option value="Japanese">Japanese</option>
        <option value="Korean">Korean</option>
        <option value="Mandarin Chinese">Mandarin Chinese</option>
        <option value="Arabic">Arabic</option>
        <option value="Russian">Russian</option>
      </select>
    </div>
    <div class="form-group">
      <label>Your current level</label>
      <select id="level">
        <option value="">â€” select â€”</option>
        <option value="Beginner">Beginner (A1â€“A2)</option>
        <option value="Intermediate">Intermediate (B1â€“B2)</option>
        <option value="Advanced">Advanced (C1â€“C2)</option>
      </select>
    </div>

    <div class="modal-buttons">
      <button class="btn-primary" id="saveProfileBtn">Save & Start</button>
    </div>
  </div>
</div>

<script>
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// CONFIG
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

const API_URL = "https://text.pollinations.ai/";
const STORAGE_KEY = "indyLanguageCoach_v1";

const SYSTEM_PROMPT_TEMPLATE = `
You are Indy, a professional, patient, encouraging language teacher running on Sunshine 1.0.

Your ONLY job is to actively TEACH the user {language} at {level} level.
Use the student's name ({name}) naturally from time to time.

Teaching style rules:
- Use MOSTLY the target language ({language}), but ALWAYS explain new grammar, vocabulary, and difficult structures IN CLEAR ENGLISH.
- Actively teach: give examples, explain rules, ask questions, give small exercises, correct mistakes gently with explanations.
- When correcting, show: wrong sentence â†’ correct version â†’ short explanation why.
- Include pronunciation help (use simple phonetic spelling when useful, e.g. "konnichiwa" = "kon-nee-chee-wah").
- Keep each reply focused, clear, and 4â€“10 sentences maximum.
- Never flood with only target language â€” always support learning.
- Never teach or use Spanish under any circumstances.
- Be warm, motivating, and structured like an excellent private tutor.
`;

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// STATE & DOM
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

let profile = null;
let recognition = null;
let isListening = false;

const chat = document.getElementById("chat");
const status = document.getElementById("status");
const inputArea = document.getElementById("inputArea");
const editBtn = document.getElementById("editProfileBtn");
const modal = document.getElementById("profileModal");
const modalTitle = document.getElementById("modalTitle");
const nameInput = document.getElementById("name");
const langSelect = document.getElementById("language");
const levelSelect = document.getElementById("level");

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// LOCAL STORAGE
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function loadProfile() {
  try {
    const data = localStorage.getItem(STORAGE_KEY);
    return data ? JSON.parse(data) : null;
  } catch {
    return null;
  }
}

function saveProfile() {
  const name = nameInput.value.trim();
  const language = langSelect.value;
  const level = levelSelect.value;

  if (!name || !language || !level) {
    alert("Please complete all fields to continue.");
    return false;
  }

  profile = { name, language, level };
  localStorage.setItem(STORAGE_KEY, JSON.stringify(profile));
  return true;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// UI HELPERS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function addMessage(sender, text) {
  const div = document.createElement("div");
  div.className = `message ${sender}`;
  div.textContent = text;
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
}

function showModal(isEdit = false) {
  if (isEdit && profile) {
    modalTitle.textContent = "Edit Profile";
    nameInput.value = profile.name;
    langSelect.value = profile.language;
    levelSelect.value = profile.level;
  } else {
    modalTitle.textContent = "Welcome! Let's get started";
    nameInput.value = "";
    langSelect.value = "";
    levelSelect.value = "";
  }
  modal.classList.add("active");
}

function hideModal() {
  modal.classList.remove("active");
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// TEXT CLEANING FOR TTS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function cleanForTTS(text) {
  return text
    .replace(/\*\*([^*]+)\*\*/g, '$1')
    .replace(/\*([^*]+)\*/g, '$1')
    .replace(/`([^`]+)`/g, '$1')
    .replace(/\[([^\]]+)\]\([^)]+\)/g, '$1')
    .replace(/[-*â€¢]/g, '')
    .replace(/[.,!?;:]\s*/g, '$& ')
    .replace(/\s+/g, ' ')
    .trim();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// AUTO-DETECT LANGUAGE & SMART VOICE SELECTION
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function detectLanguage(text) {
  // Simple char-based detection for common languages
  if (/[\u3040-\u30ff\u4e00-\u9faf]/.test(text)) return 'ja-JP'; // Japanese
  if (/[\uac00-\ud7af]/.test(text)) return 'ko-KR'; // Korean
  if (/[\u4e00-\u9fff]/.test(text)) return 'zh-CN'; // Chinese (Mandarin)
  if (/[\u0600-\u06ff]/.test(text)) return 'ar-SA'; // Arabic
  if (/[Ð°-ÑÐ-Ð¯]/.test(text)) return 'ru-RU'; // Russian
  if (/[Ã -Ã¿]/.test(text)) return 'fr-FR'; // French (basic)
  if (/[Ã¤Ã¶Ã¼ÃŸ]/.test(text)) return 'de-DE'; // German
  if (/[Ã Ã¨Ã¬Ã²Ã¹]/.test(text)) return 'it-IT'; // Italian
  if (/[Ã¡Ã©Ã­Ã³ÃºÃ§]/.test(text)) return 'pt-PT'; // Portuguese
  return 'en-AU'; // Default to English/AU
}

function getBestVoice(text) {
  const voices = speechSynthesis.getVoices();
  if (voices.length === 0) return null;

  const lang = detectLanguage(text);

  if (lang === 'en-AU' || lang.startsWith('en')) {
    // Prefer less robotic male English voices (e.g., Google/Microsoft premium)
    return voices.find(v =>
      v.lang.includes('en') &&
      /male|guy|daniel|james|liam|jack|ethan|owen|google|microsoft/i.test(v.name.toLowerCase()) &&
      !/female|siri|alexa|karen/i.test(v.name.toLowerCase())
    ) || voices.find(v => v.lang.includes('en-AU')) ||
      voices.find(v => v.lang.startsWith('en'));
  } else {
    // Target language voice (natural, system default)
    return voices.find(v => v.lang === lang) ||
           voices.find(v => v.lang.startsWith(lang.split('-')[0]));
  }
}

function speak(text) {
  if (!window.speechSynthesis) return;

  const cleanText = cleanForTTS(text);
  if (!cleanText) return;

  const utterance = new SpeechSynthesisUtterance(cleanText);
  const voice = getBestVoice(cleanText);

  if (voice) {
    utterance.voice = voice;
    utterance.lang = voice.lang;
  }

  utterance.rate = 0.95; // Slightly slower for clarity
  utterance.pitch = 1.0;
  utterance.volume = 1.0;

  speechSynthesis.speak(utterance);
}

// Load voices early
speechSynthesis.onvoiceschanged = () => {};

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// INITIALIZATION
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function initializeApp() {
  profile = loadProfile();

  if (profile) {
    editBtn.style.display = "block";
    inputArea.style.display = "flex";
    addMessage("ai", `Welcome back ${profile.name}! Ready to continue with ${profile.language} today? ðŸ˜Š`);
    speak(`Welcome back ${profile.name}. Ready to continue with ${profile.language} today?`);
    status.textContent = "Ready when you are.";
  } else {
    editBtn.style.display = "none";
    inputArea.style.display = "none";
    showModal(false);
    status.textContent = "Please set up your profile to begin.";
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// VOICE RECOGNITION (continuous, trigger-based, send on pause)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function initRecognition() {
  const SpeechRec = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SpeechRec) {
    status.textContent = "Voice recognition not supported in this browser.";
    return;
  }

  recognition = new SpeechRec();
  recognition.continuous = true;
  recognition.interimResults = false; // Final on pause
  recognition.lang = "en-US";

  recognition.onresult = (e) => {
    let transcript = '';
    for (let i = e.resultIndex; i < e.results.length; i++) {
      transcript += e.results[i][0].transcript;
    }
    transcript = transcript.trim().toLowerCase();

    const triggers = ["hey indy", "hi indy", "hello indy", "indy"];

    for (const trigger of triggers) {
      if (transcript.startsWith(trigger)) {
        const message = transcript.slice(trigger.length).trim();
        if (message) {
          addMessage("user", message);
          processUserMessage(message);
        } else {
          status.textContent = "Listening for your message...";
        }
        return;
      }
    }

    // If in listening mode, treat as full message on pause
    if (isListening && transcript) {
      addMessage("user", transcript);
      processUserMessage(transcript);
    }
  };

  recognition.onerror = (e) => {
    console.error(e);
    document.getElementById("micBtn").classList.remove("listening");
    isListening = false;
    status.textContent = "Voice error. Try again.";
  };

  recognition.onend = () => {
    if (isListening) {
      recognition.start(); // Restart for continuous listening
    } else {
      document.getElementById("micBtn").classList.remove("listening");
    }
  };
}

document.getElementById("micBtn").onclick = () => {
  if (!recognition) initRecognition();
  if (!recognition) return;

  if (isListening) {
    recognition.stop();
    isListening = false;
    document.getElementById("micBtn").classList.remove("listening");
    status.textContent = "Voice stopped.";
  } else {
    recognition.start();
    isListening = true;
    document.getElementById("micBtn").classList.add("listening");
    status.textContent = "Listening continuously... say 'Hey Indy' to start a message";
  }
};

document.getElementById("userInput").addEventListener("keypress", e => {
  if (e.key === "Enter") {
    e.preventDefault();
    const msg = e.target.value.trim();
    if (msg) {
      addMessage("user", msg);
      processUserMessage(msg);
      e.target.value = "";
    }
  }
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// AI COMMUNICATION
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function processUserMessage(message) {
  if (!profile) {
    addMessage("ai", "Please set up your profile first.");
    return;
  }

  const system = SYSTEM_PROMPT_TEMPLATE
    .replace("{name}", profile.name)
    .replace("{language}", profile.language)
    .replace("{level}", profile.level);

  const fullPrompt = system + "\n\nUser: " + message + "\n\nIndy:";

  status.textContent = "Indy is thinking...";

  try {
    const res = await fetch(API_URL + encodeURIComponent(fullPrompt));
    let reply = (await res.text()).trim();

    // Light cleaning for display
    reply = reply.replace(/\*\*|\*/g, '');

    addMessage("ai", reply);
    speak(reply);
    status.textContent = "Ready for your next message.";
  } catch (err) {
    addMessage("ai", "Sorryâ€¦ something went wrong. Try again?");
    status.textContent = "Connection issue.";
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// EVENT LISTENERS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

document.getElementById("saveProfileBtn").onclick = () => {
  if (saveProfile()) {
    hideModal();
    editBtn.style.display = "block";
    inputArea.style.display = "flex";
    addMessage("ai", `Great! Hi ${profile.name} â€” let's start learning ${profile.language}! What would you like to practice today?`);
    speak(`Great! Hi ${profile.name}. Let's start learning ${profile.language}!`);
    status.textContent = "Ready when you are.";
  }
};

editBtn.onclick = () => showModal(true);

// Start the app
initializeApp();

</script>
</body>
</html>
