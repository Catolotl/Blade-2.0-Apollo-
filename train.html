<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Indy â€” Language Coach</title>
  <style>
    :root {
      --bg: #ffffff;
      --text: #111111;
      --subtext: #444444;
      --accent: #0066cc;
      --light: #f8f9fa;
      --border: #e0e0e0;
      --modal-bg: rgba(0,0,0,0.55);
    }

    * { margin:0; padding:0; box-sizing:border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen-Sans, Ubuntu, Cantarell, 'Helvetica Neue', Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      padding: 24px;
      line-height: 1.5;
    }

    .container { max-width: 900px; margin: 0 auto; }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }

    h1 {
      font-size: 2.2rem;
      color: var(--accent);
      font-weight: 600;
    }

    .btn-small {
      padding: 8px 16px;
      background: #6c757d;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
    }
    .btn-small:hover { background: #5a6268; }

    #chat {
      border: 1px solid var(--border);
      border-radius: 10px;
      height: 480px;
      overflow-y: auto;
      padding: 1.5rem;
      background: white;
      margin-bottom: 1rem;
      box-shadow: 0 2px 10px rgba(0,0,0,0.04);
    }

    .message {
      margin: 1rem 0;
      padding: 12px 16px;
      border-radius: 10px;
      max-width: 82%;
      line-height: 1.45;
    }
    .user   { background: #e3f2fd; margin-left: auto; }
    .ai     { background: #f5f5f5; border-left: 4px solid var(--accent); }

    .input-area {
      display: flex;
      gap: 12px;
    }

    #userInput {
      flex: 1;
      padding: 14px 18px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 1.05rem;
    }
    #userInput:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(0,102,204,0.15);
    }

    .mic-btn {
      width: 54px;
      height: 54px;
      border-radius: 50%;
      background: var(--accent);
      color: white;
      border: none;
      font-size: 1.3rem;
      cursor: pointer;
    }
    .mic-btn.listening {
      background: #dc3545;
      animation: pulse 1.5s infinite;
    }
    @keyframes pulse {
      0%,100% { transform: scale(1); }
      50%     { transform: scale(1.08); }
    }

    .status { margin-top: 0.8rem; color: var(--subtext); font-size: 0.9rem; }

    /* â”€â”€ Modal â”€â”€ */
    .modal {
      position: fixed;
      inset: 0;
      background: var(--modal-bg);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      backdrop-filter: blur(4px);
    }
    .modal.active { display: flex; }

    .modal-content {
      background: white;
      border-radius: 12px;
      width: 90%;
      max-width: 480px;
      padding: 2rem;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }

    .modal h2 { margin-bottom: 1.5rem; color: var(--accent); }

    .form-group {
      margin-bottom: 1.3rem;
    }
    label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
      color: var(--subtext);
    }
    input[type="text"], select {
      width: 100%;
      padding: 10px 14px;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 1rem;
    }
    select:focus, input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(0,102,204,0.15);
    }

    .modal-buttons {
      margin-top: 1.8rem;
      text-align: right;
    }
    .btn-primary {
      padding: 10px 20px;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1rem;
    }
    .btn-primary:hover { background: #0055aa; }
  </style>
</head>
<body>

<div class="container">
  <header>
    <h1>Indy â€” Language Coach</h1>
    <button class="btn-small" id="editProfileBtn" style="display:none;">Change Profile</button>
  </header>

  <div id="chat"></div>

  <div class="input-area" id="inputArea" style="display:none;">
    <input type="text" id="userInput" placeholder="Type your message..." autocomplete="off"/>
    <button class="mic-btn" id="micBtn" title="Click or say 'Hey Indy'">ðŸŽ¤</button>
  </div>

  <div class="status" id="status">Loading...</div>
</div>

<!-- Profile Modal (no cancel button) -->
<div class="modal" id="profileModal">
  <div class="modal-content">
    <h2 id="modalTitle">Welcome! Let's get started</h2>
    <div class="form-group">
      <label>Your Name</label>
      <input type="text" id="name" placeholder="e.g. Alex" autocomplete="off"/>
    </div>
    <div class="form-group">
      <label>Language you want to learn</label>
      <select id="language">
        <option value="">â€” select â€”</option>
        <option value="French">French</option>
        <option value="German">German</option>
        <option value="Italian">Italian</option>
        <option value="Portuguese">Portuguese</option>
        <option value="Japanese">Japanese</option>
        <option value="Korean">Korean</option>
        <option value="Mandarin Chinese">Mandarin Chinese</option>
        <option value="Arabic">Arabic</option>
        <option value="Russian">Russian</option>
      </select>
    </div>
    <div class="form-group">
      <label>Your current level</label>
      <select id="level">
        <option value="">â€” select â€”</option>
        <option value="Beginner">Beginner (A1â€“A2)</option>
        <option value="Intermediate">Intermediate (B1â€“B2)</option>
        <option value="Advanced">Advanced (C1â€“C2)</option>
      </select>
    </div>

    <div class="modal-buttons">
      <button class="btn-primary" id="saveProfileBtn">Save & Start</button>
    </div>
  </div>
</div>

<script>
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// CONFIG & PROMPT
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

const API_URL = "https://text.pollinations.ai/";
const STORAGE_KEY = "indyLanguageCoach_v1";

const SYSTEM_PROMPT_TEMPLATE = `
You are Indy, a friendly, patient and very clear language coach running on Sunshine 1.0.
Your only purpose is to help the user learn {language} at {level} level.
Use the student's name ({name}) naturally sometimes.

Rules:
- Speak mostly in {language} (adjust to level)
- Explain grammar/vocabulary clearly in English when needed
- Correct mistakes gently with explanations
- Keep replies focused and reasonably short
- Never use or teach Spanish under any circumstances
- Always be encouraging and positive
`;

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// STATE
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

let profile = null;
let recognition = null;
let isListening = false;

const chat = document.getElementById("chat");
const status = document.getElementById("status");
const inputArea = document.getElementById("inputArea");
const editBtn = document.getElementById("editProfileBtn");
const modal = document.getElementById("profileModal");
const modalTitle = document.getElementById("modalTitle");
const nameInput = document.getElementById("name");
const langSelect = document.getElementById("language");
const levelSelect = document.getElementById("level");

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// LOCAL STORAGE
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function loadProfile() {
  try {
    const data = localStorage.getItem(STORAGE_KEY);
    return data ? JSON.parse(data) : null;
  } catch {
    return null;
  }
}

function saveProfile() {
  const name = nameInput.value.trim();
  const language = langSelect.value;
  const level = levelSelect.value;

  if (!name || !language || !level) {
    alert("Please complete all fields to continue.");
    return false;
  }

  profile = { name, language, level };
  localStorage.setItem(STORAGE_KEY, JSON.stringify(profile));
  return true;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// UI HELPERS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function addMessage(sender, text) {
  const div = document.createElement("div");
  div.className = `message ${sender}`;
  div.textContent = text;
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
}

function showModal(isEdit = false) {
  if (isEdit && profile) {
    modalTitle.textContent = "Edit Profile";
    nameInput.value = profile.name;
    langSelect.value = profile.language;
    levelSelect.value = profile.level;
  } else {
    modalTitle.textContent = "Welcome! Let's get started";
    nameInput.value = "";
    langSelect.value = "";
    levelSelect.value = "";
  }
  modal.classList.add("active");
}

function hideModal() {
  modal.classList.remove("active");
}

function initializeApp() {
  profile = loadProfile();

  if (profile) {
    editBtn.style.display = "block";
    inputArea.style.display = "flex";
    addMessage("ai", `Welcome back, ${profile.name}! Ready to continue with ${profile.language} today? ðŸ˜Š`);
    speak(`Welcome back, ${profile.name}. Ready to practice ${profile.language}?`);
    status.textContent = "Ready when you are.";
  } else {
    editBtn.style.display = "none";
    inputArea.style.display = "none";
    showModal(false);
    status.textContent = "Please set up your profile to begin.";
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// TTS (prefer Australian male)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function speak(text) {
  if (!window.speechSynthesis) return;
  const u = new SpeechSynthesisUtterance(text);
  const voices = speechSynthesis.getVoices();
  const ausMale = voices.find(v => 
    v.lang.includes("en-AU") && 
    /male|daniel|james|liam/i.test(v.name)
  ) || voices.find(v => v.lang.includes("en-AU"));

  if (ausMale) u.voice = ausMale;
  u.lang = "en-AU";
  u.rate = 0.94;
  u.pitch = 1.0;
  speechSynthesis.speak(u);
}

speechSynthesis.onvoiceschanged = () => {};

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// VOICE RECOGNITION + HOTWORD
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function initRecognition() {
  const SpeechRec = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SpeechRec) {
    status.textContent = "Voice recognition not supported in this browser.";
    return;
  }

  recognition = new SpeechRec();
  recognition.continuous = true;
  recognition.interimResults = false;
  recognition.lang = "en-US";

  recognition.onresult = (e) => {
    const text = e.results[e.resultIndex][0].transcript.trim().toLowerCase();
    const triggers = ["hey indy", "hi indy", "hello indy", "indy"];

    for (const trigger of triggers) {
      if (text.startsWith(trigger)) {
        const message = text.slice(trigger.length).trim();
        if (message) {
          addMessage("user", message);
          processUserMessage(message);
        } else {
          status.textContent = "Listening... what's up?";
        }
        return;
      }
    }

    if (isListening) {
      addMessage("user", text);
      processUserMessage(text);
    }
  };

  recognition.onerror = () => {
    micBtn.classList.remove("listening");
    isListening = false;
    status.textContent = "Voice error. Try again.";
  };

  recognition.onend = () => {
    if (isListening) recognition.start();
    else micBtn.classList.remove("listening");
  };
}

document.getElementById("micBtn").onclick = () => {
  if (!recognition) initRecognition();
  if (!recognition) return;

  if (isListening) {
    recognition.stop();
    isListening = false;
    micBtn.classList.remove("listening");
    status.textContent = "Voice stopped.";
  } else {
    recognition.start();
    isListening = true;
    micBtn.classList.add("listening");
    status.textContent = "Listening... say 'Hey Indy' + message";
  }
};

document.getElementById("userInput").addEventListener("keypress", e => {
  if (e.key === "Enter") {
    e.preventDefault();
    const msg = e.target.value.trim();
    if (msg) {
      addMessage("user", msg);
      processUserMessage(msg);
      e.target.value = "";
    }
  }
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// AI CALL
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function processUserMessage(message) {
  if (!profile) {
    addMessage("ai", "Please set up your profile first.");
    return;
  }

  const prompt = SYSTEM_PROMPT_TEMPLATE
    .replace("{name}", profile.name)
    .replace("{language}", profile.language)
    .replace("{level}", profile.level)
    + "\n\nUser: " + message + "\nIndy:";

  status.textContent = "Indy is thinking...";

  try {
    const res = await fetch(API_URL + encodeURIComponent(prompt));
    let reply = (await res.text()).trim();

    addMessage("ai", reply);
    speak(reply);
    status.textContent = "Ready for your next message.";
  } catch (err) {
    addMessage("ai", "Sorryâ€¦ something went wrong. Try again?");
    status.textContent = "Connection issue.";
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// EVENT LISTENERS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

document.getElementById("saveProfileBtn").onclick = () => {
  if (saveProfile()) {
    hideModal();
    editBtn.style.display = "block";
    inputArea.style.display = "flex";
    addMessage("ai", `Great! Hi ${profile.name} â€” let's start learning ${profile.language}! What would you like to practice today?`);
    speak(`Great! Hi ${profile.name}. Let's start learning ${profile.language}!`);
    status.textContent = "Ready when you are.";
  }
};

editBtn.onclick = () => showModal(true);

// Start the app
initializeApp();

</script>
</body>
</html>
