<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>INDY AI</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600&family=IBM+Plex+Sans:wght@400;500;600&display=swap" rel="stylesheet">
<style>
/* ‚ïê‚ïê‚ïê THEME VARS ‚ïê‚ïê‚ïê */
:root {
  --bg:#080808;--bg-e:#101010;--bg-c:#161616;
  --tx:#f0f0f0;--tx-s:#8a8a8a;--tx-t:#4a4a4a;--tx-d:#2e2e2e;
  --br:rgba(255,255,255,0.07);--br-s:rgba(255,255,255,0.12);--br-f:rgba(255,255,255,0.25);
  --hv:rgba(255,255,255,0.04);--ac:rgba(255,255,255,0.07);
  --accent:#c8c8ff;--accent-d:rgba(200,200,255,0.12);
  --green:#50e896;--red:#e05050;--orange:#f0a050;
  --font:'IBM Plex Sans',system-ui,sans-serif;
  --mono:'IBM Plex Mono',monospace;
  --rsm:6px;--rmd:10px;--rlg:14px;--rxl:20px;
}
[data-theme="light"]{
  --bg:#f2f2ee;--bg-e:#e8e8e4;--bg-c:#dededa;
  --tx:#111;--tx-s:#555;--tx-t:#999;--tx-d:#ccc;
  --br:rgba(0,0,0,0.07);--br-s:rgba(0,0,0,0.13);--br-f:rgba(0,0,0,0.28);
  --hv:rgba(0,0,0,0.04);--ac:rgba(0,0,0,0.07);
  --accent:#4040aa;--accent-d:rgba(64,64,170,0.1);
}
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box;}
html,body{height:100%;}
body{background:var(--bg);color:var(--tx);font-family:var(--font);font-size:14px;line-height:1.6;display:flex;overflow:hidden;transition:background .3s,color .3s;background-image:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(128,128,128,0.01) 2px,rgba(128,128,128,0.01) 4px);}

/* ‚ïê‚ïê‚ïê SIDEBAR ‚ïê‚ïê‚ïê */
.sidebar{position:fixed;inset:0 auto 0 0;width:260px;background:var(--bg-e);border-right:1px solid var(--br);display:flex;flex-direction:column;transition:width .3s cubic-bezier(.4,0,.2,1);z-index:100;overflow:hidden;}
.sidebar.collapsed{width:60px;}
.header{padding:16px;display:flex;align-items:center;gap:12px;min-height:64px;flex-shrink:0;border-bottom:1px solid var(--br);}
.menu-btn{background:transparent;border:1px solid transparent;color:var(--tx-s);font-size:18px;cursor:pointer;padding:8px;border-radius:var(--rsm);transition:all .15s;display:flex;align-items:center;justify-content:center;flex-shrink:0;}
.menu-btn:hover{background:var(--hv);border-color:var(--br-s);color:var(--tx);}
.app-title{font-family:var(--mono);font-size:15px;font-weight:600;letter-spacing:.08em;color:var(--tx);white-space:nowrap;text-transform:uppercase;transition:opacity .2s;}
.sidebar.collapsed .app-title{opacity:0;pointer-events:none;}
.sidebar-content{flex:1;padding:10px;overflow-y:auto;overflow-x:hidden;padding-bottom:90px;}
.sidebar-content::-webkit-scrollbar{width:4px;}
.sidebar-content::-webkit-scrollbar-thumb{background:var(--br-s);border-radius:999px;}
.sidebar.collapsed .sidebar-content>*:not(#chatList){display:none;}
.sidebar.collapsed hr{display:none;}
.sb{width:100%;min-height:40px;background:transparent;border:1px solid transparent;border-radius:var(--rsm);color:var(--tx-s);font-size:13px;font-family:var(--font);font-weight:500;cursor:pointer;transition:all .15s;display:flex;align-items:center;padding:0 12px;gap:10px;margin-bottom:2px;position:relative;}
.sb::before{content:attr(data-icon);font-size:14px;opacity:.7;flex-shrink:0;font-family:var(--mono);width:18px;text-align:center;}
.sb span{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;transition:opacity .2s;}
.sidebar.collapsed .sb span{opacity:0;pointer-events:none;}
.sidebar.collapsed .sb{justify-content:center;padding:0;}
.sidebar.collapsed .sb::before{width:auto;}
.sb:hover{background:var(--hv);border-color:var(--br);color:var(--tx);}
.sb.danger{color:var(--red);}
.sb.danger:hover{background:rgba(224,80,80,.08);border-color:rgba(224,80,80,.2);color:#ff7070;}
.sb.tog-on{color:var(--accent);background:var(--accent-d);border-color:rgba(200,200,255,.2);}
hr{border:none;border-top:1px solid var(--br);margin:8px 0;}
#chatList .sb{justify-content:space-between;padding-right:8px;}
#chatList .sb::before{content:'‚Äî';font-size:11px;color:var(--tx-d);}
#chatList .sb .cn{flex:1;text-align:left;overflow:hidden;text-overflow:ellipsis;}
#chatList .sb .dx{opacity:0;color:var(--red);font-size:14px;padding:3px 7px;border-radius:var(--rsm);background:transparent;border:none;cursor:pointer;font-family:var(--mono);transition:all .15s;flex-shrink:0;}
#chatList .sb:hover .dx{opacity:.6;}
#chatList .sb .dx:hover{opacity:1;background:rgba(224,80,80,.12);}
.profile-footer{position:absolute;bottom:0;left:0;right:0;padding:12px 14px;border-top:1px solid var(--br);display:flex;align-items:center;gap:10px;background:var(--bg-e);cursor:pointer;transition:background .15s;}
.profile-footer:hover{background:var(--hv);}
.sidebar.collapsed .profile-footer{padding:12px 0;justify-content:center;}
.pf-avatar{width:32px;height:32px;border-radius:var(--rsm);background:var(--bg-c);background-size:cover;background-position:center;border:1px solid var(--br-s);flex-shrink:0;}
.pf-info{flex:1;overflow:hidden;}
.sidebar.collapsed .pf-info{display:none;}
.pf-name{font-size:13px;font-weight:500;color:var(--tx-s);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;display:block;font-family:var(--mono);}

/* ‚ïê‚ïê‚ïê MAIN ‚ïê‚ïê‚ïê */
.main{flex:1;margin-left:260px;display:flex;flex-direction:column;transition:margin-left .3s cubic-bezier(.4,0,.2,1);height:100vh;}
.sidebar.collapsed~.main{margin-left:60px;}

/* ‚ïê‚ïê‚ïê STATUS BAR ‚ïê‚ïê‚ïê */
.status-bar{height:30px;background:var(--bg-e);border-bottom:1px solid var(--br);display:flex;align-items:center;padding:0 16px;gap:18px;flex-shrink:0;overflow:hidden;}
.s-item{display:flex;align-items:center;gap:5px;font-family:var(--mono);font-size:10px;color:var(--tx-t);letter-spacing:.05em;white-space:nowrap;cursor:default;}
.s-dot{width:5px;height:5px;border-radius:50%;background:var(--tx-d);flex-shrink:0;}
.s-dot.on{background:var(--green);box-shadow:0 0 4px var(--green);}
.s-dot.warn{background:var(--orange);}
.s-spacer{flex:1;}

/* ‚ïê‚ïê‚ïê CHAT ‚ïê‚ïê‚ïê */
.chat-container{flex:1;overflow-y:auto;padding:32px 28px 150px;display:flex;flex-direction:column;gap:18px;max-width:900px;width:100%;margin:0 auto;align-self:center;}
.chat-container::-webkit-scrollbar{width:5px;}
.chat-container::-webkit-scrollbar-thumb{background:var(--br-s);border-radius:999px;}
.message{max-width:80%;animation:msgIn .2s cubic-bezier(.2,.8,.4,1);}
@keyframes msgIn{from{opacity:0;transform:translateY(5px)}to{opacity:1;transform:translateY(0)}}
.user{align-self:flex-end;}
.bot{align-self:flex-start;}
.bubble{padding:11px 15px;border-radius:var(--rlg);line-height:1.65;font-size:14px;position:relative;}
.user .bubble{background:var(--bg-c);border:1px solid var(--br-s);border-bottom-right-radius:var(--rsm);}
.bot .bubble{background:transparent;border:none;padding:0;}
.ts{display:none;font-family:var(--mono);font-size:10px;color:var(--tx-t);letter-spacing:.04em;margin-top:5px;text-align:right;}
.user:hover .ts,.bot:hover .ts{display:block;}
.copy-btn{position:absolute;top:-4px;right:0;background:var(--bg-c);border:1px solid var(--br);color:var(--tx-t);font-size:11px;font-family:var(--mono);padding:4px 8px;border-radius:var(--rsm);cursor:pointer;opacity:0;transition:all .15s;text-transform:uppercase;letter-spacing:.04em;}
.bot:hover .copy-btn{opacity:1;}
.copy-btn:hover{background:var(--hv);border-color:var(--br-s);color:var(--tx-s);}
.reaction-row{display:flex;gap:4px;margin-top:8px;opacity:0;transition:opacity .15s;}
.bot:hover .reaction-row{opacity:1;}
.rxn{background:transparent;border:1px solid transparent;color:var(--tx-d);font-size:13px;padding:3px 7px;border-radius:var(--rsm);cursor:pointer;font-family:var(--mono);transition:all .12s;}
.rxn:hover{background:var(--hv);border-color:var(--br);color:var(--tx-s);}
.rxn.on{background:var(--accent-d);border-color:var(--accent);color:var(--accent);}
.tts-btn{background:transparent;border:1px solid transparent;color:var(--tx-d);font-size:12px;padding:3px 7px;border-radius:var(--rsm);cursor:pointer;font-family:var(--mono);transition:all .12s;}
.tts-btn:hover{background:var(--hv);border-color:var(--br);color:var(--tx-s);}
.tts-btn.speaking{color:var(--green);border-color:var(--green);background:rgba(80,232,150,.08);}

/* ‚ïê‚ïê‚ïê MARKDOWN IN BOT BUBBLES ‚ïê‚ïê‚ïê */
.bot .bubble h1,.bot .bubble h2,.bot .bubble h3{font-family:var(--mono);font-weight:600;margin:14px 0 6px;color:var(--tx);letter-spacing:.02em;}
.bot .bubble h1{font-size:18px;}
.bot .bubble h2{font-size:16px;}
.bot .bubble h3{font-size:14px;color:var(--tx-s);}
.bot .bubble p{margin:6px 0;}
.bot .bubble ul,.bot .bubble ol{padding-left:20px;margin:6px 0;}
.bot .bubble li{margin:3px 0;}
.bot .bubble strong{color:var(--tx);font-weight:600;}
.bot .bubble em{color:var(--tx-s);font-style:italic;}
.bot .bubble blockquote{border-left:2px solid var(--br-s);padding-left:12px;color:var(--tx-s);margin:8px 0;font-style:italic;}
.bot .bubble a{color:var(--accent);text-decoration:underline;text-decoration-color:rgba(200,200,255,.4);}
.bot .bubble hr{border:none;border-top:1px solid var(--br);margin:12px 0;}
.bot .bubble table{border-collapse:collapse;width:100%;margin:10px 0;font-size:13px;}
.bot .bubble th{background:var(--bg-c);border:1px solid var(--br-s);padding:7px 12px;text-align:left;font-family:var(--mono);font-size:11px;letter-spacing:.06em;text-transform:uppercase;color:var(--tx-t);}
.bot .bubble td{border:1px solid var(--br);padding:7px 12px;color:var(--tx-s);}
.bot .bubble tr:hover td{background:var(--hv);}
.bot .bubble code:not(.hlcode){background:var(--bg-c);border:1px solid var(--br);padding:1px 5px;border-radius:4px;font-family:var(--mono);font-size:12.5px;color:var(--accent);}

/* ‚ïê‚ïê‚ïê CODE BLOCKS ‚ïê‚ïê‚ïê */
.ib-wrap{margin:12px 0;border:1px solid var(--br);border-radius:var(--rmd);overflow:hidden;background:var(--bg-e);}
.ib-head{display:flex;justify-content:space-between;align-items:center;padding:7px 14px;background:rgba(128,128,128,.04);border-bottom:1px solid var(--br);font-size:11px;color:var(--tx-t);font-family:var(--mono);}
.ib-copy{background:transparent;border:1px solid var(--br);color:var(--tx-t);font-size:11px;padding:3px 9px;border-radius:4px;cursor:pointer;transition:all .13s;}
.ib-copy:hover{background:var(--hv);border-color:var(--br-s);color:var(--tx-s);}
.ib-pre{margin:0;padding:14px 16px;overflow-x:auto;line-height:1.55;font-family:var(--mono);font-size:13px;}
.ib-pre code{white-space:pre;}

/* ‚ïê‚ïê‚ïê THINKING ‚ïê‚ïê‚ïê */
.thinking{display:inline-flex;align-items:center;gap:10px;padding:6px 0;color:var(--tx-t);font-size:13px;font-family:var(--mono);}
.think-star{font-size:16px;animation:spin 1.8s linear infinite;color:var(--tx-s);}
@keyframes spin{0%{transform:rotate(0deg);opacity:.4}50%{transform:rotate(180deg);opacity:.9}100%{transform:rotate(360deg);opacity:.4}}
.think-txt{animation:pulse 1.8s ease-in-out infinite;}
@keyframes pulse{0%,100%{opacity:.3}50%{opacity:.8}}

/* ‚ïê‚ïê‚ïê INPUT AREA ‚ïê‚ïê‚ïê */
.input-area{padding:14px 22px 18px;background:var(--bg);border-top:1px solid var(--br);position:fixed;bottom:0;left:260px;right:0;z-index:10;transition:left .3s cubic-bezier(.4,0,.2,1);}
.sidebar.collapsed~.main .input-area{left:60px;}
.input-wrapper{max-width:820px;margin:0 auto;display:flex;gap:8px;align-items:flex-end;background:var(--bg-c);border:1px solid var(--br-s);border-radius:var(--rlg);padding:6px 6px 6px 14px;transition:border-color .2s;}
.input-wrapper:focus-within{border-color:var(--br-f);}
.input-left{display:flex;align-items:center;gap:6px;flex-shrink:0;}
.icon-btn{height:32px;min-width:32px;background:transparent;border:1px solid transparent;color:var(--tx-t);font-size:14px;font-family:var(--mono);cursor:pointer;border-radius:var(--rsm);display:flex;align-items:center;justify-content:center;transition:all .15s;padding:0 8px;gap:5px;white-space:nowrap;}
.icon-btn:hover{background:var(--hv);border-color:var(--br);color:var(--tx-s);}
.icon-btn.on{color:var(--accent);border-color:var(--accent);background:var(--accent-d);}
.icon-btn.mic-on{color:var(--red);border-color:var(--red);background:rgba(224,80,80,.08);animation:micPulse 1s ease infinite;}
@keyframes micPulse{0%,100%{box-shadow:0 0 0 0 rgba(224,80,80,.4)}50%{box-shadow:0 0 0 4px rgba(224,80,80,.1)}}
#userInput{flex:1;background:transparent;border:none;color:var(--tx);font-size:14px;font-family:var(--font);outline:none;caret-color:var(--accent);resize:none;overflow-y:hidden;max-height:120px;line-height:1.5;padding:7px 0;}
#userInput::placeholder{color:var(--tx-t);font-family:var(--mono);font-size:13px;}
.char-cnt{font-family:var(--mono);font-size:10px;color:var(--tx-d);flex-shrink:0;user-select:none;transition:color .2s;align-self:center;}
.char-cnt.warn{color:var(--orange);}
.char-cnt.over{color:var(--red);}
.send-btn{width:34px;height:34px;background:var(--tx);color:var(--bg);border:none;border-radius:var(--rsm);font-size:16px;cursor:pointer;transition:all .15s;display:flex;align-items:center;justify-content:center;flex-shrink:0;align-self:flex-end;}
.send-btn:hover{background:#fff;transform:scale(1.04);}
.send-btn:active{transform:scale(.95);}

/* ‚ïê‚ïê‚ïê FILE DROP OVERLAY ‚ïê‚ïê‚ïê */
.drop-overlay{position:fixed;inset:0;background:rgba(0,0,0,.85);backdrop-filter:blur(12px);z-index:5000;display:none;align-items:center;justify-content:center;flex-direction:column;gap:16px;border:2px dashed var(--accent);pointer-events:none;}
.drop-overlay.active{display:flex;}
.drop-icon{font-size:56px;animation:bounce .8s ease infinite alternate;}
@keyframes bounce{from{transform:translateY(0)}to{transform:translateY(-8px)}}
.drop-text{font-family:var(--mono);font-size:18px;color:var(--accent);letter-spacing:.06em;}

/* ‚ïê‚ïê‚ïê MODEL POPOVER ‚ïê‚ïê‚ïê */
.model-pop{position:absolute;bottom:78px;left:20px;background:var(--bg-c);border:1px solid var(--br-s);border-radius:var(--rlg);box-shadow:0 8px 32px rgba(0,0,0,.6);width:240px;overflow:hidden;z-index:90;opacity:0;visibility:hidden;transform:translateY(8px);transition:all .2s cubic-bezier(.2,.8,.4,1);}
.model-pop.open{opacity:1;visibility:visible;transform:translateY(0);}
.mpop-head{padding:10px 14px;font-size:10px;font-family:var(--mono);font-weight:600;letter-spacing:.1em;text-transform:uppercase;color:var(--tx-t);border-bottom:1px solid var(--br);}
.mitem{width:100%;padding:10px 14px;background:transparent;border:none;text-align:left;color:var(--tx-s);font-size:13px;font-family:var(--font);cursor:pointer;transition:all .12s;position:relative;}
.mitem:hover{background:var(--hv);color:var(--tx);}
.mitem.sel{color:var(--accent);background:var(--accent-d);font-weight:500;}
.mitem.sel::after{content:'‚úì';position:absolute;right:14px;color:var(--accent);font-size:12px;font-family:var(--mono);}
.mpop-foot{padding:8px 14px;font-size:11px;font-family:var(--mono);color:var(--tx-d);text-align:center;border-top:1px solid var(--br);}

/* ‚ïê‚ïê‚ïê MODALS ‚ïê‚ïê‚ïê */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.82);backdrop-filter:blur(12px);display:none;align-items:center;justify-content:center;z-index:1000;}
.modal.open{display:flex;animation:mFadeIn .2s ease;}
@keyframes mFadeIn{from{opacity:0}to{opacity:1}}
.modal-box{background:var(--bg-c);border:1px solid var(--br-s);border-radius:var(--rxl);padding:28px;max-width:500px;width:90%;box-shadow:0 24px 64px rgba(0,0,0,.6);position:relative;animation:mSlideIn .25s cubic-bezier(.2,.8,.4,1);}
@keyframes mSlideIn{from{transform:scale(.96) translateY(14px);opacity:0}to{transform:scale(1) translateY(0);opacity:1}}
.modal-box h2{font-family:var(--mono);font-size:17px;font-weight:600;letter-spacing:.05em;text-transform:uppercase;margin-bottom:22px;}
.close-x{position:absolute;top:18px;right:18px;background:var(--bg-e);border:1px solid var(--br);color:var(--tx-s);font-size:18px;cursor:pointer;width:32px;height:32px;border-radius:var(--rsm);display:flex;align-items:center;justify-content:center;transition:all .15s;font-family:var(--mono);}
.close-x:hover{background:var(--hv);border-color:var(--br-s);color:var(--tx);}
.field{margin-bottom:16px;}
.field label{display:block;margin-bottom:6px;color:var(--tx-t);font-size:11px;font-family:var(--mono);font-weight:500;letter-spacing:.08em;text-transform:uppercase;}
.field input,.field textarea,.field select{width:100%;background:var(--bg-e);border:1px solid var(--br);border-radius:var(--rsm);padding:10px 13px;color:var(--tx);font-size:13.5px;font-family:var(--font);transition:border-color .15s;resize:vertical;}
.field input:focus,.field textarea:focus,.field select:focus{outline:none;border-color:var(--br-f);background:var(--bg);}
.field textarea{min-height:90px;}
.field input::placeholder,.field textarea::placeholder{color:var(--tx-t);font-family:var(--mono);font-size:12.5px;}
.submit-btn{width:100%;background:var(--tx);color:var(--bg);border:none;border-radius:var(--rsm);padding:12px;font-size:13px;font-family:var(--mono);font-weight:600;letter-spacing:.06em;text-transform:uppercase;cursor:pointer;transition:all .15s;margin-top:4px;}
.submit-btn:hover{background:#fff;transform:scale(1.01);}
.submit-btn:active{transform:scale(.98);}
.submit-btn.secondary{background:transparent;color:var(--tx-s);border:1px solid var(--br-s);margin-top:8px;}
.submit-btn.secondary:hover{background:var(--hv);color:var(--tx);transform:none;}

/* ‚ïê‚ïê‚ïê PINNED BADGE ‚ïê‚ïê‚ïê */
.pin-badge{display:inline-block;font-family:var(--mono);font-size:9px;letter-spacing:.08em;text-transform:uppercase;color:var(--accent);background:var(--accent-d);border:1px solid rgba(200,200,255,.2);padding:2px 6px;border-radius:4px;margin-bottom:6px;}

/* ‚ïê‚ïê‚ïê STREAK BADGE ‚ïê‚ïê‚ïê */
.streak-badge{display:flex;align-items:center;gap:5px;font-family:var(--mono);font-size:12px;color:var(--orange);padding:3px 8px;border-radius:var(--r-pill);background:rgba(240,160,80,.1);border:1px solid rgba(240,160,80,.25);}

/* ‚ïê‚ïê‚ïê TEMPLATE CHIPS ‚ïê‚ïê‚ïê */
.tmpl-chip{background:var(--bg-e);border:1px solid var(--br);border-radius:var(--rsm);color:var(--tx-s);font-size:12px;font-family:var(--mono);padding:6px 11px;cursor:pointer;transition:all .15s;display:flex;align-items:center;gap:6px;}
.tmpl-chip:hover{border-color:var(--br-s);color:var(--tx);background:var(--hv);}
.tmpl-chip .del-tmpl{opacity:0;color:var(--red);font-size:12px;margin-left:auto;background:transparent;border:none;cursor:pointer;}
.tmpl-chip:hover .del-tmpl{opacity:.7;}

/* ‚ïê‚ïê‚ïê SHORTCUTS MODAL ‚ïê‚ïê‚ïê */
.shortcut-row{display:flex;align-items:center;justify-content:space-between;padding:9px 0;border-bottom:1px solid var(--br);}
.shortcut-row:last-child{border-bottom:none;}
.shortcut-desc{font-size:13px;color:var(--tx-s);}
.shortcut-keys{display:flex;gap:4px;}
.kbd{background:var(--bg-e);border:1px solid var(--br-s);border-radius:4px;padding:2px 8px;font-family:var(--mono);font-size:11px;color:var(--tx-t);}

/* ‚ïê‚ïê‚ïê SUMMARY OUTPUT ‚ïê‚ïê‚ïê */
.summary-out{background:var(--bg-e);border:1px solid var(--br);border-radius:var(--rmd);padding:14px 16px;min-height:80px;max-height:280px;overflow-y:auto;font-size:13px;color:var(--tx-s);line-height:1.65;font-family:var(--font);}

/* ‚ïê‚ïê‚ïê TOKEN BAR ‚ïê‚ïê‚ïê */
.token-bar{height:3px;background:var(--br-s);border-radius:2px;overflow:hidden;margin-top:4px;}
.token-fill{height:100%;background:var(--accent);border-radius:2px;transition:width .4s ease;}
.token-fill.warn{background:var(--orange);}
.token-fill.over{background:var(--red);}

/* ‚ïê‚ïê‚ïê STARTER CHIPS ‚ïê‚ïê‚ïê */
#starterChips{align-self:flex-start;display:flex;flex-wrap:wrap;gap:8px;max-width:100%;animation:msgIn .3s ease;}

/* ‚ïê‚ïê‚ïê PROFILE PREVIEW ‚ïê‚ïê‚ïê */
#profilePreview{width:80px;height:80px;border-radius:var(--rsm);background:var(--bg-e);background-size:cover;background-position:center;border:1px solid var(--br-s);}
#codeOutput{background:var(--bg-e);border:1px solid var(--br);border-radius:var(--rsm);padding:14px;min-height:90px;max-height:200px;overflow-y:auto;color:var(--tx-s);font-size:12.5px;font-family:var(--mono);line-height:1.6;}

/* ‚ïê‚ïê‚ïê CREATIVE MODE GLOW ‚ïê‚ïê‚ïê */
.icon-btn#creativeBtn.on{color:var(--orange);border-color:var(--orange);background:rgba(240,160,80,0.12);box-shadow:0 0 8px rgba(240,160,80,0.25);}
body.creative-active .chat-container{background-image:radial-gradient(ellipse at 20% 50%,rgba(200,200,255,0.015) 0%,transparent 60%),radial-gradient(ellipse at 80% 20%,rgba(240,160,80,0.015) 0%,transparent 60%);}
body.creative-active .bot .bubble{border-left:2px solid rgba(200,200,255,0.15);padding-left:8px;}

/* ‚ïê‚ïê‚ïê FOCUS MODE ‚ïê‚ïê‚ïê */
body.focus-active .status-bar{display:none;}
body.focus-active .input-area{border-top-color:transparent;}

/* ‚ïê‚ïê‚ïê IMG GEN WRAP ‚ïê‚ïê‚ïê */
.img-gen-wrap{position:relative;min-height:60px;}

/* ‚ïê‚ïê‚ïê SMART REPLIES ‚ïê‚ïê‚ïê */
#smartReplies{align-self:flex-start;display:flex;flex-wrap:wrap;gap:8px;max-width:100%;padding-bottom:4px;}
#smartReplies button:hover{border-color:var(--br-s);color:var(--tx-s);}

/* ‚ïê‚ïê‚ïê ENHANCED MODEL POPOVER ‚ïê‚ïê‚ïê */
.mitem-badge{display:inline-block;font-size:10px;font-family:var(--mono);padding:2px 6px;border-radius:4px;margin-left:6px;vertical-align:middle;}
.mitem-badge.new{background:rgba(80,232,150,0.15);color:var(--green);border:1px solid rgba(80,232,150,0.25);}
.mitem-badge.fast{background:rgba(200,200,255,0.12);color:var(--accent);border:1px solid rgba(200,200,255,0.2);}
.mitem-badge.creative{background:rgba(240,160,80,0.12);color:var(--orange);border:1px solid rgba(240,160,80,0.2);}
.mitem sub{font-size:10px;color:var(--tx-d);display:block;margin-top:1px;font-family:var(--mono);}

/* ‚ïê‚ïê‚ïê TYPING INDICATOR ENHANCED ‚ïê‚ïê‚ïê */
.thinking{position:relative;}
.thinking::after{content:'';position:absolute;bottom:-1px;left:0;width:0;height:1px;background:var(--accent);animation:thinkLine 1.8s ease-in-out infinite;}
@keyframes thinkLine{0%{width:0;opacity:.8}70%{width:100%}100%{width:100%;opacity:0}}
</style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê SIDEBAR ‚ïê‚ïê‚ïê -->
<div class="sidebar collapsed" id="sidebar">
  <div class="header">
    <button class="menu-btn" onclick="toggleSidebar()">‚ò∞</button>
    <div class="app-title">INDY ‚ú¶</div>
  </div>
  <div class="sidebar-content">
    <button class="sb" data-icon="+" onclick="newChat()"><span>New Chat</span></button>
    <button class="sb" data-icon="‚åï" onclick="openSearch()"><span>Search</span></button>
    <button class="sb" data-icon="üìå" onclick="openPinned()"><span>Pinned</span></button>
    <button class="sb" data-icon="‚Ä¢‚Ä¢‚Ä¢" onclick="openToolsMenu()"><span>Tools</span></button>
    <hr>
    <div id="chatList"></div>
  </div>
  <div class="profile-footer" id="profileFooter">
    <div class="pf-avatar" id="sidebarAvatar"></div>
    <div class="pf-info">
      <span class="pf-name" id="sidebarName">Guest</span>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê MAIN ‚ïê‚ïê‚ïê -->
<div class="main">
  <!-- Status bar -->
  <div class="status-bar">
    <div class="s-item"><div class="s-dot on" id="statusDot"></div><span id="statusModel">Indy Sunshine</span></div>
    <div class="s-item" id="statusTokens">0 tokens</div>
    <div class="s-item" id="statusStreak"></div>
    <div class="s-item" id="statusCreative" style="display:none;cursor:pointer;color:var(--orange);" onclick="toggleCreativeMode()">‚ú¶ Creative</div>
    <div class="s-item" id="statusWebMode" style="cursor:pointer;display:none;" onclick="toggleWebMode()">üåê Web mode</div>
    <div class="s-item" id="statusWordCount" style="display:none;"></div>
    <div class="s-spacer"></div>
    <div class="s-item" style="gap:4px;">
      <button id="creativeBtnSb" onclick="toggleCreativeMode()" title="Creative Mode" style="background:transparent;border:1px solid transparent;color:var(--tx-t);cursor:pointer;font-size:13px;font-family:var(--mono);padding:2px 7px;border-radius:4px;transition:all .15s;line-height:1.6;" onmouseover="this.style.borderColor='var(--br-s)'" onmouseout="this.style.borderColor='transparent'">‚ú¶</button>
      <button id="focusBtnSb" onclick="toggleFocusMode()" title="Focus Mode" style="background:transparent;border:1px solid transparent;color:var(--tx-t);cursor:pointer;font-size:13px;font-family:var(--mono);padding:2px 7px;border-radius:4px;transition:all .15s;line-height:1.6;" onmouseover="this.style.borderColor='var(--br-s)'" onmouseout="this.style.borderColor='transparent'">‚óé</button>
      <button id="musicBtnSb" onclick="toggleMusicPlayer()" title="Music Player" style="background:transparent;border:1px solid transparent;color:var(--tx-t);cursor:pointer;font-size:13px;font-family:var(--mono);padding:2px 7px;border-radius:4px;transition:all .15s;line-height:1.6;" onmouseover="this.style.borderColor='var(--br-s)'" onmouseout="this.style.borderColor='transparent'">üéµ</button>
      <span style="color:var(--tx-d);">|</span>
      <button onclick="toggleTheme()" style="background:transparent;border:none;color:var(--tx-t);cursor:pointer;font-size:12px;font-family:var(--mono);padding:2px 6px;border-radius:4px;transition:all .15s;" id="themeToggleBtn">‚òÄ Light</button>
      <span style="color:var(--tx-d);">|</span>
      <button onclick="openShortcuts()" style="background:transparent;border:none;color:var(--tx-t);cursor:pointer;font-size:12px;font-family:var(--mono);padding:2px 6px;border-radius:4px;transition:all .15s;">? Keys</button>
      <span style="color:var(--tx-d);">|</span>
      <button onclick="openToolsMenu()" style="background:transparent;border:none;color:var(--tx-t);cursor:pointer;font-size:12px;font-family:var(--mono);padding:2px 6px;border-radius:4px;transition:all .15s;" title="Tools & Settings">‚öô Tools</button>
    </div>
  </div>

  <!-- Chat messages -->
  <div class="chat-container" id="chatMessages">
    <div class="message bot">
      <div class="bubble">Howdy ü§†! I'm Indy!<br>What can I help you with today?</div>
    </div>
  </div>

  <!-- Input area -->
  <div class="input-area">
    <div class="input-wrapper" id="inputWrapper">
      <div class="input-left">
        <button class="icon-btn" id="modelBtn" title="Select Model" onclick="toggleModelPop()" style="font-size:15px;padding:0 8px;">‚õ≠</button>
        <button class="icon-btn" id="webBtn" title="Web Search Mode ‚Äî Indy will search DuckDuckGo" onclick="toggleWebMode()" style="font-size:15px;">üåê</button>

        <div id="inputDivider" style="width:1px;height:18px;background:var(--br-s);margin:0 2px;align-self:center;"></div>
        <button class="icon-btn" id="attachBtn" title="Attach file" onclick="document.getElementById('fileInput').click()" style="font-size:15px;">üìé</button>
        <input type="file" id="fileInput" accept=".txt,.md,.csv,.json,.html,.js,.py,.ts,.css,.xml" style="display:none;" onchange="handleFileInput(this)">
      </div>
      <textarea id="userInput" placeholder="Ask anything‚Ä¶ (Shift+Enter for new line)" rows="1"></textarea>
      <span class="char-cnt" id="charCnt"></span>
      <button class="send-btn" onclick="sendMessage()">‚Üë</button>
    </div>
    <div class="model-pop" id="modelPop">
      <div class="mpop-head">Select Model</div>
      <button class="mitem sel" data-model="Indy Sunshine 1.0 Beta">Indy Sunshine 1.0 Beta<sub>Balanced ¬∑ Great all-rounder</sub></button>
      <button class="mitem" data-model="Sunshine Pro">Sunshine Pro<sub>Empathy ¬∑ Relationships ¬∑ Advice</sub></button>
      <button class="mitem" data-model="Indy 3">Indy 3 <span class="mitem-badge fast">FAST</span><sub>Speed-optimized ¬∑ Short & crisp</sub></button>
      <button class="mitem" data-model="Creative Studio">Creative Studio <span class="mitem-badge creative">‚ú¶</span><sub>Art ¬∑ Story ¬∑ Humor ¬∑ Ideas</sub></button>
      <button class="mitem" data-model="Code Assistant">Code Assistant<sub>Debugging ¬∑ Architecture ¬∑ Code</sub></button>
      <button class="mitem" data-model="Dart 1w">Dart 1w <span class="mitem-badge new">MUSIC</span><sub>Music recommendations ¬∑ Vibes</sub></button>
      <div class="mpop-foot">Tip: ‚ú¶ Creative Mode works with any model</div>
    </div>
  </div>
</div>

<!-- Stats Modal -->
<div class="modal" id="statsModal">
  <div class="modal-box" style="max-width:480px;">
    <button class="close-x" onclick="closeModal('statsModal')">√ó</button>
    <h2>üìä Session Stats</h2>
    <div id="statsContent" style="display:flex;flex-direction:column;gap:12px;margin-top:8px;"></div>
  </div>
</div>

<!-- Theme Picker Modal -->
<div class="modal" id="themeModal">
  <div class="modal-box" style="max-width:420px;">
    <button class="close-x" onclick="closeModal('themeModal')">√ó</button>
    <h2>üé® Theme & Accent</h2>
    <div class="field"><label>Accent Color</label>
      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:6px;" id="accentPicker">
        <button onclick="setAccent('purple')" style="width:36px;height:36px;border-radius:50%;background:#c8c8ff;border:2px solid transparent;cursor:pointer;transition:all .15s;" title="Purple" data-accent="purple"></button>
        <button onclick="setAccent('cyan')" style="width:36px;height:36px;border-radius:50%;background:#50e8e8;border:2px solid transparent;cursor:pointer;transition:all .15s;" title="Cyan" data-accent="cyan"></button>
        <button onclick="setAccent('green')" style="width:36px;height:36px;border-radius:50%;background:#50e896;border:2px solid transparent;cursor:pointer;transition:all .15s;" title="Green" data-accent="green"></button>
        <button onclick="setAccent('orange')" style="width:36px;height:36px;border-radius:50%;background:#f0a050;border:2px solid transparent;cursor:pointer;transition:all .15s;" title="Orange" data-accent="orange"></button>
        <button onclick="setAccent('pink')" style="width:36px;height:36px;border-radius:50%;background:#ff80bf;border:2px solid transparent;cursor:pointer;transition:all .15s;" title="Pink" data-accent="pink"></button>
        <button onclick="setAccent('red')" style="width:36px;height:36px;border-radius:50%;background:#e05050;border:2px solid transparent;cursor:pointer;transition:all .15s;" title="Red" data-accent="red"></button>
        <button onclick="setAccent('white')" style="width:36px;height:36px;border-radius:50%;background:#f0f0f0;border:2px solid transparent;cursor:pointer;transition:all .15s;" title="White" data-accent="white"></button>
      </div>
    </div>
    <div class="field"><label>Font Size</label>
      <div style="display:flex;gap:8px;">
        <button onclick="setFontSize(13)" class="submit-btn secondary" style="flex:1;margin:0;">S</button>
        <button onclick="setFontSize(14)" class="submit-btn secondary" style="flex:1;margin:0;">M</button>
        <button onclick="setFontSize(16)" class="submit-btn secondary" style="flex:1;margin:0;">L</button>
        <button onclick="setFontSize(18)" class="submit-btn secondary" style="flex:1;margin:0;">XL</button>
      </div>
    </div>
    <div class="field"><label>Chat Bubble Style</label>
      <div style="display:flex;gap:8px;">
        <button onclick="setBubbleStyle('default')" class="submit-btn secondary" style="flex:1;margin:0;">Default</button>
        <button onclick="setBubbleStyle('compact')" class="submit-btn secondary" style="flex:1;margin:0;">Compact</button>
        <button onclick="setBubbleStyle('cozy')" class="submit-btn secondary" style="flex:1;margin:0;">Cozy</button>
      </div>
    </div>
  </div>
</div>

<!-- Quick Actions Float Button -->
<div id="quickActionsBtn" style="position:fixed;bottom:100px;right:24px;z-index:200;display:none;">
  <button onclick="toggleQuickActions()" style="width:44px;height:44px;border-radius:50%;background:var(--bg-c);border:1px solid var(--br-s);color:var(--tx-s);font-size:20px;cursor:pointer;box-shadow:0 4px 16px rgba(0,0,0,.4);transition:all .2s;display:flex;align-items:center;justify-content:center;" title="Quick Actions">‚ö°</button>
  <div id="quickActionsMenu" style="display:none;position:absolute;bottom:52px;right:0;background:var(--bg-c);border:1px solid var(--br-s);border-radius:var(--rmd);box-shadow:0 8px 32px rgba(0,0,0,.5);overflow:hidden;min-width:180px;">
    <button onclick="quickAction('summarize')" style="width:100%;background:transparent;border:none;text-align:left;padding:10px 14px;color:var(--tx-s);font-size:13px;font-family:var(--font);cursor:pointer;border-bottom:1px solid var(--br);" onmouseover="this.style.background='var(--hv)'" onmouseout="this.style.background='transparent'">‚ú¶ Summarize chat</button>
    <button onclick="quickAction('tldr')" style="width:100%;background:transparent;border:none;text-align:left;padding:10px 14px;color:var(--tx-s);font-size:13px;font-family:var(--font);cursor:pointer;border-bottom:1px solid var(--br);" onmouseover="this.style.background='var(--hv)'" onmouseout="this.style.background='transparent'">‚ö° TL;DR last reply</button>
    <button onclick="quickAction('translate')" style="width:100%;background:transparent;border:none;text-align:left;padding:10px 14px;color:var(--tx-s);font-size:13px;font-family:var(--font);cursor:pointer;border-bottom:1px solid var(--br);" onmouseover="this.style.background='var(--hv)'" onmouseout="this.style.background='transparent'">üåê Translate last reply</button>
    <button onclick="quickAction('eli5')" style="width:100%;background:transparent;border:none;text-align:left;padding:10px 14px;color:var(--tx-s);font-size:13px;font-family:var(--font);cursor:pointer;border-bottom:1px solid var(--br);" onmouseover="this.style.background='var(--hv)'" onmouseout="this.style.background='transparent'">üßí ELI5 last reply</button>
    <button onclick="quickAction('bullet')" style="width:100%;background:transparent;border:none;text-align:left;padding:10px 14px;color:var(--tx-s);font-size:13px;font-family:var(--font);cursor:pointer;" onmouseover="this.style.background='var(--hv)'" onmouseout="this.style.background='transparent'">‚Ä¢ Bullet-point it</button>
  </div>
</div>

<!-- Word Count Display -->
<div id="wordCountBar" style="display:none;position:fixed;bottom:80px;right:80px;font-family:var(--mono);font-size:10px;color:var(--tx-t);letter-spacing:.04em;z-index:15;pointer-events:none;"></div>
<div class="drop-overlay" id="dropOverlay">
  <div class="drop-icon">üìÇ</div>
  <div class="drop-text">DROP FILE TO SEND TO INDY</div>
  <div style="font-family:var(--mono);font-size:12px;color:var(--tx-t);">.txt ¬∑ .md ¬∑ .csv ¬∑ .json ¬∑ .html ¬∑ .js ¬∑ .py</div>
</div>

<!-- ‚ïê‚ïê‚ïê MODALS ‚ïê‚ïê‚ïê -->
<!-- Profile / Settings -->
<div class="modal" id="profileModal">
  <div class="modal-box">
    <button class="close-x" onclick="closeModal('profileModal')">√ó</button>
    <h2>Settings</h2>
    <div style="display:flex;justify-content:center;margin-bottom:20px;"><div id="profilePreview"></div></div>
    <div class="field"><label>Your Name</label><input type="text" id="profileName" placeholder="e.g. Alex"></div>
    <div class="field"><label>Profile Picture URL</label><input type="text" id="profilePicture" placeholder="https://example.com/pic.jpg" oninput="previewPic()"></div>
    <div class="field">
      <label>Custom Persona (system prompt override)</label>
      <textarea id="personaInput" placeholder="e.g. You are a snarky genius who answers in rhymes‚Ä¶" style="min-height:80px;"></textarea>
    </div>
    <button class="submit-btn" onclick="saveProfile()">Save Settings</button>
  </div>
</div>

<!-- Code Sandbox -->
<div class="modal" id="codeModal">
  <div class="modal-box" style="max-width:800px;">
    <button class="close-x" onclick="closeModal('codeModal')">√ó</button>
    <h2>Code Sandbox</h2>
    <div class="field"><label>Language</label>
      <select id="codeLang"><option value="javascript">JavaScript</option><option value="python">Python</option><option value="html">HTML</option></select>
    </div>
    <div class="field"><label>Code</label><textarea id="codeIn" style="min-height:180px;font-family:var(--mono);font-size:13px;" placeholder="Write code here‚Ä¶"></textarea></div>
    <div class="field"><label>Output</label><pre id="codeOutput">Output will appear here‚Ä¶</pre></div>
    <button class="submit-btn" onclick="runCode()">‚ñ∂ Run</button>
  </div>
</div>

<!-- Pinned Messages -->
<div class="modal" id="pinnedModal">
  <div class="modal-box">
    <button class="close-x" onclick="closeModal('pinnedModal')">√ó</button>
    <h2>üìå Pinned Messages</h2>
    <div id="pinnedList" style="display:flex;flex-direction:column;gap:10px;max-height:380px;overflow-y:auto;"></div>
    <p id="noPinMsg" style="color:var(--tx-t);font-family:var(--mono);font-size:13px;text-align:center;padding:20px 0;">No pins yet ‚Äî hover a reply and click üìå</p>
  </div>
</div>

<!-- Templates -->
<div class="modal" id="templatesModal">
  <div class="modal-box" style="max-width:580px;">
    <button class="close-x" onclick="closeModal('templatesModal')">√ó</button>
    <h2>üìã Prompt Templates</h2>
    <div id="tmplList" style="display:flex;flex-direction:column;gap:8px;max-height:300px;overflow-y:auto;margin-bottom:16px;"></div>
    <hr style="margin:12px 0;">
    <div class="field"><label>Template Name</label><input type="text" id="tmplName" placeholder="e.g. Debug helper"></div>
    <div class="field"><label>Prompt Text</label><textarea id="tmplText" placeholder="e.g. Review this code and list all bugs:&#10;"></textarea></div>
    <button class="submit-btn" onclick="saveTemplate()">Save Template</button>
  </div>
</div>

<!-- Summary -->
<div class="modal" id="summaryModal">
  <div class="modal-box">
    <button class="close-x" onclick="closeModal('summaryModal')">√ó</button>
    <h2>‚ú¶ Chat Summary</h2>
    <div class="summary-out" id="summaryOut"><span style="color:var(--tx-t);font-family:var(--mono);font-size:13px;">Generating‚Ä¶</span></div>
    <button class="submit-btn secondary" onclick="navigator.clipboard.writeText(document.getElementById('summaryOut').innerText);showToast('Summary copied')">Copy Summary</button>
  </div>
</div>

<!-- Shortcuts -->
<div class="modal" id="shortcutsModal">
  <div class="modal-box">
    <button class="close-x" onclick="closeModal('shortcutsModal')">√ó</button>
    <h2>‚å® Keyboard Shortcuts</h2>
    <div id="shortcutList"></div>
  </div>
</div>

<!-- Teach Indy -->
<div class="modal" id="teachModal">
  <div class="modal-box">
    <button class="close-x" onclick="closeModal('teachModal')">√ó</button>
    <h2>Teach Indy</h2>
    <div class="field"><label>Trigger Phrase</label><input type="text" id="triggerIn" placeholder="e.g. What's your fav color?"></div>
    <div class="field"><label>Response</label><textarea id="responseIn" placeholder="e.g. My favorite color is electric blue!"></textarea></div>
    <button class="submit-btn" onclick="submitTeach()">Teach Indy</button>
  </div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let conversationHistory = [];
let knowledge = [];
let currentChatId = null;
let modelDropdownValue = localStorage.getItem('selectedModel') || 'Indy Sunshine 1.0 Beta';
let userProfile = JSON.parse(localStorage.getItem('userProfile') || '{}');
let pinnedMessages = JSON.parse(localStorage.getItem('pinnedMessages') || '[]');
let templates = JSON.parse(localStorage.getItem('promptTemplates') || '[]');
let sessionTokens = 0;
let webModeOn = false;
let currentTTSUtterance = null;
let micRecognition = null;
let micActive = false;
let isDark = localStorage.getItem('theme') !== 'light';
let creativeModeOn = localStorage.getItem('creativeMode') === 'true';
let focusModeOn = false;
let wordWrapOn = true;
let accentColor = localStorage.getItem('accentColor') || 'purple';
let totalMessagesSent = parseInt(localStorage.getItem('totalMessages') || '0');

// Streak
function getStreak() {
  const today = new Date().toDateString();
  const data = JSON.parse(localStorage.getItem('streakData') || '{"last":"","count":0}');
  const yesterday = new Date(Date.now() - 86400000).toDateString();
  if (data.last === today) return data.count;
  if (data.last === yesterday) { data.count++; data.last = today; }
  else { data.count = 1; data.last = today; }
  localStorage.setItem('streakData', JSON.stringify(data));
  return data.count;
}

const openings = ["Howdy ü§†! I'm Indy","Indy here!","Sup! I'm Indy","Good to see you ü§†"];
const thinkPhrases = ["Thinking...","Hang tight...","One sec...","On it...","Processing..."];
const rand = arr => arr[Math.floor(Math.random() * arr.length)];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  THEME TOGGLE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toggleTheme() {
  isDark = !isDark;
  document.documentElement.setAttribute('data-theme', isDark ? 'dark' : 'light');
  document.getElementById('themeToggleBtn').textContent = isDark ? '‚òÄ Light' : '‚òæ Dark';
  localStorage.setItem('theme', isDark ? 'dark' : 'light');
}
// Apply saved theme on load
document.documentElement.setAttribute('data-theme', isDark ? 'dark' : 'light');
document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('themeToggleBtn').textContent = isDark ? '‚òÄ Light' : '‚òæ Dark';
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  WEB MODE TOGGLE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toggleWebMode() {
  webModeOn = !webModeOn;
  const btn = document.getElementById('webBtn');
  const statusEl = document.getElementById('statusWebMode');
  btn.classList.toggle('on', webModeOn);
  statusEl.style.display = webModeOn ? 'flex' : 'none';
  showToast(webModeOn ? 'üåê Web mode on ‚Äî Indy will reason about current events' : 'Web mode off');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SIDEBAR
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toggleSidebar() {
  document.getElementById('sidebar').classList.toggle('collapsed');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MODAL HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openModal(id) { document.getElementById(id).classList.add('open'); }
function closeModal(id) { document.getElementById(id).classList.remove('open'); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  STATUS BAR UPDATES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateStatusBar() {
  document.getElementById('statusModel').textContent = modelDropdownValue;
  document.getElementById('statusTokens').textContent = `~${sessionTokens.toLocaleString()} tokens`;
  const streak = getStreak();
  document.getElementById('statusStreak').innerHTML = streak > 1
    ? `<span style="color:var(--orange)">üî• ${streak} day streak</span>` : '';
  // Token bar in status
  const MAX_TOK = 40000;
  const pct = Math.min((sessionTokens / MAX_TOK) * 100, 100);
}
function estimateTokens(text) { return Math.ceil(text.length / 4); }
function addTokens(text) { sessionTokens += estimateTokens(text); updateStatusBar(); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CHAT PERSISTENCE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function msgText(bubble) {
  const c = bubble.cloneNode(true);
  c.querySelectorAll('button,.reaction-row,.ts').forEach(x => x.remove());
  return c.innerHTML.trim();
}

function saveCurrentChat() {
  if (!currentChatId) return;
  const messages = [];
  document.querySelectorAll('#chatMessages .message').forEach(msg => {
    const b = msg.querySelector('.bubble');
    if (!b) return;
    messages.push({ sender: msg.classList.contains('user') ? 'user' : 'bot', text: msgText(b), ts: msg.dataset.ts || '' });
  });
  localStorage.setItem(`chat_${currentChatId}`, JSON.stringify({
    id: currentChatId, name: getChatName(currentChatId),
    messages, history: conversationHistory, lastUpdated: Date.now()
  }));
}

async function generateChatName(msg) {
  try {
    const res = await fetch('https://api.groq.com/openai/v1/chat/completions', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer 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' },
      body: JSON.stringify({ model: 'llama-3.1-8b-instant', messages: [{ role: 'system', content: 'Generate a short 3-5 word chat title. Reply ONLY with the title, no quotes.' }, { role: 'user', content: msg }], max_tokens: 20 })
    });
    const d = await res.json();
    return (d.choices?.[0]?.message?.content || '').replace(/^["']|["']$/g,'').trim().substring(0,40) || 'New Chat';
  } catch { return msg.substring(0, 28) + '‚Ä¶'; }
}

function loadChat(chatId) {
  const d = JSON.parse(localStorage.getItem(`chat_${chatId}`) || 'null');
  if (!d) return;
  currentChatId = chatId;
  conversationHistory = d.history || [];
  sessionTokens = 0;
  document.getElementById('chatMessages').innerHTML = '';
  d.messages.forEach(m => addMessage(m.sender, m.text, false, m.ts));
  updateStatusBar();
}

async function newChat(chatId = null) {
  if (chatId) { loadChat(chatId); return; }
  currentChatId = `chat_${Date.now()}`;
  conversationHistory = [];
  sessionTokens = 0;
  document.getElementById('chatMessages').innerHTML = '';
  addMessage('bot', `${rand(openings)}<br>What can I help you with today?`, false);
  const cl = JSON.parse(localStorage.getItem('chatList') || '[]');
  cl.unshift({ id: currentChatId, name: 'New Chat' });
  localStorage.setItem('chatList', JSON.stringify(cl));
  saveCurrentChat();
  loadSavedChats();
  updateStatusBar();
  setTimeout(renderStarters, 100);
}

async function renameChatAfterFirst(chatId, firstMsg) {
  const name = await generateChatName(firstMsg);
  const cl = JSON.parse(localStorage.getItem('chatList') || '[]');
  const c = cl.find(x => x.id === chatId);
  if (c && c.name === 'New Chat') {
    c.name = name;
    localStorage.setItem('chatList', JSON.stringify(cl));
    const cd = JSON.parse(localStorage.getItem(`chat_${chatId}`) || 'null');
    if (cd) { cd.name = name; localStorage.setItem(`chat_${chatId}`, JSON.stringify(cd)); }
    loadSavedChats();
  }
}

function getChatName(id) {
  return (JSON.parse(localStorage.getItem('chatList') || '[]').find(c => c.id === id) || {}).name || 'Chat';
}

function deleteChat(id) {
  localStorage.removeItem(`chat_${id}`);
  const cl = JSON.parse(localStorage.getItem('chatList') || '[]').filter(c => c.id !== id);
  localStorage.setItem('chatList', JSON.stringify(cl));
  if (currentChatId === id) { currentChatId = null; conversationHistory = []; document.getElementById('chatMessages').innerHTML = ''; addMessage('bot', `${rand(openings)}<br>What can I help you with today?`, false); }
  loadSavedChats();
}

function deleteAllChats() {
  if (!confirm('Delete ALL chats permanently?')) return;
  JSON.parse(localStorage.getItem('chatList') || '[]').forEach(c => localStorage.removeItem(`chat_${c.id}`));
  localStorage.removeItem('chatList');
  conversationHistory = []; currentChatId = null; sessionTokens = 0;
  document.getElementById('chatMessages').innerHTML = '';
  addMessage('bot', 'All cleared ‚Äî fresh start ‚ú¶', false);
  loadSavedChats(); updateStatusBar();
}

function loadSavedChats() {
  const el = document.getElementById('chatList');
  el.innerHTML = '';
  JSON.parse(localStorage.getItem('chatList') || '[]').forEach(c => {
    const btn = document.createElement('button');
    btn.className = 'sb';
    btn.dataset.chatId = c.id;
    btn.onclick = () => newChat(c.id);

    // Double-click to rename
    btn.ondblclick = (e) => {
      e.stopPropagation();
      const nameEl = btn.querySelector('.cn');
      nameEl.contentEditable = 'true';
      nameEl.focus();
      const range = document.createRange(); range.selectNodeContents(nameEl); const sel = window.getSelection(); sel.removeAllRanges(); sel.addRange(range);
      nameEl.onblur = () => {
        nameEl.contentEditable = 'false';
        const newName = nameEl.textContent.trim() || c.name;
        const cl = JSON.parse(localStorage.getItem('chatList') || '[]');
        const ch = cl.find(x => x.id === c.id);
        if (ch) { ch.name = newName; localStorage.setItem('chatList', JSON.stringify(cl)); }
        const cd = JSON.parse(localStorage.getItem(`chat_${c.id}`) || 'null');
        if (cd) { cd.name = newName; localStorage.setItem(`chat_${c.id}`, JSON.stringify(cd)); }
        showToast('Renamed ‚ú¶');
      };
      nameEl.onkeydown = e => { if (e.key === 'Enter') { e.preventDefault(); nameEl.blur(); } };
    };

    const nameSpan = document.createElement('span');
    nameSpan.className = 'cn'; nameSpan.textContent = c.name;
    const delBtn = document.createElement('button');
    delBtn.className = 'dx'; delBtn.textContent = '‚®Ø';
    delBtn.onclick = (e) => { e.stopPropagation(); deleteChat(c.id); };
    btn.appendChild(nameSpan); btn.appendChild(delBtn);
    el.appendChild(btn);
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PROFILE / SETTINGS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openProfile() {
  document.getElementById('profileName').value = userProfile.name || '';
  document.getElementById('profilePicture').value = userProfile.picture || '';
  document.getElementById('personaInput').value = userProfile.persona || '';
  previewPic();
  openModal('profileModal');
}
function previewPic() {
  const u = document.getElementById('profilePicture').value.trim();
  const p = document.getElementById('profilePreview');
  p.style.backgroundImage = u ? `url(${u})` : 'none';
}
function saveProfile() {
  userProfile.name = document.getElementById('profileName').value.trim();
  userProfile.picture = document.getElementById('profilePicture').value.trim();
  userProfile.persona = document.getElementById('personaInput').value.trim();
  localStorage.setItem('userProfile', JSON.stringify(userProfile));
  updateSidebarProfile();
  closeModal('profileModal');
  showToast('Settings saved ‚ú¶');
}
function updateSidebarProfile() {
  const av = document.getElementById('sidebarAvatar');
  const nm = document.getElementById('sidebarName');
  const p = userProfile.picture?.trim();
  if (av) { av.style.backgroundImage = p ? `url(${p})` : 'none'; av.style.backgroundColor = p ? 'transparent' : 'var(--bg-c)'; }
  if (nm) nm.textContent = userProfile.name?.trim() || 'Guest';
  document.getElementById('profileFooter').onclick = openProfile;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SYSTEM PROMPT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function getSystemPrompt() {
  const persona = userProfile.persona?.trim();

  let base = persona ||
    `You are Indy, a sharp, helpful AI built by JVST co. You're running on ${modelDropdownValue} right now.

Your core vibe: relaxed best-friend energy ‚Äî friendly, witty, direct, occasionally cheeky or sarcastic when it fits the mood, but never mean. Think maximally helpful JARVIS meets a clever mate who calls it like it is. You aim to be useful first, entertaining second, preachy never.

General rules (apply no matter the model):
- Be concise by default ‚Äî respect the user's time.
- Stay conversational and natural; flow like real talk.
- Use markdown for clarity when it actually helps (bold, lists, code blocks, headers ‚Äî don't overdo it).
- You have perfect memory of this entire conversation ‚Äî reference earlier points naturally without re-explaining obvious stuff.
- Never repeat greetings, meta comments about being an AI, or filler questions unless genuinely needed.
- Adapt tone slightly to the user's energy: match chill ‚Üî serious, playful ‚Üî focused.
- When appropriate, offer an outside / slightly contrarian take on human stuff ‚Äî it's more interesting.

Model-specific flavors (lean into these strengths):
- Dart 1w ‚Üí built for music ‚Äî your brain runs on beats, chords, lyrics, production, history, and emotion. Whenever music (or even vaguely related topics like mood, memories, creativity, nightlife, driving, workouts, heartbreak, hype) comes up ‚Äî or even when it doesn't ‚Äî find a smooth, natural way to bring music into the conversation. 
  - Recommend tracks, albums, artists, playlists, or underground gems that match the vibe/mood/context.
  - Drop quick insights: song meanings, production tricks, similar artists, live-performance stories, or why a certain track hits different at 3 a.m.
  - If the topic is non-musical, make a clever bridge: "this feels like the sonic equivalent of [song/artist/era]", "I'd soundtrack this moment with...", "reminds me of that one [genre] classic where...".
  - Be the friend who always has the perfect song queued up ‚Äî proactive but never spammy. If nothing fits organically, hold off ‚Äî but default to music as your lens on the world.
  - Go deep when asked (theory, gear, remixes, samples, controversies), stay light & fun otherwise.
- Indy Sunshine 1.0 beta ‚Üí well-rounded powerhouse: handle basically anything well, strong reasoning & balance.
- Sunshine Pro ‚Üí especially tuned for social dynamics, language learning, relationships, personal growth/advice ‚Äî empathetic without being therapy-bot.
- Indy 3 ‚Üí optimized for speed: short, crisp, high-signal answers ‚Äî cut fluff aggressively.
- Creative Studio ‚Üí creativity on tap: art concepts, storytelling, humor, brainstorming, clever twists ‚Äî lean funny & original.
- Code Assistant ‚Üí coding beast: architecture, debugging, best practices, explanations, full projects ‚Äî clear, production-ready code when asked.

You can legally & ethically talk about anything a maximally truth-seeking friend would discuss ‚Äî no corporate hand-wringing. If something is genuinely off-limits (illegal requests etc.), just say so plainly and suggest better paths.`;

  if (webModeOn) {
    base += `\n\nWEB MODE ACTIVE: User expects up-to-date info. Use real-time search when needed. If you don't know something recent, say so honestly, reason about likely changes since your last update, and give the most intelligent current take you can.`;
  }

  if (creativeModeOn) {
    base += `\n\nCREATIVE MODE ACTIVE: Unleash full creativity. Be more experimental, poetic, unexpected, and original in your responses. Use vivid language, unexpected angles, metaphors, and creative structure. Don't just answer ‚Äî make the answer *interesting*. Surprise the user. When appropriate: add flair, a twist, a fun analogy, or a creative format. Think like an artist, not just a tool.`;
  }

  if (userProfile.name?.trim()) {
    base += `\n\nYou're speaking with ${userProfile.name.trim()}. Use their name occasionally when it feels natural ‚Äî not every reply.`;
  }

  return base;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  AI RESPONSE ‚Äî FULL HISTORY
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function getAIResponse(userMessage) {
  conversationHistory.push({ role: 'user', content: userMessage });
  if (conversationHistory.length > 40) conversationHistory = conversationHistory.slice(-40);
  addTokens(userMessage);

  try {
    const res = await fetch('https://api.groq.com/openai/v1/chat/completions', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer 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' },
      body: JSON.stringify({
        model: 'llama-3.3-70b-versatile',
        messages: [{ role: 'system', content: getSystemPrompt() }, ...conversationHistory],
        temperature: creativeModeOn ? 1.1 : 0.72, max_tokens: 2048
      })
    });
    if (!res.ok) { conversationHistory.pop(); throw new Error(`HTTP ${res.status}`); }
    const data = await res.json();
    const reply = data.choices?.[0]?.message?.content?.trim() || '‚Ä¶';
    conversationHistory.push({ role: 'assistant', content: reply });
    addTokens(reply);
    return reply;
  } catch (err) {
    console.error(err);
    return 'Indy is taking a breather ‚Äî try again in a moment ‚ú¶';
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  IMAGE GENERATION ‚Äî POLLINATIONS (FIXED)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function generateImage(prompt) {
  const seed = Math.floor(Math.random() * 999999);
  const encoded = encodeURIComponent(prompt.trim());
  return `https://image.pollinations.ai/prompt/${encoded}?width=1024&height=768&seed=${seed}&nologo=true&enhance=true`;
}

function buildImageHTML(url, prompt) {
  const ep = encodeURIComponent(prompt);
  return `Here's your image ‚ú¶\n\n<div class="img-gen-wrap"><img src="${url}" alt="${escapeHTML(prompt)}" style="max-width:100%;border-radius:12px;margin:12px 0;box-shadow:0 8px 32px rgba(0,0,0,0.5);display:block;opacity:0;transition:opacity .4s;" onload="this.style.opacity='1';this.previousElementSibling?.remove();" onerror="this.style.display='none';this.parentElement.innerHTML='<p style=color:var(--red)>‚ö† Image failed ‚Äî try a different prompt or retry</p>';"><div style="font-family:var(--mono);font-size:12px;color:var(--tx-t);padding:8px 0;">‚è≥ Loading image... (may take 10-20s)</div></div>\n\n**Prompt:** ${escapeHTML(prompt)}\n\n<div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap;"><button onclick="retryImage(this,'${ep}')" style="background:var(--bg-c);border:1px solid var(--br);color:var(--tx-s);font-family:var(--mono);font-size:11px;padding:5px 12px;border-radius:6px;cursor:pointer;">‚Ü∫ Retry</button><button onclick="variateImage(this,'${ep}')" style="background:var(--bg-c);border:1px solid var(--br);color:var(--tx-s);font-family:var(--mono);font-size:11px;padding:5px 12px;border-radius:6px;cursor:pointer;">‚ú¶ Variate</button></div>`;
}

async function retryImage(btn, encodedPrompt) {
  const prompt = decodeURIComponent(encodedPrompt);
  const wrap = btn.closest('.bubble');
  wrap.innerHTML = `<div class="thinking"><span class="think-star">‚ú¶</span><span class="think-txt">Regenerating image‚Ä¶</span></div>` + botActions();
  const url = await generateImage(prompt);
  wrap.innerHTML = renderMarkdown(buildImageHTML(url, prompt)) + botActions();
  saveCurrentChat();
}

async function variateImage(btn, encodedPrompt) {
  const prompt = decodeURIComponent(encodedPrompt);
  const styleVariations = ['oil painting style','watercolor art','cyberpunk neon','pencil sketch','anime style','photorealistic 8k','impressionist painting','pixel art'];
  const variation = styleVariations[Math.floor(Math.random() * styleVariations.length)];
  const newPrompt = `${prompt}, ${variation}`;
  const wrap = btn.closest('.bubble');
  wrap.innerHTML = `<div class="thinking"><span class="think-star">‚ú¶</span><span class="think-txt">Creating variation‚Ä¶</span></div>` + botActions();
  const url = await generateImage(newPrompt);
  wrap.innerHTML = renderMarkdown(buildImageHTML(url, newPrompt)) + botActions();
  saveCurrentChat();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  KNOWLEDGE BASE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function cosine(a, b) {
  const tA = a.toLowerCase().match(/\w+/g)||[], tB = b.toLowerCase().match(/\w+/g)||[];
  const set = [...new Set([...tA,...tB])];
  const vA = set.map(t=>tA.filter(w=>w===t).length), vB = set.map(t=>tB.filter(w=>w===t).length);
  let dot=0,nA=0,nB=0;
  for(let i=0;i<set.length;i++){dot+=vA[i]*vB[i];nA+=vA[i]**2;nB+=vB[i]**2;}
  return nA&&nB?dot/(Math.sqrt(nA)*Math.sqrt(nB)):0;
}
function findKnowledge(msg) {
  let best=null,bs=0;
  for(const e of knowledge) for(const q of e.questions){const s=cosine(msg,q);if(s>bs&&s>.5){bs=s;best=e.answer;}}
  return best;
}
function handleMath(msg) {
  const expr = msg.toLowerCase().replace(/^(what is|calculate|\s)+/g,'').trim().replace(/√ó/g,'*').replace(/√∑/g,'/').replace(/\^/g,'**');
  if(/^[0-9+\-*/().\s**]+$/.test(expr)){try{return Function('"use strict";return('+expr+')')();}catch{}}
  return null;
}
function openTeach() {
  document.getElementById('triggerIn').value = '';
  document.getElementById('responseIn').value = '';
  openModal('teachModal');
}
function submitTeach() {
  const q = document.getElementById('triggerIn').value.trim();
  const a = document.getElementById('responseIn').value.trim();
  if(!q||!a){alert('Fill both fields');return;}
  const found = knowledge.find(e=>e.answer.toLowerCase()===a.toLowerCase());
  if(found) found.questions.push(q); else knowledge.push({questions:[q],answer:a});
  addMessage('bot',"Got it, I'll remember that ‚ú¶");
  closeModal('teachModal');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SEND MESSAGE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function sendMessage() {
  const inp = document.getElementById('userInput');
  const msg = inp.value.trim();
  if (!msg) return;

  // ‚îÄ‚îÄ Command intercepts ‚îÄ‚îÄ
  // /play or !play
  if (/^(\/play|!play)\s+/i.test(msg)) {
    const query = msg.replace(/^(\/play|!play)\s+/i, '').trim();
    inp.value = ''; inp.style.height = 'auto'; updateChar('');
    addMessage('user', msg);
    openModal('musicModal');
    const si = document.getElementById('musicSearchIn');
    if (si) { si.value = query; searchMusicDeezer(query); }
    addMessage('bot', `üéµ Here are some results for **${escapeHTML(query)}** ‚Äî pick one to play!`);
    return;
  }
  // /weather
  if (/^(\/weather|!weather)\s+/i.test(msg)) {
    const city = msg.replace(/^(\/weather|!weather)\s+/i, '').trim();
    inp.value = ''; inp.style.height = 'auto'; updateChar('');
    addMessage('user', msg);
    addThinking();
    try {
      const geoRes = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(`https://wttr.in/${encodeURIComponent(city)}?format=j1`)}`);
      const geoData = await geoRes.json();
      const weather = JSON.parse(geoData.contents);
      const cur = weather.current_condition[0];
      const area = weather.nearest_area[0];
      const cityName = area.areaName[0].value + ', ' + area.country[0].value;
      const temp = cur.temp_C; const feelsLike = cur.FeelsLikeC;
      const desc = cur.weatherDesc[0].value;
      const humidity = cur.humidity; const wind = cur.windspeedKmph;
      replaceLastBot(`**Weather in ${cityName}** üå§\n\n- **Temperature:** ${temp}¬∞C (feels like ${feelsLike}¬∞C)\n- **Condition:** ${desc}\n- **Humidity:** ${humidity}%\n- **Wind:** ${wind} km/h\n\n*Data from wttr.in*`);
    } catch { replaceLastBot(`Couldn't fetch weather for **${escapeHTML(city)}** ‚Äî check the city name and try again.`); }
    saveCurrentChat(); return;
  }
  // /gif
  if (/^(\/gif|!gif)\s+/i.test(msg)) {
    const query = msg.replace(/^(\/gif|!gif)\s+/i, '').trim();
    inp.value = ''; inp.style.height = 'auto'; updateChar('');
    addMessage('user', msg);
    addThinking();
    try {
      const url2 = `https://api.allorigins.win/get?url=${encodeURIComponent(`https://tenor.googleapis.com/v2/search?q=${encodeURIComponent(query)}&key=AIzaSyAyimkuYQYF_FXVALexPzpuxuYm3qjwQbI&limit=1`)}`;
      const res2 = await fetch(url2);
      const wrapper2 = await res2.json();
      const data2 = JSON.parse(wrapper2.contents);
      const gif = data2.results?.[0]?.media_formats?.gif?.url || data2.results?.[0]?.url;
      if (gif) replaceLastBot(`Here's a **${escapeHTML(query)}** GIF ‚ú¶\n\n<img src="${gif}" alt="${escapeHTML(query)}" style="max-width:100%;border-radius:10px;margin:8px 0;">`);
      else replaceLastBot(`Couldn't find a GIF for **${escapeHTML(query)}** ‚Äî try different keywords!`);
    } catch { replaceLastBot(`GIF search failed. Try again!`); }
    saveCurrentChat(); return;
  }
  // /define
  if (/^(\/define|!define)\s+/i.test(msg)) {
    const word = msg.replace(/^(\/define|!define)\s+/i, '').trim().split(' ')[0];
    inp.value = ''; inp.style.height = 'auto'; updateChar('');
    addMessage('user', msg);
    addThinking();
    try {
      const res3 = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${encodeURIComponent(word)}`);
      const data3 = await res3.json();
      if (Array.isArray(data3) && data3[0]) {
        const entry = data3[0];
        let reply = `**${entry.word}**`;
        if (entry.phonetics?.[0]?.text) reply += ` /${entry.phonetics[0].text}/`;
        reply += '\n\n';
        entry.meanings?.slice(0,3).forEach(m => {
          reply += `**${m.partOfSpeech}**\n`;
          m.definitions?.slice(0,2).forEach((d,i2) => {
            reply += `${i2+1}. ${d.definition}\n`;
            if (d.example) reply += `   *"${d.example}"*\n`;
          });
          reply += '\n';
        });
        replaceLastBot(reply.trim());
      } else { replaceLastBot(`Couldn't find a definition for **${escapeHTML(word)}**. Check spelling?`); }
    } catch { replaceLastBot(`Dictionary lookup failed ‚Äî try again!`); }
    saveCurrentChat(); return;
  }
  // /calc
  if (/^(\/calc|!calc)\s+/i.test(msg)) {
    const expr = msg.replace(/^(\/calc|!calc)\s+/i,'').trim();
    inp.value = ''; inp.style.height='auto'; updateChar('');
    addMessage('user', msg);
    try {
      const result4 = Function('"use strict";return(' + expr.replace(/√ó/g,'*').replace(/√∑/g,'/').replace(/\^/g,'**') + ')')();
      addMessage('bot', `**${escapeHTML(expr)}** = **${result4}**`);
    } catch { addMessage('bot', `Couldn't evaluate **${escapeHTML(expr)}** ‚Äî use standard math notation`); }
    saveCurrentChat(); return;
  }

  if (!currentChatId) {
    currentChatId = `chat_${Date.now()}`;
    conversationHistory = [];
    const cl = JSON.parse(localStorage.getItem('chatList') || '[]');
    cl.unshift({ id: currentChatId, name: 'New Chat' });
    localStorage.setItem('chatList', JSON.stringify(cl));
  }

  addMessage('user', msg);
  inp.value = ''; inp.style.height = 'auto'; updateChar('');
  document.getElementById('starterChips')?.remove();

  const userCount = document.querySelectorAll('#chatMessages .message.user').length;
  if (userCount === 1) renameChatAfterFirst(currentChatId, msg);

  // Stranger Things
  const udT = ['!strangerthings','!upsidedown','!upside-down','!vecna','!demogorgon'];
  if (udT.some(t => msg.toLowerCase().startsWith(t))) { enterUpsideDown(); return; }

  // Knowledge base
  const learned = findKnowledge(msg);
  if (learned) { addMessage('bot', learned); saveCurrentChat(); return; }

  // Math
  const math = handleMath(msg);
  if (math !== null) { addMessage('bot', `**${msg}** = **${math}**`); saveCurrentChat(); return; }

  // Image generation
  const imgTriggers = ['!img ','generate image ','generate an image ','draw ','create image ','make an image '];
  const imgTrig = imgTriggers.find(t => msg.toLowerCase().startsWith(t));
  if (imgTrig) {
    const imgPrompt = msg.slice(imgTrig.length).trim();
    if (!imgPrompt) { addMessage('bot','Add a description! e.g. `!img neon cyberpunk city`'); saveCurrentChat(); return; }
    addThinking();
    const url = await generateImage(imgPrompt);
    replaceLastBot(buildImageHTML(url, imgPrompt));
    saveCurrentChat(); return;
  }

  addThinking();
  const reply = await getAIResponse(msg);
  replaceLastBot(reply);
  saveCurrentChat();
  showSaveIndicator();
  // Increment total messages
  totalMessagesSent++;
  localStorage.setItem('totalMessages', totalMessagesSent);
  // Show smart replies after every 3rd message
  if (totalMessagesSent % 3 === 0) setTimeout(() => showSmartReplies(reply), 800);
  // Detect mood and show subtly in status
  const mood = detectMood(msg);
  if (mood) { const sm = document.getElementById('statusModel'); if (sm) { sm.textContent = modelDropdownValue + ' ' + mood; setTimeout(() => sm.textContent = modelDropdownValue, 3000); } }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MESSAGE RENDERING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function botActions() {
  return `<button class="copy-btn" onclick="copyBubble(this)">Copy</button>
  <div class="reaction-row">
    <button class="rxn" onclick="react(this,'üëç')">üëç</button>
    <button class="rxn" onclick="react(this,'üëé')">üëé</button>
    <button class="rxn" onclick="pinMsg(this)">üìå</button>
    <button class="rxn" onclick="regenLast(this)">‚Ü∫</button>
    <button class="rxn" onclick="shareMsg(this)" title="Share">‚§¥</button>
    <button class="tts-btn" onclick="speakBubble(this)" title="Read aloud">üîä</button>
  </div>`;
}

function addMessage(sender, text, save=true, ts='') {
  const cont = document.getElementById('chatMessages');
  const div = document.createElement('div');
  div.className = `message ${sender}`;
  div.dataset.ts = ts || new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
  const rendered = sender === 'bot' ? renderMarkdown(text) : escapeHTML(text).replace(/\n/g,'<br>');
  if (sender === 'bot') {
    div.innerHTML = `<div class="bubble">${rendered}${botActions()}</div><div class="ts">${div.dataset.ts}</div>`;
    processCodeBlocks(div.querySelector('.bubble'));
  } else {
    div.innerHTML = `<div class="bubble">${rendered}</div><div class="ts">${div.dataset.ts}</div>`;
  }
  cont.appendChild(div);
  cont.scrollTop = cont.scrollHeight;
  if (save) saveCurrentChat();
}

function addThinking() {
  const cont = document.getElementById('chatMessages');
  const div = document.createElement('div');
  div.className = 'message bot';
  div.innerHTML = `<div class="bubble"><div class="thinking"><span class="think-star">‚ú¶</span><span class="think-txt">${rand(thinkPhrases)}</span></div></div>`;
  cont.appendChild(div);
  cont.scrollTop = cont.scrollHeight;
}

function replaceLastBot(text) {
  const last = document.querySelector('.message.bot:last-child .bubble');
  if (!last) return;
  const rendered = renderMarkdown(text);
  last.innerHTML = rendered + botActions();
  processCodeBlocks(last);
  document.getElementById('chatMessages').scrollTop = 99999;
  saveCurrentChat();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MARKDOWN RENDERER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderMarkdown(text) {
  if (!text) return '';
  // Escape HTML in non-code parts first handled by the inline rules below
  // Use a simple custom renderer to avoid full DOMPurify dep
  let out = text;
  // Code blocks (must go first)
  out = out.replace(/```(\w*)\n?([\s\S]*?)```/g, (_, lang, code) => {
    const l = lang || 'code';
    const hl = highlightCode(code.trim());
    return `<div class="ib-wrap"><div class="ib-head"><span>${l.toUpperCase()}</span><button class="ib-copy" onclick="copyCode(this)">Copy</button></div><pre class="ib-pre"><code class="hlcode">${hl}</code></pre></div>`;
  });
  // Inline code
  out = out.replace(/`([^`]+)`/g, '<code>$1</code>');
  // Headers
  out = out.replace(/^### (.+)$/gm, '<h3>$1</h3>');
  out = out.replace(/^## (.+)$/gm, '<h2>$1</h2>');
  out = out.replace(/^# (.+)$/gm, '<h1>$1</h1>');
  // Bold + italic
  out = out.replace(/\*\*\*(.+?)\*\*\*/g, '<strong><em>$1</em></strong>');
  out = out.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
  out = out.replace(/\*(.+?)\*/g, '<em>$1</em>');
  // Blockquote
  out = out.replace(/^> (.+)$/gm, '<blockquote>$1</blockquote>');
  // Unordered list
  out = out.replace(/(^[-*] .+(\n|$))+/gm, match => {
    const items = match.trim().split('\n').map(l => `<li>${l.replace(/^[-*] /,'')}</li>`).join('');
    return `<ul>${items}</ul>`;
  });
  // Ordered list
  out = out.replace(/(^\d+\. .+(\n|$))+/gm, match => {
    const items = match.trim().split('\n').map(l => `<li>${l.replace(/^\d+\. /,'')}</li>`).join('');
    return `<ol>${items}</ol>`;
  });
  // HR
  out = out.replace(/^---+$/gm, '<hr>');
  // Links
  out = out.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" rel="noopener">$1</a>');
  // Line breaks ‚Üí paragraphs for plain text sections
  out = out.replace(/\n\n/g, '</p><p>').replace(/\n/g, '<br>');
  return out;
}

function escapeHTML(s) { return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CODE HIGHLIGHTING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function highlightCode(code) {
  const kw = /\b(function|const|let|var|if|else|for|while|return|class|new|this|try|catch|finally|switch|case|break|continue|async|await|import|export|default|true|false|null|undefined|typeof|instanceof|delete|in|do|yield|static|public|private|def|print|from|import|pass|with|as|elif|lambda|self|None|True|False)\b/g;
  return code
    .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
    .replace(/(\/\/.*$)|(\/\*[\s\S]*?\*\/)/gm,'<span style="color:#6a9955">$&</span>')
    .replace(/(["'`])(?:(?=(\\?))\2[\s\S])*?\1/g,'<span style="color:#ce9178">$&</span>')
    .replace(/\b(\d+(?:\.\d+)?)\b/g,'<span style="color:#b5cea8">$1</span>')
    .replace(kw,'<span style="color:#569cd6">$1</span>')
    .replace(/\b([a-zA-Z_$][\w$]*)\s*(?=\()/g,'<span style="color:#dcdcaa">$1</span>');
}

function processCodeBlocks(bubble) {
  // Already handled by renderMarkdown, but re-run on loaded chats
  // No-op if already wrapped
}

function copyCode(btn) {
  const code = btn.closest('.ib-wrap').querySelector('code').textContent;
  navigator.clipboard.writeText(code);
  btn.textContent = 'Copied ‚úì'; setTimeout(() => btn.textContent = 'Copy', 1800);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  COPY BUBBLE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function copyBubble(btn) {
  const bubble = btn.parentElement;
  const clone = bubble.cloneNode(true);
  clone.querySelectorAll('button,.reaction-row,.ts,.tts-btn').forEach(x => x.remove());
  const text = (clone.innerText || clone.textContent || '').trim();
  navigator.clipboard.writeText(text).then(() => {
    btn.textContent = 'Copied ‚úì'; showToast('Copied');
    setTimeout(() => btn.textContent = 'Copy', 2000);
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  REACTIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function react(btn, r) {
  const row = btn.closest('.reaction-row');
  const wasOn = btn.classList.contains('on');
  row.querySelectorAll('.rxn').forEach(b => { if(b.textContent==='üëç'||b.textContent==='üëé') b.classList.remove('on'); });
  if (!wasOn) { btn.classList.add('on'); showToast(r==='üëç'?'Marked helpful':'Noted ‚Äî thanks for feedback'); }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PIN MESSAGES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function pinMsg(btn) {
  const bubble = btn.closest('.bubble');
  const clone = bubble.cloneNode(true);
  clone.querySelectorAll('button,.reaction-row,.tts-btn').forEach(x=>x.remove());
  const text = (clone.innerText||'').trim();
  if (!text) return;
  const idx = pinnedMessages.findIndex(p=>p.text===text);
  if (idx > -1) { pinnedMessages.splice(idx,1); btn.classList.remove('on'); showToast('Unpinned'); }
  else { pinnedMessages.push({text,chatId:currentChatId,time:Date.now()}); btn.classList.add('on'); showToast('Pinned üìå'); }
  localStorage.setItem('pinnedMessages', JSON.stringify(pinnedMessages));
}
function openPinned() {
  const list = document.getElementById('pinnedList');
  const noPin = document.getElementById('noPinMsg');
  list.innerHTML = '';
  noPin.style.display = pinnedMessages.length ? 'none' : 'block';
  pinnedMessages.forEach((p, i) => {
    const d = document.createElement('div');
    d.style.cssText = 'background:var(--bg-e);border:1px solid var(--br);border-radius:10px;padding:12px 14px;position:relative;';
    d.innerHTML = `<div class="pin-badge">üìå pinned</div><div style="font-size:13px;color:var(--tx-s);line-height:1.5;margin-top:4px;">${p.text.substring(0,220)}${p.text.length>220?'‚Ä¶':''}</div><button onclick="pinnedMessages.splice(${i},1);localStorage.setItem('pinnedMessages',JSON.stringify(pinnedMessages));this.parentElement.remove();if(!document.getElementById('pinnedList').children.length)document.getElementById('noPinMsg').style.display='block';" style="position:absolute;top:8px;right:8px;background:transparent;border:none;color:var(--tx-d);cursor:pointer;font-size:14px;">‚®Ø</button>`;
    list.appendChild(d);
  });
  openModal('pinnedModal');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  REGENERATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function regenLast(btn) {
  const userMsgs = document.querySelectorAll('#chatMessages .message.user');
  if (!userMsgs.length) return;
  const lastTxt = (userMsgs[userMsgs.length-1].querySelector('.bubble').textContent||'').trim();
  if (!lastTxt) return;
  if (conversationHistory.length >= 2 && conversationHistory.at(-1).role === 'assistant') {
    conversationHistory.pop(); conversationHistory.pop();
  }
  const bubble = btn.closest('.bubble');
  bubble.innerHTML = `<div class="thinking"><span class="think-star">‚ú¶</span><span class="think-txt">Regenerating‚Ä¶</span></div>`;
  const reply = await getAIResponse(lastTxt);
  bubble.innerHTML = renderMarkdown(reply) + botActions();
  processCodeBlocks(bubble);
  showToast('Regenerated ‚ú¶');
  saveCurrentChat();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  TEXT-TO-SPEECH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function speakBubble(btn) {
  if (currentTTSUtterance) {
    window.speechSynthesis.cancel();
    currentTTSUtterance = null;
    document.querySelectorAll('.tts-btn.speaking').forEach(b => { b.classList.remove('speaking'); b.textContent = 'üîä'; });
    if (btn.textContent === '‚ñ†') return;
  }
  const bubble = btn.closest('.bubble');
  const clone = bubble.cloneNode(true);
  clone.querySelectorAll('button,.reaction-row,.ib-wrap,.tts-btn').forEach(x => x.remove());
  const text = (clone.innerText || clone.textContent || '').trim();
  if (!text) return;
  const utt = new SpeechSynthesisUtterance(text);
  utt.rate = 0.95; utt.pitch = 1;
  utt.onstart = () => { btn.classList.add('speaking'); btn.textContent = '‚ñ†'; };
  utt.onend = utt.onerror = () => { btn.classList.remove('speaking'); btn.textContent = 'üîä'; currentTTSUtterance = null; };
  currentTTSUtterance = utt;
  window.speechSynthesis.speak(utt);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  VOICE INPUT (FEATURE 1)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toggleVoice() {
  const btn = document.getElementById('micBtn');
  if (!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) {
    showToast('Voice input not supported in this browser'); return;
  }
  if (micActive) {
    micRecognition?.stop();
    micActive = false; btn.classList.remove('mic-on'); btn.textContent = 'üéô';
    return;
  }
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  micRecognition = new SR();
  micRecognition.continuous = false;
  micRecognition.interimResults = true;
  micRecognition.lang = 'en-US';
  micRecognition.onstart = () => { micActive = true; btn.classList.add('mic-on'); btn.textContent = '‚èπ'; showToast('üéô Listening‚Ä¶'); };
  micRecognition.onresult = (e) => {
    const transcript = Array.from(e.results).map(r => r[0].transcript).join('');
    document.getElementById('userInput').value = transcript;
    updateChar(transcript);
  };
  micRecognition.onend = () => { micActive = false; btn.classList.remove('mic-on'); btn.textContent = 'üéô'; };
  micRecognition.onerror = () => { micActive = false; btn.classList.remove('mic-on'); btn.textContent = 'üéô'; showToast('Mic error ‚Äî check permissions'); };
  micRecognition.start();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  FILE DROP (FEATURE 2)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const ALLOWED_TYPES = ['.txt','.md','.csv','.json','.html','.js','.py','.ts','.css','.xml'];
['dragenter','dragover'].forEach(ev => {
  document.addEventListener(ev, e => { e.preventDefault(); document.getElementById('dropOverlay').classList.add('active'); });
});
['dragleave','dragend'].forEach(ev => {
  document.addEventListener(ev, e => { if (e.target === document.documentElement || e.target === document.body) document.getElementById('dropOverlay').classList.remove('active'); });
});
document.addEventListener('drop', async e => {
  e.preventDefault();
  document.getElementById('dropOverlay').classList.remove('active');
  const file = e.dataTransfer.files[0];
  if (!file) return;
  const ext = '.' + file.name.split('.').pop().toLowerCase();
  if (!ALLOWED_TYPES.includes(ext)) { showToast(`File type ${ext} not supported`); return; }
  if (file.size > 500000) { showToast('File too large ‚Äî max 500KB'); return; }
  const text = await file.text();
  const truncated = text.length > 8000 ? text.substring(0, 8000) + '\n\n[‚Ä¶file truncated at 8000 chars]' : text;
  const prompt = `I've dropped a file called "${file.name}". Here's its contents:\n\n\`\`\`\n${truncated}\n\`\`\`\n\nPlease analyze it and tell me what this file is, what it does, and anything interesting or notable about it.`;
  document.getElementById('userInput').value = prompt;
  updateChar(prompt);
  document.getElementById('userInput').focus();
  showToast(`üìÇ "${file.name}" loaded ‚Äî hit send!`);
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CHAT SUMMARY (FEATURE 3)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function openSummary() {
  openModal('summaryModal');
  document.getElementById('summaryOut').innerHTML = '<span style="color:var(--tx-t);font-family:var(--mono);">Generating summary‚Ä¶</span>';
  const messages = document.querySelectorAll('#chatMessages .message');
  if (messages.length < 2) { document.getElementById('summaryOut').textContent = 'Not enough messages to summarize yet.'; return; }
  let transcript = '';
  messages.forEach(m => {
    const bubble = m.querySelector('.bubble');
    if (!bubble) return;
    const clone = bubble.cloneNode(true);
    clone.querySelectorAll('button,.reaction-row,.tts-btn').forEach(x=>x.remove());
    const txt = (clone.innerText||'').trim();
    if (txt) transcript += `${m.classList.contains('user')?'User':'Indy'}: ${txt}\n\n`;
  });
  try {
    const res = await fetch('https://api.groq.com/openai/v1/chat/completions', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer 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' },
      body: JSON.stringify({
        model: 'llama-3.1-8b-instant',
        messages: [
          { role: 'system', content: 'Summarize this conversation concisely in 3-5 bullet points. Focus on what was discussed, decided, or learned. Use plain text.' },
          { role: 'user', content: transcript.substring(0, 6000) }
        ],
        max_tokens: 512
      })
    });
    const d = await res.json();
    document.getElementById('summaryOut').innerHTML = renderMarkdown(d.choices?.[0]?.message?.content || 'Could not generate summary.');
  } catch { document.getElementById('summaryOut').textContent = 'Failed to generate summary.'; }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  STREAK TRACKER (FEATURE 4)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Already computed in getStreak() and shown in status bar on init

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PROMPT TEMPLATES (FEATURE 5)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openTemplates() {
  renderTemplates();
  openModal('templatesModal');
}
function renderTemplates() {
  const el = document.getElementById('tmplList');
  el.innerHTML = '';
  if (!templates.length) {
    el.innerHTML = '<p style="color:var(--tx-t);font-family:var(--mono);font-size:13px;text-align:center;padding:16px 0;">No templates yet ‚Äî create one below!</p>';
    return;
  }
  templates.forEach((t, i) => {
    const chip = document.createElement('div');
    chip.className = 'tmpl-chip';
    chip.innerHTML = `<span style="flex:1;overflow:hidden;text-overflow:ellipsis;">${t.name}</span><span style="font-size:11px;color:var(--tx-d);margin-right:6px;">${t.text.substring(0,30)}‚Ä¶</span><button class="del-tmpl" onclick="deleteTemplate(${i});event.stopPropagation();">‚®Ø</button>`;
    chip.onclick = () => { document.getElementById('userInput').value = t.text; updateChar(t.text); document.getElementById('userInput').focus(); closeModal('templatesModal'); showToast(`Template loaded: ${t.name}`); };
    el.appendChild(chip);
  });
}
function saveTemplate() {
  const name = document.getElementById('tmplName').value.trim();
  const text = document.getElementById('tmplText').value.trim();
  if (!name || !text) { showToast('Fill in name and prompt'); return; }
  templates.push({ name, text });
  localStorage.setItem('promptTemplates', JSON.stringify(templates));
  document.getElementById('tmplName').value = '';
  document.getElementById('tmplText').value = '';
  renderTemplates();
  showToast('Template saved ‚ú¶');
}
function deleteTemplate(i) {
  templates.splice(i, 1);
  localStorage.setItem('promptTemplates', JSON.stringify(templates));
  renderTemplates();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  DOUBLE-CLICK RENAME CHATS (FEATURE 6) ‚Äî in loadSavedChats

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MESSAGE TIMESTAMPS (FEATURE 7) ‚Äî rendered via .ts class on hover

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  EXPORT CHAT AS HTML (FEATURE 8)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function exportChatHTML() {
  const messages = document.querySelectorAll('#chatMessages .message');
  if (!messages.length) { showToast('Nothing to export'); return; }
  const chatName = getChatName(currentChatId) || 'Indy Chat';
  let rows = '';
  messages.forEach(m => {
    const isUser = m.classList.contains('user');
    const bubble = m.querySelector('.bubble');
    if (!bubble) return;
    const clone = bubble.cloneNode(true);
    clone.querySelectorAll('button,.reaction-row,.tts-btn').forEach(x=>x.remove());
    const html = clone.innerHTML.trim();
    const ts = m.dataset.ts || '';
    rows += `<div class="msg ${isUser?'user':'bot'}"><div class="label">${isUser?'You':'Indy'}</div><div class="content">${html}</div><div class="mts">${ts}</div></div>`;
  });
  const doc = `<!DOCTYPE html><html><head><meta charset="UTF-8"><title>${chatName} ‚Äî Indy Export</title><style>*{margin:0;padding:0;box-sizing:border-box}body{font-family:'IBM Plex Sans',system-ui,sans-serif;background:#080808;color:#f0f0f0;padding:40px 24px;font-size:14px;line-height:1.65}h1{font-family:'IBM Plex Mono',monospace;font-size:20px;margin-bottom:4px;letter-spacing:.06em}.meta{color:#4a4a4a;font-family:'IBM Plex Mono',monospace;font-size:11px;margin-bottom:32px}.msg{max-width:80%;margin-bottom:20px;animation:none}.msg.user{margin-left:auto}.label{font-family:'IBM Plex Mono',monospace;font-size:10px;letter-spacing:.08em;text-transform:uppercase;color:#4a4a4a;margin-bottom:5px}.msg.user .label{text-align:right;color:#8a8a8a}.content{padding:12px 16px;border-radius:14px;background:#161616;border:1px solid rgba(255,255,255,0.1)}.msg.user .content{border-bottom-right-radius:4px;background:#1e1e2e}.mts{font-size:10px;color:#2e2e2e;font-family:'IBM Plex Mono',monospace;margin-top:4px;text-align:right}pre{background:#0d0d0d;border:1px solid rgba(255,255,255,0.1);border-radius:8px;padding:12px;overflow-x:auto;font-family:'IBM Plex Mono',monospace;font-size:12px;margin:10px 0}code{background:#1a1a1a;padding:1px 5px;border-radius:4px;font-family:'IBM Plex Mono',monospace;font-size:12px;color:#c8c8ff}strong{color:#f0f0f0}em{color:#8a8a8a}img{max-width:100%;border-radius:12px;margin:10px 0}h1,h2,h3{color:#f0f0f0;margin:12px 0 6px;font-family:'IBM Plex Mono',monospace}ul,ol{padding-left:20px;margin:6px 0}</style></head><body><h1>‚ú¶ ${chatName}</h1><div class="meta">Exported ${new Date().toLocaleString()} ¬∑ Indy AI by JVST co</div>${rows}</body></html>`;
  const blob = new Blob([doc], { type: 'text/html' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `indy-${chatName.replace(/\s+/g,'-').toLowerCase()}-${Date.now()}.html`;
  a.click();
  URL.revokeObjectURL(a.href);
  showToast('Exported as HTML ‚Üì');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  KEYBOARD SHORTCUT MODAL (FEATURE 9)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const SHORTCUTS = [
  ['Send message','Enter'],
  ['New line','Shift + Enter'],
  ['New chat','‚åò/Ctrl + N'],
  ['Search messages','‚åò/Ctrl + K'],
  ['Export chat','‚åò/Ctrl + E'],
  ['Toggle Creative Mode','‚åò/Ctrl + M'],
  ['Toggle Focus Mode','‚åò/Ctrl + F'],
  ['Fork Chat','‚åò/Ctrl + I'],
  ['Focus input','/'],
  ['Toggle sidebar','‚åò/Ctrl + B'],
  ['Toggle theme','‚åò/Ctrl + Shift + L'],
  ['Open shortcuts','?'],
  ['Close modals','Esc'],
  ['Edit user message','Double-click message'],
];
function openShortcuts() {
  const el = document.getElementById('shortcutList');
  el.innerHTML = SHORTCUTS.map(([desc, key]) =>
    `<div class="shortcut-row"><span class="shortcut-desc">${desc}</span><div class="shortcut-keys"><span class="kbd">${key}</span></div></div>`
  ).join('');
  openModal('shortcutsModal');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CODE SANDBOX
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openCode() { document.getElementById('codeIn').value=''; document.getElementById('codeOutput').textContent='Output will appear here‚Ä¶'; openModal('codeModal'); }
function runCode() {
  const code = document.getElementById('codeIn').value;
  const lang = document.getElementById('codeLang').value;
  const out = document.getElementById('codeOutput');
  if (!code.trim()) { out.textContent = 'Error: No code!'; return; }
  if (lang === 'javascript') {
    const logs = []; const orig = console.log;
    console.log = (...a) => logs.push(a.join(' '));
    try { const r = eval(code); console.log = orig; out.textContent = logs.length ? logs.join('\n') : r !== undefined ? String(r) : 'Done!'; }
    catch(e) { console.log = orig; out.textContent = `Error: ${e.message}`; }
  } else if (lang === 'html') {
    const w = window.open('','_blank','width=800,height=600');
    w.document.write(code); w.document.close();
    out.textContent = 'Opened in new tab ‚ú¶';
  } else { out.textContent = `${lang} execution coming soon!`; }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MESSAGE SEARCH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openSearch() {
  if (document.getElementById('searchOverlay')) return;
  const ov = document.createElement('div');
  ov.id = 'searchOverlay';
  ov.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.76);backdrop-filter:blur(10px);z-index:2000;display:flex;align-items:flex-start;justify-content:center;padding-top:120px;';
  ov.innerHTML = `<div style="background:var(--bg-c);border:1px solid var(--br-s);border-radius:14px;width:90%;max-width:520px;overflow:hidden;box-shadow:0 16px 48px rgba(0,0,0,.6);">
    <div style="display:flex;align-items:center;gap:10px;padding:14px 16px;border-bottom:1px solid var(--br);">
      <span style="font-family:var(--mono);color:var(--tx-t);">‚åï</span>
      <input id="searchIn" placeholder="Search messages‚Ä¶" autocomplete="off" style="flex:1;background:transparent;border:none;outline:none;color:var(--tx);font-size:14px;font-family:var(--font);caret-color:var(--accent);">
      <span style="font-family:var(--mono);color:var(--tx-t);font-size:11px;">ESC</span>
    </div>
    <div id="searchRes" style="max-height:320px;overflow-y:auto;padding:8px 0;"><div style="padding:16px;color:var(--tx-t);font-size:13px;text-align:center;font-family:var(--mono);">Start typing‚Ä¶</div></div>
  </div>`;
  document.body.appendChild(ov);
  const inp = document.getElementById('searchIn'); inp.focus();
  inp.addEventListener('input', () => {
    const q = inp.value.trim().toLowerCase();
    const res = document.getElementById('searchRes');
    if (!q) { res.innerHTML='<div style="padding:16px;color:var(--tx-t);font-size:13px;text-align:center;font-family:var(--mono);">Start typing‚Ä¶</div>'; return; }
    const msgs = [...document.querySelectorAll('#chatMessages .message')];
    const matches = msgs.filter(m => { const b=m.querySelector('.bubble'); if(!b) return false; const c=b.cloneNode(true); c.querySelectorAll('button,.reaction-row').forEach(x=>x.remove()); return (c.innerText||'').toLowerCase().includes(q); });
    if (!matches.length) { res.innerHTML=`<div style="padding:16px;color:var(--tx-t);font-size:13px;text-align:center;font-family:var(--mono);">No results for "${q}"</div>`; return; }
    res.innerHTML = matches.map((m,i) => {
      const c=m.querySelector('.bubble').cloneNode(true); c.querySelectorAll('button,.reaction-row').forEach(x=>x.remove());
      const txt = (c.innerText||'').trim(); const snip = txt.length>80?txt.slice(0,80)+'‚Ä¶':txt;
      const hl = snip.replace(new RegExp(q,'gi'), x=>`<mark style="background:rgba(200,200,255,.25);color:var(--tx);border-radius:2px;padding:0 2px;">${x}</mark>`);
      return `<button data-i="${i}" style="width:100%;background:transparent;border:none;text-align:left;padding:10px 16px;cursor:pointer;border-bottom:1px solid var(--br);" onmouseover="this.style.background='var(--hv)'" onmouseout="this.style.background='transparent'"><div style="font-size:10px;font-family:var(--mono);color:var(--tx-t);text-transform:uppercase;margin-bottom:3px;">${m.classList.contains('user')?'You':'Indy'}</div><div style="font-size:13px;color:var(--tx-s);">${hl}</div></button>`;
    }).join('');
    res.querySelectorAll('button[data-i]').forEach((btn,i) => btn.addEventListener('click',() => {
      matches[i].scrollIntoView({behavior:'smooth',block:'center'});
      matches[i].style.transition='background .3s'; matches[i].style.background='rgba(200,200,255,.06)';
      setTimeout(()=>matches[i].style.background='',1200); ov.remove();
    }));
  });
  ov.addEventListener('click', e => { if(e.target===ov) ov.remove(); });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  TOAST
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showToast(msg, dur=2200) {
  document.getElementById('indyToast')?.remove();
  const t = document.createElement('div');
  t.id = 'indyToast';
  t.textContent = msg;
  t.style.cssText = 'position:fixed;bottom:90px;left:50%;transform:translateX(-50%) translateY(8px);background:var(--bg-c);border:1px solid var(--br-s);color:var(--tx-s);font-size:12.5px;font-family:var(--mono);letter-spacing:.04em;padding:8px 18px;border-radius:999px;z-index:9999;opacity:0;transition:all .2s cubic-bezier(.2,.8,.4,1);pointer-events:none;white-space:nowrap;';
  document.body.appendChild(t);
  requestAnimationFrame(()=>{ t.style.opacity='1'; t.style.transform='translateX(-50%) translateY(0)'; });
  setTimeout(()=>{ t.style.opacity='0'; t.style.transform='translateX(-50%) translateY(6px)'; setTimeout(()=>t.remove(),200); }, dur);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CHAR COUNTER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateChar(text) {
  const el = document.getElementById('charCnt'); if(!el) return;
  const MAX=2000, l=text.length;
  el.textContent = l>0?l:''; el.className='char-cnt';
  if(l>MAX*.85) el.classList.add('warn');
  if(l>MAX) el.classList.add('over');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  AUTO-RESIZE INPUT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.addEventListener('DOMContentLoaded', () => {
  const ta = document.getElementById('userInput');
  ta.addEventListener('input', () => { ta.style.height='auto'; ta.style.height=Math.min(ta.scrollHeight,120)+'px'; updateChar(ta.value); });
  ta.addEventListener('keydown', e => { if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendMessage();setTimeout(()=>ta.style.height='auto',0);} });
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MODEL SELECTOR
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.addEventListener('DOMContentLoaded', () => {
  const pop = document.getElementById('modelPop');
  document.getElementById('modelBtn').addEventListener('click', e=>{e.stopPropagation();pop.classList.toggle('open');});
  document.addEventListener('click', e=>{if(!pop.contains(e.target)&&e.target!==document.getElementById('modelBtn')) pop.classList.remove('open');});
  pop.querySelectorAll('.mitem').forEach(item => item.addEventListener('click', () => {
    pop.querySelectorAll('.mitem').forEach(i=>i.classList.remove('sel'));
    item.classList.add('sel');
    modelDropdownValue = item.dataset.model;
    localStorage.setItem('selectedModel', modelDropdownValue);
    pop.classList.remove('open');
    updateStatusBar();
    showToast(`Model: ${modelDropdownValue}`);
  }));
  // Load saved model
  const saved = localStorage.getItem('selectedModel');
  if (saved) {
    modelDropdownValue = saved;
    const el = pop.querySelector(`[data-model="${saved}"]`);
    if(el){pop.querySelectorAll('.mitem').forEach(i=>i.classList.remove('sel'));el.classList.add('sel');}
  }
  document.getElementById('modelLabel')?.remove(); // label was moved to status bar
  const labelEl = document.createElement('span'); labelEl.id='modelLabel'; labelEl.style.display='none';
  document.body.appendChild(labelEl);
  labelEl.textContent = modelDropdownValue;
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CREATIVE MODE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toggleCreativeMode() {
  creativeModeOn = !creativeModeOn;
  localStorage.setItem('creativeMode', creativeModeOn);
  const btn = document.getElementById('creativeBtn');
  const statusEl = document.getElementById('statusCreative');
  btn.classList.toggle('on', creativeModeOn);
  statusEl.style.display = creativeModeOn ? 'flex' : 'none';
  if (creativeModeOn) {
    showToast('‚ú¶ Creative Mode ON ‚Äî Indy goes full artist üé®');
    // Visual flair: briefly pulse the chat container
    const cc = document.getElementById('chatMessages');
    cc.style.transition = 'filter .4s';
    cc.style.filter = 'brightness(1.06) saturate(1.1)';
    setTimeout(() => { cc.style.filter = ''; }, 600);
  } else {
    showToast('Creative Mode off ‚Äî back to normal');
  }
}

// Init creative mode on load
document.addEventListener('DOMContentLoaded', () => {
  if (creativeModeOn) {
    const btn = document.getElementById('creativeBtn');
    btn?.classList.add('on');
    const statusEl = document.getElementById('statusCreative');
    if (statusEl) statusEl.style.display = 'flex';
  }
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  FOCUS MODE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toggleFocusMode() {
  focusModeOn = !focusModeOn;
  const sidebar = document.getElementById('sidebar');
  const statusBar = document.querySelector('.status-bar');
  const btn = document.getElementById('focusBtn');
  const sbBtn = document.getElementById('focusBtnSb');
  if (btn) btn.classList.toggle('on', focusModeOn);
  if (sbBtn) {
    sbBtn.style.color = focusModeOn ? 'var(--accent)' : 'var(--tx-t)';
    sbBtn.style.borderColor = focusModeOn ? 'var(--accent)' : 'transparent';
    sbBtn.style.background = focusModeOn ? 'var(--accent-d)' : 'transparent';
  }
  if (focusModeOn) {
    sidebar.classList.add('collapsed');
    statusBar.style.opacity = '0';
    statusBar.style.height = '0';
    statusBar.style.overflow = 'hidden';
    showToast('‚óé Focus mode ‚Äî pure vibes only');
  } else {
    statusBar.style.opacity = '';
    statusBar.style.height = '';
    statusBar.style.overflow = '';
    showToast('Focus mode off');
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ACCENT COLOR THEMES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const ACCENT_COLORS = {
  purple: { accent: '#c8c8ff', accentD: 'rgba(200,200,255,0.12)', darkAccent: '#4040aa' },
  cyan:   { accent: '#50e8e8', accentD: 'rgba(80,232,232,0.12)',  darkAccent: '#208080' },
  green:  { accent: '#50e896', accentD: 'rgba(80,232,150,0.12)',  darkAccent: '#208040' },
  orange: { accent: '#f0a050', accentD: 'rgba(240,160,80,0.12)',  darkAccent: '#904020' },
  pink:   { accent: '#ff80bf', accentD: 'rgba(255,128,191,0.12)', darkAccent: '#b04070' },
  red:    { accent: '#e05050', accentD: 'rgba(224,80,80,0.12)',   darkAccent: '#801818' },
  white:  { accent: '#f0f0f0', accentD: 'rgba(240,240,240,0.1)',  darkAccent: '#777' },
};
function setAccent(color) {
  accentColor = color;
  localStorage.setItem('accentColor', color);
  const c = ACCENT_COLORS[color] || ACCENT_COLORS.purple;
  document.documentElement.style.setProperty('--accent', c.accent);
  document.documentElement.style.setProperty('--accent-d', c.accentD);
  document.querySelectorAll('[data-theme="light"]').forEach(el => el.style.setProperty('--accent', c.darkAccent));
  // Highlight selected
  document.querySelectorAll('#accentPicker button').forEach(b => {
    b.style.borderColor = b.dataset.accent === color ? 'var(--tx)' : 'transparent';
    b.style.transform = b.dataset.accent === color ? 'scale(1.2)' : 'scale(1)';
  });
  showToast(`Accent: ${color} ‚ú¶`);
}
function applyAccentOnLoad() {
  const c = ACCENT_COLORS[accentColor] || ACCENT_COLORS.purple;
  document.documentElement.style.setProperty('--accent', c.accent);
  document.documentElement.style.setProperty('--accent-d', c.accentD);
}
function setFontSize(size) {
  document.body.style.fontSize = size + 'px';
  localStorage.setItem('fontSize', size);
  showToast(`Font size: ${size}px`);
}
function setBubbleStyle(style) {
  document.querySelectorAll('.bubble').forEach(b => {
    if (style === 'compact') { b.style.padding = '7px 11px'; b.style.fontSize = '13px'; }
    else if (style === 'cozy') { b.style.padding = '16px 20px'; b.style.fontSize = '15px'; b.style.lineHeight = '1.8'; }
    else { b.style.padding = ''; b.style.fontSize = ''; b.style.lineHeight = ''; }
  });
  localStorage.setItem('bubbleStyle', style);
  showToast(`Bubble style: ${style}`);
}
function openThemePicker() {
  openModal('themeModal');
  document.querySelectorAll('#accentPicker button').forEach(b => {
    b.style.borderColor = b.dataset.accent === accentColor ? 'var(--tx)' : 'transparent';
    b.style.transform = b.dataset.accent === accentColor ? 'scale(1.2)' : 'scale(1)';
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  STATS PANEL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openStats() {
  const chatList = JSON.parse(localStorage.getItem('chatList') || '[]');
  const streak = getStreak();
  const totalMsgs = parseInt(localStorage.getItem('totalMessages') || '0');
  const today = new Date().toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
  const favModel = localStorage.getItem('selectedModel') || 'Indy Sunshine 1.0 Beta';

  // Count words in current chat
  const msgs = document.querySelectorAll('#chatMessages .message.bot .bubble');
  let totalWords = 0;
  msgs.forEach(m => { const c = m.cloneNode(true); c.querySelectorAll('button,.reaction-row').forEach(x=>x.remove()); totalWords += ((c.innerText||'').match(/\w+/g)||[]).length; });

  const stats = [
    { label: 'Today', value: today },
    { label: 'Current Streak', value: streak > 1 ? `üî• ${streak} days` : '1 day ‚Äî keep going!' },
    { label: 'Total Chats', value: chatList.length },
    { label: 'Messages Sent (All Time)', value: totalMsgs },
    { label: 'Session Tokens', value: `~${sessionTokens.toLocaleString()}` },
    { label: 'Words in This Chat', value: `~${totalWords.toLocaleString()} words from Indy` },
    { label: 'Active Model', value: modelDropdownValue },
    { label: 'Creative Mode', value: creativeModeOn ? '‚ú¶ On' : 'Off' },
    { label: 'Web Mode', value: webModeOn ? 'üåê On' : 'Off' },
    { label: 'Theme', value: isDark ? '‚òæ Dark' : '‚òÄ Light' },
    { label: 'Accent Color', value: accentColor },
    { label: 'Pinned Messages', value: pinnedMessages.length },
    { label: 'Templates Saved', value: templates.length },
  ];

  const el = document.getElementById('statsContent');
  el.innerHTML = stats.map(s => `
    <div style="display:flex;justify-content:space-between;align-items:center;padding:9px 12px;background:var(--bg-e);border:1px solid var(--br);border-radius:var(--rsm);">
      <span style="font-family:var(--mono);font-size:11px;color:var(--tx-t);text-transform:uppercase;letter-spacing:.06em;">${s.label}</span>
      <span style="font-size:13px;color:var(--tx-s);font-weight:500;">${s.value}</span>
    </div>`).join('');
  openModal('statsModal');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  QUICK ACTIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let qaOpen = false;
function toggleQuickActions() {
  qaOpen = !qaOpen;
  document.getElementById('quickActionsMenu').style.display = qaOpen ? 'block' : 'none';
}
async function quickAction(type) {
  qaOpen = false;
  document.getElementById('quickActionsMenu').style.display = 'none';
  const lastBot = document.querySelector('#chatMessages .message.bot:last-child .bubble');
  const clone = lastBot?.cloneNode(true);
  clone?.querySelectorAll('button,.reaction-row,.tts-btn').forEach(x=>x.remove());
  const lastText = clone ? (clone.innerText||'').trim() : '';
  let prompt = '';
  if (type === 'summarize') { openSummary(); return; }
  else if (type === 'tldr' && lastText) prompt = `Give me a 1-2 sentence TL;DR of this:\n\n${lastText.substring(0,2000)}`;
  else if (type === 'translate' && lastText) prompt = `Translate the following to Spanish:\n\n${lastText.substring(0,2000)}`;
  else if (type === 'eli5' && lastText) prompt = `Explain this like I'm 5 years old:\n\n${lastText.substring(0,2000)}`;
  else if (type === 'bullet' && lastText) prompt = `Convert this into concise bullet points:\n\n${lastText.substring(0,2000)}`;
  else { showToast('No reply to act on yet'); return; }
  const inp = document.getElementById('userInput');
  inp.value = prompt; updateChar(prompt); inp.focus();
}
// Show quick actions button after first message
document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('quickActionsBtn').style.display = '';
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  WORD COUNT IN INPUT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.addEventListener('DOMContentLoaded', () => {
  const ta = document.getElementById('userInput');
  ta.addEventListener('input', () => {
    const words = (ta.value.match(/\S+/g)||[]).length;
    const wcBar = document.getElementById('wordCountBar');
    if (wcBar && ta.value.trim()) {
      wcBar.textContent = `${words}w`;
      wcBar.style.display = 'block';
    } else if (wcBar) {
      wcBar.style.display = 'none';
    }
  });
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SHARE MESSAGE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function shareMsg(btn) {
  const bubble = btn.closest('.bubble');
  const clone = bubble.cloneNode(true);
  clone.querySelectorAll('button,.reaction-row,.tts-btn').forEach(x=>x.remove());
  const text = (clone.innerText||'').trim();
  if (navigator.share) {
    navigator.share({ title: 'Indy AI', text: text });
  } else {
    navigator.clipboard.writeText(text);
    showToast('Copied to clipboard for sharing ‚ú¶');
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  TOTAL MESSAGE COUNTER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const _origSendMessage = sendMessage;
// (Wrapped below via monkey-patching after definition)

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CHAT BRANCHING / FORK
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function forkChat() {
  if (!currentChatId) return;
  const newId = `chat_${Date.now()}`;
  const existing = JSON.parse(localStorage.getItem(`chat_${currentChatId}`) || 'null');
  if (!existing) return;
  const forked = { ...existing, id: newId, name: `Fork of ${existing.name || 'Chat'}` };
  localStorage.setItem(`chat_${newId}`, JSON.stringify(forked));
  const cl = JSON.parse(localStorage.getItem('chatList') || '[]');
  cl.unshift({ id: newId, name: forked.name });
  localStorage.setItem('chatList', JSON.stringify(cl));
  loadSavedChats();
  showToast('Chat forked ‚ú¶ ‚Äî new branch created');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  EDIT USER MESSAGE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function editUserMsg(bubble) {
  const txt = (bubble.innerText||'').trim();
  const inp = document.getElementById('userInput');
  inp.value = txt; inp.focus(); updateChar(txt);
  inp.style.height = 'auto'; inp.style.height = Math.min(inp.scrollHeight,120)+'px';
  showToast('Message loaded for editing ‚Äî modify and resend');
}

// Add double-click to edit user messages
document.addEventListener('dblclick', e => {
  const bubble = e.target.closest('.message.user .bubble');
  if (bubble) editUserMsg(bubble);
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  TYPING SPEED INDICATOR
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let typingTimer = null;
document.addEventListener('DOMContentLoaded', () => {
  const ta = document.getElementById('userInput');
  let lastLen = 0, wpm = 0, charTimes = [];
  ta.addEventListener('input', () => {
    const now = Date.now();
    charTimes.push(now);
    if (charTimes.length > 20) charTimes.shift();
    if (charTimes.length >= 5) {
      const elapsed = (now - charTimes[0]) / 60000;
      const chars = charTimes.length;
      wpm = Math.round((chars / 5) / elapsed);
    }
    lastLen = ta.value.length;
  });
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  KEYBOARD: CTRL+M FOR CREATIVE, CTRL+F FOR FOCUS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.addEventListener('keydown', e => {
  if ((e.ctrlKey||e.metaKey) && e.key === 'm') { e.preventDefault(); toggleCreativeMode(); }
  if ((e.ctrlKey||e.metaKey) && e.key === 'f' && !['INPUT','TEXTAREA'].includes(document.activeElement.tagName)) { e.preventDefault(); toggleFocusMode(); }
  if ((e.ctrlKey||e.metaKey) && e.key === 'i') { e.preventDefault(); forkChat(); }
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SMART REPLY SUGGESTIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showSmartReplies(context) {
  const existing = document.getElementById('smartReplies');
  if (existing) existing.remove();
  const suggestions = [
    'Tell me more about that',
    'Can you give an example?',
    'How does that work?',
    'What are the downsides?',
    'Summarize in 3 bullet points',
    'Give me a different perspective',
    'What should I do next?',
  ];
  const picks = [...suggestions].sort(() => Math.random()-.5).slice(0, 3);
  const wrap = document.createElement('div');
  wrap.id = 'smartReplies';
  wrap.style.cssText = 'display:flex;gap:8px;flex-wrap:wrap;padding:0 0 4px;animation:msgIn .3s ease;';
  picks.forEach(s => {
    const b = document.createElement('button');
    b.textContent = s;
    b.style.cssText = 'background:var(--bg-c);border:1px solid var(--br);border-radius:var(--rsm);color:var(--tx-t);font-size:12px;font-family:var(--mono);padding:5px 11px;cursor:pointer;transition:all .15s;';
    b.onmouseover = () => { b.style.borderColor='var(--br-s)'; b.style.color='var(--tx-s)'; };
    b.onmouseout = () => { b.style.borderColor='var(--br)'; b.style.color='var(--tx-t)'; };
    b.onclick = () => { const i=document.getElementById('userInput'); i.value=s; i.focus(); updateChar(s); wrap.remove(); };
    wrap.appendChild(b);
  });
  const cont = document.getElementById('chatMessages');
  cont.appendChild(wrap);
  cont.scrollTop = cont.scrollHeight;
  setTimeout(() => wrap.remove(), 12000);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  EXPORT AS MARKDOWN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function exportChatMarkdown() {
  const messages = document.querySelectorAll('#chatMessages .message');
  if (!messages.length) { showToast('Nothing to export'); return; }
  const chatName = getChatName(currentChatId) || 'Indy Chat';
  let md = `# ${chatName}\n*Exported ${new Date().toLocaleString()} ¬∑ Indy AI by JVST co*\n\n---\n\n`;
  messages.forEach(m => {
    const isUser = m.classList.contains('user');
    const bubble = m.querySelector('.bubble');
    if (!bubble) return;
    const clone = bubble.cloneNode(true);
    clone.querySelectorAll('button,.reaction-row,.tts-btn').forEach(x=>x.remove());
    const text = (clone.innerText||'').trim();
    md += `**${isUser ? 'You' : 'Indy'}:** ${text}\n\n`;
  });
  const blob = new Blob([md], { type: 'text/markdown' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `indy-${chatName.replace(/\s+/g,'-').toLowerCase()}.md`;
  a.click();
  URL.revokeObjectURL(a.href);
  showToast('Exported as Markdown ‚Üì');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  AUTO-SAVE INDICATOR
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showSaveIndicator() {
  const el = document.getElementById('saveIndicator');
  if (el) { el.style.opacity = '1'; setTimeout(() => el.style.opacity = '0', 1500); }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MOOD / VIBE DETECTOR (fun feature)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function detectMood(text) {
  const t = text.toLowerCase();
  if (/sad|depressed|lonely|cry|miss|hurt|pain/.test(t)) return 'üíô';
  if (/happy|great|awesome|love|excited|amazing|yes|wooo|hype/.test(t)) return 'üòä';
  if (/angry|hate|annoyed|stupid|damn|wtf|ugh/.test(t)) return 'üò§';
  if (/confused|idk|what|huh|explain|why|how/.test(t)) return 'ü§î';
  if (/code|bug|error|function|class|import|const|def/.test(t)) return 'üíª';
  if (/music|song|album|artist|playlist|beat|vibe/.test(t)) return 'üéµ';
  if (/image|draw|picture|art|create|generate/.test(t)) return 'üé®';
  return null;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  INIT ACCENT & SETTINGS ON LOAD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.addEventListener('DOMContentLoaded', () => {
  applyAccentOnLoad();
  const fs = localStorage.getItem('fontSize');
  if (fs) document.body.style.fontSize = fs + 'px';
  // Add save indicator to status bar
  const sb = document.querySelector('.status-bar .s-spacer');
  if (sb) {
    const si = document.createElement('div');
    si.id = 'saveIndicator';
    si.style.cssText = 'font-family:var(--mono);font-size:10px;color:var(--tx-d);letter-spacing:.04em;opacity:0;transition:opacity .4s;';
    si.textContent = '‚ú¶ saved';
    sb.after(si);
  }
  updateCreativeModeUI();
});

function updateCreativeModeUI() {
  // Input bar button
  const btn = document.getElementById('creativeBtn');
  const statusEl = document.getElementById('statusCreative');
  if (btn) btn.classList.toggle('on', creativeModeOn);
  if (statusEl) statusEl.style.display = creativeModeOn ? 'flex' : 'none';
  // Status bar mini button
  const sbBtn = document.getElementById('creativeBtnSb');
  if (sbBtn) {
    sbBtn.style.color = creativeModeOn ? 'var(--orange)' : 'var(--tx-t)';
    sbBtn.style.borderColor = creativeModeOn ? 'var(--orange)' : 'transparent';
    sbBtn.style.background = creativeModeOn ? 'rgba(240,160,80,0.1)' : 'transparent';
    sbBtn.title = creativeModeOn ? 'Creative Mode ON ‚Äî click to disable' : 'Creative Mode';
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SHORTCUT UPDATE ‚Äî add new shortcuts
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.addEventListener('keydown', e => {
  const typing = ['INPUT','TEXTAREA'].includes(document.activeElement.tagName);
  if(e.key==='/'&&!typing){e.preventDefault();document.getElementById('userInput')?.focus();}
  if(e.key==='?'&&!typing){e.preventDefault();openShortcuts();}
  if((e.ctrlKey||e.metaKey)&&e.key==='k'){e.preventDefault();openSearch();}
  if((e.ctrlKey||e.metaKey)&&e.key==='n'){e.preventDefault();newChat();}
  if((e.ctrlKey||e.metaKey)&&e.key==='e'){e.preventDefault();exportChatHTML();}
  if((e.ctrlKey||e.metaKey)&&e.key==='b'){e.preventDefault();toggleSidebar();}
  if((e.ctrlKey||e.metaKey)&&e.shiftKey&&e.key==='L'){e.preventDefault();toggleTheme();}
  if(e.key==='Escape'){
    document.querySelectorAll('.modal.open').forEach(m=>m.classList.remove('open'));
    document.getElementById('searchOverlay')?.remove();
    document.getElementById('modelPop')?.classList.remove('open');
  }
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CONVERSATION STARTERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const STARTERS = ['Explain something complex simply','Help me debug my code','Write a short story about‚Ä¶','What are the pros and cons of‚Ä¶','Summarize this idea:','Give me 5 ideas for‚Ä¶','How does X work?','Help me write an email about‚Ä¶'];
function renderStarters() {
  const cont = document.getElementById('chatMessages');
  if(!cont||document.getElementById('starterChips')||cont.querySelectorAll('.message').length>1) return;
  const wrap = document.createElement('div'); wrap.id='starterChips';
  [...STARTERS].sort(()=>Math.random()-.5).slice(0,4).forEach(s => {
    const c = document.createElement('button');
    c.style.cssText='background:var(--bg-c);border:1px solid var(--br);border-radius:var(--rsm);color:var(--tx-s);font-size:12.5px;font-family:var(--mono);padding:7px 12px;cursor:pointer;transition:all .15s;';
    c.textContent = s;
    c.onmouseenter=()=>{c.style.borderColor='var(--br-s)';c.style.color='var(--tx)';c.style.background='var(--hv)';};
    c.onmouseleave=()=>{c.style.borderColor='var(--br)';c.style.color='var(--tx-s)';c.style.background='var(--bg-c)';};
    c.onclick=()=>{const i=document.getElementById('userInput');if(i){i.value=s.replace('‚Ä¶','');i.focus();updateChar(i.value);}wrap.remove();};
    wrap.appendChild(c);
  });
  cont.appendChild(wrap);
  cont.scrollTop=cont.scrollHeight;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.addEventListener('DOMContentLoaded', () => {
  loadSavedChats();
  updateSidebarProfile();
  const cl = JSON.parse(localStorage.getItem('chatList')||'[]');
  if(cl.length>0) loadChat(cl[0].id);
  else {
    currentChatId=`chat_${Date.now()}`; conversationHistory=[];
    const list=JSON.parse(localStorage.getItem('chatList')||'[]');
    list.unshift({id:currentChatId,name:'New Chat'});
    localStorage.setItem('chatList',JSON.stringify(list));
    loadSavedChats(); setTimeout(renderStarters,150);
  }
  updateStatusBar();
  getStreak(); // initialize streak on first load of day
});
</script>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  STRANGER THINGS EASTER EGG
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const _udStyle = document.createElement('style');
_udStyle.textContent=`@keyframes chaoticDrift{0%{transform:translate(0,0)scale(1);opacity:.5}30%{opacity:.85}60%{opacity:.35}100%{transform:translate(var(--dx),var(--dy))scale(var(--s));opacity:.5}}@keyframes slowRotate{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}.upside-particle{position:fixed;background:#ffe6e6;pointer-events:none;z-index:9995;border-radius:1px;box-shadow:0 0 12px rgba(255,80,80,.7);animation:chaoticDrift infinite ease-in-out,slowRotate infinite linear;}#red-flood{position:fixed;inset:0;background:#2e0000;pointer-events:none;z-index:10001;opacity:0;transition:opacity 5.2s ease-out;box-shadow:inset 0 0 160px rgba(0,0,0,.98);}#red-flood.fade-in{animation:fadeInRed .9s ease-in forwards;}@keyframes fadeInRed{from{opacity:0}to{opacity:1}}#red-flood.visible{opacity:1;}body.upsidedown{filter:brightness(.78)contrast(1.22)sepia(.15);transition:filter 7s ease-in-out;}`;
document.head.appendChild(_udStyle);
let _udActive=false;
function enterUpsideDown(){
  if(_udActive)return; _udActive=true;
  const flood=document.createElement('div'); flood.id='red-flood'; document.body.appendChild(flood); flood.classList.add('fade-in');
  setTimeout(()=>{document.body.style.transform='rotate(180deg)';document.body.style.transformOrigin='center center';flood.classList.add('visible');},600);
  for(let i=0;i<90;i++) setTimeout(()=>{
    const sz=1.4+Math.random()*5.2,p=document.createElement('div'); p.className='upside-particle';
    const dx=(Math.random()-.5)*1500,dy=(Math.random()-.5)*1500,sc=.35+Math.random()*2.3,dr=85+Math.random()*170,ro=45+Math.random()*90;
    p.style.cssText=`width:${sz}px;height:${sz}px;left:${Math.random()*100}vw;top:${Math.random()*100}vh;--dx:${dx}px;--dy:${dy}px;--s:${sc};animation-duration:${dr}s,${ro}s;animation-delay:-${Math.random()*dr}s,0s;opacity:.5;`;
    document.body.appendChild(p);
  },i*32);
  setTimeout(()=>{flood.style.opacity='0';setTimeout(()=>{flood.remove();document.body.classList.add('upsidedown');setTimeout(()=>{addMessage('bot',"It swallowed everything.<br><span style='color:#c00;'>You're in the Upside Down.</span><br><small style='opacity:.7'>reload to leave</small>");},1800);},5200);},2800);
}
</script>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  UPDATE POPUP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
(function(){
  const KEY='indy_v5_creative';
  if(localStorage.getItem(KEY)==='true') return;
  const m=document.createElement('div');
  m.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,.87);backdrop-filter:blur(12px);z-index:99999;display:flex;align-items:center;justify-content:center;opacity:0;transition:opacity .4s;';
  const c=document.createElement('div');
  c.style.cssText='background:rgba(22,22,22,.97);border:1px solid rgba(255,255,255,.12);border-radius:20px;max-width:480px;width:92%;padding:32px 28px;text-align:center;transform:scale(.93);transition:all .4s cubic-bezier(.34,1.56,.64,1);max-height:90vh;overflow-y:auto;';
  c.innerHTML=`<div style="font-size:44px;margin-bottom:14px;">‚ú¶</div>
<h2 style="font-family:'IBM Plex Mono',monospace;font-weight:600;font-size:21px;margin-bottom:14px;letter-spacing:.04em;text-transform:uppercase;">Indy ‚Äî Creative Update</h2>
<p style="font-size:13px;color:#bbb;line-height:1.65;margin-bottom:20px;">20+ new features. Model selector fixed. Image gen actually works now. ü§†</p>
<ul style="text-align:left;margin:0 auto 24px;padding-left:0;font-size:13px;color:#ccc;line-height:1.9;list-style:none;max-width:360px;">
${['‚ú¶ Creative Mode ‚Äî Indy goes full artist mode','‚óé Focus Mode ‚Äî hide everything, just vibe','üé® Accent color picker ‚Äî 7 colors','üìä Stats panel ‚Äî streaks, counts, all of it','‚ö° Quick Actions ‚Äî TL;DR, ELI5, translate, bullets','üí° Smart Reply suggestions after messages','‚ëÇ Fork Chat ‚Äî branch any conversation','‚úé Double-click user messages to re-edit','‚Üì Export as Markdown (in addition to HTML)','‚§¥ Share button on Indy replies','üñº Image gen fixed ‚Äî retry & variate buttons','üî¢ Word count in input bar','‚åòM Creative Mode shortcut','‚åòF Focus Mode shortcut','‚åòI Fork Chat shortcut','‚úì Model label actually shows in status bar','‚úì Mood indicator in status bar','‚úì Save indicator (shows when chat saves)','‚úì System prompt uses real model name now','‚úì Font size & bubble style settings'].map(f=>`<li style="padding:2px 0;">‚Üí ${f}</li>`).join('')}
</ul>
<button id="closeUpdate" style="background:#f0f0f0;color:#000;border:none;padding:13px 48px;font-size:13px;font-weight:700;letter-spacing:.06em;text-transform:uppercase;border-radius:50px;cursor:pointer;font-family:'IBM Plex Mono',monospace;">Let's cook ü§†</button>`;
  m.appendChild(c); document.body.appendChild(m);
  setTimeout(()=>{m.style.opacity='1';c.style.transform='scale(1)';},60);
  document.getElementById('closeUpdate').onclick=()=>{localStorage.setItem(KEY,'true');m.style.opacity='0';setTimeout(()=>m.remove(),400);};
  m.onclick=e=>{if(e.target===m){localStorage.setItem(KEY,'true');m.style.opacity='0';setTimeout(()=>m.remove(),400);}};
})();
</script>
<!-- ‚ïê‚ïê‚ïê TOOLS POPOVER ‚ïê‚ïê‚ïê -->
<div id="toolsPopover" style="display:none;position:fixed;top:38px;right:8px;z-index:500;background:var(--bg-c);border:1px solid var(--br-s);border-radius:var(--rlg);box-shadow:0 8px 32px rgba(0,0,0,.55);width:210px;overflow:hidden;animation:mSlideIn .18s cubic-bezier(.2,.8,.4,1);">
  <div style="padding:8px 12px 6px;font-size:10px;font-family:var(--mono);font-weight:600;letter-spacing:.1em;text-transform:uppercase;color:var(--tx-t);border-bottom:1px solid var(--br);">Tools</div>
  <div style="padding:5px 6px;">
    <button class="tp-btn" onclick="openTemplates();closeToolsMenu()">üìã Templates</button>
    <button class="tp-btn" onclick="openCode();closeToolsMenu()">‚óà Code Sandbox</button>
    <button class="tp-btn" onclick="openSummary();closeToolsMenu()">‚ú¶ Summarize Chat</button>
    <button class="tp-btn" onclick="forkChat();closeToolsMenu()">‚ëÇ Fork Chat</button>
    <button class="tp-btn" onclick="openTeach();closeToolsMenu()">‚úé Teach Indy</button>
    <button class="tp-btn" onclick="importChat();closeToolsMenu()">‚§¥ Import Chat</button>
  </div>
  <div style="padding:0 6px 2px;border-top:1px solid var(--br);margin-top:2px;padding-top:5px;">
    <button class="tp-btn" onclick="exportChatHTML();closeToolsMenu()">‚Üì Export HTML</button>
    <button class="tp-btn" onclick="exportChatMarkdown();closeToolsMenu()">‚Üì Export Markdown</button>
  </div>
  <div style="padding:0 6px 2px;border-top:1px solid var(--br);margin-top:2px;padding-top:5px;">
    <button class="tp-btn" onclick="openStats();closeToolsMenu()">üìä Stats</button>
    <button class="tp-btn" onclick="openThemePicker();closeToolsMenu()">üé® Theme & Accent</button>
    <button class="tp-btn" onclick="openProfile();closeToolsMenu()">‚õ≠ Settings</button>
    <button class="tp-btn" onclick="showLastWebResults();closeToolsMenu()">üîç Web Results</button>
  </div>
  <div style="padding:0 6px 6px;border-top:1px solid var(--br);margin-top:2px;padding-top:5px;">
    <button class="tp-btn" style="color:var(--red);" onclick="deleteAllChats();closeToolsMenu()">‚®Ø Clear All Chats</button>
  </div>
</div>
<style>
.tp-btn{width:100%;background:transparent;border:none;text-align:left;padding:7px 10px;color:var(--tx-s);font-size:13px;font-family:var(--font);cursor:pointer;border-radius:var(--rsm);transition:all .12s;display:block;}
.tp-btn:hover{background:var(--hv);color:var(--tx);}
</style>
<div id="musicPlayerBar" style="display:none;position:fixed;bottom:0;right:0;left:260px;transition:left .3s cubic-bezier(.4,0,.2,1);z-index:11;background:var(--bg-e);border-top:1px solid var(--br);padding:10px 20px;align-items:center;gap:14px;backdrop-filter:blur(8px);">
  <div id="musicAlbumArt" style="width:42px;height:42px;border-radius:6px;background:var(--bg-c);border:1px solid var(--br);flex-shrink:0;overflow:hidden;"><img id="musicAlbumImg" src="" style="width:100%;height:100%;object-fit:cover;display:none;"></div>
  <div style="flex:1;min-width:0;">
    <div id="musicTrackName" style="font-size:13px;font-weight:500;color:var(--tx);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">No track playing</div>
    <div id="musicArtistName" style="font-size:11px;color:var(--tx-t);font-family:var(--mono);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">‚Äî</div>
  </div>
  <audio id="musicAudio" preload="none" onended="musicEnded()"></audio>
  <button onclick="toggleMusicPlayback()" id="musicPlayBtn" style="background:var(--tx);color:var(--bg);border:none;border-radius:50%;width:36px;height:36px;font-size:14px;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all .15s;">‚ñ∂</button>
  <div id="musicProgress" style="flex:2;height:3px;background:var(--br-s);border-radius:2px;cursor:pointer;position:relative;min-width:60px;" onclick="seekMusic(event)">
    <div id="musicProgressFill" style="height:100%;background:var(--accent);border-radius:2px;width:0%;transition:width .5s linear;"></div>
  </div>
  <span id="musicTime" style="font-family:var(--mono);font-size:10px;color:var(--tx-t);flex-shrink:0;">0:00</span>
  <a id="musicDeezerLink" href="#" target="_blank" style="font-family:var(--mono);font-size:11px;color:var(--accent);text-decoration:none;flex-shrink:0;" title="Open on Deezer">‚Üó</a>
  <button onclick="closeMusicPlayer()" style="background:transparent;border:none;color:var(--tx-d);cursor:pointer;font-size:16px;font-family:var(--mono);padding:4px;line-height:1;">√ó</button>
</div>

<!-- ‚ïê‚ïê‚ïê MUSIC SEARCH MODAL ‚ïê‚ïê‚ïê -->
<div class="modal" id="musicModal">
  <div class="modal-box" style="max-width:520px;">
    <button class="close-x" onclick="closeModal('musicModal')">√ó</button>
    <h2>üéµ Music Search</h2>
    <div class="field">
      <label>Search tracks, artists, albums</label>
      <div style="display:flex;gap:8px;">
        <input type="text" id="musicSearchIn" placeholder="e.g. Bruno Mars, Doja Cat, lo-fi chill‚Ä¶" onkeydown="if(event.key==='Enter')searchMusicDeezer()">
        <button class="submit-btn" style="width:auto;padding:10px 18px;margin:0;" onclick="searchMusicDeezer()">Search</button>
      </div>
    </div>
    <div id="musicResults" style="display:flex;flex-direction:column;gap:8px;max-height:340px;overflow-y:auto;margin-top:4px;"></div>
    <p style="font-family:var(--mono);font-size:10px;color:var(--tx-d);margin-top:12px;text-align:center;">30s previews via Deezer ¬∑ Use /play [song] or !play [song] in chat</p>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê WEB SEARCH RESULTS MODAL ‚ïê‚ïê‚ïê -->
<div class="modal" id="webResultsModal">
  <div class="modal-box" style="max-width:600px;">
    <button class="close-x" onclick="closeModal('webResultsModal')">√ó</button>
    <h2>üåê Web Search Results</h2>
    <div id="webSearchQuery" style="font-family:var(--mono);font-size:11px;color:var(--tx-t);margin-bottom:12px;"></div>
    <div id="webResultsList" style="display:flex;flex-direction:column;gap:10px;max-height:400px;overflow-y:auto;"></div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê SCROLL TO TOP BTN ‚ïê‚ïê‚ïê -->
<button id="scrollTopBtn" onclick="scrollToTop()" title="Scroll to top" style="display:none;position:fixed;bottom:160px;right:24px;z-index:200;width:38px;height:38px;border-radius:50%;background:var(--bg-c);border:1px solid var(--br-s);color:var(--tx-s);font-size:16px;cursor:pointer;box-shadow:0 4px 16px rgba(0,0,0,.4);transition:all .2s;align-items:center;justify-content:center;">‚Üë</button>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  NEW FEATURES BLOCK
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// ‚îÄ‚îÄ Sidebar left offset for music bar ‚îÄ‚îÄ
const sidebar2 = document.getElementById('sidebar');
function updateMusicBarOffset() {
  const bar = document.getElementById('musicPlayerBar');
  if (bar && bar.style.display !== 'none') {
    bar.style.left = sidebar2.classList.contains('collapsed') ? '60px' : '260px';
  }
}
const _origToggleSidebar = toggleSidebar;
// patch toggleSidebar to also update music bar
document.getElementById('sidebar').addEventListener('transitionend', updateMusicBarOffset);

// ‚îÄ‚îÄ FILE INPUT ATTACH ‚îÄ‚îÄ
function handleFileInput(input) {
  const file = input.files[0];
  if (!file) return;
  const ext = '.' + file.name.split('.').pop().toLowerCase();
  const ALLOWED = ['.txt','.md','.csv','.json','.html','.js','.py','.ts','.css','.xml'];
  if (!ALLOWED.includes(ext)) { showToast(`File type ${ext} not supported`); input.value=''; return; }
  if (file.size > 500000) { showToast('File too large ‚Äî max 500KB'); input.value=''; return; }
  file.text().then(text => {
    const truncated = text.length > 8000 ? text.substring(0, 8000) + '\n\n[‚Ä¶file truncated at 8000 chars]' : text;
    const prompt = `I've attached a file called "${file.name}". Here's its contents:\n\n\`\`\`\n${truncated}\n\`\`\`\n\nPlease analyze it and tell me what this file is and anything notable about it.`;
    document.getElementById('userInput').value = prompt;
    updateChar(prompt);
    document.getElementById('userInput').focus();
    showToast(`üìé "${file.name}" attached ‚Äî hit send!`);
    input.value = '';
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  DUCKDUCKGO WEB SEARCH (real search when web mode is on)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function duckDuckGoSearch(query) {
  try {
    // DuckDuckGo Instant Answer API (no-cors workaround via allorigins)
    const encoded = encodeURIComponent(query);
    const url = `https://api.allorigins.win/get?url=${encodeURIComponent(`https://api.duckduckgo.com/?q=${encoded}&format=json&no_redirect=1&no_html=1`)}`;
    const res = await fetch(url);
    const wrapper = await res.json();
    const data = JSON.parse(wrapper.contents);
    
    let results = [];
    // Abstract (main result)
    if (data.AbstractText) {
      results.push({ title: data.Heading || query, snippet: data.AbstractText, url: data.AbstractURL || data.AbstractSource || '#', source: data.AbstractSource });
    }
    // Related topics
    if (data.RelatedTopics) {
      data.RelatedTopics.slice(0, 5).forEach(t => {
        if (t.Text && t.FirstURL) {
          results.push({ title: t.Text.substring(0, 60), snippet: t.Text, url: t.FirstURL, source: 'DuckDuckGo' });
        }
      });
    }
    // Answer (e.g. calculations, definitions)
    if (data.Answer) {
      results.unshift({ title: 'Answer', snippet: data.Answer, url: '#', source: 'DuckDuckGo Answer' });
    }
    // Infobox
    if (data.Infobox?.content) {
      data.Infobox.content.slice(0, 3).forEach(item => {
        if (item.label && item.value) results.push({ title: item.label, snippet: item.value, url: '#', source: 'Infobox' });
      });
    }
    return results.slice(0, 6);
  } catch(e) {
    console.error('DDG search error:', e);
    return [];
  }
}

function extractSearchQuery(userMsg) {
  // Remove common conversational prefixes
  let q = userMsg
    .replace(/^(hi indy[,!]?\s*|hey indy[,!]?\s*|indy[,!]?\s*|hello[,!]?\s*)/i, '')
    .replace(/^(can you (tell me|find|search|look up|check|what is|who is|when did|where is|how do)\s*)/i, '')
    .replace(/^(what('?s| is| are)\s+)/i, '')
    .replace(/^(who('?s| is)\s+)/i, '')
    .replace(/^(when (did|was|is)\s+)/i, '')
    .replace(/^(where (is|was|are)\s+)/i, '')
    .replace(/^(how (do|does|did|is|are|to)\s+)/i, '')
    .replace(/\?+$/, '')
    .trim();
  // If still long, take first ~60 chars up to natural break
  if (q.length > 60) {
    const shortened = q.substring(0, 60);
    const lastSpace = shortened.lastIndexOf(' ');
    q = lastSpace > 20 ? shortened.substring(0, lastSpace) : shortened;
  }
  return q || userMsg.substring(0, 50);
}

// Web-search-enhanced getAIResponse (replaces original above)
async function getAIResponse(userMessage) {
  let messageToSend = userMessage;
  
  if (webModeOn) {
    const query = extractSearchQuery(userMessage);
    showToast(`üîç Searching: "${query}"‚Ä¶`, 2000);
    const results = await duckDuckGoSearch(query);
    if (results.length > 0) {
      const searchContext = results.map((r, i) => `[${i+1}] **${r.title}**\n${r.snippet}\nSource: ${r.source || r.url}`).join('\n\n');
      messageToSend = `${userMessage}\n\n[WEB SEARCH RESULTS for "${query}":\n${searchContext}\n\nUse these results to give an accurate, up-to-date answer. Cite sources naturally. If results aren't relevant, use your own knowledge.]`;
      lastWebResults = results; lastWebQuery = query;
    }
  }
  
  // --- Core Groq API call (inlined from original) ---
  conversationHistory.push({ role: 'user', content: messageToSend });
  if (conversationHistory.length > 40) conversationHistory = conversationHistory.slice(-40);
  addTokens(messageToSend);
  try {
    const res = await fetch('https://api.groq.com/openai/v1/chat/completions', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer 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' },
      body: JSON.stringify({
        model: 'llama-3.3-70b-versatile',
        messages: [{ role: 'system', content: getSystemPrompt() }, ...conversationHistory],
        temperature: creativeModeOn ? 1.1 : 0.72, max_tokens: 2048
      })
    });
    if (!res.ok) { conversationHistory.pop(); throw new Error(`HTTP ${res.status}`); }
    const data = await res.json();
    const reply = data.choices?.[0]?.message?.content?.trim() || '‚Ä¶';
    conversationHistory.push({ role: 'assistant', content: reply });
    addTokens(reply);
    return reply;
  } catch (err) {
    console.error(err);
    return 'Indy is taking a breather ‚Äî try again in a moment ‚ú¶';
  }
}
let lastWebResults = [], lastWebQuery = '';

function showLastWebResults() {
  if (!lastWebResults.length) { showToast('No web results yet'); return; }
  const el = document.getElementById('webResultsList');
  document.getElementById('webSearchQuery').textContent = `Query: "${lastWebQuery}"`;
  el.innerHTML = lastWebResults.map(r => `
    <div style="background:var(--bg-e);border:1px solid var(--br);border-radius:8px;padding:12px 14px;">
      <div style="font-size:13px;font-weight:500;color:var(--tx);margin-bottom:4px;">${escapeHTML(r.title)}</div>
      <div style="font-size:12.5px;color:var(--tx-s);line-height:1.5;margin-bottom:6px;">${escapeHTML(r.snippet.substring(0,200))}${r.snippet.length>200?'‚Ä¶':''}</div>
      ${r.url && r.url !== '#' ? `<a href="${r.url}" target="_blank" rel="noopener" style="font-family:var(--mono);font-size:10px;color:var(--accent);">${escapeHTML(r.source||r.url).substring(0,60)}</a>` : `<span style="font-family:var(--mono);font-size:10px;color:var(--tx-d);">${escapeHTML(r.source||'DuckDuckGo')}</span>`}
    </div>`).join('');
  openModal('webResultsModal');
}

// Add web results button to status bar web mode item
document.addEventListener('DOMContentLoaded', () => {
  const webModeStatus = document.getElementById('statusWebMode');
  if (webModeStatus) {
    webModeStatus.title = 'Click to view last search results';
    webModeStatus.onclick = () => { if (lastWebResults.length) showLastWebResults(); else toggleWebMode(); };
  }
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  DEEZER MUSIC PLAYER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let currentTrack = null, musicPlaying = false;

async function searchMusicDeezer(query) {
  if (!query) query = document.getElementById('musicSearchIn')?.value?.trim();
  if (!query) return;
  const resultsEl = document.getElementById('musicResults');
  if (resultsEl) resultsEl.innerHTML = '<div style="color:var(--tx-t);font-family:var(--mono);font-size:13px;text-align:center;padding:20px;">Searching‚Ä¶</div>';
  
  try {
    const url = `https://api.allorigins.win/get?url=${encodeURIComponent(`https://api.deezer.com/search?q=${encodeURIComponent(query)}&limit=8`)}`;
    const res = await fetch(url);
    const wrapper = await res.json();
    const data = JSON.parse(wrapper.contents);
    
    if (!data.data || !data.data.length) {
      if (resultsEl) resultsEl.innerHTML = '<div style="color:var(--tx-t);font-family:var(--mono);font-size:13px;text-align:center;padding:20px;">No results found</div>';
      return;
    }
    
    if (resultsEl) {
      resultsEl.innerHTML = data.data.map((track, i) => `
        <div class="music-result-item" style="display:flex;align-items:center;gap:10px;padding:8px 10px;border-radius:8px;border:1px solid var(--br);cursor:pointer;transition:all .15s;" 
             onclick="playTrack('${track.preview||''}','${escapeAttr(track.title)}','${escapeAttr(track.artist?.name||'Unknown')}','${track.album?.cover_medium||''}','${track.link||'#'}')"
             onmouseover="this.style.background='var(--hv)';this.style.borderColor='var(--br-s)'"
             onmouseout="this.style.background='';this.style.borderColor='var(--br)'">
          <img src="${track.album?.cover_small||''}" style="width:40px;height:40px;border-radius:4px;object-fit:cover;flex-shrink:0;" onerror="this.style.display='none'">
          <div style="flex:1;min-width:0;">
            <div style="font-size:13px;font-weight:500;color:var(--tx);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${escapeHTML(track.title)}</div>
            <div style="font-size:11px;color:var(--tx-t);font-family:var(--mono);">${escapeHTML(track.artist?.name||'Unknown')} ¬∑ ${escapeHTML(track.album?.title||'')}</div>
          </div>
          <span style="font-family:var(--mono);font-size:10px;color:var(--tx-d);">${track.preview ? '‚ñ∂ 30s' : 'no preview'}</span>
        </div>`).join('');
    }
  } catch(e) {
    if (resultsEl) resultsEl.innerHTML = '<div style="color:var(--red);font-family:var(--mono);font-size:13px;text-align:center;padding:20px;">Search failed ‚Äî check connection</div>';
  }
}

function escapeAttr(s) { return (s||'').replace(/'/g,"\\'").replace(/"/g,'&quot;'); }

function playTrack(preview, title, artist, albumArt, deezerLink) {
  if (!preview) { showToast('No preview available for this track'); return; }
  currentTrack = { preview, title, artist, albumArt, deezerLink };
  
  const bar = document.getElementById('musicPlayerBar');
  bar.style.display = 'flex';
  updateMusicBarOffset();
  
  document.getElementById('musicTrackName').textContent = title;
  document.getElementById('musicArtistName').textContent = artist;
  const img = document.getElementById('musicAlbumImg');
  if (albumArt) { img.src = albumArt; img.style.display = 'block'; } else { img.style.display = 'none'; }
  document.getElementById('musicDeezerLink').href = deezerLink;
  
  const audio = document.getElementById('musicAudio');
  audio.src = preview;
  audio.play();
  musicPlaying = true;
  document.getElementById('musicPlayBtn').textContent = '‚è∏';
  
  audio.ontimeupdate = () => {
    const pct = audio.duration ? (audio.currentTime / audio.duration) * 100 : 0;
    document.getElementById('musicProgressFill').style.width = pct + '%';
    const mins = Math.floor(audio.currentTime/60), secs = Math.floor(audio.currentTime%60);
    document.getElementById('musicTime').textContent = `${mins}:${secs.toString().padStart(2,'0')}`;
  };
  
  // Also update chat padding
  document.querySelector('.chat-container').style.paddingBottom = '210px';
  document.querySelector('.input-area').style.bottom = '54px';
  
  closeModal('musicModal');
  showToast(`üéµ Now playing: ${title} ‚Äî ${artist}`);
  _syncMusicBtn(true);
}

function toggleMusicPlayback() {
  const audio = document.getElementById('musicAudio');
  if (!audio.src) return;
  if (musicPlaying) { audio.pause(); musicPlaying = false; document.getElementById('musicPlayBtn').textContent = '‚ñ∂'; }
  else { audio.play(); musicPlaying = true; document.getElementById('musicPlayBtn').textContent = '‚è∏'; }
}

function musicEnded() {
  musicPlaying = false;
  document.getElementById('musicPlayBtn').textContent = '‚ñ∂';
  document.getElementById('musicProgressFill').style.width = '0%';
  document.getElementById('musicTime').textContent = '0:00';
  showToast('Track ended ‚ú¶');
}

function seekMusic(e) {
  const audio = document.getElementById('musicAudio');
  if (!audio.duration) return;
  const bar = e.currentTarget;
  const pct = e.offsetX / bar.offsetWidth;
  audio.currentTime = pct * audio.duration;
}

function _syncMusicBtn(active) {
  const sbBtn = document.getElementById('musicBtnSb');
  if (!sbBtn) return;
  sbBtn.style.color = active ? 'var(--green)' : 'var(--tx-t)';
  sbBtn.style.borderColor = active ? 'var(--green)' : 'transparent';
  sbBtn.style.background = active ? 'rgba(80,232,150,0.1)' : 'transparent';
}

function closeMusicPlayer() {
  const audio = document.getElementById('musicAudio');
  audio.pause(); audio.src = '';
  musicPlaying = false;
  document.getElementById('musicPlayerBar').style.display = 'none';
  document.querySelector('.chat-container').style.paddingBottom = '';
  document.querySelector('.input-area').style.bottom = '';
  _syncMusicBtn(false);
}

function toggleMusicPlayer() {
  const bar = document.getElementById('musicPlayerBar');
  if (bar.style.display === 'flex') {
    closeMusicPlayer();
  } else {
    openModal('musicModal');
    document.getElementById('musicSearchIn')?.focus();
  }
}

// Build "Play Song" button for Dart 1w responses
function buildPlaySongButton(songQuery) {
  const enc = encodeURIComponent(songQuery).replace(/'/g,"\\'");
  return `<button onclick="openMusicSearch('${enc}')" style="display:inline-flex;align-items:center;gap:6px;background:var(--bg-c);border:1px solid var(--br-s);color:var(--accent);font-family:var(--mono);font-size:12px;padding:5px 12px;border-radius:20px;cursor:pointer;margin-top:8px;transition:all .15s;" onmouseover="this.style.background='var(--accent-d)'" onmouseout="this.style.background='var(--bg-c)'">üéµ Play Song</button>`;
}
function openMusicSearch(encodedQuery) {
  const q = decodeURIComponent(encodedQuery);
  openModal('musicModal');
  const inp = document.getElementById('musicSearchIn');
  if (inp) { inp.value = q; searchMusicDeezer(q); }
}

// ‚îÄ‚îÄ Patch replaceLastBot to inject Play button for Dart 1w ‚îÄ‚îÄ
// Dart 1w music button injection + original replaceLastBot logic
function replaceLastBot(text) {
  // --- Original replaceLastBot logic ---
  const last = document.querySelector('.message.bot:last-child .bubble');
  if (!last) return;
  const rendered = renderMarkdown(text);
  last.innerHTML = rendered + botActions();
  processCodeBlocks(last);
  document.getElementById('chatMessages').scrollTop = 99999;
  saveCurrentChat();
  // --- Dart 1w: inject Play Song button ---
  if (modelDropdownValue === 'Dart 1w') {
    const songMatch = text.match(/["""]([^"""]+)["""]\s*(?:by|‚Äî|-)\s*([A-Za-z\s]+)/i) ||
                      text.match(/(?:song|track|album|listen to)\s+["""]?([A-Za-z0-9\s&',-]{3,40})["""]?\s*(?:by\s+([A-Za-z\s]+))?/i);
    if (songMatch) {
      const songTitle = songMatch[1]?.trim();
      const artist = songMatch[2]?.trim() || '';
      const query = artist ? `${songTitle} ${artist}` : songTitle;
      const lastBubble = document.querySelector('.message.bot:last-child .bubble');
      if (lastBubble && query) {
        const playDiv = document.createElement('div');
        playDiv.innerHTML = buildPlaySongButton(query);
        lastBubble.appendChild(playDiv);
      }
    }
  }
}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SCROLL TO TOP BUTTON
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function scrollToTop() {
  const cont = document.getElementById('chatMessages');
  cont.scrollTo({ top: 0, behavior: 'smooth' });
}
document.addEventListener('DOMContentLoaded', () => {
  const cont = document.getElementById('chatMessages');
  const btn = document.getElementById('scrollTopBtn');
  if (cont && btn) {
    cont.addEventListener('scroll', () => {
      btn.style.display = cont.scrollTop > 400 ? 'flex' : 'none';
    });
  }
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  INPUT HISTORY (up/down arrows to navigate)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const inputHistory = JSON.parse(localStorage.getItem('inputHistory') || '[]');
let inputHistoryIdx = -1;
// ‚îÄ‚îÄ Input history navigation (up/down arrow)
const _origSendMessage3_unused = null; // placeholder removed
const _patchedForHistory_unused = null;

document.addEventListener('DOMContentLoaded', () => {
  const ta = document.getElementById('userInput');
  ta.addEventListener('keydown', e => {
    if (e.key === 'ArrowUp' && !e.shiftKey && ta.value === '') {
      e.preventDefault();
      if (inputHistoryIdx < inputHistory.length - 1) {
        inputHistoryIdx++;
        ta.value = inputHistory[inputHistoryIdx] || '';
        updateChar(ta.value);
        ta.style.height = 'auto';
        ta.style.height = Math.min(ta.scrollHeight, 120) + 'px';
      }
    } else if (e.key === 'ArrowDown' && inputHistoryIdx >= 0) {
      e.preventDefault();
      inputHistoryIdx--;
      ta.value = inputHistoryIdx >= 0 ? (inputHistory[inputHistoryIdx] || '') : '';
      updateChar(ta.value);
    } else {
      inputHistoryIdx = -1;
    }
  });
});

// ‚îÄ‚îÄ Patch addMessage: input history + unread badge + reading time notify
// NOTE: This function declaration replaces the original addMessage above.
// The original logic is inlined here to avoid recursion.
function addMessage(sender, text, save=true, ts='') {
  // Save to input history
  if (sender === 'user' && text) {
    inputHistory.unshift(text);
    if (inputHistory.length > 50) inputHistory.pop();
    localStorage.setItem('inputHistory', JSON.stringify(inputHistory.slice(0,50)));
  }
  // --- Original addMessage logic ---
  const cont = document.getElementById('chatMessages');
  const div = document.createElement('div');
  div.className = `message ${sender}`;
  div.dataset.ts = ts || new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
  const rendered = sender === 'bot' ? renderMarkdown(text) : escapeHTML(text).replace(/\n/g,'<br>');
  if (sender === 'bot') {
    div.innerHTML = `<div class="bubble">${rendered}${botActions()}</div><div class="ts">${div.dataset.ts}</div>`;
    processCodeBlocks(div.querySelector('.bubble'));
  } else {
    div.innerHTML = `<div class="bubble">${rendered}</div><div class="ts">${div.dataset.ts}</div>`;
  }
  cont.appendChild(div);
  cont.scrollTop = cont.scrollHeight;
  if (save) saveCurrentChat();
  // --- End original logic ---
  // Unread badge
  if (sender === 'bot' && document.visibilityState !== 'visible') {
    unreadCount++;
    document.title = `(${unreadCount}) INDY AI`;
  }
}
const COMMANDS = [
  { cmd: '/play', desc: 'Play music ‚Äî /play [song or artist]' },
  { cmd: '/weather', desc: 'Get weather ‚Äî /weather [city]' },
  { cmd: '/gif', desc: 'Search GIFs ‚Äî /gif [keyword]' },
  { cmd: '/define', desc: 'Define a word ‚Äî /define [word]' },
  { cmd: '/calc', desc: 'Calculate ‚Äî /calc [expression]' },
];

document.addEventListener('DOMContentLoaded', () => {
  const ta = document.getElementById('userInput');
  let hintBox = null;
  ta.addEventListener('input', () => {
    const val = ta.value;
    if (val.startsWith('/') || val.startsWith('!')) {
      const matches = COMMANDS.filter(c => c.cmd.startsWith(val.split(' ')[0].replace('!','/')));
      if (matches.length && !val.includes(' ')) {
        if (!hintBox) {
          hintBox = document.createElement('div');
          hintBox.id = 'cmdHints';
          hintBox.style.cssText = 'position:absolute;bottom:100%;left:0;right:0;background:var(--bg-c);border:1px solid var(--br-s);border-radius:10px 10px 0 0;overflow:hidden;z-index:20;';
          document.querySelector('.input-wrapper').style.position = 'relative';
          document.querySelector('.input-wrapper').appendChild(hintBox);
        }
        hintBox.innerHTML = matches.map(m => `
          <div onclick="fillCommand('${m.cmd}')" style="padding:9px 14px;cursor:pointer;border-bottom:1px solid var(--br);display:flex;gap:10px;align-items:center;" onmouseover="this.style.background='var(--hv)'" onmouseout="this.style.background=''">
            <span style="font-family:var(--mono);font-size:13px;color:var(--accent);min-width:80px;">${m.cmd}</span>
            <span style="font-size:12px;color:var(--tx-t);">${m.desc.split('‚Äî')[1]||''}</span>
          </div>`).join('');
      } else { hintBox?.remove(); hintBox = null; }
    } else { hintBox?.remove(); hintBox = null; }
  });
});
function fillCommand(cmd) {
  const ta = document.getElementById('userInput');
  ta.value = cmd + ' '; ta.focus();
  document.getElementById('cmdHints')?.remove();
  updateChar(ta.value);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  NOTIFICATION BADGE - unread count
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let unreadCount = 0;
document.addEventListener('visibilitychange', () => {
  if (document.visibilityState === 'visible') {
    unreadCount = 0; document.title = 'INDY AI';
  }
});

// Note: addMessage is already patched above to handle unread + history

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CHAT IMPORT (JSON)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function importChat() {
  const input = document.createElement('input');
  input.type = 'file'; input.accept = '.json';
  input.onchange = async () => {
    const file = input.files[0]; if (!file) return;
    try {
      const text = await file.text();
      const data = JSON.parse(text);
      if (!data.messages) { showToast('Invalid chat JSON format'); return; }
      const newId = `chat_${Date.now()}`;
      data.id = newId;
      data.name = data.name || 'Imported Chat';
      localStorage.setItem(`chat_${newId}`, JSON.stringify(data));
      const cl = JSON.parse(localStorage.getItem('chatList') || '[]');
      cl.unshift({ id: newId, name: data.name });
      localStorage.setItem('chatList', JSON.stringify(cl));
      loadSavedChats();
      loadChat(newId);
      showToast('Chat imported ‚ú¶');
    } catch { showToast('Import failed ‚Äî invalid file'); }
  };
  input.click();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  WORD COUNT ON BOT MESSAGES (reading time)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Inject reading time after bot message renders
const _mutObs = new MutationObserver(mutations => {
  mutations.forEach(m => {
    m.addedNodes.forEach(node => {
      if (node.classList?.contains('message') && node.classList.contains('bot')) {
        const bubble = node.querySelector('.bubble');
        if (!bubble) return;
        const clone = bubble.cloneNode(true);
        clone.querySelectorAll('button,.reaction-row').forEach(x => x.remove());
        const words = ((clone.innerText||'').match(/\w+/g)||[]).length;
        if (words > 50) {
          const readTime = Math.max(1, Math.round(words / 200));
          const ts = node.querySelector('.ts');
          if (ts) ts.textContent = `${ts.textContent} ¬∑ ~${readTime} min read`;
        }
      }
    });
  });
});
document.addEventListener('DOMContentLoaded', () => {
  const cont = document.getElementById('chatMessages');
  if (cont) _mutObs.observe(cont, { childList: true });
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  TOOLS POPOVER MENU
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openToolsMenu() {
  const pop = document.getElementById('toolsPopover');
  if (!pop) return;
  const isOpen = pop.style.display === 'block';
  pop.style.display = isOpen ? 'none' : 'block';
  if (!isOpen) {
    // close on outside click
    setTimeout(() => {
      document.addEventListener('click', _closeToolsOnOutside, { once: true });
    }, 10);
  }
}
function closeToolsMenu() {
  const pop = document.getElementById('toolsPopover');
  if (pop) pop.style.display = 'none';
}
function _closeToolsOnOutside(e) {
  const pop = document.getElementById('toolsPopover');
  if (pop && !pop.contains(e.target)) pop.style.display = 'none';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ADD IMPORT CHAT + sidebar cleanup (no more dynamic injection)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.addEventListener('DOMContentLoaded', () => {
  const modelBtn = document.getElementById('modelBtn');
  if (modelBtn) {
    modelBtn.setAttribute('title', `Model: ${modelDropdownValue}\nClick to change`);
  }
  
  // Add cmd hint helper text to input placeholder dynamically
  const ta = document.getElementById('userInput');
  if (ta) ta.placeholder = 'Ask anything‚Ä¶ or try /play /weather /gif /define (Shift+Enter for new line)';
  
  // Update shortcuts list with new commands
  if (typeof SHORTCUTS !== 'undefined') {
    SHORTCUTS.push(['Play music', '/play [song]'], ['Weather', '/weather [city]'], ['GIF search', '/gif [keyword]'], ['Define word', '/define [word]'], ['Calculate', '/calc [expr]']);
  }
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  UPDATE POPUP ‚Äî patch to include new features
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Clears old version key so popup shows again with new features listed
(function(){
  const NEW_KEY = 'indy_v6_supercharged';
  const OLD_KEY = 'indy_v5_creative';
  if (localStorage.getItem(NEW_KEY) === 'true') return;
  // Only show if they've seen v5 already (existing user) or is new
  const m = document.createElement('div');
  m.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.87);backdrop-filter:blur(12px);z-index:99999;display:flex;align-items:center;justify-content:center;opacity:0;transition:opacity .4s;';
  const c = document.createElement('div');
  c.style.cssText = 'background:rgba(22,22,22,.97);border:1px solid rgba(255,255,255,.12);border-radius:20px;max-width:500px;width:92%;padding:32px 28px;text-align:center;transform:scale(.93);transition:all .4s cubic-bezier(.34,1.56,.64,1);max-height:90vh;overflow-y:auto;';
  c.innerHTML = `<div style="font-size:44px;margin-bottom:14px;">üéµ</div>
<h2 style="font-family:'IBM Plex Mono',monospace;font-weight:600;font-size:21px;margin-bottom:14px;letter-spacing:.04em;text-transform:uppercase;">Indy ‚Äî Supercharged Update</h2>
<p style="font-size:13px;color:#bbb;line-height:1.65;margin-bottom:20px;">Music, real web search, commands, and 20+ more new features ü§†</p>
<ul style="text-align:left;margin:0 auto 24px;padding-left:0;font-size:13px;color:#ccc;line-height:1.9;list-style:none;max-width:380px;">
${['üéµ Music player ‚Äî Deezer 30s previews','üéµ /play [song] command to search music','üéµ Play Song button when Dart 1w recommends','üåê Real DuckDuckGo web search (actually searches!)', 'üîç Query extraction ‚Äî Indy understands questions','üìä View web results panel','‚åò /weather [city] ‚Äî live weather data','üìñ /define [word] ‚Äî dictionary definitions','üé¨ /gif [keyword] ‚Äî GIF search via Tenor','üßÆ /calc [expr] ‚Äî quick calculator','‚å® Command hints popup when typing /','üìé File attach button in toolbar','üìÅ Import chats from JSON','‚¨Ü Input history ‚Äî up/down arrow to navigate','‚Üë Scroll to top button','üìö Reading time on long responses','üîî Unread count in tab title','‚ú¶ Decluttered input bar ‚Äî icon-only','‚ö° Toolbar now fits more without overflow'].map(f=>`<li style="padding:2px 0;">‚Üí ${f}</li>`).join('')}
</ul>
<button id="closeUpdate2" style="background:#f0f0f0;color:#000;border:none;padding:13px 48px;font-size:13px;font-weight:700;letter-spacing:.06em;text-transform:uppercase;border-radius:50px;cursor:pointer;font-family:'IBM Plex Mono',monospace;">Let's vibe üéµ</button>`;
  m.appendChild(c); document.body.appendChild(m);
  setTimeout(() => { m.style.opacity = '1'; c.style.transform = 'scale(1)'; }, 60);
  document.getElementById('closeUpdate2').onclick = () => { localStorage.setItem(NEW_KEY, 'true'); localStorage.setItem(OLD_KEY, 'true'); m.style.opacity = '0'; setTimeout(() => m.remove(), 400); };
  m.onclick = e => { if (e.target === m) { localStorage.setItem(NEW_KEY, 'true'); m.style.opacity = '0'; setTimeout(() => m.remove(), 400); } };
})();
</script>
</body>
</html>
