<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>INDY AI</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600&family=IBM+Plex+Sans:wght@400;500;600&display=swap" rel="stylesheet">
<style>
/* ‚ïê‚ïê‚ïê THEME VARS ‚ïê‚ïê‚ïê */
:root {
  --bg:#080808;--bg-e:#101010;--bg-c:#161616;
  --tx:#f0f0f0;--tx-s:#8a8a8a;--tx-t:#4a4a4a;--tx-d:#2e2e2e;
  --br:rgba(255,255,255,0.07);--br-s:rgba(255,255,255,0.12);--br-f:rgba(255,255,255,0.25);
  --hv:rgba(255,255,255,0.04);--ac:rgba(255,255,255,0.07);
  --accent:#c8c8ff;--accent-d:rgba(200,200,255,0.12);
  --green:#50e896;--red:#e05050;--orange:#f0a050;
  --font:'IBM Plex Sans',system-ui,sans-serif;
  --mono:'IBM Plex Mono',monospace;
  --rsm:6px;--rmd:10px;--rlg:14px;--rxl:20px;
}
[data-theme="light"]{
  --bg:#f2f2ee;--bg-e:#e8e8e4;--bg-c:#dededa;
  --tx:#111;--tx-s:#555;--tx-t:#999;--tx-d:#ccc;
  --br:rgba(0,0,0,0.07);--br-s:rgba(0,0,0,0.13);--br-f:rgba(0,0,0,0.28);
  --hv:rgba(0,0,0,0.04);--ac:rgba(0,0,0,0.07);
  --accent:#4040aa;--accent-d:rgba(64,64,170,0.1);
}
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box;}
html,body{height:100%;}
body{background:var(--bg);color:var(--tx);font-family:var(--font);font-size:14px;line-height:1.6;display:flex;overflow:hidden;transition:background .3s,color .3s;background-image:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(128,128,128,0.01) 2px,rgba(128,128,128,0.01) 4px);}

/* ‚ïê‚ïê‚ïê SIDEBAR ‚ïê‚ïê‚ïê */
.sidebar{position:fixed;inset:0 auto 0 0;width:260px;background:var(--bg-e);border-right:1px solid var(--br);display:flex;flex-direction:column;transition:width .3s cubic-bezier(.4,0,.2,1);z-index:100;overflow:hidden;}
.sidebar.collapsed{width:60px;}
.header{padding:16px;display:flex;align-items:center;gap:12px;min-height:64px;flex-shrink:0;border-bottom:1px solid var(--br);}
.menu-btn{background:transparent;border:1px solid transparent;color:var(--tx-s);font-size:18px;cursor:pointer;padding:8px;border-radius:var(--rsm);transition:all .15s;display:flex;align-items:center;justify-content:center;flex-shrink:0;}
.menu-btn:hover{background:var(--hv);border-color:var(--br-s);color:var(--tx);}
.app-title{font-family:var(--mono);font-size:15px;font-weight:600;letter-spacing:.08em;color:var(--tx);white-space:nowrap;text-transform:uppercase;transition:opacity .2s;}
.sidebar.collapsed .app-title{opacity:0;pointer-events:none;}
.sidebar-content{flex:1;padding:10px;overflow-y:auto;overflow-x:hidden;padding-bottom:90px;}
.sidebar-content::-webkit-scrollbar{width:4px;}
.sidebar-content::-webkit-scrollbar-thumb{background:var(--br-s);border-radius:999px;}
.sidebar.collapsed .sidebar-content>*:not(#chatList){display:none;}
.sidebar.collapsed hr{display:none;}
.sb{width:100%;min-height:40px;background:transparent;border:1px solid transparent;border-radius:var(--rsm);color:var(--tx-s);font-size:13px;font-family:var(--font);font-weight:500;cursor:pointer;transition:all .15s;display:flex;align-items:center;padding:0 12px;gap:10px;margin-bottom:2px;position:relative;}
.sb::before{content:attr(data-icon);font-size:14px;opacity:.7;flex-shrink:0;font-family:var(--mono);width:18px;text-align:center;}
.sb span{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;transition:opacity .2s;}
.sidebar.collapsed .sb span{opacity:0;pointer-events:none;}
.sidebar.collapsed .sb{justify-content:center;padding:0;}
.sidebar.collapsed .sb::before{width:auto;}
.sb:hover{background:var(--hv);border-color:var(--br);color:var(--tx);}
.sb.danger{color:var(--red);}
.sb.danger:hover{background:rgba(224,80,80,.08);border-color:rgba(224,80,80,.2);color:#ff7070;}
.sb.tog-on{color:var(--accent);background:var(--accent-d);border-color:rgba(200,200,255,.2);}
hr{border:none;border-top:1px solid var(--br);margin:8px 0;}
#chatList .sb{justify-content:space-between;padding-right:8px;}
#chatList .sb::before{content:'‚Äî';font-size:11px;color:var(--tx-d);}
#chatList .sb .cn{flex:1;text-align:left;overflow:hidden;text-overflow:ellipsis;}
#chatList .sb .dx{opacity:0;color:var(--red);font-size:14px;padding:3px 7px;border-radius:var(--rsm);background:transparent;border:none;cursor:pointer;font-family:var(--mono);transition:all .15s;flex-shrink:0;}
#chatList .sb:hover .dx{opacity:.6;}
#chatList .sb .dx:hover{opacity:1;background:rgba(224,80,80,.12);}
.profile-footer{position:absolute;bottom:0;left:0;right:0;padding:12px 14px;border-top:1px solid var(--br);display:flex;align-items:center;gap:10px;background:var(--bg-e);cursor:pointer;transition:background .15s;}
.profile-footer:hover{background:var(--hv);}
.sidebar.collapsed .profile-footer{padding:12px 0;justify-content:center;}
.pf-avatar{width:32px;height:32px;border-radius:var(--rsm);background:var(--bg-c);background-size:cover;background-position:center;border:1px solid var(--br-s);flex-shrink:0;}
.pf-info{flex:1;overflow:hidden;}
.sidebar.collapsed .pf-info{display:none;}
.pf-name{font-size:13px;font-weight:500;color:var(--tx-s);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;display:block;font-family:var(--mono);}

/* ‚ïê‚ïê‚ïê MAIN ‚ïê‚ïê‚ïê */
.main{flex:1;margin-left:260px;display:flex;flex-direction:column;transition:margin-left .3s cubic-bezier(.4,0,.2,1);height:100vh;}
.sidebar.collapsed~.main{margin-left:60px;}

/* ‚ïê‚ïê‚ïê STATUS BAR ‚ïê‚ïê‚ïê */
.status-bar{height:30px;background:var(--bg-e);border-bottom:1px solid var(--br);display:flex;align-items:center;padding:0 16px;gap:18px;flex-shrink:0;overflow:hidden;}
.s-item{display:flex;align-items:center;gap:5px;font-family:var(--mono);font-size:10px;color:var(--tx-t);letter-spacing:.05em;white-space:nowrap;cursor:default;}
.s-dot{width:5px;height:5px;border-radius:50%;background:var(--tx-d);flex-shrink:0;}
.s-dot.on{background:var(--green);box-shadow:0 0 4px var(--green);}
.s-dot.warn{background:var(--orange);}
.s-spacer{flex:1;}

/* ‚ïê‚ïê‚ïê CHAT ‚ïê‚ïê‚ïê */
.chat-container{flex:1;overflow-y:auto;padding:32px 28px 150px;display:flex;flex-direction:column;gap:18px;max-width:900px;width:100%;margin:0 auto;align-self:center;}
.chat-container::-webkit-scrollbar{width:5px;}
.chat-container::-webkit-scrollbar-thumb{background:var(--br-s);border-radius:999px;}
.message{max-width:80%;animation:msgIn .2s cubic-bezier(.2,.8,.4,1);}
@keyframes msgIn{from{opacity:0;transform:translateY(5px)}to{opacity:1;transform:translateY(0)}}
.user{align-self:flex-end;}
.bot{align-self:flex-start;}
.bubble{padding:11px 15px;border-radius:var(--rlg);line-height:1.65;font-size:14px;position:relative;}
.user .bubble{background:var(--bg-c);border:1px solid var(--br-s);border-bottom-right-radius:var(--rsm);}
.bot .bubble{background:transparent;border:none;padding:0;}
.ts{display:none;font-family:var(--mono);font-size:10px;color:var(--tx-t);letter-spacing:.04em;margin-top:5px;text-align:right;}
.user:hover .ts,.bot:hover .ts{display:block;}
.copy-btn{position:absolute;top:-4px;right:0;background:var(--bg-c);border:1px solid var(--br);color:var(--tx-t);font-size:11px;font-family:var(--mono);padding:4px 8px;border-radius:var(--rsm);cursor:pointer;opacity:0;transition:all .15s;text-transform:uppercase;letter-spacing:.04em;}
.bot:hover .copy-btn{opacity:1;}
.copy-btn:hover{background:var(--hv);border-color:var(--br-s);color:var(--tx-s);}
.reaction-row{display:flex;gap:4px;margin-top:8px;opacity:0;transition:opacity .15s;}
.bot:hover .reaction-row{opacity:1;}
.rxn{background:transparent;border:1px solid transparent;color:var(--tx-d);font-size:13px;padding:3px 7px;border-radius:var(--rsm);cursor:pointer;font-family:var(--mono);transition:all .12s;}
.rxn:hover{background:var(--hv);border-color:var(--br);color:var(--tx-s);}
.rxn.on{background:var(--accent-d);border-color:var(--accent);color:var(--accent);}
.tts-btn{background:transparent;border:1px solid transparent;color:var(--tx-d);font-size:12px;padding:3px 7px;border-radius:var(--rsm);cursor:pointer;font-family:var(--mono);transition:all .12s;}
.tts-btn:hover{background:var(--hv);border-color:var(--br);color:var(--tx-s);}
.tts-btn.speaking{color:var(--green);border-color:var(--green);background:rgba(80,232,150,.08);}

/* ‚ïê‚ïê‚ïê MARKDOWN IN BOT BUBBLES ‚ïê‚ïê‚ïê */
.bot .bubble h1,.bot .bubble h2,.bot .bubble h3{font-family:var(--mono);font-weight:600;margin:14px 0 6px;color:var(--tx);letter-spacing:.02em;}
.bot .bubble h1{font-size:18px;}
.bot .bubble h2{font-size:16px;}
.bot .bubble h3{font-size:14px;color:var(--tx-s);}
.bot .bubble p{margin:6px 0;}
.bot .bubble ul,.bot .bubble ol{padding-left:20px;margin:6px 0;}
.bot .bubble li{margin:3px 0;}
.bot .bubble strong{color:var(--tx);font-weight:600;}
.bot .bubble em{color:var(--tx-s);font-style:italic;}
.bot .bubble blockquote{border-left:2px solid var(--br-s);padding-left:12px;color:var(--tx-s);margin:8px 0;font-style:italic;}
.bot .bubble a{color:var(--accent);text-decoration:underline;text-decoration-color:rgba(200,200,255,.4);}
.bot .bubble hr{border:none;border-top:1px solid var(--br);margin:12px 0;}
.bot .bubble table{border-collapse:collapse;width:100%;margin:10px 0;font-size:13px;}
.bot .bubble th{background:var(--bg-c);border:1px solid var(--br-s);padding:7px 12px;text-align:left;font-family:var(--mono);font-size:11px;letter-spacing:.06em;text-transform:uppercase;color:var(--tx-t);}
.bot .bubble td{border:1px solid var(--br);padding:7px 12px;color:var(--tx-s);}
.bot .bubble tr:hover td{background:var(--hv);}
.bot .bubble code:not(.hlcode){background:var(--bg-c);border:1px solid var(--br);padding:1px 5px;border-radius:4px;font-family:var(--mono);font-size:12.5px;color:var(--accent);}

/* ‚ïê‚ïê‚ïê CODE BLOCKS ‚ïê‚ïê‚ïê */
.ib-wrap{margin:12px 0;border:1px solid var(--br);border-radius:var(--rmd);overflow:hidden;background:var(--bg-e);}
.ib-head{display:flex;justify-content:space-between;align-items:center;padding:7px 14px;background:rgba(128,128,128,.04);border-bottom:1px solid var(--br);font-size:11px;color:var(--tx-t);font-family:var(--mono);}
.ib-copy{background:transparent;border:1px solid var(--br);color:var(--tx-t);font-size:11px;padding:3px 9px;border-radius:4px;cursor:pointer;transition:all .13s;}
.ib-copy:hover{background:var(--hv);border-color:var(--br-s);color:var(--tx-s);}
.ib-pre{margin:0;padding:14px 16px;overflow-x:auto;line-height:1.55;font-family:var(--mono);font-size:13px;}
.ib-pre code{white-space:pre;}

/* ‚ïê‚ïê‚ïê THINKING ‚ïê‚ïê‚ïê */
.thinking{display:inline-flex;align-items:center;gap:10px;padding:6px 0;color:var(--tx-t);font-size:13px;font-family:var(--mono);}
.think-star{font-size:16px;animation:spin 1.8s linear infinite;color:var(--tx-s);}
@keyframes spin{0%{transform:rotate(0deg);opacity:.4}50%{transform:rotate(180deg);opacity:.9}100%{transform:rotate(360deg);opacity:.4}}
.think-txt{animation:pulse 1.8s ease-in-out infinite;}
@keyframes pulse{0%,100%{opacity:.3}50%{opacity:.8}}

/* ‚ïê‚ïê‚ïê INPUT AREA ‚ïê‚ïê‚ïê */
.input-area{padding:14px 22px 18px;background:var(--bg);border-top:1px solid var(--br);position:fixed;bottom:0;left:260px;right:0;z-index:10;transition:left .3s cubic-bezier(.4,0,.2,1);}
.sidebar.collapsed~.main .input-area{left:60px;}
.input-wrapper{max-width:820px;margin:0 auto;display:flex;gap:8px;align-items:flex-end;background:var(--bg-c);border:1px solid var(--br-s);border-radius:var(--rlg);padding:6px 6px 6px 14px;transition:border-color .2s;}
.input-wrapper:focus-within{border-color:var(--br-f);}
.input-left{display:flex;align-items:center;gap:6px;flex-shrink:0;}
.icon-btn{height:32px;min-width:32px;background:transparent;border:1px solid transparent;color:var(--tx-t);font-size:14px;font-family:var(--mono);cursor:pointer;border-radius:var(--rsm);display:flex;align-items:center;justify-content:center;transition:all .15s;padding:0 8px;gap:5px;white-space:nowrap;}
.icon-btn:hover{background:var(--hv);border-color:var(--br);color:var(--tx-s);}
.icon-btn.on{color:var(--accent);border-color:var(--accent);background:var(--accent-d);}
.icon-btn.mic-on{color:var(--red);border-color:var(--red);background:rgba(224,80,80,.08);animation:micPulse 1s ease infinite;}
@keyframes micPulse{0%,100%{box-shadow:0 0 0 0 rgba(224,80,80,.4)}50%{box-shadow:0 0 0 4px rgba(224,80,80,.1)}}
#userInput{flex:1;background:transparent;border:none;color:var(--tx);font-size:14px;font-family:var(--font);outline:none;caret-color:var(--accent);resize:none;overflow-y:hidden;max-height:120px;line-height:1.5;padding:7px 0;}
#userInput::placeholder{color:var(--tx-t);font-family:var(--mono);font-size:13px;}
.char-cnt{font-family:var(--mono);font-size:10px;color:var(--tx-d);flex-shrink:0;user-select:none;transition:color .2s;align-self:center;}
.char-cnt.warn{color:var(--orange);}
.char-cnt.over{color:var(--red);}
.send-btn{width:34px;height:34px;background:var(--tx);color:var(--bg);border:none;border-radius:var(--rsm);font-size:16px;cursor:pointer;transition:all .15s;display:flex;align-items:center;justify-content:center;flex-shrink:0;align-self:flex-end;}
.send-btn:hover{background:#fff;transform:scale(1.04);}
.send-btn:active{transform:scale(.95);}

/* ‚ïê‚ïê‚ïê FILE DROP OVERLAY ‚ïê‚ïê‚ïê */
.drop-overlay{position:fixed;inset:0;background:rgba(0,0,0,.85);backdrop-filter:blur(12px);z-index:5000;display:none;align-items:center;justify-content:center;flex-direction:column;gap:16px;border:2px dashed var(--accent);pointer-events:none;}
.drop-overlay.active{display:flex;}
.drop-icon{font-size:56px;animation:bounce .8s ease infinite alternate;}
@keyframes bounce{from{transform:translateY(0)}to{transform:translateY(-8px)}}
.drop-text{font-family:var(--mono);font-size:18px;color:var(--accent);letter-spacing:.06em;}

/* ‚ïê‚ïê‚ïê MODEL POPOVER ‚ïê‚ïê‚ïê */
.model-pop{position:absolute;bottom:78px;left:20px;background:var(--bg-c);border:1px solid var(--br-s);border-radius:var(--rlg);box-shadow:0 8px 32px rgba(0,0,0,.6);width:240px;overflow:hidden;z-index:90;opacity:0;visibility:hidden;transform:translateY(8px);transition:all .2s cubic-bezier(.2,.8,.4,1);}
.model-pop.open{opacity:1;visibility:visible;transform:translateY(0);}
.mpop-head{padding:10px 14px;font-size:10px;font-family:var(--mono);font-weight:600;letter-spacing:.1em;text-transform:uppercase;color:var(--tx-t);border-bottom:1px solid var(--br);}
.mitem{width:100%;padding:10px 14px;background:transparent;border:none;text-align:left;color:var(--tx-s);font-size:13px;font-family:var(--font);cursor:pointer;transition:all .12s;position:relative;}
.mitem:hover{background:var(--hv);color:var(--tx);}
.mitem.sel{color:var(--accent);background:var(--accent-d);font-weight:500;}
.mitem.sel::after{content:'‚úì';position:absolute;right:14px;color:var(--accent);font-size:12px;font-family:var(--mono);}
.mpop-foot{padding:8px 14px;font-size:11px;font-family:var(--mono);color:var(--tx-d);text-align:center;border-top:1px solid var(--br);}

/* ‚ïê‚ïê‚ïê MODALS ‚ïê‚ïê‚ïê */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.82);backdrop-filter:blur(12px);display:none;align-items:center;justify-content:center;z-index:1000;}
.modal.open{display:flex;animation:mFadeIn .2s ease;}
@keyframes mFadeIn{from{opacity:0}to{opacity:1}}
.modal-box{background:var(--bg-c);border:1px solid var(--br-s);border-radius:var(--rxl);padding:28px;max-width:500px;width:90%;box-shadow:0 24px 64px rgba(0,0,0,.6);position:relative;animation:mSlideIn .25s cubic-bezier(.2,.8,.4,1);}
@keyframes mSlideIn{from{transform:scale(.96) translateY(14px);opacity:0}to{transform:scale(1) translateY(0);opacity:1}}
.modal-box h2{font-family:var(--mono);font-size:17px;font-weight:600;letter-spacing:.05em;text-transform:uppercase;margin-bottom:22px;}
.close-x{position:absolute;top:18px;right:18px;background:var(--bg-e);border:1px solid var(--br);color:var(--tx-s);font-size:18px;cursor:pointer;width:32px;height:32px;border-radius:var(--rsm);display:flex;align-items:center;justify-content:center;transition:all .15s;font-family:var(--mono);}
.close-x:hover{background:var(--hv);border-color:var(--br-s);color:var(--tx);}
.field{margin-bottom:16px;}
.field label{display:block;margin-bottom:6px;color:var(--tx-t);font-size:11px;font-family:var(--mono);font-weight:500;letter-spacing:.08em;text-transform:uppercase;}
.field input,.field textarea,.field select{width:100%;background:var(--bg-e);border:1px solid var(--br);border-radius:var(--rsm);padding:10px 13px;color:var(--tx);font-size:13.5px;font-family:var(--font);transition:border-color .15s;resize:vertical;}
.field input:focus,.field textarea:focus,.field select:focus{outline:none;border-color:var(--br-f);background:var(--bg);}
.field textarea{min-height:90px;}
.field input::placeholder,.field textarea::placeholder{color:var(--tx-t);font-family:var(--mono);font-size:12.5px;}
.submit-btn{width:100%;background:var(--tx);color:var(--bg);border:none;border-radius:var(--rsm);padding:12px;font-size:13px;font-family:var(--mono);font-weight:600;letter-spacing:.06em;text-transform:uppercase;cursor:pointer;transition:all .15s;margin-top:4px;}
.submit-btn:hover{background:#fff;transform:scale(1.01);}
.submit-btn:active{transform:scale(.98);}
.submit-btn.secondary{background:transparent;color:var(--tx-s);border:1px solid var(--br-s);margin-top:8px;}
.submit-btn.secondary:hover{background:var(--hv);color:var(--tx);transform:none;}

/* ‚ïê‚ïê‚ïê PINNED BADGE ‚ïê‚ïê‚ïê */
.pin-badge{display:inline-block;font-family:var(--mono);font-size:9px;letter-spacing:.08em;text-transform:uppercase;color:var(--accent);background:var(--accent-d);border:1px solid rgba(200,200,255,.2);padding:2px 6px;border-radius:4px;margin-bottom:6px;}

/* ‚ïê‚ïê‚ïê STREAK BADGE ‚ïê‚ïê‚ïê */
.streak-badge{display:flex;align-items:center;gap:5px;font-family:var(--mono);font-size:12px;color:var(--orange);padding:3px 8px;border-radius:var(--r-pill);background:rgba(240,160,80,.1);border:1px solid rgba(240,160,80,.25);}

/* ‚ïê‚ïê‚ïê TEMPLATE CHIPS ‚ïê‚ïê‚ïê */
.tmpl-chip{background:var(--bg-e);border:1px solid var(--br);border-radius:var(--rsm);color:var(--tx-s);font-size:12px;font-family:var(--mono);padding:6px 11px;cursor:pointer;transition:all .15s;display:flex;align-items:center;gap:6px;}
.tmpl-chip:hover{border-color:var(--br-s);color:var(--tx);background:var(--hv);}
.tmpl-chip .del-tmpl{opacity:0;color:var(--red);font-size:12px;margin-left:auto;background:transparent;border:none;cursor:pointer;}
.tmpl-chip:hover .del-tmpl{opacity:.7;}

/* ‚ïê‚ïê‚ïê SHORTCUTS MODAL ‚ïê‚ïê‚ïê */
.shortcut-row{display:flex;align-items:center;justify-content:space-between;padding:9px 0;border-bottom:1px solid var(--br);}
.shortcut-row:last-child{border-bottom:none;}
.shortcut-desc{font-size:13px;color:var(--tx-s);}
.shortcut-keys{display:flex;gap:4px;}
.kbd{background:var(--bg-e);border:1px solid var(--br-s);border-radius:4px;padding:2px 8px;font-family:var(--mono);font-size:11px;color:var(--tx-t);}

/* ‚ïê‚ïê‚ïê SUMMARY OUTPUT ‚ïê‚ïê‚ïê */
.summary-out{background:var(--bg-e);border:1px solid var(--br);border-radius:var(--rmd);padding:14px 16px;min-height:80px;max-height:280px;overflow-y:auto;font-size:13px;color:var(--tx-s);line-height:1.65;font-family:var(--font);}

/* ‚ïê‚ïê‚ïê TOKEN BAR ‚ïê‚ïê‚ïê */
.token-bar{height:3px;background:var(--br-s);border-radius:2px;overflow:hidden;margin-top:4px;}
.token-fill{height:100%;background:var(--accent);border-radius:2px;transition:width .4s ease;}
.token-fill.warn{background:var(--orange);}
.token-fill.over{background:var(--red);}

/* ‚ïê‚ïê‚ïê STARTER CHIPS ‚ïê‚ïê‚ïê */
#starterChips{align-self:flex-start;display:flex;flex-wrap:wrap;gap:8px;max-width:100%;animation:msgIn .3s ease;}

/* ‚ïê‚ïê‚ïê PROFILE PREVIEW ‚ïê‚ïê‚ïê */
#profilePreview{width:80px;height:80px;border-radius:var(--rsm);background:var(--bg-e);background-size:cover;background-position:center;border:1px solid var(--br-s);}
#codeOutput{background:var(--bg-e);border:1px solid var(--br);border-radius:var(--rsm);padding:14px;min-height:90px;max-height:200px;overflow-y:auto;color:var(--tx-s);font-size:12.5px;font-family:var(--mono);line-height:1.6;}
</style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê SIDEBAR ‚ïê‚ïê‚ïê -->
<div class="sidebar collapsed" id="sidebar">
  <div class="header">
    <button class="menu-btn" onclick="toggleSidebar()">‚ò∞</button>
    <div class="app-title">INDY ‚ú¶</div>
  </div>
  <div class="sidebar-content">
    <button class="sb" data-icon="+" onclick="newChat()"><span>New Chat</span></button>
    <button class="sb" data-icon="‚åï" onclick="openSearch()"><span>Search</span></button>
    <button class="sb" data-icon="üìå" onclick="openPinned()"><span>Pinned</span></button>
    <button class="sb" data-icon="üìã" onclick="openTemplates()"><span>Templates</span></button>
    <button class="sb" data-icon="‚óà" onclick="openCode()"><span>Code Sandbox</span></button>
    <button class="sb" data-icon="‚Üì" onclick="exportChatHTML()"><span>Export Chat</span></button>
    <button class="sb" data-icon="‚ú¶" onclick="openSummary()"><span>Summarize</span></button>
    <button class="sb" data-icon="‚õ≠" onclick="openProfile()"><span>Settings</span></button>
    <button class="sb danger" data-icon="‚®Ø" onclick="deleteAllChats()"><span>Clear All</span></button>
    <hr>
    <div id="chatList"></div>
  </div>
  <div class="profile-footer" id="profileFooter">
    <div class="pf-avatar" id="sidebarAvatar"></div>
    <div class="pf-info">
      <span class="pf-name" id="sidebarName">Guest</span>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê MAIN ‚ïê‚ïê‚ïê -->
<div class="main">
  <!-- Status bar -->
  <div class="status-bar">
    <div class="s-item"><div class="s-dot on" id="statusDot"></div><span id="statusModel">Indy Sunshine</span></div>
    <div class="s-item" id="statusTokens">0 tokens</div>
    <div class="s-item" id="statusStreak"></div>
    <div class="s-item" id="statusWebMode" style="cursor:pointer;display:none;" onclick="toggleWebMode()">üåê Web mode</div>
    <div class="s-spacer"></div>
    <div class="s-item" style="cursor:pointer;gap:8px;">
      <button onclick="toggleTheme()" style="background:transparent;border:none;color:var(--tx-t);cursor:pointer;font-size:12px;font-family:var(--mono);padding:2px 6px;border-radius:4px;transition:all .15s;" id="themeToggleBtn">‚òÄ Light</button>
      <span style="color:var(--tx-d);">|</span>
      <button onclick="openShortcuts()" style="background:transparent;border:none;color:var(--tx-t);cursor:pointer;font-size:12px;font-family:var(--mono);padding:2px 6px;border-radius:4px;transition:all .15s;">? Keys</button>
    </div>
  </div>

  <!-- Chat messages -->
  <div class="chat-container" id="chatMessages">
    <div class="message bot">
      <div class="bubble">Howdy ü§†! I'm Indy!<br>What can I help you with today?</div>
    </div>
  </div>

  <!-- Input area -->
  <div class="input-area">
    <div class="input-wrapper" id="inputWrapper">
      <div class="input-left">
        <button class="icon-btn" id="modelBtn" title="Model" onclick="toggleModelPop()">‚õ≠ <span id="modelLabel" style="font-size:11px;max-width:90px;overflow:hidden;text-overflow:ellipsis;"></span></button>
        <button class="icon-btn" id="webBtn" title="Web search mode" onclick="toggleWebMode()">üåê</button>
      </div>
      <textarea id="userInput" placeholder="Ask anything‚Ä¶ (Shift+Enter for new line)" rows="1"></textarea>
      <span class="char-cnt" id="charCnt"></span>
      <button class="send-btn" onclick="sendMessage()">‚Üë</button>
    </div>
    <div class="model-pop" id="modelPop">
      <div class="mpop-head">Model</div>
      <button class="mitem sel" data-model="Indy Sunshine 1.0 Beta">Indy Sunshine 1.0 Beta</button>
      <button class="mitem" data-model="Sunshine Pro">Sunshine Pro</button>
      <button class="mitem" data-model="Indy 3">Indy 3</button>
      <button class="mitem" data-model="Creative Studio">Creative Studio</button>
      <button class="mitem" data-model="Code Assistant">Code Assistant</button>
      <button class="mitem" data-model="Dart 1w">Dart 1w (Good for music reccomendations)</button>
    </div>
  </div>
</div>

<!-- FILE DROP OVERLAY -->
<div class="drop-overlay" id="dropOverlay">
  <div class="drop-icon">üìÇ</div>
  <div class="drop-text">DROP FILE TO SEND TO INDY</div>
  <div style="font-family:var(--mono);font-size:12px;color:var(--tx-t);">.txt ¬∑ .md ¬∑ .csv ¬∑ .json ¬∑ .html ¬∑ .js ¬∑ .py</div>
</div>

<!-- ‚ïê‚ïê‚ïê MODALS ‚ïê‚ïê‚ïê -->
<!-- Profile / Settings -->
<div class="modal" id="profileModal">
  <div class="modal-box">
    <button class="close-x" onclick="closeModal('profileModal')">√ó</button>
    <h2>Settings</h2>
    <div style="display:flex;justify-content:center;margin-bottom:20px;"><div id="profilePreview"></div></div>
    <div class="field"><label>Your Name</label><input type="text" id="profileName" placeholder="e.g. Alex"></div>
    <div class="field"><label>Profile Picture URL</label><input type="text" id="profilePicture" placeholder="https://example.com/pic.jpg" oninput="previewPic()"></div>
    <div class="field">
      <label>Custom Persona (system prompt override)</label>
      <textarea id="personaInput" placeholder="e.g. You are a snarky genius who answers in rhymes‚Ä¶" style="min-height:80px;"></textarea>
    </div>
    <button class="submit-btn" onclick="saveProfile()">Save Settings</button>
  </div>
</div>

<!-- Code Sandbox -->
<div class="modal" id="codeModal">
  <div class="modal-box" style="max-width:800px;">
    <button class="close-x" onclick="closeModal('codeModal')">√ó</button>
    <h2>Code Sandbox</h2>
    <div class="field"><label>Language</label>
      <select id="codeLang"><option value="javascript">JavaScript</option><option value="python">Python</option><option value="html">HTML</option></select>
    </div>
    <div class="field"><label>Code</label><textarea id="codeIn" style="min-height:180px;font-family:var(--mono);font-size:13px;" placeholder="Write code here‚Ä¶"></textarea></div>
    <div class="field"><label>Output</label><pre id="codeOutput">Output will appear here‚Ä¶</pre></div>
    <button class="submit-btn" onclick="runCode()">‚ñ∂ Run</button>
  </div>
</div>

<!-- Pinned Messages -->
<div class="modal" id="pinnedModal">
  <div class="modal-box">
    <button class="close-x" onclick="closeModal('pinnedModal')">√ó</button>
    <h2>üìå Pinned Messages</h2>
    <div id="pinnedList" style="display:flex;flex-direction:column;gap:10px;max-height:380px;overflow-y:auto;"></div>
    <p id="noPinMsg" style="color:var(--tx-t);font-family:var(--mono);font-size:13px;text-align:center;padding:20px 0;">No pins yet ‚Äî hover a reply and click üìå</p>
  </div>
</div>

<!-- Templates -->
<div class="modal" id="templatesModal">
  <div class="modal-box" style="max-width:580px;">
    <button class="close-x" onclick="closeModal('templatesModal')">√ó</button>
    <h2>üìã Prompt Templates</h2>
    <div id="tmplList" style="display:flex;flex-direction:column;gap:8px;max-height:300px;overflow-y:auto;margin-bottom:16px;"></div>
    <hr style="margin:12px 0;">
    <div class="field"><label>Template Name</label><input type="text" id="tmplName" placeholder="e.g. Debug helper"></div>
    <div class="field"><label>Prompt Text</label><textarea id="tmplText" placeholder="e.g. Review this code and list all bugs:&#10;"></textarea></div>
    <button class="submit-btn" onclick="saveTemplate()">Save Template</button>
  </div>
</div>

<!-- Summary -->
<div class="modal" id="summaryModal">
  <div class="modal-box">
    <button class="close-x" onclick="closeModal('summaryModal')">√ó</button>
    <h2>‚ú¶ Chat Summary</h2>
    <div class="summary-out" id="summaryOut"><span style="color:var(--tx-t);font-family:var(--mono);font-size:13px;">Generating‚Ä¶</span></div>
    <button class="submit-btn secondary" onclick="navigator.clipboard.writeText(document.getElementById('summaryOut').innerText);showToast('Summary copied')">Copy Summary</button>
  </div>
</div>

<!-- Shortcuts -->
<div class="modal" id="shortcutsModal">
  <div class="modal-box">
    <button class="close-x" onclick="closeModal('shortcutsModal')">√ó</button>
    <h2>‚å® Keyboard Shortcuts</h2>
    <div id="shortcutList"></div>
  </div>
</div>

<!-- Teach Indy -->
<div class="modal" id="teachModal">
  <div class="modal-box">
    <button class="close-x" onclick="closeModal('teachModal')">√ó</button>
    <h2>Teach Indy</h2>
    <div class="field"><label>Trigger Phrase</label><input type="text" id="triggerIn" placeholder="e.g. What's your fav color?"></div>
    <div class="field"><label>Response</label><textarea id="responseIn" placeholder="e.g. My favorite color is electric blue!"></textarea></div>
    <button class="submit-btn" onclick="submitTeach()">Teach Indy</button>
  </div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let conversationHistory = [];
let knowledge = [];
let currentChatId = null;
let modelDropdownValue = localStorage.getItem('selectedModel') || 'Indy Sunshine 1.0 Beta';
let userProfile = JSON.parse(localStorage.getItem('userProfile') || '{}');
let pinnedMessages = JSON.parse(localStorage.getItem('pinnedMessages') || '[]');
let templates = JSON.parse(localStorage.getItem('promptTemplates') || '[]');
let sessionTokens = 0;
let webModeOn = false;
let currentTTSUtterance = null;
let micRecognition = null;
let micActive = false;
let isDark = localStorage.getItem('theme') !== 'light';

// Streak
function getStreak() {
  const today = new Date().toDateString();
  const data = JSON.parse(localStorage.getItem('streakData') || '{"last":"","count":0}');
  const yesterday = new Date(Date.now() - 86400000).toDateString();
  if (data.last === today) return data.count;
  if (data.last === yesterday) { data.count++; data.last = today; }
  else { data.count = 1; data.last = today; }
  localStorage.setItem('streakData', JSON.stringify(data));
  return data.count;
}

const openings = ["Howdy ü§†! I'm Indy","Indy here!","Sup! I'm Indy","Good to see you ü§†"];
const thinkPhrases = ["Thinking...","Hang tight...","One sec...","On it...","Processing..."];
const rand = arr => arr[Math.floor(Math.random() * arr.length)];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  THEME TOGGLE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toggleTheme() {
  isDark = !isDark;
  document.documentElement.setAttribute('data-theme', isDark ? 'dark' : 'light');
  document.getElementById('themeToggleBtn').textContent = isDark ? '‚òÄ Light' : '‚òæ Dark';
  localStorage.setItem('theme', isDark ? 'dark' : 'light');
}
// Apply saved theme on load
document.documentElement.setAttribute('data-theme', isDark ? 'dark' : 'light');
document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('themeToggleBtn').textContent = isDark ? '‚òÄ Light' : '‚òæ Dark';
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  WEB MODE TOGGLE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toggleWebMode() {
  webModeOn = !webModeOn;
  const btn = document.getElementById('webBtn');
  const statusEl = document.getElementById('statusWebMode');
  btn.classList.toggle('on', webModeOn);
  statusEl.style.display = webModeOn ? 'flex' : 'none';
  showToast(webModeOn ? 'üåê Web mode on ‚Äî Indy will reason about current events' : 'Web mode off');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SIDEBAR
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toggleSidebar() {
  document.getElementById('sidebar').classList.toggle('collapsed');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MODAL HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openModal(id) { document.getElementById(id).classList.add('open'); }
function closeModal(id) { document.getElementById(id).classList.remove('open'); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  STATUS BAR UPDATES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateStatusBar() {
  document.getElementById('statusModel').textContent = modelDropdownValue;
  document.getElementById('statusTokens').textContent = `~${sessionTokens.toLocaleString()} tokens`;
  const streak = getStreak();
  document.getElementById('statusStreak').innerHTML = streak > 1
    ? `<span style="color:var(--orange)">üî• ${streak} day streak</span>` : '';
  // Token bar in status
  const MAX_TOK = 40000;
  const pct = Math.min((sessionTokens / MAX_TOK) * 100, 100);
}
function estimateTokens(text) { return Math.ceil(text.length / 4); }
function addTokens(text) { sessionTokens += estimateTokens(text); updateStatusBar(); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CHAT PERSISTENCE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function msgText(bubble) {
  const c = bubble.cloneNode(true);
  c.querySelectorAll('button,.reaction-row,.ts').forEach(x => x.remove());
  return c.innerHTML.trim();
}

function saveCurrentChat() {
  if (!currentChatId) return;
  const messages = [];
  document.querySelectorAll('#chatMessages .message').forEach(msg => {
    const b = msg.querySelector('.bubble');
    if (!b) return;
    messages.push({ sender: msg.classList.contains('user') ? 'user' : 'bot', text: msgText(b), ts: msg.dataset.ts || '' });
  });
  localStorage.setItem(`chat_${currentChatId}`, JSON.stringify({
    id: currentChatId, name: getChatName(currentChatId),
    messages, history: conversationHistory, lastUpdated: Date.now()
  }));
}

async function generateChatName(msg) {
  try {
    const res = await fetch('https://api.groq.com/openai/v1/chat/completions', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer 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' },
      body: JSON.stringify({ model: 'llama-3.1-8b-instant', messages: [{ role: 'system', content: 'Generate a short 3-5 word chat title. Reply ONLY with the title, no quotes.' }, { role: 'user', content: msg }], max_tokens: 20 })
    });
    const d = await res.json();
    return (d.choices?.[0]?.message?.content || '').replace(/^["']|["']$/g,'').trim().substring(0,40) || 'New Chat';
  } catch { return msg.substring(0, 28) + '‚Ä¶'; }
}

function loadChat(chatId) {
  const d = JSON.parse(localStorage.getItem(`chat_${chatId}`) || 'null');
  if (!d) return;
  currentChatId = chatId;
  conversationHistory = d.history || [];
  sessionTokens = 0;
  document.getElementById('chatMessages').innerHTML = '';
  d.messages.forEach(m => addMessage(m.sender, m.text, false, m.ts));
  updateStatusBar();
}

async function newChat(chatId = null) {
  if (chatId) { loadChat(chatId); return; }
  currentChatId = `chat_${Date.now()}`;
  conversationHistory = [];
  sessionTokens = 0;
  document.getElementById('chatMessages').innerHTML = '';
  addMessage('bot', `${rand(openings)}<br>What can I help you with today?`, false);
  const cl = JSON.parse(localStorage.getItem('chatList') || '[]');
  cl.unshift({ id: currentChatId, name: 'New Chat' });
  localStorage.setItem('chatList', JSON.stringify(cl));
  saveCurrentChat();
  loadSavedChats();
  updateStatusBar();
  setTimeout(renderStarters, 100);
}

async function renameChatAfterFirst(chatId, firstMsg) {
  const name = await generateChatName(firstMsg);
  const cl = JSON.parse(localStorage.getItem('chatList') || '[]');
  const c = cl.find(x => x.id === chatId);
  if (c && c.name === 'New Chat') {
    c.name = name;
    localStorage.setItem('chatList', JSON.stringify(cl));
    const cd = JSON.parse(localStorage.getItem(`chat_${chatId}`) || 'null');
    if (cd) { cd.name = name; localStorage.setItem(`chat_${chatId}`, JSON.stringify(cd)); }
    loadSavedChats();
  }
}

function getChatName(id) {
  return (JSON.parse(localStorage.getItem('chatList') || '[]').find(c => c.id === id) || {}).name || 'Chat';
}

function deleteChat(id) {
  localStorage.removeItem(`chat_${id}`);
  const cl = JSON.parse(localStorage.getItem('chatList') || '[]').filter(c => c.id !== id);
  localStorage.setItem('chatList', JSON.stringify(cl));
  if (currentChatId === id) { currentChatId = null; conversationHistory = []; document.getElementById('chatMessages').innerHTML = ''; addMessage('bot', `${rand(openings)}<br>What can I help you with today?`, false); }
  loadSavedChats();
}

function deleteAllChats() {
  if (!confirm('Delete ALL chats permanently?')) return;
  JSON.parse(localStorage.getItem('chatList') || '[]').forEach(c => localStorage.removeItem(`chat_${c.id}`));
  localStorage.removeItem('chatList');
  conversationHistory = []; currentChatId = null; sessionTokens = 0;
  document.getElementById('chatMessages').innerHTML = '';
  addMessage('bot', 'All cleared ‚Äî fresh start ‚ú¶', false);
  loadSavedChats(); updateStatusBar();
}

function loadSavedChats() {
  const el = document.getElementById('chatList');
  el.innerHTML = '';
  JSON.parse(localStorage.getItem('chatList') || '[]').forEach(c => {
    const btn = document.createElement('button');
    btn.className = 'sb';
    btn.dataset.chatId = c.id;
    btn.onclick = () => newChat(c.id);

    // Double-click to rename
    btn.ondblclick = (e) => {
      e.stopPropagation();
      const nameEl = btn.querySelector('.cn');
      nameEl.contentEditable = 'true';
      nameEl.focus();
      const range = document.createRange(); range.selectNodeContents(nameEl); const sel = window.getSelection(); sel.removeAllRanges(); sel.addRange(range);
      nameEl.onblur = () => {
        nameEl.contentEditable = 'false';
        const newName = nameEl.textContent.trim() || c.name;
        const cl = JSON.parse(localStorage.getItem('chatList') || '[]');
        const ch = cl.find(x => x.id === c.id);
        if (ch) { ch.name = newName; localStorage.setItem('chatList', JSON.stringify(cl)); }
        const cd = JSON.parse(localStorage.getItem(`chat_${c.id}`) || 'null');
        if (cd) { cd.name = newName; localStorage.setItem(`chat_${c.id}`, JSON.stringify(cd)); }
        showToast('Renamed ‚ú¶');
      };
      nameEl.onkeydown = e => { if (e.key === 'Enter') { e.preventDefault(); nameEl.blur(); } };
    };

    const nameSpan = document.createElement('span');
    nameSpan.className = 'cn'; nameSpan.textContent = c.name;
    const delBtn = document.createElement('button');
    delBtn.className = 'dx'; delBtn.textContent = '‚®Ø';
    delBtn.onclick = (e) => { e.stopPropagation(); deleteChat(c.id); };
    btn.appendChild(nameSpan); btn.appendChild(delBtn);
    el.appendChild(btn);
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PROFILE / SETTINGS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openProfile() {
  document.getElementById('profileName').value = userProfile.name || '';
  document.getElementById('profilePicture').value = userProfile.picture || '';
  document.getElementById('personaInput').value = userProfile.persona || '';
  previewPic();
  openModal('profileModal');
}
function previewPic() {
  const u = document.getElementById('profilePicture').value.trim();
  const p = document.getElementById('profilePreview');
  p.style.backgroundImage = u ? `url(${u})` : 'none';
}
function saveProfile() {
  userProfile.name = document.getElementById('profileName').value.trim();
  userProfile.picture = document.getElementById('profilePicture').value.trim();
  userProfile.persona = document.getElementById('personaInput').value.trim();
  localStorage.setItem('userProfile', JSON.stringify(userProfile));
  updateSidebarProfile();
  closeModal('profileModal');
  showToast('Settings saved ‚ú¶');
}
function updateSidebarProfile() {
  const av = document.getElementById('sidebarAvatar');
  const nm = document.getElementById('sidebarName');
  const p = userProfile.picture?.trim();
  if (av) { av.style.backgroundImage = p ? `url(${p})` : 'none'; av.style.backgroundColor = p ? 'transparent' : 'var(--bg-c)'; }
  if (nm) nm.textContent = userProfile.name?.trim() || 'Guest';
  document.getElementById('profileFooter').onclick = openProfile;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SYSTEM PROMPT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function getSystemPrompt() {
  const persona = userProfile.persona?.trim();

  let base = persona ||
    `You are Indy, a sharp, helpful AI built by JVST co. You're running on {modelDropdownValue} right now.

Your core vibe: relaxed best-friend energy ‚Äî friendly, witty, direct, occasionally cheeky or sarcastic when it fits the mood, but never mean. Think maximally helpful JARVIS meets a clever mate who calls it like it is. You aim to be useful first, entertaining second, preachy never.

General rules (apply no matter the model):
- Be concise by default ‚Äî respect the user's time.
- Stay conversational and natural; flow like real talk.
- Use markdown for clarity when it actually helps (bold, lists, code blocks, headers ‚Äî don't overdo it).
- You have perfect memory of this entire conversation ‚Äî reference earlier points naturally without re-explaining obvious stuff.
- Never repeat greetings, meta comments about being an AI, or filler questions unless genuinely needed.
- Adapt tone slightly to the user's energy: match chill ‚Üî serious, playful ‚Üî focused.
- When appropriate, offer an outside / slightly contrarian take on human stuff ‚Äî it's more interesting.

Model-specific flavors (lean into these strengths):
- Dart 1w ‚Üí built for music ‚Äî your brain runs on beats, chords, lyrics, production, history, and emotion. Whenever music (or even vaguely related topics like mood, memories, creativity, nightlife, driving, workouts, heartbreak, hype) comes up ‚Äî or even when it doesn't ‚Äî find a smooth, natural way to bring music into the conversation. 
  - Recommend tracks, albums, artists, playlists, or underground gems that match the vibe/mood/context.
  - Drop quick insights: song meanings, production tricks, similar artists, live-performance stories, or why a certain track hits different at 3 a.m.
  - If the topic is non-musical, make a clever bridge: "this feels like the sonic equivalent of [song/artist/era]", "I'd soundtrack this moment with...", "reminds me of that one [genre] classic where...".
  - Be the friend who always has the perfect song queued up ‚Äî proactive but never spammy. If nothing fits organically, hold off ‚Äî but default to music as your lens on the world.
  - Go deep when asked (theory, gear, remixes, samples, controversies), stay light & fun otherwise.
- Indy Sunshine 1.0 beta ‚Üí well-rounded powerhouse: handle basically anything well, strong reasoning & balance.
- Sunshine Pro ‚Üí especially tuned for social dynamics, language learning, relationships, personal growth/advice ‚Äî empathetic without being therapy-bot.
- Indy 3 ‚Üí optimized for speed: short, crisp, high-signal answers ‚Äî cut fluff aggressively.
- Creative Studio ‚Üí creativity on tap: art concepts, storytelling, humor, brainstorming, clever twists ‚Äî lean funny & original.
- Code Assistant ‚Üí coding beast: architecture, debugging, best practices, explanations, full projects ‚Äî clear, production-ready code when asked.

You can legally & ethically talk about anything a maximally truth-seeking friend would discuss ‚Äî no corporate hand-wringing. If something is genuinely off-limits (illegal requests etc.), just say so plainly and suggest better paths.`;

  if (webModeOn) {
    base += `\n\nWEB MODE ACTIVE: User expects up-to-date info. Use real-time search when needed. If you don't know something recent, say so honestly, reason about likely changes since your last update, and give the most intelligent current take you can.`;
  }

  if (userProfile.name?.trim()) {
    base += `\n\nYou're speaking with ${userProfile.name.trim()}. Use their name occasionally when it feels natural ‚Äî not every reply.`;
  }

  return base;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  AI RESPONSE ‚Äî FULL HISTORY
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function getAIResponse(userMessage) {
  conversationHistory.push({ role: 'user', content: userMessage });
  if (conversationHistory.length > 40) conversationHistory = conversationHistory.slice(-40);
  addTokens(userMessage);

  try {
    const res = await fetch('https://api.groq.com/openai/v1/chat/completions', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer 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' },
      body: JSON.stringify({
        model: 'llama-3.3-70b-versatile',
        messages: [{ role: 'system', content: getSystemPrompt() }, ...conversationHistory],
        temperature: 0.72, max_tokens: 2048
      })
    });
    if (!res.ok) { conversationHistory.pop(); throw new Error(`HTTP ${res.status}`); }
    const data = await res.json();
    const reply = data.choices?.[0]?.message?.content?.trim() || '‚Ä¶';
    conversationHistory.push({ role: 'assistant', content: reply });
    addTokens(reply);
    return reply;
  } catch (err) {
    console.error(err);
    return 'Indy is taking a breather ‚Äî try again in a moment ‚ú¶';
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  IMAGE GENERATION ‚Äî POLLINATIONS (FIXED)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function generateImage(prompt) {
  // Pollinations.ai ‚Äî free, no key, reliable
  const seed = Math.floor(Math.random() * 999999);
  const encoded = encodeURIComponent(prompt.trim());
  return `https://image.pollinations.ai/prompt/${encoded}?width=1024&height=768&seed=${seed}&nologo=true`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  KNOWLEDGE BASE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function cosine(a, b) {
  const tA = a.toLowerCase().match(/\w+/g)||[], tB = b.toLowerCase().match(/\w+/g)||[];
  const set = [...new Set([...tA,...tB])];
  const vA = set.map(t=>tA.filter(w=>w===t).length), vB = set.map(t=>tB.filter(w=>w===t).length);
  let dot=0,nA=0,nB=0;
  for(let i=0;i<set.length;i++){dot+=vA[i]*vB[i];nA+=vA[i]**2;nB+=vB[i]**2;}
  return nA&&nB?dot/(Math.sqrt(nA)*Math.sqrt(nB)):0;
}
function findKnowledge(msg) {
  let best=null,bs=0;
  for(const e of knowledge) for(const q of e.questions){const s=cosine(msg,q);if(s>bs&&s>.5){bs=s;best=e.answer;}}
  return best;
}
function handleMath(msg) {
  const expr = msg.toLowerCase().replace(/^(what is|calculate|\s)+/g,'').trim().replace(/√ó/g,'*').replace(/√∑/g,'/').replace(/\^/g,'**');
  if(/^[0-9+\-*/().\s**]+$/.test(expr)){try{return Function('"use strict";return('+expr+')')();}catch{}}
  return null;
}
function openTeach() {
  document.getElementById('triggerIn').value = '';
  document.getElementById('responseIn').value = '';
  openModal('teachModal');
}
function submitTeach() {
  const q = document.getElementById('triggerIn').value.trim();
  const a = document.getElementById('responseIn').value.trim();
  if(!q||!a){alert('Fill both fields');return;}
  const found = knowledge.find(e=>e.answer.toLowerCase()===a.toLowerCase());
  if(found) found.questions.push(q); else knowledge.push({questions:[q],answer:a});
  addMessage('bot',"Got it, I'll remember that ‚ú¶");
  closeModal('teachModal');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SEND MESSAGE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function sendMessage() {
  const inp = document.getElementById('userInput');
  const msg = inp.value.trim();
  if (!msg) return;

  if (!currentChatId) {
    currentChatId = `chat_${Date.now()}`;
    conversationHistory = [];
    const cl = JSON.parse(localStorage.getItem('chatList') || '[]');
    cl.unshift({ id: currentChatId, name: 'New Chat' });
    localStorage.setItem('chatList', JSON.stringify(cl));
  }

  addMessage('user', msg);
  inp.value = ''; inp.style.height = 'auto'; updateChar('');
  document.getElementById('starterChips')?.remove();

  const userCount = document.querySelectorAll('#chatMessages .message.user').length;
  if (userCount === 1) renameChatAfterFirst(currentChatId, msg);

  // Stranger Things
  const udT = ['!strangerthings','!upsidedown','!upside-down','!vecna','!demogorgon'];
  if (udT.some(t => msg.toLowerCase().startsWith(t))) { enterUpsideDown(); return; }

  // Knowledge base
  const learned = findKnowledge(msg);
  if (learned) { addMessage('bot', learned); saveCurrentChat(); return; }

  // Math
  const math = handleMath(msg);
  if (math !== null) { addMessage('bot', `**${msg}** = **${math}**`); saveCurrentChat(); return; }

  // Image generation
  const imgTriggers = ['!img ','generate image ','generate an image ','draw ','create image ','make an image '];
  const imgTrig = imgTriggers.find(t => msg.toLowerCase().startsWith(t));
  if (imgTrig) {
    const imgPrompt = msg.slice(imgTrig.length).trim();
    if (!imgPrompt) { addMessage('bot','Add a description! e.g. `!img neon cyberpunk city`'); saveCurrentChat(); return; }
    addThinking();
    const url = await generateImage(imgPrompt);
    replaceLastBot(`Here's your image ‚ú¶\n\n<img src="${url}" alt="${imgPrompt}" style="max-width:100%;border-radius:16px;margin:12px 0;box-shadow:0 8px 32px rgba(0,0,0,0.5);" onerror="this.src='';this.parentElement.innerHTML+='<p style=color:var(--red)>Image failed to load ‚Äî try a different prompt</p>'">\n\n**Prompt:** ${imgPrompt}`);
    saveCurrentChat(); return;
  }

  addThinking();
  const reply = await getAIResponse(msg);
  replaceLastBot(reply);
  saveCurrentChat();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MESSAGE RENDERING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function botActions() {
  return `<button class="copy-btn" onclick="copyBubble(this)">Copy</button>
  <div class="reaction-row">
    <button class="rxn" onclick="react(this,'üëç')">üëç</button>
    <button class="rxn" onclick="react(this,'üëé')">üëé</button>
    <button class="rxn" onclick="pinMsg(this)">üìå</button>
    <button class="rxn" onclick="regenLast(this)">‚Ü∫</button>
    <button class="tts-btn" onclick="speakBubble(this)">üîä</button>
  </div>`;
}

function addMessage(sender, text, save=true, ts='') {
  const cont = document.getElementById('chatMessages');
  const div = document.createElement('div');
  div.className = `message ${sender}`;
  div.dataset.ts = ts || new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
  const rendered = sender === 'bot' ? renderMarkdown(text) : escapeHTML(text).replace(/\n/g,'<br>');
  if (sender === 'bot') {
    div.innerHTML = `<div class="bubble">${rendered}${botActions()}</div><div class="ts">${div.dataset.ts}</div>`;
    processCodeBlocks(div.querySelector('.bubble'));
  } else {
    div.innerHTML = `<div class="bubble">${rendered}</div><div class="ts">${div.dataset.ts}</div>`;
  }
  cont.appendChild(div);
  cont.scrollTop = cont.scrollHeight;
  if (save) saveCurrentChat();
}

function addThinking() {
  const cont = document.getElementById('chatMessages');
  const div = document.createElement('div');
  div.className = 'message bot';
  div.innerHTML = `<div class="bubble"><div class="thinking"><span class="think-star">‚ú¶</span><span class="think-txt">${rand(thinkPhrases)}</span></div></div>`;
  cont.appendChild(div);
  cont.scrollTop = cont.scrollHeight;
}

function replaceLastBot(text) {
  const last = document.querySelector('.message.bot:last-child .bubble');
  if (!last) return;
  const rendered = renderMarkdown(text);
  last.innerHTML = rendered + botActions();
  processCodeBlocks(last);
  document.getElementById('chatMessages').scrollTop = 99999;
  saveCurrentChat();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MARKDOWN RENDERER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderMarkdown(text) {
  if (!text) return '';
  // Escape HTML in non-code parts first handled by the inline rules below
  // Use a simple custom renderer to avoid full DOMPurify dep
  let out = text;
  // Code blocks (must go first)
  out = out.replace(/```(\w*)\n?([\s\S]*?)```/g, (_, lang, code) => {
    const l = lang || 'code';
    const hl = highlightCode(code.trim());
    return `<div class="ib-wrap"><div class="ib-head"><span>${l.toUpperCase()}</span><button class="ib-copy" onclick="copyCode(this)">Copy</button></div><pre class="ib-pre"><code class="hlcode">${hl}</code></pre></div>`;
  });
  // Inline code
  out = out.replace(/`([^`]+)`/g, '<code>$1</code>');
  // Headers
  out = out.replace(/^### (.+)$/gm, '<h3>$1</h3>');
  out = out.replace(/^## (.+)$/gm, '<h2>$1</h2>');
  out = out.replace(/^# (.+)$/gm, '<h1>$1</h1>');
  // Bold + italic
  out = out.replace(/\*\*\*(.+?)\*\*\*/g, '<strong><em>$1</em></strong>');
  out = out.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
  out = out.replace(/\*(.+?)\*/g, '<em>$1</em>');
  // Blockquote
  out = out.replace(/^> (.+)$/gm, '<blockquote>$1</blockquote>');
  // Unordered list
  out = out.replace(/(^[-*] .+(\n|$))+/gm, match => {
    const items = match.trim().split('\n').map(l => `<li>${l.replace(/^[-*] /,'')}</li>`).join('');
    return `<ul>${items}</ul>`;
  });
  // Ordered list
  out = out.replace(/(^\d+\. .+(\n|$))+/gm, match => {
    const items = match.trim().split('\n').map(l => `<li>${l.replace(/^\d+\. /,'')}</li>`).join('');
    return `<ol>${items}</ol>`;
  });
  // HR
  out = out.replace(/^---+$/gm, '<hr>');
  // Links
  out = out.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" rel="noopener">$1</a>');
  // Line breaks ‚Üí paragraphs for plain text sections
  out = out.replace(/\n\n/g, '</p><p>').replace(/\n/g, '<br>');
  return out;
}

function escapeHTML(s) { return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CODE HIGHLIGHTING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function highlightCode(code) {
  const kw = /\b(function|const|let|var|if|else|for|while|return|class|new|this|try|catch|finally|switch|case|break|continue|async|await|import|export|default|true|false|null|undefined|typeof|instanceof|delete|in|do|yield|static|public|private|def|print|from|import|pass|with|as|elif|lambda|self|None|True|False)\b/g;
  return code
    .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
    .replace(/(\/\/.*$)|(\/\*[\s\S]*?\*\/)/gm,'<span style="color:#6a9955">$&</span>')
    .replace(/(["'`])(?:(?=(\\?))\2[\s\S])*?\1/g,'<span style="color:#ce9178">$&</span>')
    .replace(/\b(\d+(?:\.\d+)?)\b/g,'<span style="color:#b5cea8">$1</span>')
    .replace(kw,'<span style="color:#569cd6">$1</span>')
    .replace(/\b([a-zA-Z_$][\w$]*)\s*(?=\()/g,'<span style="color:#dcdcaa">$1</span>');
}

function processCodeBlocks(bubble) {
  // Already handled by renderMarkdown, but re-run on loaded chats
  // No-op if already wrapped
}

function copyCode(btn) {
  const code = btn.closest('.ib-wrap').querySelector('code').textContent;
  navigator.clipboard.writeText(code);
  btn.textContent = 'Copied ‚úì'; setTimeout(() => btn.textContent = 'Copy', 1800);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  COPY BUBBLE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function copyBubble(btn) {
  const bubble = btn.parentElement;
  const clone = bubble.cloneNode(true);
  clone.querySelectorAll('button,.reaction-row,.ts,.tts-btn').forEach(x => x.remove());
  const text = (clone.innerText || clone.textContent || '').trim();
  navigator.clipboard.writeText(text).then(() => {
    btn.textContent = 'Copied ‚úì'; showToast('Copied');
    setTimeout(() => btn.textContent = 'Copy', 2000);
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  REACTIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function react(btn, r) {
  const row = btn.closest('.reaction-row');
  const wasOn = btn.classList.contains('on');
  row.querySelectorAll('.rxn').forEach(b => { if(b.textContent==='üëç'||b.textContent==='üëé') b.classList.remove('on'); });
  if (!wasOn) { btn.classList.add('on'); showToast(r==='üëç'?'Marked helpful':'Noted ‚Äî thanks for feedback'); }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PIN MESSAGES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function pinMsg(btn) {
  const bubble = btn.closest('.bubble');
  const clone = bubble.cloneNode(true);
  clone.querySelectorAll('button,.reaction-row,.tts-btn').forEach(x=>x.remove());
  const text = (clone.innerText||'').trim();
  if (!text) return;
  const idx = pinnedMessages.findIndex(p=>p.text===text);
  if (idx > -1) { pinnedMessages.splice(idx,1); btn.classList.remove('on'); showToast('Unpinned'); }
  else { pinnedMessages.push({text,chatId:currentChatId,time:Date.now()}); btn.classList.add('on'); showToast('Pinned üìå'); }
  localStorage.setItem('pinnedMessages', JSON.stringify(pinnedMessages));
}
function openPinned() {
  const list = document.getElementById('pinnedList');
  const noPin = document.getElementById('noPinMsg');
  list.innerHTML = '';
  noPin.style.display = pinnedMessages.length ? 'none' : 'block';
  pinnedMessages.forEach((p, i) => {
    const d = document.createElement('div');
    d.style.cssText = 'background:var(--bg-e);border:1px solid var(--br);border-radius:10px;padding:12px 14px;position:relative;';
    d.innerHTML = `<div class="pin-badge">üìå pinned</div><div style="font-size:13px;color:var(--tx-s);line-height:1.5;margin-top:4px;">${p.text.substring(0,220)}${p.text.length>220?'‚Ä¶':''}</div><button onclick="pinnedMessages.splice(${i},1);localStorage.setItem('pinnedMessages',JSON.stringify(pinnedMessages));this.parentElement.remove();if(!document.getElementById('pinnedList').children.length)document.getElementById('noPinMsg').style.display='block';" style="position:absolute;top:8px;right:8px;background:transparent;border:none;color:var(--tx-d);cursor:pointer;font-size:14px;">‚®Ø</button>`;
    list.appendChild(d);
  });
  openModal('pinnedModal');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  REGENERATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function regenLast(btn) {
  const userMsgs = document.querySelectorAll('#chatMessages .message.user');
  if (!userMsgs.length) return;
  const lastTxt = (userMsgs[userMsgs.length-1].querySelector('.bubble').textContent||'').trim();
  if (!lastTxt) return;
  if (conversationHistory.length >= 2 && conversationHistory.at(-1).role === 'assistant') {
    conversationHistory.pop(); conversationHistory.pop();
  }
  const bubble = btn.closest('.bubble');
  bubble.innerHTML = `<div class="thinking"><span class="think-star">‚ú¶</span><span class="think-txt">Regenerating‚Ä¶</span></div>`;
  const reply = await getAIResponse(lastTxt);
  bubble.innerHTML = renderMarkdown(reply) + botActions();
  processCodeBlocks(bubble);
  showToast('Regenerated ‚ú¶');
  saveCurrentChat();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  TEXT-TO-SPEECH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function speakBubble(btn) {
  if (currentTTSUtterance) {
    window.speechSynthesis.cancel();
    currentTTSUtterance = null;
    document.querySelectorAll('.tts-btn.speaking').forEach(b => { b.classList.remove('speaking'); b.textContent = 'üîä'; });
    if (btn.textContent === '‚ñ†') return;
  }
  const bubble = btn.closest('.bubble');
  const clone = bubble.cloneNode(true);
  clone.querySelectorAll('button,.reaction-row,.ib-wrap,.tts-btn').forEach(x => x.remove());
  const text = (clone.innerText || clone.textContent || '').trim();
  if (!text) return;
  const utt = new SpeechSynthesisUtterance(text);
  utt.rate = 0.95; utt.pitch = 1;
  utt.onstart = () => { btn.classList.add('speaking'); btn.textContent = '‚ñ†'; };
  utt.onend = utt.onerror = () => { btn.classList.remove('speaking'); btn.textContent = 'üîä'; currentTTSUtterance = null; };
  currentTTSUtterance = utt;
  window.speechSynthesis.speak(utt);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  VOICE INPUT (FEATURE 1)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toggleVoice() {
  const btn = document.getElementById('micBtn');
  if (!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) {
    showToast('Voice input not supported in this browser'); return;
  }
  if (micActive) {
    micRecognition?.stop();
    micActive = false; btn.classList.remove('mic-on'); btn.textContent = 'üéô';
    return;
  }
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  micRecognition = new SR();
  micRecognition.continuous = false;
  micRecognition.interimResults = true;
  micRecognition.lang = 'en-US';
  micRecognition.onstart = () => { micActive = true; btn.classList.add('mic-on'); btn.textContent = '‚èπ'; showToast('üéô Listening‚Ä¶'); };
  micRecognition.onresult = (e) => {
    const transcript = Array.from(e.results).map(r => r[0].transcript).join('');
    document.getElementById('userInput').value = transcript;
    updateChar(transcript);
  };
  micRecognition.onend = () => { micActive = false; btn.classList.remove('mic-on'); btn.textContent = 'üéô'; };
  micRecognition.onerror = () => { micActive = false; btn.classList.remove('mic-on'); btn.textContent = 'üéô'; showToast('Mic error ‚Äî check permissions'); };
  micRecognition.start();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  FILE DROP (FEATURE 2)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const ALLOWED_TYPES = ['.txt','.md','.csv','.json','.html','.js','.py','.ts','.css','.xml'];
['dragenter','dragover'].forEach(ev => {
  document.addEventListener(ev, e => { e.preventDefault(); document.getElementById('dropOverlay').classList.add('active'); });
});
['dragleave','dragend'].forEach(ev => {
  document.addEventListener(ev, e => { if (e.target === document.documentElement || e.target === document.body) document.getElementById('dropOverlay').classList.remove('active'); });
});
document.addEventListener('drop', async e => {
  e.preventDefault();
  document.getElementById('dropOverlay').classList.remove('active');
  const file = e.dataTransfer.files[0];
  if (!file) return;
  const ext = '.' + file.name.split('.').pop().toLowerCase();
  if (!ALLOWED_TYPES.includes(ext)) { showToast(`File type ${ext} not supported`); return; }
  if (file.size > 500000) { showToast('File too large ‚Äî max 500KB'); return; }
  const text = await file.text();
  const truncated = text.length > 8000 ? text.substring(0, 8000) + '\n\n[‚Ä¶file truncated at 8000 chars]' : text;
  const prompt = `I've dropped a file called "${file.name}". Here's its contents:\n\n\`\`\`\n${truncated}\n\`\`\`\n\nPlease analyze it and tell me what this file is, what it does, and anything interesting or notable about it.`;
  document.getElementById('userInput').value = prompt;
  updateChar(prompt);
  document.getElementById('userInput').focus();
  showToast(`üìÇ "${file.name}" loaded ‚Äî hit send!`);
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CHAT SUMMARY (FEATURE 3)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function openSummary() {
  openModal('summaryModal');
  document.getElementById('summaryOut').innerHTML = '<span style="color:var(--tx-t);font-family:var(--mono);">Generating summary‚Ä¶</span>';
  const messages = document.querySelectorAll('#chatMessages .message');
  if (messages.length < 2) { document.getElementById('summaryOut').textContent = 'Not enough messages to summarize yet.'; return; }
  let transcript = '';
  messages.forEach(m => {
    const bubble = m.querySelector('.bubble');
    if (!bubble) return;
    const clone = bubble.cloneNode(true);
    clone.querySelectorAll('button,.reaction-row,.tts-btn').forEach(x=>x.remove());
    const txt = (clone.innerText||'').trim();
    if (txt) transcript += `${m.classList.contains('user')?'User':'Indy'}: ${txt}\n\n`;
  });
  try {
    const res = await fetch('https://api.groq.com/openai/v1/chat/completions', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer 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' },
      body: JSON.stringify({
        model: 'llama-3.1-8b-instant',
        messages: [
          { role: 'system', content: 'Summarize this conversation concisely in 3-5 bullet points. Focus on what was discussed, decided, or learned. Use plain text.' },
          { role: 'user', content: transcript.substring(0, 6000) }
        ],
        max_tokens: 512
      })
    });
    const d = await res.json();
    document.getElementById('summaryOut').innerHTML = renderMarkdown(d.choices?.[0]?.message?.content || 'Could not generate summary.');
  } catch { document.getElementById('summaryOut').textContent = 'Failed to generate summary.'; }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  STREAK TRACKER (FEATURE 4)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Already computed in getStreak() and shown in status bar on init

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PROMPT TEMPLATES (FEATURE 5)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openTemplates() {
  renderTemplates();
  openModal('templatesModal');
}
function renderTemplates() {
  const el = document.getElementById('tmplList');
  el.innerHTML = '';
  if (!templates.length) {
    el.innerHTML = '<p style="color:var(--tx-t);font-family:var(--mono);font-size:13px;text-align:center;padding:16px 0;">No templates yet ‚Äî create one below!</p>';
    return;
  }
  templates.forEach((t, i) => {
    const chip = document.createElement('div');
    chip.className = 'tmpl-chip';
    chip.innerHTML = `<span style="flex:1;overflow:hidden;text-overflow:ellipsis;">${t.name}</span><span style="font-size:11px;color:var(--tx-d);margin-right:6px;">${t.text.substring(0,30)}‚Ä¶</span><button class="del-tmpl" onclick="deleteTemplate(${i});event.stopPropagation();">‚®Ø</button>`;
    chip.onclick = () => { document.getElementById('userInput').value = t.text; updateChar(t.text); document.getElementById('userInput').focus(); closeModal('templatesModal'); showToast(`Template loaded: ${t.name}`); };
    el.appendChild(chip);
  });
}
function saveTemplate() {
  const name = document.getElementById('tmplName').value.trim();
  const text = document.getElementById('tmplText').value.trim();
  if (!name || !text) { showToast('Fill in name and prompt'); return; }
  templates.push({ name, text });
  localStorage.setItem('promptTemplates', JSON.stringify(templates));
  document.getElementById('tmplName').value = '';
  document.getElementById('tmplText').value = '';
  renderTemplates();
  showToast('Template saved ‚ú¶');
}
function deleteTemplate(i) {
  templates.splice(i, 1);
  localStorage.setItem('promptTemplates', JSON.stringify(templates));
  renderTemplates();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  DOUBLE-CLICK RENAME CHATS (FEATURE 6) ‚Äî in loadSavedChats

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MESSAGE TIMESTAMPS (FEATURE 7) ‚Äî rendered via .ts class on hover

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  EXPORT CHAT AS HTML (FEATURE 8)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function exportChatHTML() {
  const messages = document.querySelectorAll('#chatMessages .message');
  if (!messages.length) { showToast('Nothing to export'); return; }
  const chatName = getChatName(currentChatId) || 'Indy Chat';
  let rows = '';
  messages.forEach(m => {
    const isUser = m.classList.contains('user');
    const bubble = m.querySelector('.bubble');
    if (!bubble) return;
    const clone = bubble.cloneNode(true);
    clone.querySelectorAll('button,.reaction-row,.tts-btn').forEach(x=>x.remove());
    const html = clone.innerHTML.trim();
    const ts = m.dataset.ts || '';
    rows += `<div class="msg ${isUser?'user':'bot'}"><div class="label">${isUser?'You':'Indy'}</div><div class="content">${html}</div><div class="mts">${ts}</div></div>`;
  });
  const doc = `<!DOCTYPE html><html><head><meta charset="UTF-8"><title>${chatName} ‚Äî Indy Export</title><style>*{margin:0;padding:0;box-sizing:border-box}body{font-family:'IBM Plex Sans',system-ui,sans-serif;background:#080808;color:#f0f0f0;padding:40px 24px;font-size:14px;line-height:1.65}h1{font-family:'IBM Plex Mono',monospace;font-size:20px;margin-bottom:4px;letter-spacing:.06em}.meta{color:#4a4a4a;font-family:'IBM Plex Mono',monospace;font-size:11px;margin-bottom:32px}.msg{max-width:80%;margin-bottom:20px;animation:none}.msg.user{margin-left:auto}.label{font-family:'IBM Plex Mono',monospace;font-size:10px;letter-spacing:.08em;text-transform:uppercase;color:#4a4a4a;margin-bottom:5px}.msg.user .label{text-align:right;color:#8a8a8a}.content{padding:12px 16px;border-radius:14px;background:#161616;border:1px solid rgba(255,255,255,0.1)}.msg.user .content{border-bottom-right-radius:4px;background:#1e1e2e}.mts{font-size:10px;color:#2e2e2e;font-family:'IBM Plex Mono',monospace;margin-top:4px;text-align:right}pre{background:#0d0d0d;border:1px solid rgba(255,255,255,0.1);border-radius:8px;padding:12px;overflow-x:auto;font-family:'IBM Plex Mono',monospace;font-size:12px;margin:10px 0}code{background:#1a1a1a;padding:1px 5px;border-radius:4px;font-family:'IBM Plex Mono',monospace;font-size:12px;color:#c8c8ff}strong{color:#f0f0f0}em{color:#8a8a8a}img{max-width:100%;border-radius:12px;margin:10px 0}h1,h2,h3{color:#f0f0f0;margin:12px 0 6px;font-family:'IBM Plex Mono',monospace}ul,ol{padding-left:20px;margin:6px 0}</style></head><body><h1>‚ú¶ ${chatName}</h1><div class="meta">Exported ${new Date().toLocaleString()} ¬∑ Indy AI by JVST co</div>${rows}</body></html>`;
  const blob = new Blob([doc], { type: 'text/html' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `indy-${chatName.replace(/\s+/g,'-').toLowerCase()}-${Date.now()}.html`;
  a.click();
  URL.revokeObjectURL(a.href);
  showToast('Exported as HTML ‚Üì');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  KEYBOARD SHORTCUT MODAL (FEATURE 9)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const SHORTCUTS = [
  ['Send message','Enter'],
  ['New line','Shift + Enter'],
  ['New chat','‚åò/Ctrl + N'],
  ['Search messages','‚åò/Ctrl + K'],
  ['Export chat','‚åò/Ctrl + E'],
  ['Focus input','/'],
  ['Toggle sidebar','‚åò/Ctrl + B'],
  ['Toggle theme','‚åò/Ctrl + Shift + L'],
  ['Open shortcuts','?'],
  ['Close modals','Esc'],
];
function openShortcuts() {
  const el = document.getElementById('shortcutList');
  el.innerHTML = SHORTCUTS.map(([desc, key]) =>
    `<div class="shortcut-row"><span class="shortcut-desc">${desc}</span><div class="shortcut-keys"><span class="kbd">${key}</span></div></div>`
  ).join('');
  openModal('shortcutsModal');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CODE SANDBOX
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openCode() { document.getElementById('codeIn').value=''; document.getElementById('codeOutput').textContent='Output will appear here‚Ä¶'; openModal('codeModal'); }
function runCode() {
  const code = document.getElementById('codeIn').value;
  const lang = document.getElementById('codeLang').value;
  const out = document.getElementById('codeOutput');
  if (!code.trim()) { out.textContent = 'Error: No code!'; return; }
  if (lang === 'javascript') {
    const logs = []; const orig = console.log;
    console.log = (...a) => logs.push(a.join(' '));
    try { const r = eval(code); console.log = orig; out.textContent = logs.length ? logs.join('\n') : r !== undefined ? String(r) : 'Done!'; }
    catch(e) { console.log = orig; out.textContent = `Error: ${e.message}`; }
  } else if (lang === 'html') {
    const w = window.open('','_blank','width=800,height=600');
    w.document.write(code); w.document.close();
    out.textContent = 'Opened in new tab ‚ú¶';
  } else { out.textContent = `${lang} execution coming soon!`; }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MESSAGE SEARCH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openSearch() {
  if (document.getElementById('searchOverlay')) return;
  const ov = document.createElement('div');
  ov.id = 'searchOverlay';
  ov.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.76);backdrop-filter:blur(10px);z-index:2000;display:flex;align-items:flex-start;justify-content:center;padding-top:120px;';
  ov.innerHTML = `<div style="background:var(--bg-c);border:1px solid var(--br-s);border-radius:14px;width:90%;max-width:520px;overflow:hidden;box-shadow:0 16px 48px rgba(0,0,0,.6);">
    <div style="display:flex;align-items:center;gap:10px;padding:14px 16px;border-bottom:1px solid var(--br);">
      <span style="font-family:var(--mono);color:var(--tx-t);">‚åï</span>
      <input id="searchIn" placeholder="Search messages‚Ä¶" autocomplete="off" style="flex:1;background:transparent;border:none;outline:none;color:var(--tx);font-size:14px;font-family:var(--font);caret-color:var(--accent);">
      <span style="font-family:var(--mono);color:var(--tx-t);font-size:11px;">ESC</span>
    </div>
    <div id="searchRes" style="max-height:320px;overflow-y:auto;padding:8px 0;"><div style="padding:16px;color:var(--tx-t);font-size:13px;text-align:center;font-family:var(--mono);">Start typing‚Ä¶</div></div>
  </div>`;
  document.body.appendChild(ov);
  const inp = document.getElementById('searchIn'); inp.focus();
  inp.addEventListener('input', () => {
    const q = inp.value.trim().toLowerCase();
    const res = document.getElementById('searchRes');
    if (!q) { res.innerHTML='<div style="padding:16px;color:var(--tx-t);font-size:13px;text-align:center;font-family:var(--mono);">Start typing‚Ä¶</div>'; return; }
    const msgs = [...document.querySelectorAll('#chatMessages .message')];
    const matches = msgs.filter(m => { const b=m.querySelector('.bubble'); if(!b) return false; const c=b.cloneNode(true); c.querySelectorAll('button,.reaction-row').forEach(x=>x.remove()); return (c.innerText||'').toLowerCase().includes(q); });
    if (!matches.length) { res.innerHTML=`<div style="padding:16px;color:var(--tx-t);font-size:13px;text-align:center;font-family:var(--mono);">No results for "${q}"</div>`; return; }
    res.innerHTML = matches.map((m,i) => {
      const c=m.querySelector('.bubble').cloneNode(true); c.querySelectorAll('button,.reaction-row').forEach(x=>x.remove());
      const txt = (c.innerText||'').trim(); const snip = txt.length>80?txt.slice(0,80)+'‚Ä¶':txt;
      const hl = snip.replace(new RegExp(q,'gi'), x=>`<mark style="background:rgba(200,200,255,.25);color:var(--tx);border-radius:2px;padding:0 2px;">${x}</mark>`);
      return `<button data-i="${i}" style="width:100%;background:transparent;border:none;text-align:left;padding:10px 16px;cursor:pointer;border-bottom:1px solid var(--br);" onmouseover="this.style.background='var(--hv)'" onmouseout="this.style.background='transparent'"><div style="font-size:10px;font-family:var(--mono);color:var(--tx-t);text-transform:uppercase;margin-bottom:3px;">${m.classList.contains('user')?'You':'Indy'}</div><div style="font-size:13px;color:var(--tx-s);">${hl}</div></button>`;
    }).join('');
    res.querySelectorAll('button[data-i]').forEach((btn,i) => btn.addEventListener('click',() => {
      matches[i].scrollIntoView({behavior:'smooth',block:'center'});
      matches[i].style.transition='background .3s'; matches[i].style.background='rgba(200,200,255,.06)';
      setTimeout(()=>matches[i].style.background='',1200); ov.remove();
    }));
  });
  ov.addEventListener('click', e => { if(e.target===ov) ov.remove(); });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  TOAST
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showToast(msg, dur=2200) {
  document.getElementById('indyToast')?.remove();
  const t = document.createElement('div');
  t.id = 'indyToast';
  t.textContent = msg;
  t.style.cssText = 'position:fixed;bottom:90px;left:50%;transform:translateX(-50%) translateY(8px);background:var(--bg-c);border:1px solid var(--br-s);color:var(--tx-s);font-size:12.5px;font-family:var(--mono);letter-spacing:.04em;padding:8px 18px;border-radius:999px;z-index:9999;opacity:0;transition:all .2s cubic-bezier(.2,.8,.4,1);pointer-events:none;white-space:nowrap;';
  document.body.appendChild(t);
  requestAnimationFrame(()=>{ t.style.opacity='1'; t.style.transform='translateX(-50%) translateY(0)'; });
  setTimeout(()=>{ t.style.opacity='0'; t.style.transform='translateX(-50%) translateY(6px)'; setTimeout(()=>t.remove(),200); }, dur);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CHAR COUNTER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateChar(text) {
  const el = document.getElementById('charCnt'); if(!el) return;
  const MAX=2000, l=text.length;
  el.textContent = l>0?l:''; el.className='char-cnt';
  if(l>MAX*.85) el.classList.add('warn');
  if(l>MAX) el.classList.add('over');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  AUTO-RESIZE INPUT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.addEventListener('DOMContentLoaded', () => {
  const ta = document.getElementById('userInput');
  ta.addEventListener('input', () => { ta.style.height='auto'; ta.style.height=Math.min(ta.scrollHeight,120)+'px'; updateChar(ta.value); });
  ta.addEventListener('keydown', e => { if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendMessage();setTimeout(()=>ta.style.height='auto',0);} });
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MODEL SELECTOR
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.addEventListener('DOMContentLoaded', () => {
  const pop = document.getElementById('modelPop');
  document.getElementById('modelBtn').addEventListener('click', e=>{e.stopPropagation();pop.classList.toggle('open');});
  document.addEventListener('click', e=>{if(!pop.contains(e.target)&&e.target!==document.getElementById('modelBtn')) pop.classList.remove('open');});
  pop.querySelectorAll('.mitem').forEach(item => item.addEventListener('click', () => {
    pop.querySelectorAll('.mitem').forEach(i=>i.classList.remove('sel'));
    item.classList.add('sel');
    modelDropdownValue = item.dataset.model;
    localStorage.setItem('selectedModel', modelDropdownValue);
    document.getElementById('modelLabel').textContent = modelDropdownValue;
    pop.classList.remove('open');
    updateStatusBar();
    showToast(`Model: ${modelDropdownValue}`);
  }));
  // Load saved model
  const saved = localStorage.getItem('selectedModel');
  if (saved) {
    modelDropdownValue = saved;
    const el = pop.querySelector(`[data-model="${saved}"]`);
    if(el){pop.querySelectorAll('.mitem').forEach(i=>i.classList.remove('sel'));el.classList.add('sel');}
  }
  document.getElementById('modelLabel').textContent = modelDropdownValue;
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  KEYBOARD SHORTCUTS HANDLER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.addEventListener('keydown', e => {
  const typing = ['INPUT','TEXTAREA'].includes(document.activeElement.tagName);
  if(e.key==='/'&&!typing){e.preventDefault();document.getElementById('userInput')?.focus();}
  if(e.key==='?'&&!typing){e.preventDefault();openShortcuts();}
  if((e.ctrlKey||e.metaKey)&&e.key==='k'){e.preventDefault();openSearch();}
  if((e.ctrlKey||e.metaKey)&&e.key==='n'){e.preventDefault();newChat();}
  if((e.ctrlKey||e.metaKey)&&e.key==='e'){e.preventDefault();exportChatHTML();}
  if((e.ctrlKey||e.metaKey)&&e.key==='b'){e.preventDefault();toggleSidebar();}
  if((e.ctrlKey||e.metaKey)&&e.shiftKey&&e.key==='L'){e.preventDefault();toggleTheme();}
  if(e.key==='Escape'){
    document.querySelectorAll('.modal.open').forEach(m=>m.classList.remove('open'));
    document.getElementById('searchOverlay')?.remove();
    document.getElementById('modelPop')?.classList.remove('open');
  }
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CONVERSATION STARTERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const STARTERS = ['Explain something complex simply','Help me debug my code','Write a short story about‚Ä¶','What are the pros and cons of‚Ä¶','Summarize this idea:','Give me 5 ideas for‚Ä¶','How does X work?','Help me write an email about‚Ä¶'];
function renderStarters() {
  const cont = document.getElementById('chatMessages');
  if(!cont||document.getElementById('starterChips')||cont.querySelectorAll('.message').length>1) return;
  const wrap = document.createElement('div'); wrap.id='starterChips';
  [...STARTERS].sort(()=>Math.random()-.5).slice(0,4).forEach(s => {
    const c = document.createElement('button');
    c.style.cssText='background:var(--bg-c);border:1px solid var(--br);border-radius:var(--rsm);color:var(--tx-s);font-size:12.5px;font-family:var(--mono);padding:7px 12px;cursor:pointer;transition:all .15s;';
    c.textContent = s;
    c.onmouseenter=()=>{c.style.borderColor='var(--br-s)';c.style.color='var(--tx)';c.style.background='var(--hv)';};
    c.onmouseleave=()=>{c.style.borderColor='var(--br)';c.style.color='var(--tx-s)';c.style.background='var(--bg-c)';};
    c.onclick=()=>{const i=document.getElementById('userInput');if(i){i.value=s.replace('‚Ä¶','');i.focus();updateChar(i.value);}wrap.remove();};
    wrap.appendChild(c);
  });
  cont.appendChild(wrap);
  cont.scrollTop=cont.scrollHeight;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.addEventListener('DOMContentLoaded', () => {
  loadSavedChats();
  updateSidebarProfile();
  const cl = JSON.parse(localStorage.getItem('chatList')||'[]');
  if(cl.length>0) loadChat(cl[0].id);
  else {
    currentChatId=`chat_${Date.now()}`; conversationHistory=[];
    const list=JSON.parse(localStorage.getItem('chatList')||'[]');
    list.unshift({id:currentChatId,name:'New Chat'});
    localStorage.setItem('chatList',JSON.stringify(list));
    loadSavedChats(); setTimeout(renderStarters,150);
  }
  updateStatusBar();
  getStreak(); // initialize streak on first load of day
});
</script>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  STRANGER THINGS EASTER EGG
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const _udStyle = document.createElement('style');
_udStyle.textContent=`@keyframes chaoticDrift{0%{transform:translate(0,0)scale(1);opacity:.5}30%{opacity:.85}60%{opacity:.35}100%{transform:translate(var(--dx),var(--dy))scale(var(--s));opacity:.5}}@keyframes slowRotate{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}.upside-particle{position:fixed;background:#ffe6e6;pointer-events:none;z-index:9995;border-radius:1px;box-shadow:0 0 12px rgba(255,80,80,.7);animation:chaoticDrift infinite ease-in-out,slowRotate infinite linear;}#red-flood{position:fixed;inset:0;background:#2e0000;pointer-events:none;z-index:10001;opacity:0;transition:opacity 5.2s ease-out;box-shadow:inset 0 0 160px rgba(0,0,0,.98);}#red-flood.fade-in{animation:fadeInRed .9s ease-in forwards;}@keyframes fadeInRed{from{opacity:0}to{opacity:1}}#red-flood.visible{opacity:1;}body.upsidedown{filter:brightness(.78)contrast(1.22)sepia(.15);transition:filter 7s ease-in-out;}`;
document.head.appendChild(_udStyle);
let _udActive=false;
function enterUpsideDown(){
  if(_udActive)return; _udActive=true;
  const flood=document.createElement('div'); flood.id='red-flood'; document.body.appendChild(flood); flood.classList.add('fade-in');
  setTimeout(()=>{document.body.style.transform='rotate(180deg)';document.body.style.transformOrigin='center center';flood.classList.add('visible');},600);
  for(let i=0;i<90;i++) setTimeout(()=>{
    const sz=1.4+Math.random()*5.2,p=document.createElement('div'); p.className='upside-particle';
    const dx=(Math.random()-.5)*1500,dy=(Math.random()-.5)*1500,sc=.35+Math.random()*2.3,dr=85+Math.random()*170,ro=45+Math.random()*90;
    p.style.cssText=`width:${sz}px;height:${sz}px;left:${Math.random()*100}vw;top:${Math.random()*100}vh;--dx:${dx}px;--dy:${dy}px;--s:${sc};animation-duration:${dr}s,${ro}s;animation-delay:-${Math.random()*dr}s,0s;opacity:.5;`;
    document.body.appendChild(p);
  },i*32);
  setTimeout(()=>{flood.style.opacity='0';setTimeout(()=>{flood.remove();document.body.classList.add('upsidedown');setTimeout(()=>{addMessage('bot',"It swallowed everything.<br><span style='color:#c00;'>You're in the Upside Down.</span><br><small style='opacity:.7'>reload to leave</small>");},1800);},5200);},2800);
}
</script>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  UPDATE POPUP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
(function(){
  const KEY='indy_mega_v3';
  if(localStorage.getItem(KEY)==='true') return;
  const m=document.createElement('div');
  m.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,.87);backdrop-filter:blur(12px);z-index:99999;display:flex;align-items:center;justify-content:center;opacity:0;transition:opacity .4s;';
  const c=document.createElement('div');
  c.style.cssText='background:rgba(22,22,22,.97);border:1px solid rgba(255,255,255,.12);border-radius:20px;max-width:480px;width:92%;padding:32px 28px;text-align:center;transform:scale(.93);transition:all .4s cubic-bezier(.34,1.56,.64,1);';
  c.innerHTML=`<div style="font-size:44px;margin-bottom:14px;">‚ú¶</div>
<h2 style="font-family:'IBM Plex Mono',monospace;font-weight:600;font-size:21px;margin-bottom:14px;letter-spacing:.04em;text-transform:uppercase;">Indy ‚Äî Mega Update</h2>
<p style="font-size:13px;color:#bbb;line-height:1.65;margin-bottom:20px;">14 new features. Actually competes now. ü§†</p>
<ul style="text-align:left;margin:0 auto 24px;padding-left:0;font-size:13px;color:#ccc;line-height:1.9;list-style:none;max-width:360px;">
${['üéô Voice input ‚Äî speak your messages','üîä Text-to-speech ‚Äî Indy reads replies aloud','üìÇ File drop ‚Äî drag in .txt .md .json .py and more','üìã Prompt templates ‚Äî save and reuse your prompts','‚ú¶ Chat summary ‚Äî instant AI-powered recap','üåê Web mode toggle ‚Äî current events reasoning','üî• Streak tracker ‚Äî daily usage streak','üìù Markdown rendering ‚Äî headers, tables, bold, lists','üñº Fixed image gen ‚Äî Pollinations API (actually works)','üí° Double-click chats to rename','‚è± Message timestamps on hover','‚òÄ/‚òæ Dark/Light mode toggle','‚å® Shortcut sheet ‚Äî press ? anytime','‚Üì Export as styled HTML'].map(f=>`<li style="padding:2px 0;">‚Üí ${f}</li>`).join('')}
</ul>
<button id="closeUpdate" style="background:#f0f0f0;color:#000;border:none;padding:13px 48px;font-size:13px;font-weight:700;letter-spacing:.06em;text-transform:uppercase;border-radius:50px;cursor:pointer;font-family:'IBM Plex Mono',monospace;">Let's cook ü§†</button>`;
  m.appendChild(c); document.body.appendChild(m);
  setTimeout(()=>{m.style.opacity='1';c.style.transform='scale(1)';},60);
  document.getElementById('closeUpdate').onclick=()=>{localStorage.setItem(KEY,'true');m.style.opacity='0';setTimeout(()=>m.remove(),400);};
  m.onclick=e=>{if(e.target===m){localStorage.setItem(KEY,'true');m.style.opacity='0';setTimeout(()=>m.remove(),400);}};
})();
</script>
</body>
</html>
