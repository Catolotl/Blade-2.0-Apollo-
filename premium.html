<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Indy Sunrise AI</title>
  <link rel="shortcut icon" type="image/png" href="favicon.png">
  
<style>
    :root {
      --bg: #000000;
      --bg-elevated: #0f0f0f;
      --bg-card: #1a1a1a;
      --text: #f5f5f5;
      --text-secondary: #9ca3af;
      --text-tertiary: #6b7280;
      --border: rgba(255, 255, 255, 0.06);
      --glass-bg: rgba(26, 26, 26, 0.5);
      --glass-border: rgba(255, 255, 255, 0.08);
      --hover-bg: rgba(255, 255, 255, 0.05);
      --active-bg: rgba(255, 255, 255, 0.08);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', system-ui, sans-serif;
      min-height: 100vh;
      display: flex;
      overflow: hidden;
    }

    /* â”€â”€ Sidebar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .sidebar {
      position: fixed;
      inset: 0 auto 0 0;
      width: 280px;
      background: var(--bg-elevated);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      transition: width 0.35s cubic-bezier(0.32, 0.72, 0, 1);
      z-index: 100;
      overflow: hidden;
    }
    
    .sidebar.collapsed {
      width: 72px;
    }

    .header {
      padding: 20px 20px;
      display: flex;
      align-items: center;
      gap: 14px;
      min-height: 72px;
      flex-shrink: 0;
      border-bottom: 1px solid var(--border);
    }

    .menu-btn {
      background: transparent;
      border: none;
      color: var(--text-secondary);
      font-size: 22px;
      cursor: pointer;
      padding: 10px;
      border-radius: 10px;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    
    .menu-btn:hover {
      background: var(--hover-bg);
      color: var(--text);
      transform: scale(1.05);
    }
    
    .menu-btn:active {
      transform: scale(0.95);
    }

    .title {
      font-size: 22px;
      font-weight: 600;
      letter-spacing: -0.02em;
      color: var(--text);
      white-space: nowrap;
      opacity: 1;
      transition: opacity 0.25s ease;
    }
    
    .sidebar.collapsed .title {
      opacity: 0;
      pointer-events: none;
    }

    .sidebar-content {
      flex: 1;
      padding: 12px;
      overflow-y: auto;
      overflow-x: hidden;
    }

    .sidebar-content::-webkit-scrollbar {
      width: 6px;
    }

    .sidebar-content::-webkit-scrollbar-track {
      background: transparent;
    }

    .sidebar-content::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 10px;
    }

    .sidebar-btn {
      width: 100%;
      height: 44px;
      background: transparent;
      border: none;
      border-radius: 10px;
      color: var(--text-secondary);
      font-size: 15px;
      cursor: pointer;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      align-items: center;
      justify-content: flex-start;
      padding: 0 14px;
      gap: 12px;
      margin-bottom: 4px;
      position: relative;
      overflow: hidden;
    }

    .sidebar-btn::before {
      content: attr(data-icon);
      font-size: 18px;
      opacity: 0.8;
      flex-shrink: 0;
      transition: opacity 0.2s;
    }

    .sidebar-btn span {
      white-space: nowrap;
      opacity: 1;
      transition: opacity 0.25s ease;
      font-weight: 500;
    }

    .sidebar.collapsed .sidebar-btn span {
      opacity: 0;
      pointer-events: none;
    }

    .sidebar.collapsed .sidebar-btn {
      justify-content: center;
    }

    .sidebar-btn:hover {
      background: var(--hover-bg);
      color: var(--text);
    }

    .sidebar-btn:hover::before {
      opacity: 1;
    }

    .sidebar-btn:active {
      background: var(--active-bg);
      transform: scale(0.98);
    }

    .sidebar-btn.danger {
      color: #ff453a;
    }

    .sidebar-btn.danger:hover {
      background: rgba(255, 69, 58, 0.1);
    }

    hr {
      border: none;
      border-top: 1px solid var(--border);
      margin: 12px 0;
    }

    /* Chat List Items */
    #chatList .sidebar-btn {
      justify-content: space-between;
      padding-right: 8px;
    }

    #chatList .sidebar-btn span:first-of-type {
      flex: 1;
      text-align: left;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    #chatList .sidebar-btn span:last-of-type {
      opacity: 0;
      color: #ff453a;
      font-size: 16px;
      padding: 4px 8px;
      border-radius: 6px;
      transition: all 0.2s;
      flex-shrink: 0;
    }

    #chatList .sidebar-btn:hover span:last-of-type {
      opacity: 0.7;
    }

    #chatList .sidebar-btn span:last-of-type:hover {
      opacity: 1;
      background: rgba(255, 69, 58, 0.15);
    }

    /* â”€â”€ Main â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .main {
      flex: 1;
      margin-left: 280px;
      display: flex;
      flex-direction: column;
      transition: margin-left 0.35s cubic-bezier(0.32, 0.72, 0, 1);
      height: 100vh;
    }
    
    .sidebar.collapsed ~ .main {
      margin-left: 72px;
    }

    .chat-container {
      flex: 1;
      overflow-y: auto;
      padding: 32px 24px 140px;
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    .chat-container::-webkit-scrollbar {
      width: 8px;
    }

    .chat-container::-webkit-scrollbar-track {
      background: transparent;
    }

    .chat-container::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 10px;
    }

    /* Messages */
    .message {
      max-width: 80%;
      animation: messageSlide 0.3s cubic-bezier(0.32, 0.72, 0, 1);
    }

    @keyframes messageSlide {
      from {
        opacity: 0;
        transform: translateY(8px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .user {
      align-self: flex-end;
    }

    .bot {
      align-self: flex-start;
    }

    .bubble {
      padding: 12px 16px;
      border-radius: 18px;
      line-height: 1.5;
      font-size: 15px;
      position: relative;
    }

    .user .bubble {
      background: var(--glass-bg);
      backdrop-filter: blur(20px) saturate(180%);
      -webkit-backdrop-filter: blur(20px) saturate(180%);
      border: 1px solid var(--glass-border);
      color: var(--text);
      border-bottom-right-radius: 4px;
      max-width: 100%;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
    }

    .bot .bubble {
      background: transparent;
      border: none;
      padding: 0;
      color: var(--text);
      font-size: 15px;
      line-height: 1.6;
    }

    .bot .bubble img {
      border-radius: 16px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
      margin: 12px 0;
    }

    /* Copy button */
    .copy-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      background: var(--glass-bg);
      backdrop-filter: blur(10px);
      border: 1px solid var(--glass-border);
      color: var(--text-secondary);
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 8px;
      cursor: pointer;
      opacity: 0;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      font-weight: 500;
    }

    .bot:hover .copy-btn {
      opacity: 1;
    }

    .copy-btn:hover {
      background: var(--hover-bg);
      color: var(--text);
      transform: scale(1.05);
    }

    .copy-btn:active {
      transform: scale(0.95);
    }

    /* Input Area */
    .input-area {
      padding: 20px 24px 24px;
      background: var(--bg);
      border-top: 1px solid var(--border);
      position: fixed;
      bottom: 0;
      left: 280px;
      right: 0;
      z-index: 10;
      transition: left 0.35s cubic-bezier(0.32, 0.72, 0, 1);
    }

    .sidebar.collapsed ~ .main .input-area {
      left: 72px;
    }

    .input-wrapper {
      max-width: 900px;
      margin: 0 auto;
      display: flex;
      gap: 12px;
      align-items: center;
      background: var(--glass-bg);
      backdrop-filter: blur(20px) saturate(180%);
      -webkit-backdrop-filter: blur(20px) saturate(180%);
      border: 1px solid var(--glass-border);
      border-radius: 24px;
      padding: 6px 6px 6px 20px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .input-wrapper:focus-within {
      border-color: rgba(255, 255, 255, 0.15);
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
    }

    #userInput {
      flex: 1;
      background: transparent;
      border: none;
      color: var(--text);
      font-size: 15px;
      outline: none;
      padding: 12px 0;
      font-family: inherit;
    }

    #userInput::placeholder {
      color: var(--text-tertiary);
    }

    .send-btn {
      width: 36px;
      height: 36px;
      background: var(--text);
      color: var(--bg);
      border: none;
      border-radius: 50%;
      font-size: 18px;
      cursor: pointer;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .send-btn:hover {
      transform: scale(1.08);
      box-shadow: 0 4px 12px rgba(255, 255, 255, 0.2);
    }

    .send-btn:active {
      transform: scale(0.95);
    }

    /* Typing Indicator */
    .typing-indicator {
      display: inline-flex;
      gap: 6px;
      padding: 8px 0;
    }

    .typing-indicator span {
      width: 8px;
      height: 8px;
      background: var(--text-secondary);
      border-radius: 50%;
      animation: typingBounce 1.4s infinite ease-in-out;
    }

    .typing-indicator span:nth-child(2) {
      animation-delay: 0.2s;
    }

    .typing-indicator span:nth-child(3) {
      animation-delay: 0.4s;
    }

    @keyframes typingBounce {
      0%, 60%, 100% {
        transform: translateY(0);
        opacity: 0.4;
      }
      30% {
        transform: translateY(-10px);
        opacity: 1;
      }
    }

    /* Modals */
    .teach-modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.75);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.25s ease;
    }

    .teach-modal.active {
      display: flex;
      animation: fadeIn 0.25s ease forwards;
    }

    @keyframes fadeIn {
      to {
        opacity: 1;
      }
    }

    .teach-content {
      background: var(--bg-card);
      border: 1px solid var(--glass-border);
      border-radius: 20px;
      padding: 32px;
      max-width: 520px;
      width: 90%;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      position: relative;
      animation: modalSlide 0.3s cubic-bezier(0.32, 0.72, 0, 1);
    }

    @keyframes modalSlide {
      from {
        transform: scale(0.95) translateY(20px);
        opacity: 0;
      }
      to {
        transform: scale(1) translateY(0);
        opacity: 1;
      }
    }

    .teach-content h2 {
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 24px;
      color: var(--text);
    }

    .close-btn {
      position: absolute;
      top: 20px;
      right: 20px;
      background: var(--hover-bg);
      border: none;
      color: var(--text-secondary);
      font-size: 24px;
      cursor: pointer;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .close-btn:hover {
      background: var(--active-bg);
      color: var(--text);
      transform: scale(1.1);
    }

    .close-btn:active {
      transform: scale(0.9);
    }

    .teach-input-group {
      margin-bottom: 20px;
    }

    .teach-input-group label {
      display: block;
      margin-bottom: 8px;
      color: var(--text-secondary);
      font-size: 14px;
      font-weight: 500;
    }

    .teach-input-group input,
    .teach-input-group textarea {
      width: 100%;
      background: var(--bg-elevated);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px 16px;
      color: var(--text);
      font-size: 15px;
      font-family: inherit;
      transition: all 0.2s;
      resize: vertical;
    }

    .teach-input-group input:focus,
    .teach-input-group textarea:focus {
      outline: none;
      border-color: rgba(255, 255, 255, 0.2);
      background: var(--bg);
    }

    .teach-input-group textarea {
      min-height: 100px;
    }

    .teach-submit-btn {
      width: 100%;
      background: var(--text);
      color: var(--bg);
      border: none;
      border-radius: 12px;
      padding: 14px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .teach-submit-btn:hover {
      transform: scale(1.02);
      box-shadow: 0 4px 16px rgba(255, 255, 255, 0.2);
    }

    .teach-submit-btn:active {
      transform: scale(0.98);
    }

    #profilePreview {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      background: var(--bg-elevated);
      background-size: cover;
      background-position: center;
      border: 2px solid var(--border);
      transition: all 0.3s;
    }

    #profilePreview:hover {
      transform: scale(1.05);
    }
  </style>
</head>
<body>
  <div class="sidebar collapsed" id="sidebar">
    <div class="header">
      <button class="menu-btn" onclick="toggleSidebar()">â˜°</button>
      <div class="title">Indy/</div>
    </div>
    <div class="sidebar-content">
      <button class="sidebar-btn" data-icon="âœ¦" onclick="newChat()">
        <span>New Chat</span>
      </button>
      <button class="sidebar-btn" data-icon="ðŸ—‚" onclick="openProjects()">
        <span>Projects</span>
      </button>
      <button class="sidebar-btn" data-icon="ðŸ‘¤" onclick="openProfile()">
        <span>Profile Settings</span>
      </button>
      <button class="sidebar-btn danger" data-icon="ðŸ—‘" onclick="deleteAllChats()">
        <span>Delete Everything</span>
      </button>
      <hr>
      <div id="chatList"></div>
    </div>
  </div>

  <div class="main">
    <div class="chat-container" id="chatMessages">
      <div class="message bot">
        <div class="bubble">
          How's it going! I'm Indy,<br>
          Ready when you are!
        </div>
      </div>
    </div>

    <div class="input-area">
      <div class="input-wrapper">
        <input type="text" id="userInput" placeholder="Ask anything..." onkeypress="if(event.key==='Enter') sendMessage()">
        <button class="send-btn" onclick="sendMessage()">â†‘</button>
      </div>
    </div>
  </div>

  <!-- Teach Modal -->
  <div class="teach-modal" id="teachModal">
    <div class="teach-content">
      <button class="close-btn" onclick="closeTeachModal()">Ã—</button>
      <h2>Teach Indy</h2>
      <div class="teach-input-group">
        <label>Trigger Phrase</label>
        <input type="text" id="triggerInput" placeholder="e.g. What's your favorite color?">
      </div>
      <div class="teach-input-group">
        <label>Response</label>
        <textarea id="responseInput" placeholder="e.g. My favorite color is blue!"></textarea>
      </div>
      <button class="teach-submit-btn" onclick="submitTeaching()">Teach Indy</button>
    </div>
  </div>

  <!-- Profile Modal -->
  <div class="teach-modal" id="profileModal">
    <div class="teach-content">
      <button class="close-btn" onclick="closeProfileModal()">Ã—</button>
      <h2>Profile Settings</h2>
      <div style="display:flex;justify-content:center;margin-bottom:20px;">
        <div id="profilePreview"></div>
      </div>
      <div class="teach-input-group">
        <label>Your Name</label>
        <input type="text" id="profileName" placeholder="e.g. Alex">
      </div>
      <div class="teach-input-group">
        <label>Profile Picture URL</label>
        <input type="text" id="profilePicture" placeholder="https://example.com/image.jpg" oninput="updateProfilePreview()">
      </div>
      <button class="teach-submit-btn" onclick="submitProfile()">Save Profile</button>
    </div>
  </div>

  <script>
let knowledge = [];
let personality = "";
let currentChatId = null;
let userProfile = JSON.parse(localStorage.getItem('userProfile')) || { name: '', picture: '' };

function toggleSidebar() {
  document.getElementById('sidebar').classList.toggle('collapsed');
}

function saveCurrentChat() {
  if (!currentChatId) return;
  const messages = [];
  document.querySelectorAll('#chatMessages .message').forEach(msg => {
    const sender = msg.classList.contains('user') ? 'user' : 'bot';
    const text = msg.querySelector('.bubble').textContent.replace('Copy', '').trim();
    messages.push({ sender, text });
  });
  const chatData = {
    id: currentChatId,
    name: getChatName(currentChatId),
    messages,
    lastUpdated: Date.now()
  };
  localStorage.setItem(`chat_${currentChatId}`, JSON.stringify(chatData));
}

async function generateChatName(firstMessage) {
  try {
    const prompt = `Generate a short, concise chat title (3-5 words max) for a conversation that starts with: "${firstMessage}". Only respond with the title, nothing else.`;
    const res = await fetch(`https://text.pollinations.ai/${encodeURIComponent(prompt)}`);
    if (res.ok) {
      const name = await res.text();
      return name.trim().replace(/['"]/g, '').substring(0, 40);
    }
  } catch {}
  return `Chat ${Date.now()}`;
}

function loadChat(chatId) {
  const chatData = JSON.parse(localStorage.getItem(`chat_${chatId}`));
  if (!chatData) return;
  currentChatId = chatId;
  document.getElementById('chatMessages').innerHTML = '';
  chatData.messages.forEach(msg => addMessage(msg.sender, msg.text, false));
}

async function newChat(chatId = null) {
  if (chatId) {
    loadChat(chatId);
    return;
  }
  currentChatId = `chat_${Date.now()}`;
  document.getElementById('chatMessages').innerHTML = '';
  addMessage('bot', `Ready when you are!`, false);
  const chatList = JSON.parse(localStorage.getItem('chatList') || '[]');
  chatList.unshift({ id: currentChatId, name: 'New Chat' });
  localStorage.setItem('chatList', JSON.stringify(chatList));
  saveCurrentChat();
  loadSavedChats();
}

async function updateChatName(chatId, firstMessage) {
  const generatedName = await generateChatName(firstMessage);
  const chatList = JSON.parse(localStorage.getItem('chatList') || '[]');
  const chat = chatList.find(c => c.id === chatId);
  if (chat && chat.name === 'New Chat') {
    chat.name = generatedName;
    localStorage.setItem('chatList', JSON.stringify(chatList));
    const chatData = JSON.parse(localStorage.getItem(`chat_${chatId}`));
    if (chatData) {
      chatData.name = generatedName;
      localStorage.setItem(`chat_${chatId}`, JSON.stringify(chatData));
    }
    loadSavedChats();
  }
}

function getChatName(chatId) {
  const chatList = JSON.parse(localStorage.getItem('chatList') || '[]');
  const chat = chatList.find(c => c.id === chatId);
  return chat ? chat.name : 'Unnamed Chat';
}

function deleteChat(chatId) {
  localStorage.removeItem(`chat_${chatId}`);
  let chatList = JSON.parse(localStorage.getItem('chatList') || '[]');
  chatList = chatList.filter(c => c.id !== chatId);
  localStorage.setItem('chatList', JSON.stringify(chatList));
  if (currentChatId === chatId) {
    currentChatId = null;
    document.getElementById('chatMessages').innerHTML = '';
    addMessage('bot', `Ready when you are!`, false);
  }
  loadSavedChats();
}

function deleteAllChats() {
  if (confirm("Delete all saved chats and history permanently?")) {
    const chatList = JSON.parse(localStorage.getItem('chatList') || '[]');
    chatList.forEach(chat => localStorage.removeItem(`chat_${chat.id}`));
    localStorage.removeItem('chatList');
    knowledge = [];
    currentChatId = null;
    document.getElementById('chatMessages').innerHTML = '';
    addMessage('bot', `All chats deleted! Ready for a fresh start!`, false);
    loadSavedChats();
  }
}

function teachAI() {
  document.getElementById('teachModal').classList.add('active');
  document.getElementById('triggerInput').value = '';
  document.getElementById('responseInput').value = '';
  document.getElementById('triggerInput').focus();
}

function closeTeachModal() {
  document.getElementById('teachModal').classList.remove('active');
}

function submitTeaching() {
  const q = document.getElementById('triggerInput').value.trim();
  const a = document.getElementById('responseInput').value.trim();
  if (!q || !a) { alert('Please fill in both fields!'); return; }
  let found = false;
  for (const entry of knowledge) {
    if (entry.answer.toLowerCase() === a.toLowerCase()) {
      entry.questions.push(q);
      found = true;
      break;
    }
  }
  if (!found) knowledge.push({ questions: [q], answer: a });
  addMessage('bot', "Learned! I'll remember that.");
  closeTeachModal();
}

function openProfile() {
  document.getElementById('profileModal').classList.add('active');
  document.getElementById('profileName').value = userProfile.name;
  document.getElementById('profilePicture').value = userProfile.picture;
  updateProfilePreview();
}

function closeProfileModal() {
  document.getElementById('profileModal').classList.remove('active');
}

function updateProfilePreview() {
  const preview = document.getElementById('profilePreview');
  const pictureUrl = document.getElementById('profilePicture').value.trim();
  preview.style.backgroundImage = pictureUrl ? `url(${pictureUrl})` : 'none';
  preview.style.backgroundColor = pictureUrl ? 'transparent' : 'var(--bg-elevated)';
}

function submitProfile() {
  userProfile.name = document.getElementById('profileName').value.trim();
  userProfile.picture = document.getElementById('profilePicture').value.trim();
  localStorage.setItem('userProfile', JSON.stringify(userProfile));
  closeProfileModal();
}

function openProjects() {
  alert("Projects view coming soon! You can later expand this to show saved projects or canvases.");
}

function getSystemPrompt() {
  return `You are Indy, a helpful AI assistant. Be concise, friendly, and conversational. ${personality}`.trim() + "\n\nUser: ";
}

function cosineSimilarity(a, b) {
  const tokensA = a.toLowerCase().match(/\w+/g) || [];
  const tokensB = b.toLowerCase().match(/\w+/g) || [];
  const set = [...new Set([...tokensA, ...tokensB])];
  const vecA = set.map(t => tokensA.filter(w => w === t).length);
  const vecB = set.map(t => tokensB.filter(w => w === t).length);
  let dot = 0, normA = 0, normB = 0;
  for (let i = 0; i < set.length; i++) {
    dot += vecA[i] * vecB[i];
    normA += vecA[i] ** 2;
    normB += vecB[i] ** 2;
  }
  return normA && normB ? dot / (Math.sqrt(normA) * Math.sqrt(normB)) : 0;
}

function findInKnowledge(msg) {
  let best = null, bestScore = 0;
  for (const entry of knowledge) {
    for (const q of entry.questions) {
      const score = cosineSimilarity(msg, q);
      if (score > bestScore && score > 0.5) {
        bestScore = score;
        best = entry.answer;
      }
    }
  }
  return best;
}

function handleMath(msg) {
  const expr = msg.toLowerCase().replace(/^(what is|calculate|\s)+/g, '').trim()
    .replace(/Ã—/g,'*').replace(/Ã·/g,'/').replace(/\^/g,'**');
  if (/^[0-9+\-*/().\s**]+$/.test(expr)) {
    try { return Function('"use strict"; return (' + expr + ')')(); } catch(e) {}
  }
  return null;
}

async function getDefinition(word) {
  try {
    const res = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${word}`);
    const data = await res.json();
    if (!data.title) return `**${word}:** ${data[0].meanings[0].definitions[0].definition}`;
  } catch {}
  return null;
}

async function getWikipedia(topic) {
  try {
    const res = await fetch(`https://en.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(topic)}`);
    const data = await res.json();
    if (data.extract) return `**${data.title}:** ${data.extract}`;
  } catch {}
  return null;
}

async function getAIResponse(prompt) {
  const fullPrompt = getSystemPrompt() + prompt;
  try {
    const res = await fetch(`https://text.pollinations.ai/${encodeURIComponent(fullPrompt)}`);
    if (res.ok) {
      const text = await res.text();
      return text.trim() || "â€¦";
    }
  } catch {}
  return "Thinking took too long.";
}

async function generateImage(prompt) {
  try {
    const encoded = encodeURIComponent(prompt.trim());
    const url = `https://image.pollinations.ai/prompt/${encoded}?model=flux&width=1152&height=896&nologo=true&safe=true`;
    const head = await fetch(url, { method: 'HEAD' });
    if (!head.ok) throw new Error(`Pollinations responded ${head.status}`);
    return url;
  } catch (err) {
    console.error("Image gen error:", err);
    return `Error generating image: ${err.message}. Try again in a few seconds.`;
  }
}

async function sendMessage() {
  const input = document.getElementById('userInput');
  const msg = input.value.trim();
  if (!msg) return;

  if (!currentChatId) {
    currentChatId = `chat_${Date.now()}`;
    const chatList = JSON.parse(localStorage.getItem('chatList') || '[]');
    chatList.unshift({ id: currentChatId, name: 'New Chat' });
    localStorage.setItem('chatList', JSON.stringify(chatList));
  }

  addMessage('user', msg);
  input.value = '';

  const messageCount = document.querySelectorAll('#chatMessages .message.user').length;
  if (messageCount === 1) {
    updateChatName(currentChatId, msg);
  }

  const learned = findInKnowledge(msg);
  if (learned) {
    addMessage('bot', learned);
    saveCurrentChat();
    return;
  }

  if (/^define |^meaning of /.test(msg.toLowerCase())) {
    const word = msg.replace(/^define |^meaning of /i, '').trim().split(' ')[0];
    addTypingIndicator();
    const def = await getDefinition(word);
    replaceLastBot(def || "Not found.");
    saveCurrentChat();
    return;
  }

  if (/^tell me about |^what is /.test(msg.toLowerCase())) {
    const topic = msg.replace(/^tell me about |^what is /i, '').trim();
    addTypingIndicator();
    const wiki = await getWikipedia(topic);
    replaceLastBot(wiki || "No result.");
    saveCurrentChat();
    return;
  }

  const math = handleMath(msg);
  if (math !== null) {
    addMessage('bot', `**${msg} = ${math}**`);
    saveCurrentChat();
    return;
  }

  if (msg.toLowerCase().startsWith('!img ') ||
      msg.toLowerCase().startsWith('generate image ') ||
      msg.toLowerCase().startsWith('draw ') ||
      msg.toLowerCase().startsWith('create image ')) {
    const imagePrompt = msg
      .replace(/^!img /i, '')
      .replace(/^generate image /i, '')
      .replace(/^draw /i, '')
      .replace(/^create image /i, '')
      .trim();

    if (!imagePrompt) {
      addMessage('bot', "Add a description please!\nExample: `!img neon cyberpunk fox in tokyo rain`");
      saveCurrentChat();
      return;
    }

    addTypingIndicator();
    const result = await generateImage(imagePrompt);

    if (result.startsWith('http')) {
      replaceLastBot(
        `Here's your Flux image:\n\n` +
        `<img src="${result}" alt="${imagePrompt}" ` +
        `style="max-width:100%; border-radius:20px; margin:16px 0; box-shadow:0 8px 32px rgba(0,0,0,0.5);">` +
        `\n\n**Prompt:** ${imagePrompt}\n` +
        `(Powered by pollinations.ai â€“ free & no login)`
      );
    } else {
      replaceLastBot(result);
    }
    saveCurrentChat();
    return;
  }

  addTypingIndicator();
  const response = await getAIResponse(msg);
  replaceLastBot(response);
  saveCurrentChat();
}

function addMessage(sender, text, shouldSave = true) {
  const container = document.getElementById('chatMessages');
  const msgDiv = document.createElement('div');
  msgDiv.className = `message ${sender}`;
  if (sender === 'bot') {
    msgDiv.innerHTML = `
      <div class="bubble">
        ${text.replace(/\n/g, '<br>')}
        <button class="copy-btn" onclick="copyText(this)">Copy</button>
      </div>`;
  } else {
    msgDiv.innerHTML = `<div class="bubble">${text.replace(/\n/g, '<br>')}</div>`;
  }
  container.appendChild(msgDiv);
  container.scrollTop = container.scrollHeight;
  if (shouldSave) saveCurrentChat();
}

function addTypingIndicator() {
  const container = document.getElementById('chatMessages');
  const msgDiv = document.createElement('div');
  msgDiv.className = 'message bot';
  msgDiv.innerHTML = `
    <div class="bubble">
      <div class="typing-indicator">
        <span></span><span></span><span></span>
      </div>
    </div>`;
  container.appendChild(msgDiv);
  container.scrollTop = container.scrollHeight;
}

function replaceLastBot(text) {
  const lastBotBubble = document.querySelector('.message.bot:last-child .bubble');
  if (lastBotBubble) {
    lastBotBubble.innerHTML = text.replace(/\n/g, '<br>') +
      '<button class="copy-btn" onclick="copyText(this)">Copy</button>';
  }
  document.getElementById('chatMessages').scrollTop = document.getElementById('chatMessages').scrollHeight;
  saveCurrentChat();
}

function copyText(btn) {
  const bubble = btn.parentElement;
  const text = bubble.textContent.replace('Copy', '').trim();
  navigator.clipboard.writeText(text);
  btn.textContent = 'Copied';
  setTimeout(() => btn.textContent = 'Copy', 2000);
}

function loadSavedChats() {
  const chatList = document.getElementById('chatList');
  chatList.innerHTML = '';
  const chats = JSON.parse(localStorage.getItem('chatList') || '[]');
  chats.forEach(chat => createChatButton(chat.id, chat.name));
}

function createChatButton(chatId, name) {
  const chatList = document.getElementById('chatList');
  const btn = document.createElement('button');
  btn.className = 'sidebar-btn';
  btn.onclick = () => newChat(chatId);
  
  const nameSpan = document.createElement('span');
  nameSpan.textContent = name;
  
  const delSpan = document.createElement('span');
  delSpan.textContent = 'âœ•';
  delSpan.onclick = (e) => {
    e.stopPropagation();
    deleteChat(chatId);
  };
  
  btn.appendChild(nameSpan);
  btn.appendChild(delSpan);
  chatList.appendChild(btn);
}

// Init
window.addEventListener('DOMContentLoaded', () => {
  loadSavedChats();
  const chatList = JSON.parse(localStorage.getItem('chatList') || '[]');
  if (chatList.length > 0) {
    loadChat(chatList[0].id);
  } else {
    addMessage('bot', `Ready when you are!`, false);
  }
});
</script>
</body>
</html>
