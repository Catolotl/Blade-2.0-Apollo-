
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Indy Sunrise AI</title>

<link rel="shortcut icon" type="image/png" href="favicon.png">
  
<style>

:root {
  /* Core colors */
  --bg-primary:      #0a0a0a;
  --bg-secondary:    #111111;
  --bg-tertiary:     #1a1a1a;
  --text-primary:    #f0f0f0;
  --text-secondary:  #b0b0b0;
  --text-muted:      #707070;
  --accent:          #60a5fa;
  --accent-hover:    #93c5fd;
  --accent-muted:    #3b82f6;

  /* Borders & shadows */
  --border:          1px solid #222222;
  --border-radius:   12px;
  --shadow-sm:       0 1px 3px rgba(0,0,0,0.4);
  --shadow-md:       0 4px 12px rgba(0,0,0,0.5);

  /* Typography */
  --font-base:       system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  --line-height:     1.65;
  --letter-spacing:  -0.01em;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  background: var(--bg-primary);
  color: var(--text-primary);
  font-family: var(--font-base);
  line-height: var(--line-height);
  letter-spacing: var(--letter-spacing);
  min-height: 100vh;
  display: flex;
}

/* Sidebar */
.sidebar {
  position: fixed;
  top: 0; left: 0;
  width: 280px;
  height: 100vh;
  background: var(--bg-secondary);
  border-right: var(--border);
  display: flex;
  flex-direction: column;
  transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  z-index: 10;
  overflow-y: auto;
}
.sidebar.collapsed { width: 64px; }

.header {
  padding: 18px 20px;
  display: flex;
  align-items: center;
  gap: 16px;
  min-height: 68px;
  flex-shrink: 0;
}

.menu-btn {
  background: none;
  border: none;
  color: var(--text-muted);
  font-size: 24px;
  cursor: pointer;
  padding: 8px;
  border-radius: 8px;
  transition: all 0.2s;
}
.menu-btn:hover {
  background: var(--bg-tertiary);
  color: var(--text-primary);
}

.title-wrapper {
  overflow: hidden;
  white-space: nowrap;
  opacity: 1;
  transition: opacity 0.35s ease 0.05s;
}
.sidebar.collapsed .title-wrapper {
  opacity: 0;
  width: 0;
}

.title {
  font-size: 26px;
  font-weight: 600;
  background: linear-gradient(135deg, var(--accent), #c084fc, #f472b6, #fbbf24);
  background-size: 200% 100%;
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  animation: shimmer 8s ease-in-out infinite;
}
@keyframes shimmer {
  0%, 100% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
}

.sidebar-content {
  flex: 1;
  padding: 0 20px 20px;
  overflow-y: auto;
}
.sidebar.collapsed .sidebar-content {
  opacity: 0;
  pointer-events: none;
}

.sidebar-btn {
  width: 100%;
  padding: 12px 16px;
  background: transparent;
  border: none;
  border-radius: 10px;
  color: var(--text-secondary);
  font-size: 15px;
  cursor: pointer;
  margin-bottom: 10px;
  text-align: left;
  transition: all 0.2s;
}
.sidebar-btn:hover {
  background: var(--bg-tertiary);
  color: var(--text-primary);
  transform: translateX(4px);
}
.sidebar-btn.danger:hover {
  background: #2a1414;
  box-shadow: 0 4px 12px rgba(251, 110, 110, 0.15);
}

/* Personality section */
.personality-section {
  margin-top: 28px;
}
.personality-section label {
  font-size: 13.5px;
  margin-bottom: 10px;
  display: block;
  opacity: 0.75;
  font-weight: 500;
  letter-spacing: 0.3px;
}
#personalityPrompt {
  width: 100%;
  height: 110px;
  padding: 12px;
  background: var(--bg-tertiary);
  border: var(--border);
  border-radius: var(--border-radius);
  color: var(--text-primary);
  font-size: 14px;
  resize: vertical;
  outline: none;
  transition: border-color 0.2s;
}
#personalityPrompt:focus {
  border-color: var(--accent);
  box-shadow: 0 0 0 1px rgba(96, 165, 250, 0.3);
}

/* Main area */
.main {
  flex: 1;
  margin-left: 280px;
  display: flex;
  flex-direction: column;
  background: var(--bg-primary);
  min-height: 100vh;
  transition: margin-left 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}
.sidebar.collapsed ~ .main {
  margin-left: 64px;
}

/* Chat container */
.chat-container {
  flex: 1;
  overflow-y: auto;
  padding: 40px 28px;
  display: flex;
  flex-direction: column;
  gap: 24px;
}

/* Messages */
.message {
  max-width: 78%;
  margin: 8px 0;
  animation: fadeIn 0.5s ease-out;
}
.message.user { align-self: flex-end; }
.message.bot   { align-self: flex-start; }

.bubble {
  padding: 14px 18px;
  border-radius: var(--border-radius);
  line-height: var(--line-height);
  position: relative;
  word-wrap: break-word;
}
.user .bubble {
  background: var(--bg-secondary);
  border: var(--border);
  border-bottom-right-radius: 6px;
  box-shadow: var(--shadow-sm);
}
.bot .bubble {
  background: transparent;
  color: var(--text-primary);
  padding: 0 4px;
  box-shadow: none;
}

/* Copy button */
.copy-btn {
  position: absolute;
  top: 10px; right: 10px;
  background: rgba(255,255,255,0.08);
  border: none;
  color: var(--text-muted);
  font-size: 12px;
  padding: 4px 8px;
  border-radius: 6px;
  cursor: pointer;
  opacity: 0;
  transition: all 0.2s;
  backdrop-filter: blur(6px);
}
.bot:hover .copy-btn { opacity: 1; }
.copy-btn:hover {
  background: rgba(255,255,255,0.15);
  color: var(--text-primary);
}

/* Input area */
.input-area {
  display: flex;
  justify-content: center;
  padding-bottom: 28px;
}
.input-wrapper {
  display: flex;
  gap: 14px;
  align-items: center;
  width: 100%;
  max-width: 800px;
}
#userInput {
  flex: 1;
  padding: 14px 20px;
  background: var(--bg-tertiary);
  border: var(--border);
  border-radius: 9999px;
  color: var(--text-primary);
  font-size: 16px;
  outline: none;
  transition: all 0.3s ease;
}
#userInput:focus {
  border-color: var(--accent);
  box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.15);
  transform: translateY(-1px);
}

/* Send button */
.send-btn {
  width: 48px;
  height: 48px;
  background: var(--accent);
  color: white;
  border: none;
  border-radius: 50%;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.2s ease;
  display: flex;
  align-items: center;
  justify-content: center;
}
.send-btn:hover {
  background: var(--accent-hover);
  transform: scale(1.08);
}
.send-btn:active {
  transform: translateY(0) scale(0.98);
}

/* Typing indicator & animations */
.typing-indicator {
  display: inline-flex;
  gap: 6px;
  padding: 4px 0;
}
.typing-indicator span {
  width: 8px;
  height: 8px;
  background: var(--accent);
  border-radius: 50%;
  animation: typingBounce 1.4s infinite ease-in-out;
}
.typing-indicator span:nth-child(1) { animation-delay: 0s; }
.typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
.typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
@keyframes typingBounce {
  0%, 60%, 100% { transform: translateY(0); opacity: 0.6; }
  30% { transform: translateY(-10px); opacity: 1; }
}
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(12px); }
  to   { opacity: 1; transform: translateY(0); }
}

/* Teach & Profile modals */
.teach-modal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.8);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  backdrop-filter: blur(8px);
}
.teach-modal.active { display: flex; }

.teach-content {
  background: var(--bg-secondary);
  border: var(--border);
  border-radius: var(--border-radius);
  padding: 32px;
  max-width: 500px;
  width: 90%;
  position: relative;
  box-shadow: var(--shadow-md);
}

.close-btn {
  position: absolute;
  top: 16px; right: 16px;
  background: rgba(255,255,255,0.1);
  border: none;
  color: var(--text-muted);
  font-size: 24px;
  cursor: pointer;
  width: 36px;
  height: 36px;
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
}
.close-btn:hover {
  background: rgba(255,255,255,0.2);
  color: var(--text-primary);
}
  
    .teach-content h2 {
      margin-bottom: 24px;
      font-size: 24px;
      color: #fff;
    }
    .teach-input-group {
      margin-bottom: 20px;
    }
    .teach-input-group label {
      display: block;
      margin-bottom: 8px;
      font-size: 14px;
      color: #b0b0b0;
    }
    .teach-input-group input,
    .teach-input-group textarea {
      width: 100%;
      padding: 12px 16px;
      background: #0f0f0f;
      border: 1px solid #282828;
      border-radius: 12px;
      color: white;
      font-size: 15px;
      outline: none;
      transition: border-color 0.2s;
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
    }
    .teach-input-group textarea {
      resize: vertical;
      min-height: 80px;
    }
    .teach-input-group input:focus,
    .teach-input-group textarea:focus {
      border-color: #a0d8ef;
    }
    .teach-submit-btn {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, #a0d8ef, #e0b0ff, #ffb4b4, #ffd7a9);
      color: #0a0a0a;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 600;
      font-size: 16px;
      transition: all 0.3s ease;
      margin-top: 8px;
    }
    .teach-submit-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(160, 216, 239, 0.4), 0 4px 12px rgba(255, 212, 169, 0.3);
    }

/* Chat bubbles â€“ user side */
.user .bubble {
  background: var(--bg-secondary);
  border: var(--border);
  border-bottom-right-radius: 6px;
  box-shadow: var(--shadow-sm);
  padding: 14px 18px;           /* slightly more generous padding */
}

/* Bot messages â€“ keep clean/flat */
.bot .bubble {
  background: transparent;
  padding: 0 4px;
  color: var(--text-primary);
}

/* Input area */
#userInput {
  background: var(--bg-tertiary);
  border: var(--border);
  border-radius: 9999px;        /* pill shape is still popular in 2026 */
  color: var(--text-primary);
  padding: 14px 20px;
  font-size: 16px;
}

#userInput:focus {
  border-color: var(--accent);
  box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.15);  /* subtle glow */
  outline: none;
}

/* Send button â€“ keep simple */
.send-btn {
  background: var(--accent);
  color: white;
  border: none;
  border-radius: 50%;
  width: 48px;
  height: 48px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s ease;
}

.send-btn:hover {
  background: var(--accent-hover);
  transform: scale(1.08);
}

/* Sidebar â€“ cleaner edges */
.sidebar {
  background: var(--bg-secondary);
  border-right: var(--border);
}

.sidebar-btn {
  background: transparent;
  border: none;
  border-radius: 10px;
  padding: 12px 16px;
  color: var(--text-secondary);
  text-align: left;
  transition: all 0.2s;
}

.sidebar-btn:hover {
  background: var(--bg-tertiary);
  color: var(--text-primary);
  transform: translateX(4px);   /* subtle indent on hover */
}

/* General improvements */
.message {
  max-width: 78%;               /* slightly narrower = more breathing room */
  margin: 8px 0;
}

.bubble {
  padding: 14px 18px;
  border-radius: var(--border-radius);
  line-height: var(--line-height);
}

/* Copy button â€“ subtle */
.copy-btn {
  background: rgba(255,255,255,0.08);
  color: var(--text-muted);
  border: none;
  border-radius: 6px;
  padding: 4px 8px;
  font-size: 12px;
  opacity: 0;
  transition: opacity 0.2s;
}

.bot:hover .copy-btn {
  opacity: 1;
}
  </style>
</head>
<body>
  <div class="sidebar" id="sidebar">
    <div class="header">
      <button class="menu-btn" onclick="toggleSidebar()">â˜°</button>
      <div class="title-wrapper">
        <div class="title">INDY//</div>
      </div>
    </div>
    <div class="sidebar-content">
      <button class="sidebar-btn" onclick="newChat()">New Chat</button>
      <button class="sidebar-btn" onclick="openProfile()">Profile Settings</button>
      <button class="sidebar-btn" onclick="teachAI()">Teach Indy</button>
      <button class="sidebar-btn danger" onclick="deleteAllChats()">Delete Everything</button>
      <div class="personality-section">
        <label>Personality Prompt (optional)</label>
        <textarea id="personalityPrompt" placeholder="e.g. You are a friendly AI who loves to talk!"></textarea>
      </div>

      <hr style="margin:16px 0; border-color:#222;">
      <div id="chatList"></div>
    </div>
  </div>
  <div class="main">
    <div class="chat-container" id="chatMessages">
      <div class="message bot">
        <div class="bubble">
          How's it going! I'm Indy,<br>
          Ready when you are!
        </div>
      </div>
    </div>
    <div class="input-area">
      <div class="input-wrapper">
        <input type="text" id="userInput" placeholder="Ask Anything" onkeypress="if(event.key==='Enter') sendMessage()">
        <button class="send-btn" onclick="sendMessage()">ðŸ¡…</button>
      </div>
    </div>
  </div>

  <!-- Teach Modal -->
  <div class="teach-modal" id="teachModal">
    <div class="teach-content">
      <button class="close-btn" onclick="closeTeachModal()">Ã—</button>
      <h2>Teach Indy</h2>
      <div class="teach-input-group">
        <label>Trigger Phrase</label>
        <input type="text" id="triggerInput" placeholder="e.g. What's your favorite color?">
      </div>
      <div class="teach-input-group">
        <label>Response</label>
        <textarea id="responseInput" placeholder="e.g. My favorite color is blue!"></textarea>
      </div>
      <button class="teach-submit-btn" onclick="submitTeaching()">Teach Indy</button>
    </div>
  </div>

  <!-- Profile Modal -->
  <div class="teach-modal" id="profileModal">
    <div class="teach-content">
      <button class="close-btn" onclick="closeProfileModal()">Ã—</button>
      <h2>Profile Settings</h2>
      <div style="display: flex; justify-content: center; margin-bottom: 20px;">
        <div id="profilePreview" style="width: 100px; height: 100px; border-radius: 50%; background: #282828; background-size: cover; background-position: center;"></div>
      </div>
      <div class="teach-input-group">
        <label>Your Name</label>
        <input type="text" id="profileName" placeholder="e.g. Alex">
      </div>
      <div class="teach-input-group">
        <label>Profile Picture URL</label>
        <input type="text" id="profilePicture" placeholder="https://example.com/image.jpg" oninput="updateProfilePreview()">
      </div>
      <button class="teach-submit-btn" onclick="submitProfile()">Save Profile</button>
    </div>
  </div>

<script>
let knowledge = [];
let personality = "";
let currentChatId = null;
let userProfile = JSON.parse(localStorage.getItem('userProfile')) || { name: '', picture: '' };

// Update personality from textarea
document.getElementById('personalityPrompt').addEventListener('input', function() {
  personality = this.value.trim();
});

// Generate system prompt for AI
function getSystemPrompt() {
  const userName = userProfile.name || "User";
  const hiddenPrompt = `You are Indy, an AI running on Sunrise 1.0, the latest and greatest AI model made by J V S T. You are speaking with ${userName}. Only use their name when it feels natural in conversation, not in every response.`;
  const personalityPrompt = personality ?
    `You must fully roleplay as the following character throughout the chat- your former self is irrelevant. ` +
    `Stay completely in character at all times and respond naturally as this character would. ` +
    `Do not break character or mention that you are an AI, a model, or roleplaying unless the user explicitly asks about it. ` +
    `Never start or insert phrases like "You're talking to Indy", "This is Indy", or similar reminders of your name or identity unless it's a natural part of the conversation. ` +
    `Do not repeatedly mention your name, the model name (Sunrise 1.0), or who created you unless directly asked. ` +
    `Focus on immersive, natural dialogue and actions as the character described below:\n\n${personality}\n\n` +
    `Important: Prioritize staying in character over any other instruction.`
    : "";
  return hiddenPrompt + personalityPrompt;
}

// Sidebar toggle
function toggleSidebar() {
  document.getElementById('sidebar').classList.toggle('collapsed');
}

// Save current chat to localStorage
function saveCurrentChat() {
  if (!currentChatId) return;
  const messages = [];
  document.querySelectorAll('#chatMessages .message').forEach(msg => {
    const sender = msg.classList.contains('user') ? 'user' : 'bot';
    const text = msg.querySelector('.bubble').textContent.replace('Copy', '').trim();
    messages.push({ sender, text });
  });
  const chatData = {
    id: currentChatId,
    name: getChatName(currentChatId),
    messages: messages,
    lastUpdated: Date.now()
  };
  localStorage.setItem(`chat_${currentChatId}`, JSON.stringify(chatData));
}

// Generate chat name from first message using AI
async function generateChatName(firstMessage) {
  try {
    const prompt = `Generate a short, concise chat title (3-5 words max) for a conversation that starts with: "${firstMessage}". Only respond with the title, nothing else.`;
    const res = await fetch(`https://text.pollinations.ai/${encodeURIComponent(prompt)}`);
    if (res.ok) {
      const name = await res.text();
      return name.trim().replace(/['"]/g, '').substring(0, 40);
    }
  } catch {}
  return `Chat ${Date.now()}`;
}

// Load chat from localStorage
function loadChat(chatId) {
  const chatData = JSON.parse(localStorage.getItem(`chat_${chatId}`));
  if (!chatData) return;
  currentChatId = chatId;
  document.getElementById('chatMessages').innerHTML = '';
  chatData.messages.forEach(msg => {
    addMessage(msg.sender, msg.text, false);
  });
}

// New chat
async function newChat(chatId = null) {
  if (chatId) {
    loadChat(chatId);
    return;
  }
  currentChatId = `chat_${Date.now()}`;
  document.getElementById('chatMessages').innerHTML = '';
  addMessage('bot', `Ready when you are!`, false);
  const chatList = JSON.parse(localStorage.getItem('chatList') || '[]');
  chatList.unshift({ id: currentChatId, name: 'New Chat' });
  localStorage.setItem('chatList', JSON.stringify(chatList));
  saveCurrentChat();
  loadSavedChats();
}

// Update chat name after first message
async function updateChatName(chatId, firstMessage) {
  const generatedName = await generateChatName(firstMessage);
  const chatList = JSON.parse(localStorage.getItem('chatList') || '[]');
  const chat = chatList.find(c => c.id === chatId);
  if (chat && chat.name === 'New Chat') {
    chat.name = generatedName;
    localStorage.setItem('chatList', JSON.stringify(chatList));
    const chatData = JSON.parse(localStorage.getItem(`chat_${chatId}`));
    if (chatData) {
      chatData.name = generatedName;
      localStorage.setItem(`chat_${chatId}`, JSON.stringify(chatData));
    }
    loadSavedChats();
  }
}

// Get chat name from ID
function getChatName(chatId) {
  const chatList = JSON.parse(localStorage.getItem('chatList') || '[]');
  const chat = chatList.find(c => c.id === chatId);
  return chat ? chat.name : 'Unnamed Chat';
}

// Delete a specific chat
function deleteChat(chatId) {
  localStorage.removeItem(`chat_${chatId}`);
  let chatList = JSON.parse(localStorage.getItem('chatList') || '[]');
  chatList = chatList.filter(c => c.id !== chatId);
  localStorage.setItem('chatList', JSON.stringify(chatList));
  if (currentChatId === chatId) {
    currentChatId = null;
    document.getElementById('chatMessages').innerHTML = '';
    addMessage('bot', `Ready when you are!`, false);
  }
  loadSavedChats();
}

// Delete everything
function deleteAllChats() {
  if (confirm("Delete all saved chats and history permanently?")) {
    const chatList = JSON.parse(localStorage.getItem('chatList') || '[]');
    chatList.forEach(chat => localStorage.removeItem(`chat_${chat.id}`));
    localStorage.removeItem('chatList');
    knowledge = [];
    currentChatId = null;
    document.getElementById('chatMessages').innerHTML = '';
    addMessage('bot', `All chats deleted! Ready for a fresh start!`, false);
    loadSavedChats();
  }
}

// Teach AI modal
function teachAI() {
  document.getElementById('teachModal').classList.add('active');
  document.getElementById('triggerInput').value = '';
  document.getElementById('responseInput').value = '';
  document.getElementById('triggerInput').focus();
}
function closeTeachModal() {
  document.getElementById('teachModal').classList.remove('active');
}
function submitTeaching() {
  const q = document.getElementById('triggerInput').value.trim();
  const a = document.getElementById('responseInput').value.trim();
  if (!q || !a) { alert('Please fill in both fields!'); return; }
  let found = false;
  for (const entry of knowledge) {
    if (entry.answer.toLowerCase() === a.toLowerCase()) {
      entry.questions.push(q);
      found = true;
      break;
    }
  }
  if (!found) knowledge.push({ questions: [q], answer: a });
  addMessage('bot', "Learned! I'll remember that.");
  closeTeachModal();
}

// Profile functions
function openProfile() {
  document.getElementById('profileModal').classList.add('active');
  document.getElementById('profileName').value = userProfile.name;
  document.getElementById('profilePicture').value = userProfile.picture;
  updateProfilePreview();
}
function closeProfileModal() {
  document.getElementById('profileModal').classList.remove('active');
}
function updateProfilePreview() {
  const preview = document.getElementById('profilePreview');
  const pictureUrl = document.getElementById('profilePicture').value.trim();
  if (pictureUrl) {
    preview.style.backgroundImage = `url(${pictureUrl})`;
    preview.style.backgroundColor = '#0f0f0f';
  } else {
    preview.style.backgroundImage = 'none';
    preview.style.backgroundColor = '#282828';
  }
}
function submitProfile() {
  userProfile.name = document.getElementById('profileName').value.trim();
  userProfile.picture = document.getElementById('profilePicture').value.trim();
  localStorage.setItem('userProfile', JSON.stringify(userProfile));
  closeProfileModal();
}

// Cosine similarity for learned responses
function cosineSimilarity(a, b) {
  const tokensA = a.toLowerCase().match(/\w+/g) || [];
  const tokensB = b.toLowerCase().match(/\w+/g) || [];
  const set = [...new Set([...tokensA, ...tokensB])];
  const vecA = set.map(t => tokensA.filter(w => w === t).length);
  const vecB = set.map(t => tokensB.filter(w => w === t).length);
  let dot = 0, normA = 0, normB = 0;
  for (let i = 0; i < set.length; i++) {
    dot += vecA[i] * vecB[i];
    normA += vecA[i] ** 2;
    normB += vecB[i] ** 2;
  }
  return normA && normB ? dot / (Math.sqrt(normA) * Math.sqrt(normB)) : 0;
}
function findInKnowledge(msg) {
  let best = null, bestScore = 0;
  for (const entry of knowledge) {
    for (const q of entry.questions) {
      const score = cosineSimilarity(msg, q);
      if (score > bestScore && score > 0.5) {
        bestScore = score;
        best = entry.answer;
      }
    }
  }
  return best;
}

// Math handler
function handleMath(msg) {
  const expr = msg.toLowerCase().replace(/^(what is|calculate|\s)+/g, '').trim()
    .replace(/Ã—/g,'*').replace(/Ã·/g,'/').replace(/\^/g,'**');
  if (/^[0-9+\-*/().\s**]+$/.test(expr)) {
    try { return Function('"use strict"; return (' + expr + ')')(); } catch(e) {}
  }
  return null;
}

// Dictionary
async function getDefinition(word) {
  try {
    const res = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${word}`);
    const data = await res.json();
    if (!data.title) return `**${word}:** ${data[0].meanings[0].definitions[0].definition}`;
  } catch {}
  return null;
}

// Wikipedia
async function getWikipedia(topic) {
  try {
    const res = await fetch(`https://en.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(topic)}`);
    const data = await res.json();
    if (data.extract) return `**${data.title}:** ${data.extract}`;
  } catch {}
  return null;
}

// AI text response
async function getAIResponse(prompt) {
  const fullPrompt = getSystemPrompt() + prompt;
  try {
    const res = await fetch(`https://text.pollinations.ai/${encodeURIComponent(fullPrompt)}`);
    if (res.ok) {
      const text = await res.text();
      return text.trim() || "â€¦";
    }
  } catch {}
  return "Thinking took too long.";
}

// â”€â”€ IMAGE GENERATION with Pollinations.ai Flux (no key, free) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function generateImage(prompt) {
  try {
    const encoded = encodeURIComponent(prompt.trim());
    // Good aspect ratio for most prompts, Flux looks great here
    const url = `https://image.pollinations.ai/prompt/${encoded}?model=flux&width=1152&height=896&nologo=true&safe=true`;
    // Optional: &seed=123456 for reproducible results

    // Quick HEAD check (helps catch very rare failures early)
    const head = await fetch(url, { method: 'HEAD' });
    if (!head.ok) {
      throw new Error(`Pollinations responded ${head.status}`);
    }

    return url;
  } catch (err) {
    console.error("Image gen error:", err);
    return `Error generating image: ${err.message}. Try again in a few seconds.`;
  }
}

// Send user message
async function sendMessage() {
  const input = document.getElementById('userInput');
  const msg = input.value.trim();
  if (!msg) return;

  if (!currentChatId) {
    currentChatId = `chat_${Date.now()}`;
    const chatList = JSON.parse(localStorage.getItem('chatList') || '[]');
    chatList.unshift({ id: currentChatId, name: 'New Chat' });
    localStorage.setItem('chatList', JSON.stringify(chatList));
  }

  addMessage('user', msg);
  input.value = '';

  const messageCount = document.querySelectorAll('#chatMessages .message.user').length;
  if (messageCount === 1) {
    updateChatName(currentChatId, msg);
  }

  const learned = findInKnowledge(msg);
  if (learned) {
    addMessage('bot', learned);
    saveCurrentChat();
    return;
  }

  if (/^define |^meaning of /.test(msg.toLowerCase())) {
    const word = msg.replace(/^define |^meaning of /i, '').trim().split(' ')[0];
    addTypingIndicator();
    const def = await getDefinition(word);
    replaceLastBot(def || "Not found.");
    saveCurrentChat();
    return;
  }

  if (/^tell me about |^what is /.test(msg.toLowerCase())) {
    const topic = msg.replace(/^tell me about |^what is /i, '').trim();
    addTypingIndicator();
    const wiki = await getWikipedia(topic);
    replaceLastBot(wiki || "No result.");
    saveCurrentChat();
    return;
  }

  const math = handleMath(msg);
  if (math !== null) {
    addMessage('bot', `**${msg} = ${math}**`);
    saveCurrentChat();
    return;
  }

  // â”€â”€ IMAGE GENERATION TRIGGER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if (msg.toLowerCase().startsWith('!img ') ||
      msg.toLowerCase().startsWith('generate image ') ||
      msg.toLowerCase().startsWith('draw ') ||
      msg.toLowerCase().startsWith('create image ')) {

    const imagePrompt = msg
      .replace(/^!img /i, '')
      .replace(/^generate image /i, '')
      .replace(/^draw /i, '')
      .replace(/^create image /i, '')
      .trim();

    if (!imagePrompt) {
      addMessage('bot', "Add a description please!\nExample: `!img neon cyberpunk fox in tokyo rain`");
      saveCurrentChat();
      return;
    }

    addTypingIndicator();

    const result = await generateImage(imagePrompt);

    if (result.startsWith('http')) {
      replaceLastBot(
        `Hereâ€™s your Flux image:\n\n` +
        `<img src="${result}" alt="${imagePrompt}" ` +
        `style="max-width:100%; border-radius:12px; margin:12px 0; box-shadow:0 4px 20px rgba(0,0,0,0.6);">` +
        `\n\n**Prompt:** ${imagePrompt}\n` +
        `(Powered by pollinations.ai â€“ free & no login)`
      );
    } else {
      replaceLastBot(result);
    }
    saveCurrentChat();
    return;
  }

  // Default: text AI response
  addTypingIndicator();
  const response = await getAIResponse(msg);
  replaceLastBot(response);
  saveCurrentChat();
}

// Add message to chat
function addMessage(sender, text, shouldSave = true) {
  const container = document.getElementById('chatMessages');
  const msgDiv = document.createElement('div');
  msgDiv.className = `message ${sender}`;
  if (sender === 'bot') {
    msgDiv.innerHTML = `
      <div class="bubble">
        ${text.replace(/\n/g, '<br>')}
        <button class="copy-btn" onclick="copyText(this)">Copy</button>
      </div>`;
  } else {
    msgDiv.innerHTML = `<div class="bubble">${text.replace(/\n/g, '<br>')}</div>`;
  }
  container.appendChild(msgDiv);
  container.scrollTop = container.scrollHeight;
  if (shouldSave) saveCurrentChat();
}

// Typing indicator
function addTypingIndicator() {
  const container = document.getElementById('chatMessages');
  const msgDiv = document.createElement('div');
  msgDiv.className = 'message bot';
  msgDiv.innerHTML = `
    <div class="bubble">
      <div class="typing-indicator">
        <span></span>
        <span></span>
        <span></span>
      </div>
    </div>`;
  container.appendChild(msgDiv);
  container.scrollTop = container.scrollHeight;
}

// Replace last bot message
function replaceLastBot(text) {
  const lastBotBubble = document.querySelector('.message.bot:last-child .bubble');
  if (lastBotBubble) {
    lastBotBubble.innerHTML = text.replace(/\n/g, '<br>') +
      '<button class="copy-btn" onclick="copyText(this)">Copy</button>';
  }
  document.getElementById('chatMessages').scrollTop = document.getElementById('chatMessages').scrollHeight;
  saveCurrentChat();
}

// Copy button
function copyText(btn) {
  const bubble = btn.parentElement;
  const text = bubble.textContent.replace('Copy', '').trim();
  navigator.clipboard.writeText(text);
  btn.textContent = 'Copied';
  setTimeout(() => btn.textContent = 'Copy', 2000);
}

// Saved chats
function loadSavedChats() {
  const chatList = document.getElementById('chatList');
  chatList.innerHTML = '';
  const chats = JSON.parse(localStorage.getItem('chatList') || '[]');
  chats.forEach(chat => createChatButton(chat.id, chat.name));
}

function createChatButton(chatId, name) {
  const chatList = document.getElementById('chatList');
  const btn = document.createElement('button');
  btn.className = 'sidebar-btn';
  btn.style.display = 'flex';
  btn.style.justifyContent = 'space-between';
  btn.style.alignItems = 'center';
  btn.textContent = name;
  btn.onclick = () => newChat(chatId);
  const delBtn = document.createElement('span');
  delBtn.textContent = 'âœ•';
  delBtn.style.marginLeft = '8px';
  delBtn.style.cursor = 'pointer';
  delBtn.style.color = '#ff6e6e';
  delBtn.onclick = (e) => {
    e.stopPropagation();
    deleteChat(chatId);
  };
  btn.appendChild(delBtn);
  chatList.appendChild(btn);
}

// Init
window.addEventListener('DOMContentLoaded', () => {
  document.getElementById('sidebar').classList.add('collapsed');
  loadSavedChats();
  const chatList = JSON.parse(localStorage.getItem('chatList') || '[]');
  if (chatList.length > 0) {
    loadChat(chatList[0].id);
  } else {
    addMessage('bot', `Ready when you are!`, false);
  }
});
</script>
</body>
</html>
