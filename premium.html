<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>INDY AI</title>
  <link rel="shortcut icon" type="image/png" href="favicon.png">
  
<style>
@import url('https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600&family=IBM+Plex+Sans:wght@400;500;600&display=swap');

:root {
  --bg:            #080808;
  --bg-elevated:   #101010;
  --bg-card:       #161616;
  --bg-input:      #0d0d0d;
  --text:          #f0f0f0;
  --text-secondary:#8a8a8a;
  --text-tertiary: #4a4a4a;
  --text-dim:      #2e2e2e;
  --border:        rgba(255,255,255,0.07);
  --border-strong: rgba(255,255,255,0.12);
  --border-focus:  rgba(255,255,255,0.25);
  --glass-bg:      rgba(18,18,18,0.85);
  --glass-border:  rgba(255,255,255,0.08);
  --hover-bg:      rgba(255,255,255,0.04);
  --active-bg:     rgba(255,255,255,0.07);
  --accent:        #c8c8ff;
  --accent-dim:    rgba(200,200,255,0.12);
  --font-ui:       'IBM Plex Sans', system-ui, sans-serif;
  --font-mono:     'IBM Plex Mono', 'Fira Code', monospace;
  --radius-sm:     6px;
  --radius-md:     10px;
  --radius-lg:     14px;
  --radius-xl:     20px;
  --radius-pill:   999px;
}

*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

body {
  background: var(--bg);
  color: var(--text);
  font-family: var(--font-ui);
  font-size: 14px;
  line-height: 1.6;
  min-height: 100vh;
  display: flex;
  overflow: hidden;
  background-image: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(255,255,255,0.008) 2px, rgba(255,255,255,0.008) 4px);
}

/* â”€â”€ SIDEBAR â”€â”€ */
.sidebar {
  position: fixed;
  inset: 0 auto 0 0;
  width: 260px;
  background: var(--bg-elevated);
  border-right: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  z-index: 100;
  overflow: hidden;
}
.sidebar.collapsed { width: 60px; }

.header {
  padding: 16px;
  display: flex;
  align-items: center;
  gap: 12px;
  min-height: 64px;
  flex-shrink: 0;
  border-bottom: 1px solid var(--border);
}

.menu-btn {
  background: transparent;
  border: 1px solid transparent;
  color: var(--text-secondary);
  font-size: 18px;
  cursor: pointer;
  padding: 8px;
  border-radius: var(--radius-sm);
  transition: all 0.15s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  font-family: var(--font-mono);
  letter-spacing: -0.05em;
}
.menu-btn:hover { background: var(--hover-bg); border-color: var(--border-strong); color: var(--text); }
.menu-btn:active { background: var(--active-bg); transform: scale(0.96); }

.title {
  font-family: var(--font-mono);
  font-size: 15px;
  font-weight: 600;
  letter-spacing: 0.08em;
  color: var(--text);
  white-space: nowrap;
  text-transform: uppercase;
  opacity: 1;
  transition: opacity 0.2s ease;
}
.sidebar.collapsed .title { opacity: 0; pointer-events: none; }

.sidebar-content {
  flex: 1;
  padding: 10px;
  overflow-y: auto;
  overflow-x: hidden;
  padding-bottom: 80px;
}
.sidebar-content::-webkit-scrollbar { width: 4px; }
.sidebar-content::-webkit-scrollbar-track { background: transparent; }
.sidebar-content::-webkit-scrollbar-thumb { background: var(--border-strong); border-radius: var(--radius-pill); }

.sidebar-btn {
  width: 100%;
  height: 40px;
  background: transparent;
  border: 1px solid transparent;
  border-radius: var(--radius-sm);
  color: var(--text-secondary);
  font-size: 13px;
  font-family: var(--font-ui);
  font-weight: 500;
  cursor: pointer;
  transition: all 0.15s ease;
  display: flex;
  align-items: center;
  justify-content: flex-start;
  padding: 0 12px;
  gap: 10px;
  margin-bottom: 2px;
  position: relative;
  overflow: hidden;
  letter-spacing: 0.01em;
}
.sidebar-btn::before {
  content: attr(data-icon);
  font-size: 15px;
  opacity: 0.7;
  flex-shrink: 0;
  transition: opacity 0.15s;
  font-family: var(--font-mono);
  width: 18px;
  text-align: center;
}
.sidebar-btn span { white-space: nowrap; opacity: 1; transition: opacity 0.2s ease; }
.sidebar.collapsed .sidebar-btn span { opacity: 0; pointer-events: none; }
.sidebar.collapsed .sidebar-btn { justify-content: center; padding: 0; }
.sidebar.collapsed .sidebar-btn::before { width: auto; }
.sidebar-btn:hover { background: var(--hover-bg); border-color: var(--border); color: var(--text); }
.sidebar-btn:hover::before { opacity: 1; }
.sidebar-btn:active { background: var(--active-bg); transform: scale(0.99); }
.sidebar-btn.danger { color: #e05050; }
.sidebar-btn.danger:hover { background: rgba(224,80,80,0.08); border-color: rgba(224,80,80,0.2); color: #ff6b6b; }

hr { border: none; border-top: 1px solid var(--border); margin: 8px 0; }

#chatList .sidebar-btn { justify-content: space-between; padding-right: 8px; }
#chatList .sidebar-btn::before { content: 'â€”'; font-size: 11px; color: var(--text-dim); font-family: var(--font-mono); }
#chatList .sidebar-btn span:first-of-type { flex: 1; text-align: left; overflow: hidden; text-overflow: ellipsis; }
#chatList .sidebar-btn span:last-of-type { opacity: 0; color: #e05050; font-size: 14px; padding: 3px 6px; border-radius: var(--radius-sm); transition: all 0.15s; flex-shrink: 0; font-family: var(--font-mono); }
#chatList .sidebar-btn:hover span:last-of-type { opacity: 0.6; }
#chatList .sidebar-btn span:last-of-type:hover { opacity: 1; background: rgba(224,80,80,0.12); }

.sidebar-logo { display: none; font-family: var(--font-mono); font-size: 22px; text-align: center; padding: 16px 0; color: var(--text-secondary); letter-spacing: 0.1em; }
.sidebar.collapsed .sidebar-logo { display: block; }

.user-profile-footer {
  position: absolute;
  bottom: 0; left: 0; right: 0;
  padding: 12px 14px;
  border-top: 1px solid var(--border);
  display: flex;
  align-items: center;
  gap: 10px;
  background: var(--bg-elevated);
  cursor: pointer;
  transition: background 0.15s;
}
.user-profile-footer:hover { background: var(--hover-bg); }
.sidebar.collapsed .user-profile-footer { padding: 12px 0; justify-content: center; }

.profile-avatar {
  width: 32px; height: 32px;
  border-radius: var(--radius-sm);
  background: var(--bg-card);
  background-size: cover;
  background-position: center;
  border: 1px solid var(--border-strong);
  flex-shrink: 0;
  transition: border-color 0.2s;
}
.user-profile-footer:hover .profile-avatar { border-color: var(--border-focus); }
.sidebar.collapsed .profile-avatar { width: 30px; height: 30px; }
.profile-info { flex: 1; overflow: hidden; }
.sidebar.collapsed .profile-info { display: none; }
.profile-name { font-size: 13px; font-weight: 500; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; font-family: var(--font-mono); letter-spacing: 0.02em; }

/* â”€â”€ MAIN â”€â”€ */
.main { flex: 1; margin-left: 260px; display: flex; flex-direction: column; transition: margin-left 0.3s cubic-bezier(0.4, 0, 0.2, 1); height: 100vh; }
.sidebar.collapsed ~ .main { margin-left: 60px; }

.chat-container {
  flex: 1;
  overflow-y: auto;
  padding: 40px 32px 140px;
  display: flex;
  flex-direction: column;
  gap: 20px;
  max-width: 960px;
  width: 100%;
  margin: 0 auto;
  align-self: center;
}
.chat-container::-webkit-scrollbar { width: 6px; }
.chat-container::-webkit-scrollbar-track { background: transparent; }
.chat-container::-webkit-scrollbar-thumb { background: var(--border-strong); border-radius: var(--radius-pill); }

.message { max-width: 78%; animation: msgIn 0.22s cubic-bezier(0.2, 0.8, 0.4, 1); }
@keyframes msgIn { from { opacity: 0; transform: translateY(6px); } to { opacity: 1; transform: translateY(0); } }
.user { align-self: flex-end; }
.bot  { align-self: flex-start; }

.bubble { padding: 11px 15px; border-radius: var(--radius-lg); line-height: 1.6; font-size: 14px; position: relative; }
.user .bubble { background: var(--bg-card); border: 1px solid var(--border-strong); color: var(--text); border-bottom-right-radius: var(--radius-sm); font-family: var(--font-ui); }
.bot .bubble { background: transparent; border: none; padding: 0; color: var(--text); font-size: 14px; font-family: var(--font-ui); }
.bot .bubble img { border-radius: var(--radius-md); border: 1px solid var(--border); margin: 12px 0; display: block; }
.bot .bubble pre { background: var(--bg-card); border: 1px solid var(--border); border-left: 2px solid var(--border-focus); border-radius: var(--radius-md); padding: 14px 16px; overflow-x: auto; margin: 10px 0; font-family: var(--font-mono); font-size: 12.5px; line-height: 1.6; color: var(--text-secondary); }
.bot .bubble code { background: var(--bg-card); border: 1px solid var(--border); padding: 1px 5px; border-radius: 4px; font-family: var(--font-mono); font-size: 12.5px; color: var(--accent); }

.copy-btn { position: absolute; top: -4px; right: 0; background: var(--bg-card); border: 1px solid var(--border); color: var(--text-tertiary); font-size: 11px; font-family: var(--font-mono); letter-spacing: 0.04em; padding: 4px 8px; border-radius: var(--radius-sm); cursor: pointer; opacity: 0; transition: all 0.15s ease; text-transform: uppercase; }
.bot:hover .copy-btn { opacity: 1; }
.copy-btn:hover { background: var(--hover-bg); border-color: var(--border-strong); color: var(--text-secondary); }
.copy-btn:active { transform: scale(0.96); }

/* â”€â”€ INPUT AREA â”€â”€ */
.input-area {
  padding: 16px 24px 20px;
  background: var(--bg);
  border-top: 1px solid var(--border);
  position: fixed;
  bottom: 0;
  left: 260px;
  right: 0;
  z-index: 10;
  transition: left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}
.sidebar.collapsed ~ .main .input-area { left: 60px; }

.input-wrapper {
  max-width: 820px;
  margin: 0 auto;
  display: flex;
  gap: 10px;
  align-items: center;
  background: var(--bg-card);
  border: 1px solid var(--border-strong);
  border-radius: var(--radius-lg);
  padding: 5px 5px 5px 16px;
  transition: border-color 0.2s ease;
}
.input-wrapper:focus-within { border-color: var(--border-focus); }

#userInput {
  flex: 1;
  background: transparent;
  border: none;
  color: var(--text);
  font-size: 14px;
  font-family: var(--font-ui);
  outline: none;
  padding: 10px 0;
  caret-color: var(--accent);
}
#userInput::placeholder { color: var(--text-tertiary); font-family: var(--font-mono); font-size: 13px; letter-spacing: 0.02em; }

.send-btn { width: 34px; height: 34px; background: var(--text); color: var(--bg); border: none; border-radius: var(--radius-sm); font-size: 16px; font-family: var(--font-mono); cursor: pointer; transition: all 0.15s ease; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
.send-btn:hover { background: #ffffff; transform: scale(1.04); }
.send-btn:active { transform: scale(0.95); background: #dcdcdc; }

.model-btn { height: 34px; background: transparent; border: 1px solid transparent; color: var(--text-tertiary); font-size: 13px; font-family: var(--font-mono); cursor: pointer; border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center; gap: 6px; padding: 0 10px; transition: all 0.15s ease; flex-shrink: 0; letter-spacing: 0.03em; }
.model-btn:hover { background: var(--hover-bg); border-color: var(--border); color: var(--text-secondary); }

.model-popover {
  position: absolute;
  bottom: 76px;
  left: 20px;
  background: var(--bg-card);
  border: 1px solid var(--border-strong);
  border-radius: var(--radius-lg);
  box-shadow: 0 8px 32px rgba(0,0,0,0.6);
  width: 240px;
  overflow: hidden;
  z-index: 90;
  opacity: 0;
  visibility: hidden;
  transform: translateY(8px);
  transition: all 0.2s cubic-bezier(0.2, 0.8, 0.4, 1);
}
.model-popover.active { opacity: 1; visibility: visible; transform: translateY(0); }
.model-header { padding: 10px 14px; font-size: 10px; font-family: var(--font-mono); font-weight: 600; letter-spacing: 0.1em; text-transform: uppercase; color: var(--text-tertiary); border-bottom: 1px solid var(--border); }
.model-item { width: 100%; padding: 10px 14px; background: transparent; border: none; text-align: left; color: var(--text-secondary); font-size: 13px; font-family: var(--font-ui); cursor: pointer; transition: all 0.12s ease; position: relative; }
.model-item:hover { background: var(--hover-bg); color: var(--text); }
.model-item.active { color: var(--accent); background: var(--accent-dim); font-weight: 500; }
.model-item.active::after { content: 'âœ“'; position: absolute; right: 14px; color: var(--accent); font-size: 12px; font-family: var(--font-mono); }
.model-footer { padding: 8px 14px; font-size: 11px; font-family: var(--font-mono); color: var(--text-dim); text-align: center; border-top: 1px solid var(--border); letter-spacing: 0.04em; }

/* â”€â”€ THINKING â”€â”€ */
.thinking-indicator { display: inline-flex; align-items: center; gap: 10px; padding: 6px 0; color: var(--text-tertiary); font-size: 13px; font-family: var(--font-mono); letter-spacing: 0.04em; }
.thinking-star { font-size: 16px; display: inline-block; animation: thinkSpin 1.8s linear infinite; color: var(--text-secondary); }
@keyframes thinkSpin { 0% { transform: rotate(0deg); opacity: 0.4; } 50% { transform: rotate(180deg); opacity: 0.9; } 100% { transform: rotate(360deg); opacity: 0.4; } }
.thinking-text { animation: thinkPulse 1.8s ease-in-out infinite; }
@keyframes thinkPulse { 0%, 100% { opacity: 0.35; } 50% { opacity: 0.8; } }

/* â”€â”€ MODALS â”€â”€ */
.teach-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.82); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); display: none; align-items: center; justify-content: center; z-index: 1000; }
.teach-modal.active { display: flex; animation: modalBgIn 0.2s ease forwards; }
@keyframes modalBgIn { from { opacity: 0; } to { opacity: 1; } }

.teach-content { background: var(--bg-card); border: 1px solid var(--border-strong); border-radius: var(--radius-xl); padding: 28px; max-width: 500px; width: 90%; box-shadow: 0 24px 64px rgba(0,0,0,0.6); position: relative; animation: modalIn 0.25s cubic-bezier(0.2, 0.8, 0.4, 1); }
@keyframes modalIn { from { transform: scale(0.96) translateY(16px); opacity: 0; } to { transform: scale(1) translateY(0); opacity: 1; } }

.teach-content h2 { font-family: var(--font-mono); font-size: 18px; font-weight: 600; letter-spacing: 0.04em; text-transform: uppercase; color: var(--text); margin-bottom: 22px; }

.close-btn { position: absolute; top: 18px; right: 18px; background: var(--bg-elevated); border: 1px solid var(--border); color: var(--text-secondary); font-size: 18px; font-family: var(--font-mono); cursor: pointer; width: 32px; height: 32px; border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center; transition: all 0.15s ease; }
.close-btn:hover { background: var(--hover-bg); border-color: var(--border-strong); color: var(--text); }
.close-btn:active { transform: scale(0.94); }

.teach-input-group { margin-bottom: 16px; }
.teach-input-group label { display: block; margin-bottom: 6px; color: var(--text-tertiary); font-size: 11px; font-family: var(--font-mono); font-weight: 500; letter-spacing: 0.08em; text-transform: uppercase; }
.teach-input-group input, .teach-input-group textarea, .teach-input-group select { width: 100%; background: var(--bg-elevated); border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 10px 13px; color: var(--text); font-size: 13.5px; font-family: var(--font-ui); transition: border-color 0.15s; resize: vertical; }
.teach-input-group select { background: var(--bg-elevated) !important; color: var(--text) !important; }
.teach-input-group input:focus, .teach-input-group textarea:focus, .teach-input-group select:focus { outline: none; border-color: var(--border-focus); background: var(--bg); }
.teach-input-group textarea { min-height: 96px; }
.teach-input-group input::placeholder, .teach-input-group textarea::placeholder { color: var(--text-tertiary); font-family: var(--font-mono); font-size: 12.5px; }

.teach-submit-btn { width: 100%; background: var(--text); color: var(--bg); border: none; border-radius: var(--radius-sm); padding: 12px; font-size: 13px; font-family: var(--font-mono); font-weight: 600; letter-spacing: 0.06em; text-transform: uppercase; cursor: pointer; transition: all 0.15s ease; margin-top: 4px; }
.teach-submit-btn:hover { background: #ffffff; transform: scale(1.01); }
.teach-submit-btn:active { transform: scale(0.98); background: #dcdcdc; }

#profilePreview { width: 80px; height: 80px; border-radius: var(--radius-sm); background: var(--bg-elevated); background-size: cover; background-position: center; border: 1px solid var(--border-strong); transition: all 0.2s; }
#profilePreview:hover { border-color: var(--border-focus); transform: scale(1.03); }

#codeOutput { background: var(--bg-elevated); border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 14px; min-height: 90px; max-height: 200px; overflow-y: auto; color: var(--text-secondary); font-size: 12.5px; font-family: var(--font-mono); line-height: 1.6; }

.sidebar.collapsed .sidebar-content > *:not(#chatList) { display: none; }
.sidebar.collapsed hr { display: none; }

/* â”€â”€ NEW: Token / char counter â”€â”€ */
.char-counter {
  font-family: var(--font-mono);
  font-size: 10px;
  color: var(--text-dim);
  padding: 0 6px;
  flex-shrink: 0;
  transition: color 0.2s;
  user-select: none;
}
.char-counter.warn { color: #e0a050; }
.char-counter.over { color: #e05050; }

/* â”€â”€ NEW: Reaction buttons â”€â”€ */
.reaction-row {
  display: flex;
  gap: 4px;
  margin-top: 8px;
  opacity: 0;
  transition: opacity 0.15s;
}
.message.bot:hover .reaction-row { opacity: 1; }
.reaction-btn {
  background: transparent;
  border: 1px solid transparent;
  color: var(--text-dim);
  font-size: 13px;
  padding: 3px 7px;
  border-radius: var(--radius-sm);
  cursor: pointer;
  font-family: var(--font-mono);
  transition: all 0.12s;
}
.reaction-btn:hover { background: var(--hover-bg); border-color: var(--border); color: var(--text-secondary); }
.reaction-btn.active { background: var(--accent-dim); border-color: var(--accent); color: var(--accent); }

/* â”€â”€ NEW: Typing animation â”€â”€ */
@keyframes typingCursor {
  0%, 100% { opacity: 1; }
  50% { opacity: 0; }
}
.streaming-cursor {
  display: inline-block;
  width: 2px;
  height: 14px;
  background: var(--accent);
  margin-left: 2px;
  vertical-align: middle;
  animation: typingCursor 0.8s ease infinite;
  border-radius: 1px;
}

/* â”€â”€ NEW: Pinned messages badge â”€â”€ */
.pinned-badge {
  display: inline-block;
  font-family: var(--font-mono);
  font-size: 9px;
  letter-spacing: 0.08em;
  text-transform: uppercase;
  color: var(--accent);
  background: var(--accent-dim);
  border: 1px solid rgba(200,200,255,0.2);
  padding: 2px 6px;
  border-radius: 4px;
  margin-bottom: 6px;
}

/* â”€â”€ NEW: Code blocks â”€â”€ */
.indy-code-container { margin: 14px 0; border: 1px solid var(--border); border-radius: var(--radius-md); overflow: hidden; background: var(--bg-elevated); font-family: var(--font-mono); font-size: 13px; }
.indy-code-header { display: flex; justify-content: space-between; align-items: center; padding: 8px 14px; background: rgba(255,255,255,0.03); border-bottom: 1px solid var(--border); font-size: 11.5px; color: var(--text-tertiary); font-family: var(--font-mono); }
.indy-copy-code { background: transparent; border: 1px solid var(--border); color: var(--text-tertiary); font-size: 11px; padding: 3px 9px; border-radius: 4px; cursor: pointer; transition: all 0.13s; }
.indy-copy-code:hover { background: var(--hover-bg); border-color: var(--border-strong); color: var(--text-secondary); }
.indy-code-block { margin: 0; padding: 14px 16px; overflow-x: auto; background: transparent; line-height: 1.55; }
.indy-code-block code { white-space: pre; }
</style>
</head>
<body>
  <div class="sidebar collapsed" id="sidebar">
    <div class="header">
      <button class="menu-btn" onclick="toggleSidebar()">â˜°</button>
      <div class="title">INDY âœ¦</div>
    </div>
    <div class="sidebar-content">
      <div class="sidebar-logo">âœ¦</div>
      <button class="sidebar-btn" data-icon="+" onclick="newChat()"><span>New Chat</span></button>
      <button class="sidebar-btn" data-icon="â—ˆ" onclick="openCode()"><span>Code Sandbox</span></button>
      <button class="sidebar-btn" data-icon="â†“" onclick="exportChat()"><span>Export Chat</span></button>
      <button class="sidebar-btn" data-icon="âŒ•" onclick="openSearch()"><span>Search</span></button>
      <button class="sidebar-btn" data-icon="â›­" onclick="openProfile()"><span>Settings</span></button>
      <button class="sidebar-btn danger" data-icon="â¨¯" onclick="deleteAllChats()"><span>Clear All</span></button>
      <hr>
      <div id="chatList"></div>
    </div>
  </div>

  <div id="userProfileFooter" class="user-profile-footer">
    <div class="profile-avatar" id="sidebarAvatar"></div>
    <div class="profile-info">
      <span id="sidebarName" class="profile-name"></span>
    </div>
  </div>

  <div class="main">
    <div class="chat-container" id="chatMessages">
      <div class="message bot">
        <div class="bubble">
          Howdy ğŸ¤ ! I'm Indy!<br>What can I help you with today?
        </div>
      </div>
    </div>

    <div class="input-area">
      <div class="input-wrapper">
        <div style="display:flex;align-items:center;gap:8px;">
          <button class="model-btn" id="modelSelectorBtn" title="Choose model">â›­</button>
        </div>
        <textarea id="userInput" placeholder="Ask anything... (Shift+Enter for new line)" rows="1"></textarea>
        <span class="char-counter" id="charCounter">0</span>
        <button class="send-btn" onclick="sendMessage()">â†‘</button>
      </div>

      <div class="model-popover" id="modelPopover">
        <div class="model-header">Available Models</div>
        <button class="model-item active" data-model="Indy Sunshine 1.0 Beta">Indy Sunshine 1.0 Beta</button>
        <button class="model-item" data-model="Sunshine Pro">Sunshine Pro</button>
        <button class="model-item" data-model="Indy 3">Indy 3</button>
        <button class="model-item" data-model="Creative Studio">Creative Studio</button>
        <button class="model-item" data-model="Code Assistant">Code Assistant</button>
        <div class="model-footer">More models coming soon</div>
      </div>
    </div>
  </div>

  <!-- Teach Modal -->
  <div class="teach-modal" id="teachModal">
    <div class="teach-content">
      <button class="close-btn" onclick="closeTeachModal()">Ã—</button>
      <h2>Teach Indy</h2>
      <div class="teach-input-group">
        <label>Trigger Phrase</label>
        <input type="text" id="triggerInput" placeholder="e.g. What's your favorite color?">
      </div>
      <div class="teach-input-group">
        <label>Response</label>
        <textarea id="responseInput" placeholder="e.g. My favorite color is blue!"></textarea>
      </div>
      <button class="teach-submit-btn" onclick="submitTeaching()">Teach Indy</button>
    </div>
  </div>

  <!-- Profile Modal -->
  <div class="teach-modal" id="profileModal">
    <div class="teach-content">
      <button class="close-btn" onclick="closeProfileModal()">Ã—</button>
      <h2>Settings</h2>
      <div style="display:flex;justify-content:center;margin-bottom:20px;">
        <div id="profilePreview"></div>
      </div>
      <div class="teach-input-group">
        <label>Your Name</label>
        <input type="text" id="profileName" placeholder="e.g. Alex">
      </div>
      <div class="teach-input-group">
        <label>Profile Picture URL</label>
        <input type="text" id="profilePicture" placeholder="https://example.com/image.jpg" oninput="updateProfilePreview()">
      </div>
      <button class="teach-submit-btn" onclick="submitProfile()">Save Settings</button>
    </div>
  </div>

  <!-- Code Sandbox Modal -->
  <div class="teach-modal" id="codeModal">
    <div class="teach-content" style="max-width:800px;">
      <button class="close-btn" onclick="closeCodeModal()">Ã—</button>
      <h2>Code Sandbox</h2>
      <div class="teach-input-group">
        <label>Language</label>
        <select id="codeLanguage" style="width:100%;background:var(--bg-elevated);border:1px solid var(--border);border-radius:12px;padding:12px 16px;color:var(--text);font-size:15px;font-family:inherit;">
          <option value="javascript">JavaScript</option>
          <option value="python">Python</option>
          <option value="html">HTML</option>
          <option value="css">CSS</option>
        </select>
      </div>
      <div class="teach-input-group">
        <label>Your Code</label>
        <textarea id="codeInput" placeholder="Write your code here..." style="min-height:200px;font-family:'IBM Plex Mono',monospace;font-size:13px;"></textarea>
      </div>
      <div class="teach-input-group">
        <label>Output</label>
        <pre id="codeOutput">Output will appear here...</pre>
      </div>
      <button class="teach-submit-btn" onclick="runCode()">â–¶ Run Code</button>
    </div>
  </div>

  <!-- Pinned Messages Modal -->
  <div class="teach-modal" id="pinnedModal">
    <div class="teach-content">
      <button class="close-btn" onclick="document.getElementById('pinnedModal').classList.remove('active')">Ã—</button>
      <h2>Pinned Messages</h2>
      <div id="pinnedList" style="display:flex;flex-direction:column;gap:10px;max-height:400px;overflow-y:auto;"></div>
      <p id="noPinnedMsg" style="color:var(--text-tertiary);font-family:var(--font-mono);font-size:13px;text-align:center;padding:20px 0;">No pinned messages yet.<br>Hover a bot reply and click ğŸ“Œ</p>
    </div>
  </div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INDY AI â€” Core State
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â”€â”€ CONVERSATION HISTORY (THE BIG FIX) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// This array holds the full chat history sent to Groq with every request.
// Without this, every message starts a brand new conversation.
let conversationHistory = [];

let knowledge = [];
let personality = "";
let modelDropdownValue = "Indy Sunshine 1.0 Beta";
let currentChatId = null;
let userProfile = JSON.parse(localStorage.getItem('userProfile')) || { name: '', picture: '' };
let pinnedMessages = JSON.parse(localStorage.getItem('pinnedMessages') || '[]');

const openings = ["Howdy ğŸ¤ ! I'm Indy", "Indy here!", "Sup! I'm Indy", "Good to see you ğŸ¤  I'm Indy"];
const openingPhrase = { get value() { return openings[Math.floor(Math.random() * openings.length)]; } };

const thinkingPhrases = ["Thinking...", "Hang tight...", "One sec...", "Let me check on that", "Processing..."];
const phrase = { get value() { return thinkingPhrases[Math.floor(Math.random() * thinkingPhrases.length)]; } };

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SIDEBAR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleSidebar() {
  document.getElementById('sidebar').classList.toggle('collapsed');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CHAT PERSISTENCE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function saveCurrentChat() {
  if (!currentChatId) return;
  const messages = [];
  document.querySelectorAll('#chatMessages .message').forEach(msg => {
    const sender = msg.classList.contains('user') ? 'user' : 'bot';
    const bubble = msg.querySelector('.bubble');
    const text = bubble.innerHTML.replace(/<button[^>]*>.*?<\/button>/g, '').replace(/<div class="reaction-row"[^>]*>.*?<\/div>/gs, '').trim();
    messages.push({ sender, text });
  });
  const chatData = {
    id: currentChatId,
    name: getChatName(currentChatId),
    messages,
    // Also persist conversation history so memory survives page reload
    history: conversationHistory,
    lastUpdated: Date.now()
  };
  localStorage.setItem(`chat_${currentChatId}`, JSON.stringify(chatData));
}

async function generateChatName(firstMessage) {
  const systemPrompt = `You are a concise title generator. Given the first message of a conversation, create a short, catchy chat title (3-6 words max). Respond with ONLY the title â€” no quotes, no extra text.`;
  try {
    const res = await fetch("https://api.groq.com/openai/v1/chat/completions", {
      method: "POST",
      headers: { "Content-Type": "application/json", "Authorization": "Bearer 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" },
      body: JSON.stringify({
        model: "llama-3.1-8b-instant",
        messages: [{ role: "system", content: systemPrompt }, { role: "user", content: `First message: "${firstMessage}"\n\nTitle:` }],
        temperature: 0.6,
        max_tokens: 30
      })
    });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    let title = data.choices?.[0]?.message?.content?.trim() || "";
    title = title.replace(/^["']|["']$/g, '').trim().substring(0, 40);
    return title || `Chat ${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`;
  } catch (err) {
    return `Chat about ${firstMessage.substring(0, 20).trim()}...`;
  }
}

function loadChat(chatId) {
  const chatData = JSON.parse(localStorage.getItem(`chat_${chatId}`));
  if (!chatData) return;
  currentChatId = chatId;
  // Restore conversation history so Indy remembers the loaded chat
  conversationHistory = chatData.history || [];
  document.getElementById('chatMessages').innerHTML = '';
  chatData.messages.forEach(msg => addMessage(msg.sender, msg.text, false));
}

async function newChat(chatId = null) {
  if (chatId) { loadChat(chatId); return; }
  currentChatId = `chat_${Date.now()}`;
  // Reset memory for new chat
  conversationHistory = [];
  document.getElementById('chatMessages').innerHTML = '';
  addMessage('bot', `${openingPhrase.value} <br>What can I help you with today?`, false);
  const chatList = JSON.parse(localStorage.getItem('chatList') || '[]');
  chatList.unshift({ id: currentChatId, name: 'New Chat' });
  localStorage.setItem('chatList', JSON.stringify(chatList));
  saveCurrentChat();
  loadSavedChats();
  setTimeout(renderStarterChips, 80);
}

async function updateChatName(chatId, firstMessage) {
  const generatedName = await generateChatName(firstMessage);
  const chatList = JSON.parse(localStorage.getItem('chatList') || '[]');
  const chat = chatList.find(c => c.id === chatId);
  if (chat && chat.name === 'New Chat') {
    chat.name = generatedName;
    localStorage.setItem('chatList', JSON.stringify(chatList));
    const chatData = JSON.parse(localStorage.getItem(`chat_${chatId}`));
    if (chatData) { chatData.name = generatedName; localStorage.setItem(`chat_${chatId}`, JSON.stringify(chatData)); }
    loadSavedChats();
  }
}

function getChatName(chatId) {
  const chatList = JSON.parse(localStorage.getItem('chatList') || '[]');
  const chat = chatList.find(c => c.id === chatId);
  return chat ? chat.name : 'Unnamed Chat';
}

function deleteChat(chatId) {
  localStorage.removeItem(`chat_${chatId}`);
  let chatList = JSON.parse(localStorage.getItem('chatList') || '[]');
  chatList = chatList.filter(c => c.id !== chatId);
  localStorage.setItem('chatList', JSON.stringify(chatList));
  if (currentChatId === chatId) {
    currentChatId = null;
    conversationHistory = [];
    document.getElementById('chatMessages').innerHTML = '';
    addMessage('bot', `${openingPhrase.value}<br>What can I help you with today?`, false);
  }
  loadSavedChats();
}

function deleteAllChats() {
  if (confirm("Delete all saved chats and history permanently?")) {
    const chatList = JSON.parse(localStorage.getItem('chatList') || '[]');
    chatList.forEach(chat => localStorage.removeItem(`chat_${chat.id}`));
    localStorage.removeItem('chatList');
    knowledge = [];
    conversationHistory = [];
    currentChatId = null;
    document.getElementById('chatMessages').innerHTML = '';
    addMessage('bot', `All chats cleared! Ready for a fresh start âœ¦`, false);
    loadSavedChats();
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MODALS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function teachAI() {
  document.getElementById('teachModal').classList.add('active');
  document.getElementById('triggerInput').value = '';
  document.getElementById('responseInput').value = '';
  document.getElementById('triggerInput').focus();
}
function closeTeachModal() { document.getElementById('teachModal').classList.remove('active'); }

function submitTeaching() {
  const q = document.getElementById('triggerInput').value.trim();
  const a = document.getElementById('responseInput').value.trim();
  if (!q || !a) { alert('Please fill in both fields!'); return; }
  let found = false;
  for (const entry of knowledge) {
    if (entry.answer.toLowerCase() === a.toLowerCase()) { entry.questions.push(q); found = true; break; }
  }
  if (!found) knowledge.push({ questions: [q], answer: a });
  addMessage('bot', "Got it! I'll remember that âœ¦");
  closeTeachModal();
}

function openProfile() {
  document.getElementById('profileModal').classList.add('active');
  document.getElementById('profileName').value = userProfile.name;
  document.getElementById('profilePicture').value = userProfile.picture;
  updateProfilePreview();
}
function closeProfileModal() { document.getElementById('profileModal').classList.remove('active'); }

function updateProfilePreview() {
  const preview = document.getElementById('profilePreview');
  const pictureUrl = document.getElementById('profilePicture').value.trim();
  preview.style.backgroundImage = pictureUrl ? `url(${pictureUrl})` : 'none';
  preview.style.backgroundColor = pictureUrl ? 'transparent' : 'var(--bg-elevated)';
}

function submitProfile() {
  userProfile.name = document.getElementById('profileName').value.trim();
  userProfile.picture = document.getElementById('profilePicture').value.trim();
  localStorage.setItem('userProfile', JSON.stringify(userProfile));
  userProfile = JSON.parse(localStorage.getItem('userProfile')) || { name: '', picture: '' };
  closeProfileModal();
  updateSidebarProfile();
  showToast('Settings saved âœ¦');
}

function openProjects() { alert("Projects coming soon â€” appreciate the patience"); }

function openCode() {
  document.getElementById('codeModal').classList.add('active');
  document.getElementById('codeInput').value = '';
  document.getElementById('codeOutput').textContent = 'Output will appear here...';
}
function closeCodeModal() { document.getElementById('codeModal').classList.remove('active'); }

function runCode() {
  const code = document.getElementById('codeInput').value;
  const lang = document.getElementById('codeLanguage').value;
  const output = document.getElementById('codeOutput');
  if (!code.trim()) { output.textContent = 'Error: No code to run!'; return; }
  if (lang === 'javascript') {
    const logs = [];
    const originalLog = console.log;
    console.log = (...args) => logs.push(args.join(' '));
    try {
      const result = eval(code);
      console.log = originalLog;
      output.textContent = logs.length > 0 ? logs.join('\n') : (result !== undefined ? String(result) : 'Code executed successfully!');
    } catch (e) {
      console.log = originalLog;
      output.textContent = `Error: ${e.message}`;
    }
  } else {
    output.textContent = `${lang} execution coming soon! For now, only JavaScript works.`;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SYSTEM PROMPT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getSystemPrompt() {
  let base = `You are Indy, a helpful AI assistant by JVST co, running on ${modelDropdownValue}. Be concise, friendly, and conversational with a relaxed, modern tone.

Rules:
- Use informal greetings like "hey" or occasional "howdy" only once at the very start of a conversation.
- NEVER repeat the same phrase (like "What's on your mind?", "How can I help?", etc.) more than once.
- Do NOT keep asking open-ended questions unless the user is clearly stuck.
- Respond directly to what the user says.
- Use at most one emoji sparingly, only when it fits naturally.
- Sound confident, warm, and contemporary.
- You remember everything said earlier in this conversation â€” refer back to prior messages naturally when relevant.`.trim();

  if (userProfile?.name && userProfile.name.trim() !== "") {
    const name = userProfile.name.trim();
    base += `\n\nYou are talking to ${name}. Use their name naturally when it feels right. Do NOT use their name every reply.`;
  }
  if (personality) base += `\n${personality}`;
  return base;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  KNOWLEDGE BASE HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function cosineSimilarity(a, b) {
  const tokensA = a.toLowerCase().match(/\w+/g) || [];
  const tokensB = b.toLowerCase().match(/\w+/g) || [];
  const set = [...new Set([...tokensA, ...tokensB])];
  const vecA = set.map(t => tokensA.filter(w => w === t).length);
  const vecB = set.map(t => tokensB.filter(w => w === t).length);
  let dot = 0, normA = 0, normB = 0;
  for (let i = 0; i < set.length; i++) { dot += vecA[i] * vecB[i]; normA += vecA[i] ** 2; normB += vecB[i] ** 2; }
  return normA && normB ? dot / (Math.sqrt(normA) * Math.sqrt(normB)) : 0;
}

function findInKnowledge(msg) {
  let best = null, bestScore = 0;
  for (const entry of knowledge) {
    for (const q of entry.questions) {
      const score = cosineSimilarity(msg, q);
      if (score > bestScore && score > 0.5) { bestScore = score; best = entry.answer; }
    }
  }
  return best;
}

function handleMath(msg) {
  const expr = msg.toLowerCase().replace(/^(what is|calculate|\s)+/g, '').trim().replace(/Ã—/g,'*').replace(/Ã·/g,'/').replace(/\^/g,'**');
  if (/^[0-9+\-*/().\s**]+$/.test(expr)) {
    try { return Function('"use strict"; return (' + expr + ')')(); } catch(e) {}
  }
  return null;
}

async function getDefinition(word) {
  try {
    const res = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${word}`);
    const data = await res.json();
    if (!data.title) return `<strong>${word}:</strong> ${data[0].meanings[0].definitions[0].definition}`;
  } catch {}
  return null;
}

async function getWikipedia(topic) {
  try {
    const res = await fetch(`https://en.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(topic)}`);
    const data = await res.json();
    if (data.extract) return `<strong>${data.title}:</strong> ${data.extract}`;
  } catch {}
  return null;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  AI RESPONSE â€” WITH FULL CONVERSATION HISTORY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function getAIResponse(userMessage) {
  const systemPrompt = getSystemPrompt();

  // Add the new user message to history BEFORE sending
  conversationHistory.push({ role: "user", content: userMessage });

  // Keep history from growing too large (last 40 messages = 20 turns)
  const MAX_HISTORY = 40;
  if (conversationHistory.length > MAX_HISTORY) {
    conversationHistory = conversationHistory.slice(-MAX_HISTORY);
  }

  try {
    const res = await fetch("https://api.groq.com/openai/v1/chat/completions", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": "Bearer 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"
      },
      body: JSON.stringify({
        model: "llama-3.3-70b-versatile",
        messages: [
          { role: "system", content: systemPrompt },
          ...conversationHistory   // â† Full history goes here
        ],
        temperature: 0.7,
        max_tokens: 2048
      })
    });

    if (!res.ok) {
      const errorText = await res.text();
      console.error("Indy error:", errorText);
      // Remove the message we added if the request failed
      conversationHistory.pop();
      throw new Error(`HTTP ${res.status}`);
    }

    const data = await res.json();
    const reply = data.choices?.[0]?.message?.content?.trim() || "â€¦";

    // Add assistant reply to history so it's included in next request
    conversationHistory.push({ role: "assistant", content: reply });

    return reply;

  } catch (err) {
    console.error("Indy API call failed:", err);
    return "Indy is taking a quick breather â€” try again in a moment âœ¦";
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  IMAGE GENERATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function generateImage(prompt) {
  try {
    const encodedPrompt = encodeURIComponent(prompt.trim());
    const url = `https://api.pixazo.ai/text-to-image/stable-diffusion?prompt=${encodedPrompt}&width=1152&height=896&style=realistic`;
    const head = await fetch(url, { method: 'HEAD' });
    if (!head.ok) throw new Error(`Pixazo responded ${head.status}`);
    return url;
  } catch (err) {
    console.error("Image gen error:", err);
    return `Error generating image: ${err.message}. Try again in a few seconds.`;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SEND MESSAGE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function sendMessage() {
  const input = document.getElementById('userInput');
  const msg = input.value.trim();
  if (!msg) return;

  if (!currentChatId) {
    currentChatId = `chat_${Date.now()}`;
    conversationHistory = [];
    const chatList = JSON.parse(localStorage.getItem('chatList') || '[]');
    chatList.unshift({ id: currentChatId, name: 'New Chat' });
    localStorage.setItem('chatList', JSON.stringify(chatList));
  }

  addMessage('user', msg);
  input.value = '';
  input.style.height = 'auto';
  updateCharCounter('');

  // Remove starter chips if present
  document.getElementById('starterChips')?.remove();

  const messageCount = document.querySelectorAll('#chatMessages .message.user').length;
  if (messageCount === 1) updateChatName(currentChatId, msg);

  const learned = findInKnowledge(msg);
  if (learned) { addMessage('bot', learned); saveCurrentChat(); return; }

  if (/^define |^meaning of /.test(msg.toLowerCase())) {
    const word = msg.replace(/^define |^meaning of /i, '').trim().split(' ')[0];
    addThinkingIndicator();
    const def = await getDefinition(word);
    replaceLastBot(def || "Not found.");
    saveCurrentChat();
    return;
  }

  if (/^tell me about |^what is /.test(msg.toLowerCase())) {
    const topic = msg.replace(/^tell me about |^what is /i, '').trim();
    addThinkingIndicator();
    const wiki = await getWikipedia(topic);
    if (wiki) { replaceLastBot(wiki); saveCurrentChat(); return; }
    // If Wikipedia fails, fall through to AI
  }

  const math = handleMath(msg);
  if (math !== null) {
    addMessage('bot', `<strong>${msg} = ${math}</strong>`);
    saveCurrentChat();
    return;
  }

  if (msg.toLowerCase().startsWith('!img ') || msg.toLowerCase().startsWith('generate image ') ||
      msg.toLowerCase().startsWith('generate an image ') || msg.toLowerCase().startsWith('generate a picture') ||
      msg.toLowerCase().startsWith('draw ') || msg.toLowerCase().startsWith('create image ')) {
    const imagePrompt = msg
      .replace(/^!img /i,'').replace(/^generate image /i,'').replace(/^generate an image /i,'')
      .replace(/^generate a picture /i,'').replace(/^draw /i,'').replace(/^create image /i,'').trim();

    if (!imagePrompt) { addMessage('bot', "Add a description!<br>Example: <code>!img neon cyberpunk city</code>"); saveCurrentChat(); return; }

    addThinkingIndicator();
    const result = await generateImage(imagePrompt);
    if (result.startsWith('http')) {
      replaceLastBot(
        `Here's your image âœ¦<br><br>` +
        `<img src="${result}" alt="${imagePrompt}" style="max-width:100%;border-radius:20px;margin:16px 0;box-shadow:0 8px 32px rgba(0,0,0,0.5);">` +
        `<br><strong>Prompt:</strong> ${imagePrompt}`
      );
    } else { replaceLastBot(result); }
    saveCurrentChat();
    return;
  }

  // Stranger Things trigger
  const udTriggers = ['!strangerthings','!upsidedown','!upside-down','!vecna','!demogorgon','!the upside down'];
  if (udTriggers.some(t => msg.toLowerCase() === t || msg.toLowerCase().startsWith(t + ' '))) {
    enterUpsideDown();
    return;
  }

  addThinkingIndicator();
  const response = await getAIResponse(msg);
  replaceLastBot(response);
  saveCurrentChat();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MESSAGE RENDERING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function addMessage(sender, text, shouldSave = true) {
  const container = document.getElementById('chatMessages');
  const msgDiv = document.createElement('div');
  msgDiv.className = `message ${sender}`;
  if (sender === 'bot') {
    msgDiv.innerHTML = `
      <div class="bubble">
        ${text}
        <button class="copy-btn" onclick="copyText(this)">Copy</button>
        <div class="reaction-row">
          <button class="reaction-btn" title="Helpful" onclick="reactToMessage(this,'ğŸ‘')">ğŸ‘</button>
          <button class="reaction-btn" title="Not helpful" onclick="reactToMessage(this,'ğŸ‘')">ğŸ‘</button>
          <button class="reaction-btn" title="Pin" onclick="pinMessage(this)">ğŸ“Œ</button>
          <button class="reaction-btn" title="Regenerate" onclick="regenerateLast(this)">â†º</button>
        </div>
      </div>`;
  } else {
    msgDiv.innerHTML = `<div class="bubble">${text.replace(/\n/g, '<br>')}</div>`;
  }
  container.appendChild(msgDiv);
  container.scrollTop = container.scrollHeight;
  if (shouldSave) saveCurrentChat();
}

function addThinkingIndicator() {
  const container = document.getElementById('chatMessages');
  const msgDiv = document.createElement('div');
  msgDiv.className = 'message bot';
  msgDiv.innerHTML = `<div class="bubble"><div class="thinking-indicator"><span class="thinking-star">âœ¦</span><span class="thinking-text">${phrase.value}</span></div></div>`;
  container.appendChild(msgDiv);
  container.scrollTop = container.scrollHeight;
}

function replaceLastBot(text) {
  const lastBotBubble = document.querySelector('.message.bot:last-child .bubble');
  if (lastBotBubble) {
    lastBotBubble.innerHTML = text +
      '<button class="copy-btn" onclick="copyText(this)">Copy</button>' +
      '<div class="reaction-row">' +
        '<button class="reaction-btn" title="Helpful" onclick="reactToMessage(this,\'ğŸ‘\')">ğŸ‘</button>' +
        '<button class="reaction-btn" title="Not helpful" onclick="reactToMessage(this,\'ğŸ‘\')">ğŸ‘</button>' +
        '<button class="reaction-btn" title="Pin" onclick="pinMessage(this)">ğŸ“Œ</button>' +
        '<button class="reaction-btn" title="Regenerate" onclick="regenerateLast(this)">â†º</button>' +
      '</div>';
    processCodeBlocks(lastBotBubble);
  }
  document.getElementById('chatMessages').scrollTop = document.getElementById('chatMessages').scrollHeight;
  saveCurrentChat();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CHAT LIST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function loadSavedChats() {
  const chatList = document.getElementById('chatList');
  chatList.innerHTML = '';
  const chats = JSON.parse(localStorage.getItem('chatList') || '[]');
  chats.forEach(chat => createChatButton(chat.id, chat.name));
}

function createChatButton(chatId, name) {
  const chatList = document.getElementById('chatList');
  const btn = document.createElement('button');
  btn.className = 'sidebar-btn';
  btn.onclick = () => newChat(chatId);
  const nameSpan = document.createElement('span');
  nameSpan.textContent = name;
  const delSpan = document.createElement('span');
  delSpan.textContent = 'â¨¯';
  delSpan.onclick = (e) => { e.stopPropagation(); deleteChat(chatId); };
  btn.appendChild(nameSpan);
  btn.appendChild(delSpan);
  chatList.appendChild(btn);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SIDEBAR PROFILE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateSidebarProfile() {
  const avatar = document.getElementById('sidebarAvatar');
  const nameEl = document.getElementById('sidebarName');
  if (!avatar || !nameEl) return;
  const picUrl = userProfile?.picture?.trim();
  avatar.style.backgroundImage = picUrl ? `url(${picUrl})` : 'none';
  avatar.style.backgroundColor = picUrl ? 'transparent' : 'var(--bg-card)';
  nameEl.textContent = userProfile?.name?.trim() || 'Guest';
  document.getElementById('userProfileFooter').onclick = () => {
    document.getElementById('profileModal').classList.add('active');
    document.getElementById('profileName').value = userProfile.name;
    document.getElementById('profilePicture').value = userProfile.picture;
    updateProfilePreview();
  };
}
updateSidebarProfile();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  COPY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function copyText(btn) {
  const bubble = btn.parentElement;
  const clone = bubble.cloneNode(true);
  clone.querySelectorAll('button').forEach(b => b.remove());
  clone.querySelectorAll('.reaction-row').forEach(r => r.remove());
  const text = (clone.innerText || clone.textContent || '').trim();
  navigator.clipboard.writeText(text).then(() => {
    btn.textContent = 'Copied âœ“';
    showToast('Copied to clipboard');
    setTimeout(() => btn.textContent = 'Copy', 2000);
  }).catch(() => { btn.textContent = 'Failed'; setTimeout(() => btn.textContent = 'Copy', 2000); });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FEATURE 1 â€” REACTION BUTTONS (ğŸ‘ğŸ‘ğŸ“Œâ†º)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function reactToMessage(btn, reaction) {
  const isActive = btn.classList.contains('active');
  // Clear other thumbs in same row
  const row = btn.closest('.reaction-row');
  row.querySelectorAll('.reaction-btn').forEach(b => {
    if (b.textContent === 'ğŸ‘' || b.textContent === 'ğŸ‘') b.classList.remove('active');
  });
  if (!isActive) {
    btn.classList.add('active');
    showToast(reaction === 'ğŸ‘' ? 'Marked as helpful' : 'Got it â€” will improve');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FEATURE 2 â€” PIN MESSAGES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function pinMessage(btn) {
  const bubble = btn.closest('.bubble');
  const clone = bubble.cloneNode(true);
  clone.querySelectorAll('button').forEach(b => b.remove());
  clone.querySelectorAll('.reaction-row').forEach(r => r.remove());
  const text = (clone.innerText || clone.textContent || '').trim();
  if (!text) return;

  const alreadyPinned = pinnedMessages.some(p => p.text === text);
  if (alreadyPinned) {
    pinnedMessages = pinnedMessages.filter(p => p.text !== text);
    btn.classList.remove('active');
    showToast('Unpinned');
  } else {
    pinnedMessages.push({ text, chatId: currentChatId, time: Date.now() });
    btn.classList.add('active');
    showToast('Message pinned ğŸ“Œ');
  }
  localStorage.setItem('pinnedMessages', JSON.stringify(pinnedMessages));
}

function openPinned() {
  const modal = document.getElementById('pinnedModal');
  const list = document.getElementById('pinnedList');
  const noMsg = document.getElementById('noPinnedMsg');
  list.innerHTML = '';
  if (pinnedMessages.length === 0) {
    noMsg.style.display = 'block';
  } else {
    noMsg.style.display = 'none';
    pinnedMessages.forEach((pin, i) => {
      const item = document.createElement('div');
      item.style.cssText = `background:var(--bg-elevated);border:1px solid var(--border);border-radius:var(--radius-md);padding:12px 14px;position:relative;`;
      item.innerHTML = `
        <div class="pinned-badge">ğŸ“Œ pinned</div>
        <div style="font-size:13px;color:var(--text-secondary);line-height:1.5;">${pin.text.substring(0,200)}${pin.text.length>200?'â€¦':''}</div>
        <button onclick="this.parentElement.remove();pinnedMessages.splice(${i},1);localStorage.setItem('pinnedMessages',JSON.stringify(pinnedMessages));" style="position:absolute;top:8px;right:8px;background:transparent;border:none;color:var(--text-dim);cursor:pointer;font-family:var(--font-mono);font-size:14px;">â¨¯</button>
      `;
      list.appendChild(item);
    });
  }
  modal.classList.add('active');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FEATURE 3 â€” REGENERATE LAST RESPONSE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function regenerateLast(btn) {
  // Find the last user message
  const userMessages = document.querySelectorAll('#chatMessages .message.user');
  if (!userMessages.length) return;
  const lastUserMsg = userMessages[userMessages.length - 1];
  const lastUserText = (lastUserMsg.querySelector('.bubble').textContent || '').trim();
  if (!lastUserText) return;

  showToast('Regeneratingâ€¦');

  // Remove last assistant turn from history so we can get a fresh answer
  if (conversationHistory.length >= 2 && conversationHistory[conversationHistory.length - 1].role === 'assistant') {
    conversationHistory.pop(); // remove last assistant
    conversationHistory.pop(); // remove last user (will be re-added in getAIResponse)
  }

  // Show thinking state in the current bubble
  const bubble = btn.closest('.bubble');
  bubble.innerHTML = `<div class="thinking-indicator"><span class="thinking-star">âœ¦</span><span class="thinking-text">Regenerating...</span></div>`;

  const response = await getAIResponse(lastUserText);
  bubble.innerHTML = response +
    '<button class="copy-btn" onclick="copyText(this)">Copy</button>' +
    '<div class="reaction-row">' +
      '<button class="reaction-btn" onclick="reactToMessage(this,\'ğŸ‘\')">ğŸ‘</button>' +
      '<button class="reaction-btn" onclick="reactToMessage(this,\'ğŸ‘\')">ğŸ‘</button>' +
      '<button class="reaction-btn" onclick="pinMessage(this)">ğŸ“Œ</button>' +
      '<button class="reaction-btn" onclick="regenerateLast(this)">â†º</button>' +
    '</div>';
  processCodeBlocks(bubble);
  saveCurrentChat();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FEATURE 4 â€” EXPORT CHAT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function exportChat() {
  const messages = document.querySelectorAll('#chatMessages .message');
  if (!messages.length) { showToast('Nothing to export'); return; }

  let text = `INDY CHAT EXPORT\nDate: ${new Date().toLocaleString()}\nChat: ${getChatName(currentChatId) || 'Untitled'}\n${'â”€'.repeat(40)}\n\n`;
  messages.forEach(msg => {
    const isUser = msg.classList.contains('user');
    const bubble = msg.querySelector('.bubble');
    if (!bubble) return;
    const clone = bubble.cloneNode(true);
    clone.querySelectorAll('button, .reaction-row').forEach(b => b.remove());
    const clean = (clone.innerText || clone.textContent || '').trim();
    if (!clean) return;
    text += `[${isUser ? 'YOU' : 'INDY'}]\n${clean}\n\n`;
  });

  const blob = new Blob([text], { type: 'text/plain' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `indy-chat-${Date.now()}.txt`;
  a.click();
  URL.revokeObjectURL(url);
  showToast('Chat exported â†“');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FEATURE 5 â€” CHARACTER COUNTER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateCharCounter(text) {
  const counter = document.getElementById('charCounter');
  if (!counter) return;
  const len = text.length;
  const MAX = 2000;
  counter.textContent = len > 0 ? len : '';
  counter.className = 'char-counter';
  if (len > MAX * 0.85) counter.classList.add('warn');
  if (len > MAX) counter.classList.add('over');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FEATURE 6 â€” MESSAGE SEARCH (Ctrl+K)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openSearch() {
  if (document.getElementById('searchOverlay')) return;
  const overlay = document.createElement('div');
  overlay.id = 'searchOverlay';
  overlay.style.cssText = `position:fixed;inset:0;background:rgba(0,0,0,0.75);backdrop-filter:blur(10px);z-index:2000;display:flex;align-items:flex-start;justify-content:center;padding-top:120px;`;
  overlay.innerHTML = `
    <div style="background:var(--bg-card);border:1px solid var(--border-strong);border-radius:12px;width:90%;max-width:520px;overflow:hidden;box-shadow:0 16px 48px rgba(0,0,0,0.6);">
      <div style="display:flex;align-items:center;gap:10px;padding:14px 16px;border-bottom:1px solid var(--border);">
        <span style="font-family:var(--font-mono);color:var(--text-tertiary);font-size:14px;">âŒ•</span>
        <input id="searchInput" placeholder="Search messagesâ€¦" autocomplete="off" style="flex:1;background:transparent;border:none;outline:none;color:var(--text);font-size:14px;font-family:var(--font-ui);caret-color:var(--accent);">
        <span style="font-family:var(--font-mono);color:var(--text-tertiary);font-size:11px;">ESC</span>
      </div>
      <div id="searchResults" style="max-height:320px;overflow-y:auto;padding:8px 0;">
        <div style="padding:16px;color:var(--text-tertiary);font-size:13px;text-align:center;font-family:var(--font-mono);">Start typing to searchâ€¦</div>
      </div>
    </div>`;
  document.body.appendChild(overlay);
  const searchInput = document.getElementById('searchInput');
  searchInput.focus();

  searchInput.addEventListener('input', () => {
    const query = searchInput.value.trim().toLowerCase();
    const resultsEl = document.getElementById('searchResults');
    if (!query) { resultsEl.innerHTML = `<div style="padding:16px;color:var(--text-tertiary);font-size:13px;text-align:center;font-family:var(--font-mono);">Start typing to searchâ€¦</div>`; return; }
    const messages = document.querySelectorAll('#chatMessages .message');
    const matches = [];
    messages.forEach((msg, i) => {
      const bubble = msg.querySelector('.bubble');
      if (!bubble) return;
      const clone = bubble.cloneNode(true);
      clone.querySelectorAll('button, .reaction-row').forEach(b => b.remove());
      const text = (clone.innerText || clone.textContent || '').trim();
      if (text.toLowerCase().includes(query)) matches.push({ index: i, text, isUser: msg.classList.contains('user'), el: msg });
    });
    if (!matches.length) { resultsEl.innerHTML = `<div style="padding:16px;color:var(--text-tertiary);font-size:13px;text-align:center;font-family:var(--font-mono);">No results for "${query}"</div>`; return; }
    resultsEl.innerHTML = matches.map((m, i) => {
      const snippet = m.text.length > 80 ? m.text.slice(0, 80) + 'â€¦' : m.text;
      const highlighted = snippet.replace(new RegExp(query, 'gi'), match => `<mark style="background:rgba(200,200,255,0.25);color:var(--text);border-radius:2px;padding:0 2px;">${match}</mark>`);
      return `<button data-match-index="${i}" style="width:100%;background:transparent;border:none;text-align:left;padding:10px 16px;cursor:pointer;border-bottom:1px solid var(--border);" onmouseover="this.style.background='var(--hover-bg)'" onmouseout="this.style.background='transparent'">
        <div style="font-size:10px;font-family:var(--font-mono);color:var(--text-tertiary);letter-spacing:.06em;margin-bottom:4px;text-transform:uppercase;">${m.isUser ? 'You' : 'Indy'}</div>
        <div style="font-size:13px;color:var(--text-secondary);line-height:1.5;">${highlighted}</div>
      </button>`;
    }).join('');
    resultsEl.querySelectorAll('button[data-match-index]').forEach((btn, i) => {
      btn.addEventListener('click', () => {
        matches[i].el.scrollIntoView({ behavior: 'smooth', block: 'center' });
        matches[i].el.style.transition = 'background 0.3s';
        matches[i].el.style.background = 'rgba(200,200,255,0.06)';
        setTimeout(() => matches[i].el.style.background = '', 1200);
        overlay.remove();
      });
    });
  });
  overlay.addEventListener('click', e => { if (e.target === overlay) overlay.remove(); });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TOAST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showToast(message, duration = 2200) {
  const existing = document.getElementById('indyToast');
  if (existing) existing.remove();
  const toast = document.createElement('div');
  toast.id = 'indyToast';
  toast.textContent = message;
  toast.style.cssText = `position:fixed;bottom:90px;left:50%;transform:translateX(-50%) translateY(8px);background:var(--bg-card);border:1px solid var(--border-strong);color:var(--text-secondary);font-size:12.5px;font-family:var(--font-mono);letter-spacing:0.04em;padding:8px 16px;border-radius:999px;z-index:9999;opacity:0;transition:all 0.2s cubic-bezier(0.2,0.8,0.4,1);pointer-events:none;white-space:nowrap;`;
  document.body.appendChild(toast);
  requestAnimationFrame(() => { toast.style.opacity = '1'; toast.style.transform = 'translateX(-50%) translateY(0)'; });
  setTimeout(() => { toast.style.opacity = '0'; toast.style.transform = 'translateX(-50%) translateY(6px)'; setTimeout(() => toast.remove(), 200); }, duration);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  KEYBOARD SHORTCUTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.addEventListener('keydown', (e) => {
  const active = document.activeElement;
  const isTyping = active.tagName === 'INPUT' || active.tagName === 'TEXTAREA';
  if (e.key === '/' && !isTyping) { e.preventDefault(); document.getElementById('userInput')?.focus(); }
  if ((e.ctrlKey || e.metaKey) && e.key === 'k') { e.preventDefault(); openSearch(); }
  if ((e.ctrlKey || e.metaKey) && e.key === 'n') { e.preventDefault(); newChat(); }
  if ((e.ctrlKey || e.metaKey) && e.key === 'e') { e.preventDefault(); exportChat(); }
  if (e.key === 'Escape') {
    document.querySelectorAll('.teach-modal.active').forEach(m => m.classList.remove('active'));
    document.getElementById('searchOverlay')?.remove();
    document.getElementById('modelPopover')?.classList.remove('active');
  }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  AUTO-RESIZE TEXTAREA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(function initAutoResize() {
  const textarea = document.getElementById('userInput');
  if (!textarea) return;
  textarea.style.cssText += `resize:none;overflow-y:hidden;max-height:120px;line-height:1.5;`;
  textarea.addEventListener('input', () => {
    textarea.style.height = 'auto';
    textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
    updateCharCounter(textarea.value);
  });
  textarea.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
      setTimeout(() => { textarea.style.height = 'auto'; }, 0);
    }
  });
})();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CODE BLOCK SYNTAX HIGHLIGHTING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function highlightCode(code) {
  const keywords = /\b(?:function|const|let|var|if|else|for|while|return|class|new|this|super|try|catch|finally|switch|case|break|continue|async|await|import|export|default|true|false|null|undefined|void|typeof|instanceof|delete|in|do|with|yield|static|public|private|protected)\b/g;
  const functions = /\b([a-zA-Z_$][\w$]*)\s*(?=\()/g;
  const strings = /(["'`])(?:(?=(\\?))\2.)*?\1/g;
  const comments = /(\/\/.*$)|(\/\*[\s\S]*?\*\/)/gm;
  const numbers = /\b(?:0[xX][0-9a-fA-F]+|\d+(?:\.\d+)?)\b/g;
  return code
    .replace(comments, '<span style="color:#6a9955;">$&</span>')
    .replace(strings,  '<span style="color:#ce9178;">$&</span>')
    .replace(numbers,  '<span style="color:#b5cea8;">$&</span>')
    .replace(keywords, '<span style="color:#569cd6;">$&</span>')
    .replace(functions,'<span style="color:#dcdcaa;">$1</span>');
}

function processCodeBlocks(bubble) {
  bubble.innerHTML = bubble.innerHTML.replace(
    /```(\w+)?\n?([\s\S]*?)\n?```/g,
    (match, lang, code) => {
      const language = (lang || 'text').toLowerCase();
      const highlighted = highlightCode(code.trim());
      return `<div class="indy-code-container">
        <div class="indy-code-header">
          <span>${language.toUpperCase()}</span>
          <button class="indy-copy-code" onclick="navigator.clipboard.writeText(this.closest('.indy-code-container').querySelector('code').textContent);this.textContent='Copied âœ“';setTimeout(()=>this.textContent='Copy',1800)">Copy</button>
        </div>
        <pre class="indy-code-block"><code>${highlighted}</code></pre>
      </div>`;
    }
  );
}

// Observe new bot messages for code blocks
new MutationObserver((mutations) => {
  mutations.forEach(mutation => {
    mutation.addedNodes.forEach(node => {
      if (node.nodeType !== 1 || !node.classList?.contains('bot')) return;
      const bubble = node.querySelector('.bubble');
      if (bubble) processCodeBlocks(bubble);
    });
  });
}).observe(document.getElementById('chatMessages'), { childList: true });

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MODEL SELECTOR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const modelBtn = document.getElementById('modelSelectorBtn');
const modelPopover = document.getElementById('modelPopover');
if (modelBtn && modelPopover) {
  modelBtn.addEventListener('click', (e) => { e.stopPropagation(); modelPopover.classList.toggle('active'); });
  document.addEventListener('click', (e) => {
    if (!modelPopover.contains(e.target) && e.target !== modelBtn) modelPopover.classList.remove('active');
  });
  modelPopover.querySelectorAll('.model-item').forEach(item => {
    item.addEventListener('click', () => {
      modelPopover.querySelectorAll('.model-item').forEach(i => i.classList.remove('active'));
      item.classList.add('active');
      modelDropdownValue = item.getAttribute('data-model');
      localStorage.setItem('selectedModel', modelDropdownValue);
      modelPopover.classList.remove('active');
      showToast(`Model: ${modelDropdownValue}`);
    });
  });
  const savedModel = localStorage.getItem('selectedModel');
  if (savedModel) {
    modelDropdownValue = savedModel;
    const activeItem = modelPopover.querySelector(`[data-model="${savedModel}"]`);
    if (activeItem) { modelPopover.querySelectorAll('.model-item').forEach(i => i.classList.remove('active')); activeItem.classList.add('active'); }
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONVERSATION STARTERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const STARTER_PROMPTS = [
  "Explain something complex simply", "Help me debug my code",
  "Write a short story about...", "What are the pros and cons of...",
  "Summarize this idea:", "Give me 5 ideas for...",
  "How does X work?", "Help me write an email about...",
];

function renderStarterChips() {
  const container = document.getElementById('chatMessages');
  if (!container || document.getElementById('starterChips')) return;
  const existingMsgs = container.querySelectorAll('.message');
  if (existingMsgs.length > 1) return;

  const wrapper = document.createElement('div');
  wrapper.id = 'starterChips';
  wrapper.style.cssText = `align-self:flex-start;display:flex;flex-wrap:wrap;gap:8px;max-width:100%;animation:msgIn 0.3s ease;`;
  const shuffled = [...STARTER_PROMPTS].sort(() => Math.random() - 0.5).slice(0, 4);
  shuffled.forEach(prompt => {
    const chip = document.createElement('button');
    chip.textContent = prompt;
    chip.style.cssText = `background:var(--bg-card);border:1px solid var(--border);border-radius:6px;color:var(--text-secondary);font-size:12.5px;font-family:var(--font-mono);padding:7px 12px;cursor:pointer;transition:all 0.15s ease;text-align:left;`;
    chip.addEventListener('mouseenter', () => { chip.style.borderColor='var(--border-strong)';chip.style.color='var(--text)';chip.style.background='var(--hover-bg)'; });
    chip.addEventListener('mouseleave', () => { chip.style.borderColor='var(--border)';chip.style.color='var(--text-secondary)';chip.style.background='var(--bg-card)'; });
    chip.addEventListener('click', () => {
      const input = document.getElementById('userInput');
      if (input) { input.value = prompt.replace('...',''); input.focus(); updateCharCounter(input.value); }
      wrapper.remove();
    });
    wrapper.appendChild(chip);
  });
  container.appendChild(wrapper);
  container.scrollTop = container.scrollHeight;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.addEventListener('DOMContentLoaded', () => {
  loadSavedChats();
  const chatList = JSON.parse(localStorage.getItem('chatList') || '[]');
  if (chatList.length > 0) {
    loadChat(chatList[0].id);
  } else {
    currentChatId = `chat_${Date.now()}`;
    conversationHistory = [];
    const list = JSON.parse(localStorage.getItem('chatList') || '[]');
    list.unshift({ id: currentChatId, name: 'New Chat' });
    localStorage.setItem('chatList', JSON.stringify(list));
    loadSavedChats();
    setTimeout(renderStarterChips, 150);
  }
});

// Pinned button in sidebar
document.querySelector('[data-icon="â—ˆ"]')?.insertAdjacentHTML('afterend',
  `<button class="sidebar-btn" data-icon="ğŸ“Œ" onclick="openPinned()"><span>Pinned</span></button>`
);
</script>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UPDATE POPUP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(function() {
  const UPDATE_KEY = "indy_memory_update_v2";
  if (localStorage.getItem(UPDATE_KEY) === "true") return;

  const modal = document.createElement("div");
  modal.style.cssText = `position:fixed;inset:0;background:rgba(0,0,0,0.85);backdrop-filter:blur(10px);z-index:9999;display:flex;align-items:center;justify-content:center;opacity:0;transition:opacity 0.4s ease;`;
  const content = document.createElement("div");
  content.style.cssText = `background:rgba(30,30,40,0.95);border:1px solid rgba(255,255,255,0.12);border-radius:16px;max-width:440px;width:90%;padding:28px 24px;text-align:center;box-shadow:0 20px 60px rgba(0,0,0,0.7);transform:scale(0.92);transition:all 0.4s cubic-bezier(0.34,1.56,0.64,1);`;
  content.innerHTML = `
    <div style="font-size:48px;margin-bottom:12px;">âœ¦</div>
    <h2 style="font-family:'IBM Plex Mono',monospace;font-weight:600;font-size:22px;margin-bottom:16px;letter-spacing:0.04em;text-transform:uppercase;">Indy Memory Update</h2>
    <p style="font-size:14px;color:#ddd;line-height:1.6;margin-bottom:20px;">Indy now remembers your full conversation â€” no more amnesia mid-chat.</p>
    <ul style="text-align:left;max-width:380px;margin:0 auto 24px;padding-left:20px;font-size:13px;color:#ccc;line-height:1.8;list-style-type:'â†’ ';">
      <li>Full conversation memory (the real fix)</li>
      <li>Reaction buttons on every reply</li>
      <li>Pin important messages</li>
      <li>Regenerate any response</li>
      <li>Character counter on input</li>
      <li>History persists between sessions</li>
    </ul>
    <button id="acceptUpdateBtn" style="background:linear-gradient(135deg,#ffffff,#e0e0e0);color:#000;border:none;padding:12px 44px;font-size:14px;font-weight:700;letter-spacing:0.06em;text-transform:uppercase;border-radius:50px;cursor:pointer;font-family:'IBM Plex Mono',monospace;">Got it, let's go</button>
  `;
  modal.appendChild(content);
  document.body.appendChild(modal);
  setTimeout(() => { modal.style.opacity = "1"; content.style.transform = "scale(1)"; }, 50);
  document.getElementById("acceptUpdateBtn").onclick = () => {
    localStorage.setItem(UPDATE_KEY, "true");
    modal.style.opacity = "0";
    setTimeout(() => modal.remove(), 400);
    if (typeof addMessage === 'function') addMessage('bot', "Memory's working now â€” I'll remember everything we talk about ğŸ¤ ", false);
  };
  modal.onclick = (e) => {
    if (e.target === modal) { localStorage.setItem(UPDATE_KEY, "true"); modal.style.opacity = "0"; setTimeout(() => modal.remove(), 400); }
  };
})();
</script>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STRANGER THINGS EASTER EGG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
if (!document.getElementById('upsidedown-v7-locked')) {
  const style = document.createElement('style');
  style.id = 'upsidedown-v7-locked';
  style.textContent = `
    @keyframes chaoticDrift { 0%{transform:translate(0,0)scale(1);opacity:.50}30%{opacity:.85}60%{opacity:.35}100%{transform:translate(var(--dx),var(--dy))scale(var(--s));opacity:.50}}
    @keyframes slowRotate { from{transform:rotate(0deg)}to{transform:rotate(360deg)}}
    .upside-particle{position:fixed;background:#ffe6e6;pointer-events:none;z-index:9995;border-radius:1px;box-shadow:0 0 12px rgba(255,80,80,0.7);animation:chaoticDrift infinite ease-in-out,slowRotate infinite linear;will-change:transform,opacity;}
    #red-flood{position:fixed;inset:0;background:#2e0000;pointer-events:none;z-index:10001;opacity:0;transition:opacity 5.2s ease-out;box-shadow:inset 0 0 160px rgba(0,0,0,0.98);}
    #red-flood.fade-in{animation:fadeInRed 0.9s ease-in forwards;}
    @keyframes fadeInRed{from{opacity:0}to{opacity:1}}
    #red-flood.visible{opacity:1;}
    body.upsidedown{filter:brightness(0.78)contrast(1.22)sepia(0.15);transition:filter 7s ease-in-out;}
  `;
  document.head.appendChild(style);
}

let _udActive = false;
let _udParticles = [];

function createUDParticle() {
  const size = 1.4 + Math.random() * 5.2, x = Math.random()*100, y = Math.random()*100;
  const dx=(Math.random()-0.5)*1500, dy=(Math.random()-0.5)*1500, scale=0.35+Math.random()*2.3;
  const drift=85+Math.random()*170, rotate=45+Math.random()*90;
  const p = document.createElement('div');
  p.className='upside-particle';
  p.style.cssText=`width:${size}px;height:${size}px;left:${x}vw;top:${y}vh;--dx:${dx}px;--dy:${dy}px;--s:${scale};animation-duration:${drift}s,${rotate}s;animation-direction:${Math.random()>.5?'normal':'reverse'},normal;animation-delay:-${Math.random()*drift}s,0s;opacity:.50;`;
  document.body.appendChild(p);
  _udParticles.push(p);
}

function enterUpsideDown() {
  if (_udActive) return;
  _udActive = true;
  const flood = document.createElement('div'); flood.id='red-flood'; document.body.appendChild(flood); flood.classList.add('fade-in');
  setTimeout(() => { document.body.style.transform='rotate(180deg)'; document.body.style.transformOrigin='center center'; flood.classList.add('visible'); }, 600);
  for (let i=0;i<90;i++) setTimeout(createUDParticle, i*32);
  setTimeout(() => {
    flood.style.opacity='0';
    setTimeout(() => {
      flood.remove();
      document.body.classList.add('upsidedown');
      setTimeout(() => { if (typeof addMessage==='function') addMessage('bot',"It swallowed everything.<br><span style='color:#c00;opacity:0.97;'>You're in the Upside Down.</span><br><small style='opacity:0.78'>reload to leave</small>"); }, 1800);
    }, 5200);
  }, 2800);
}
</script>

</body>
</html>
